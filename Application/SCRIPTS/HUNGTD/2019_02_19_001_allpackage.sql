-- Start of DDL Script for Package LEGALTECH.PKG_ALLCODE
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_allcode
  IS TYPE tcursor IS ref CURSOR;

PROCEDURE proc_AllCode_GetAll
(
    p_cursor OUT tcursor
);

PROCEDURE proc_Country_GetAll
(
    p_cursor OUT tcursor
);
END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_allcode
IS

PROCEDURE proc_AllCode_GetAll
(
    p_cursor OUT tcursor
)
IS
BEGIN

    OPEN p_cursor FOR SELECT * FROM allcode ORDER BY cdname,cdtype,lstodr;

END;

PROCEDURE proc_Country_GetAll
(
    p_cursor OUT tcursor
)
IS
BEGIN

    OPEN p_cursor FOR SELECT * FROM country ORDER BY name;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_ALLCODE

-- Start of DDL Script for Package LEGALTECH.PKG_APP_CLASS
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_class
 IS TYPE TCURSOR IS REF CURSOR;

PROCEDURE PROC_CLASS_ADD
(
    P_CODE IN VARCHAR2,
    P_NAME_VI IN VARCHAR2,
    P_NAME_EN IN VARCHAR2,
    P_NAME_CN IN VARCHAR2,
    P_CREATED_BY IN VARCHAR2,
    P_CREATED_DATE IN DATE,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_CLASS_UPDATE
(
    P_ID IN NUMBER,
    P_CODE IN VARCHAR2,
    P_NAME_VI IN VARCHAR2,
    P_NAME_EN IN VARCHAR2,
    P_NAME_CN IN VARCHAR2,
    P_MODIFIED_BY IN VARCHAR2,
    P_MODIFIED_DATE IN DATE,
    P_RETURN OUT NUMBER
);


PROCEDURE PROC_CLASS_DELETE
(
    P_ID IN NUMBER,
    P_MODIFIED_BY IN VARCHAR2,
    P_MODIFIED_DATE IN DATE,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_APP_CLASS_SEARCH
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT TCURSOR
);


PROCEDURE PROC_APP_CLASS_GET_BY_ID
(
    P_ID IN NUMBER,
    P_CURSOR OUT TCURSOR
);

PROCEDURE PROC_APP_CLASS_GET_MEMORY
(
     P_CURSOR OUT TCURSOR
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_class
IS

PROCEDURE PROC_CLASS_ADD
(
    P_CODE IN VARCHAR2,
    P_NAME_VI IN VARCHAR2,
    P_NAME_EN IN VARCHAR2,
    P_NAME_CN IN VARCHAR2,
    P_CREATED_BY IN VARCHAR2,
    P_CREATED_DATE IN DATE,
    P_RETURN OUT NUMBER
)
IS
    V_ID NUMBER;
    V_COUNT NUMBER;
BEGIN
    P_RETURN := 0 ;

    SELECT COUNT(0) INTO V_COUNT FROM APP_CLASS_INFO A WHERE UPPER(A.CODE) = UPPER(P_CODE) AND DELETED = 0;

    IF V_COUNT > 0 THEN
        P_RETURN := -2;
        RETURN;
    END IF;

    SELECT SEQ_APP_CLASS_INFO.NEXTVAL INTO V_ID FROM DUAL;

    INSERT INTO APP_CLASS_INFO (ID, CODE, NAME_VI, NAME_EN, NAME_CN, CREATED_BY, CREATED_DATE)
    VALUES( V_ID, P_CODE,  P_NAME_VI, P_NAME_EN, P_NAME_CN,  P_CREATED_BY, P_CREATED_DATE);
    P_RETURN:= V_ID;
    COMMIT;

EXCEPTION
WHEN OTHERS THEN
    P_RETURN:= -99 ;
    RAISE;
    ROLLBACK;
END;




PROCEDURE PROC_CLASS_UPDATE
(
P_ID IN NUMBER,
P_CODE IN VARCHAR2,
P_NAME_VI IN VARCHAR2,
P_NAME_EN IN VARCHAR2,
P_NAME_CN IN VARCHAR2,
P_MODIFIED_BY IN VARCHAR2,
P_MODIFIED_DATE IN DATE,
P_RETURN OUT NUMBER
)
IS

V_COUNT NUMBER;
BEGIN
P_RETURN := 0 ;

SELECT COUNT(0) INTO V_COUNT FROM APP_CLASS_INFO A WHERE UPPER(A.CODE) = UPPER(P_CODE) AND DELETED = 0 AND ID <> P_ID;

IF V_COUNT > 0 THEN
P_RETURN := -2;
RETURN;
END IF;

UPDATE  APP_CLASS_INFO SET CODE = P_CODE, NAME_VI = P_NAME_VI, NAME_EN = P_NAME_EN, NAME_CN =  P_NAME_CN,
  MODIFIED_BY = P_MODIFIED_BY, MODIFIED_DATE = P_MODIFIED_DATE WHERE ID = P_ID;
 COMMIT;


EXCEPTION
WHEN OTHERS THEN
P_RETURN:= -99;
RAISE;
ROLLBACK;
END;



PROCEDURE PROC_CLASS_DELETE
(
P_ID IN NUMBER,
P_MODIFIED_BY IN VARCHAR2,
P_MODIFIED_DATE IN DATE,
P_RETURN OUT NUMBER
)
IS

V_COUNT NUMBER;
BEGIN
P_RETURN := 0 ;

UPDATE  APP_CLASS_INFO SET DELETED = 1,
  MODIFIED_BY = P_MODIFIED_BY, MODIFIED_DATE = P_MODIFIED_DATE WHERE ID = P_ID;
 COMMIT;


EXCEPTION
WHEN OTHERS THEN
P_RETURN:= -99 ;
RAISE;
ROLLBACK;
END;



PROCEDURE PROC_APP_CLASS_SEARCH
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT TCURSOR
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_SQL_TOTAL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT NUMBER  ;

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_CLASS_CODE VARCHAR2(100) DEFAULT 'ALL';
    V_CLASS_NAME_VI VARCHAR2(100) DEFAULT 'ALL';
    V_CLASS_NAME_EN VARCHAR2(100) DEFAULT 'ALL';
    V_CLASS_NAME_CN VARCHAR2(100) DEFAULT 'ALL';


    V_FROM NUMBER ;
    V_TO NUMBER;
BEGIN
    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_CLASS_CODE := ITEM.CONDITION;
        END IF;
         IF V_INDEX = 1 THEN
            V_CLASS_NAME_VI := ITEM.CONDITION;
        END IF;
         IF V_INDEX = 2 THEN
            V_CLASS_NAME_EN := ITEM.CONDITION;
        END IF;
         IF V_INDEX = 3 THEN
            V_CLASS_NAME_CN := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;

    IF V_CLASS_CODE <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.CODE) LIKE ''%' || UPPER(V_CLASS_CODE) || '%'' ';
    END IF;
    IF V_CLASS_NAME_VI <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.NAME_VI) LIKE ''%' || UPPER(V_CLASS_NAME_VI) || '%'' ';
    END IF;
    IF V_CLASS_NAME_EN <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.NAME_EN) LIKE ''%' || UPPER(V_CLASS_NAME_EN) || '%'' ';
    END IF;
    IF V_CLASS_NAME_CN <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.NAME_CN) LIKE ''%' || UPPER(V_CLASS_NAME_CN) || '%'' ';
    END IF;


    V_SQL := 'SELECT * FROM APP_CLASS_INFO A WHERE NVL(DELETED,0) = 0  ';

    V_SQL :=  V_SQL || V_CONDITION;

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || ' ORDER BY ' || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.MODIFIED_BY DESC';
    END IF;

   -- DBMS_OUTPUT.PUT_LINE(V_SQL);
    --PKG_LOG.LOGMSG(V_SQL);

    V_SQL_TOTAL := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_SQL_TOTAL INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;
    --PKG_LOG.LOGMSG(V_SQL);


    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;



PROCEDURE PROC_APP_CLASS_GET_BY_ID
(
    P_ID IN NUMBER,
    P_CURSOR OUT TCURSOR
)
IS
 BEGIN
  OPEN P_CURSOR FOR SELECT * FROM APP_CLASS_INFO WHERE ID = P_ID;
 EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE PROC_APP_CLASS_GET_MEMORY
(
     P_CURSOR OUT TCURSOR
)
IS
 BEGIN
  OPEN P_CURSOR FOR SELECT code , name_en,name_vi, code || name_vi AS DisplayValue, UPPER(code || name_en || name_vi) AS KeySearch,
    NVL( SUBSTR(CODE, 0, 2), '') AS GroupCode
   FROM APP_CLASS_INFO ORDER BY NAME_VI;
 EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_CLASS

-- Start of DDL Script for Package LEGALTECH.PKG_APP_DDSHCN
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_ddshcn
  IS
PROCEDURE PROC_APPDDSHCN_GETALL
(   P_NAME  IN VARCHAR2 ,
    P_PHONE IN VARCHAR2 ,
    P_START IN NUMBER ,
    P_END IN NUMBER ,
    P_CURSOR OUT PKG_COMMON.T_CURSOR ,
    P_RECORD OUT NUMBER
);

PROCEDURE PROC_APP_DDSHCN_INSERT
(

    P_NAME_VI IN APP_DDSHCN.NAME_VI % TYPE,
    P_ADDRESS_VI IN APP_DDSHCN.ADDRESS_VI % TYPE,
    P_NAME_EN IN APP_DDSHCN.NAME_EN % TYPE,
    P_ADDRESS_EN IN APP_DDSHCN.ADDRESS_EN % TYPE,
    P_PHONE IN APP_DDSHCN.PHONE % TYPE,
    P_FAX IN APP_DDSHCN.FAX % TYPE,
    P_EMAIL IN APP_DDSHCN.EMAIL % TYPE,
    P_CREATEDDATE IN APP_DDSHCN.CREATEDDATE % TYPE,
    P_CREATEDBY IN APP_DDSHCN.CREATEDBY % TYPE,
    P_NGUOIDDSH IN VARCHAR2 ,
    P_MANGUOIDAIDIEN IN VARCHAR2 ,
    P_RETURN OUT NUMBER

);

PROCEDURE PROC_APP_DDSHCN_UPDATE
(
    P_ID IN NUMBER ,
    P_NAME_VI IN APP_DDSHCN.NAME_VI % TYPE,
    P_ADDRESS_VI IN APP_DDSHCN.ADDRESS_VI % TYPE,
    P_NAME_EN IN APP_DDSHCN.NAME_EN % TYPE,
    P_ADDRESS_EN IN APP_DDSHCN.ADDRESS_EN % TYPE,
    P_PHONE IN APP_DDSHCN.PHONE % TYPE,
    P_FAX IN APP_DDSHCN.FAX % TYPE,
    P_EMAIL IN APP_DDSHCN.EMAIL % TYPE,
    P_MODIFIEDDATE IN APP_DDSHCN.MODIFIEDDATE % TYPE,
    P_MODIFIEDBY IN APP_DDSHCN.MODIFIEDBY % TYPE,
    P_NGUOIDDSH IN VARCHAR2 ,
    P_MANGUOIDAIDIEN IN VARCHAR2 ,
    P_RETURN OUT NUMBER

);


PROCEDURE PROC_APP_DDSHCN_DELETED
(
    P_ID IN  NUMBER ,
    P_MODIFY_BY IN VARCHAR2 ,
    P_MODIFY_DATE IN DATE ,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_APPDDSHCN_GETBYID
(
    P_ID IN  NUMBER ,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_ddshcn
IS

PROCEDURE PROC_APPDDSHCN_GETALL
(
    P_NAME  IN VARCHAR2 ,
    P_PHONE IN VARCHAR2 ,
    P_START IN NUMBER ,
    P_END IN NUMBER ,
    P_CURSOR OUT PKG_COMMON.T_CURSOR ,
    P_RECORD OUT NUMBER
)
IS
    V_CONDITION VARCHAR2(1000);
    V_SQL VARCHAR2(4000);
    V_TOTALSQL VARCHAR2(2000) ;

       V_FROM NUMBER ;
    V_TO NUMBER;
BEGIN

    IF P_NAME IS NOT NULL  THEN
        V_CONDITION := V_CONDITION || ' AND UPPER( NAME_VI ) LIKE  ''%' || UPPER( P_NAME) || '%''';
    END IF;

    IF P_PHONE IS NOT NULL  THEN
        V_CONDITION := V_CONDITION || ' AND  PHONE LIKE  ''%' ||  P_PHONE  || '%'' OR  FAX LIKE  ''%' || P_PHONE  || '%''' ;
    END IF;

    V_SQL := 'SELECT * FROM APP_DDSHCN T WHERE T.DELETED=0  ';

    V_SQL :=  V_SQL || V_CONDITION;

    V_TOTALSQL:= 'SELECT COUNT(*) FROM APP_DDSHCN T WHERE T.DELETED=0  ';

    V_TOTALSQL:=  V_TOTALSQL || V_CONDITION;

    EXECUTE IMMEDIATE V_TOTALSQL INTO P_RECORD;

    V_FROM := P_START ;
    V_TO := P_END;

     IF P_START = '0' AND P_END = '0' THEN
        V_FROM := '1' ;
        V_TO := P_RECORD;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || '  ORDER BY   T.ID DESC ' || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;

END;




PROCEDURE PROC_APP_DDSHCN_INSERT
(

    P_NAME_VI IN APP_DDSHCN.NAME_VI % TYPE,
    P_ADDRESS_VI IN APP_DDSHCN.ADDRESS_VI % TYPE,
    P_NAME_EN IN APP_DDSHCN.NAME_EN % TYPE,
    P_ADDRESS_EN IN APP_DDSHCN.ADDRESS_EN % TYPE,
    P_PHONE IN APP_DDSHCN.PHONE % TYPE,
    P_FAX IN APP_DDSHCN.FAX % TYPE,
    P_EMAIL IN APP_DDSHCN.EMAIL % TYPE,
    P_CREATEDDATE IN APP_DDSHCN.CREATEDDATE % TYPE,
    P_CREATEDBY IN APP_DDSHCN.CREATEDBY % TYPE,
    P_NGUOIDDSH IN VARCHAR2 ,
    P_MANGUOIDAIDIEN IN VARCHAR2 ,
    P_RETURN OUT NUMBER

)
IS
 V_ID NUMBER;
BEGIN
SELECT SEQ_APP_DDSHCN.NEXTVAL INTO V_ID FROM DUAL;
    INSERT INTO APP_DDSHCN
    (
     ID, NAME_VI, ADDRESS_VI, NAME_EN, ADDRESS_EN, PHONE, FAX, EMAIL, CREATEDDATE, CREATEDBY,  DELETED, NGUOIDDSH ,MANGUOIDAIDIEN
    )
    VALUES
    (
     V_ID, P_NAME_VI, P_ADDRESS_VI, P_NAME_EN, P_ADDRESS_EN, P_PHONE, P_FAX, P_EMAIL, TRUNC(P_CREATEDDATE), P_CREATEDBY, 0 , P_NGUOIDDSH,P_MANGUOIDAIDIEN
    );

    P_RETURN := V_ID;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    P_RETURN := -1;
    RAISE;
END;




PROCEDURE PROC_APP_DDSHCN_UPDATE
(
    P_ID IN NUMBER ,
    P_NAME_VI IN APP_DDSHCN.NAME_VI % TYPE,
    P_ADDRESS_VI IN APP_DDSHCN.ADDRESS_VI % TYPE,
    P_NAME_EN IN APP_DDSHCN.NAME_EN % TYPE,
    P_ADDRESS_EN IN APP_DDSHCN.ADDRESS_EN % TYPE,
    P_PHONE IN APP_DDSHCN.PHONE % TYPE,
    P_FAX IN APP_DDSHCN.FAX % TYPE,
    P_EMAIL IN APP_DDSHCN.EMAIL % TYPE,
    P_MODIFIEDDATE IN APP_DDSHCN.MODIFIEDDATE % TYPE,
    P_MODIFIEDBY IN APP_DDSHCN.MODIFIEDBY % TYPE,
    P_NGUOIDDSH IN VARCHAR2 ,
    P_MANGUOIDAIDIEN IN VARCHAR2 ,
    P_RETURN OUT NUMBER

)
IS

BEGIN
 UPDATE APP_DDSHCN SET    NAME_VI = P_NAME_VI,
    ADDRESS_VI = P_ADDRESS_VI,  NAME_EN = P_NAME_EN,
    ADDRESS_EN = P_ADDRESS_EN, PHONE = P_PHONE,
    FAX = P_FAX,  EMAIL = P_EMAIL,
    MODIFIEDDATE = TRUNC(P_MODIFIEDDATE), MODIFIEDBY = P_MODIFIEDBY ,
    NGUOIDDSH =P_NGUOIDDSH ,MANGUOIDAIDIEN  =P_MANGUOIDAIDIEN
    WHERE ID = P_ID;
    P_RETURN := P_ID;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    P_RETURN := -1;
    RAISE;
END;



PROCEDURE PROC_APP_DDSHCN_DELETED
(
    P_ID IN  NUMBER ,
    P_MODIFY_BY IN VARCHAR2 ,
    P_MODIFY_DATE IN DATE ,
    P_RETURN OUT NUMBER
)
IS
BEGIN
    UPDATE APP_DDSHCN SET DELETED = 1, MODIFIEDBY = P_MODIFY_BY,  MODIFIEDDATE = TRUNC(P_MODIFY_DATE) WHERE ID = P_ID;
    P_RETURN := P_ID;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    P_RETURN := -1;
    RAISE;
END;


PROCEDURE PROC_APPDDSHCN_GETBYID
(
    P_ID IN  NUMBER ,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
BEGIN
    OPEN   P_CURSOR FOR  SELECT  * FROM APP_DDSHCN WHERE DELETED =0 AND ID =P_ID ;


EXCEPTION
WHEN OTHERS THEN

    RAISE;
END;

   -- ENTER FURTHER CODE BELOW AS SPECIFIED IN THE PACKAGE SPEC.
END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_DDSHCN

-- Start of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_01
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_detail_01
  IS

PROCEDURE PROC_APP_DETAIL_01_INSERT
(

    P_APP_HEADER_ID IN APP_DETAIL_01.APP_HEADER_ID % TYPE,
    P_APPCODE IN APP_DETAIL_01.APPCODE % TYPE,
    P_REQUEST IN APP_DETAIL_01.REQUEST % TYPE,
    P_CORRECT_REQUEST IN APP_DETAIL_01.CORRECT_REQUEST % TYPE,
    P_CORRECT_REQUEST_TO IN APP_DETAIL_01.CORRECT_REQUEST_TO % TYPE,
    P_LANGUAGE_CODE IN APP_DETAIL_01.LANGUAGE_CODE % TYPE,
    P_APPNO IN APP_DETAIL_01.APPNO % TYPE,
    P_SOCHUNGTU_NOPTHEO IN APP_DETAIL_01.SOCHUNGTU_NOPTHEO % TYPE ,
    P_RETURN OUT NUMBER
);


PROCEDURE PROC_APP_DETAIL_01_UPDATE
(
    P_ID IN APP_DETAIL_01.ID % TYPE,
    P_APP_HEADER_ID IN APP_DETAIL_01.APP_HEADER_ID % TYPE,
    P_APPCODE IN APP_DETAIL_01.APPCODE % TYPE,
    P_REQUEST IN APP_DETAIL_01.REQUEST % TYPE,
    P_CORRECT_REQUEST IN APP_DETAIL_01.CORRECT_REQUEST % TYPE,
    P_CORRECT_REQUEST_TO IN APP_DETAIL_01.CORRECT_REQUEST_TO % TYPE,
    P_LANGUAGE_CODE IN APP_DETAIL_01.LANGUAGE_CODE % TYPE,
    P_APPNO IN APP_DETAIL_01.APPNO % TYPE,
    P_SOCHUNGTU_NOPTHEO IN APP_DETAIL_01.SOCHUNGTU_NOPTHEO % TYPE,
    P_RETURN OUT NUMBER
);


PROCEDURE PROC_APP_DETAIL_01_DELETED
(
    P_ID IN APP_DETAIL_01.ID % TYPE,
    P_LANGUAGE_CODE IN APP_DETAIL_01.LANGUAGE_CODE % TYPE,
    P_RETURN OUT NUMBER
);



END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_detail_01
IS



PROCEDURE PROC_APP_DETAIL_01_INSERT
(

    P_APP_HEADER_ID IN APP_DETAIL_01.APP_HEADER_ID % TYPE,
    P_APPCODE IN APP_DETAIL_01.APPCODE % TYPE,
    P_REQUEST IN APP_DETAIL_01.REQUEST % TYPE,
    P_CORRECT_REQUEST IN APP_DETAIL_01.CORRECT_REQUEST % TYPE,
    P_CORRECT_REQUEST_TO IN APP_DETAIL_01.CORRECT_REQUEST_TO % TYPE,
    P_LANGUAGE_CODE IN APP_DETAIL_01.LANGUAGE_CODE % TYPE,
    P_APPNO IN APP_DETAIL_01.APPNO % TYPE,
    P_SOCHUNGTU_NOPTHEO IN APP_DETAIL_01.SOCHUNGTU_NOPTHEO % TYPE ,
    P_RETURN OUT NUMBER
)
IS
 V_ID NUMBER DEFAULT 0 ;
BEGIN
    P_RETURN:= 0 ;
    SELECT SEQ_APP_DETAIL_01.NEXTVAL INTO V_ID FROM DUAL;

    INSERT INTO APP_DETAIL_01
    (
        ID, APP_HEADER_ID, APPCODE, REQUEST, CORRECT_REQUEST, CORRECT_REQUEST_TO, LANGUAGE_CODE, APPNO, SOCHUNGTU_NOPTHEO    )
    VALUES
    (
        V_ID, P_APP_HEADER_ID, P_APPCODE, P_REQUEST, P_CORRECT_REQUEST, P_CORRECT_REQUEST_TO, P_LANGUAGE_CODE, P_APPNO,
        P_SOCHUNGTU_NOPTHEO);


COMMIT;
EXCEPTION
WHEN OTHERS THEN
RAISE;
  P_RETURN:= -99 ;
END;




PROCEDURE PROC_APP_DETAIL_01_UPDATE
(
    P_ID IN APP_DETAIL_01.ID % TYPE,
    P_APP_HEADER_ID IN APP_DETAIL_01.APP_HEADER_ID % TYPE,
    P_APPCODE IN APP_DETAIL_01.APPCODE % TYPE,
    P_REQUEST IN APP_DETAIL_01.REQUEST % TYPE,
    P_CORRECT_REQUEST IN APP_DETAIL_01.CORRECT_REQUEST % TYPE,
    P_CORRECT_REQUEST_TO IN APP_DETAIL_01.CORRECT_REQUEST_TO % TYPE,
    P_LANGUAGE_CODE IN APP_DETAIL_01.LANGUAGE_CODE % TYPE,
    P_APPNO IN APP_DETAIL_01.APPNO % TYPE,
    P_SOCHUNGTU_NOPTHEO IN APP_DETAIL_01.SOCHUNGTU_NOPTHEO % TYPE,
    P_RETURN OUT NUMBER
)
IS
BEGIN
   P_RETURN:= 0 ;
    UPDATE APP_DETAIL_01 SET   APP_HEADER_ID = P_APP_HEADER_ID,
    REQUEST = P_REQUEST,   CORRECT_REQUEST = P_CORRECT_REQUEST,  CORRECT_REQUEST_TO = P_CORRECT_REQUEST_TO,    APPNO = P_APPNO,
    SOCHUNGTU_NOPTHEO = P_SOCHUNGTU_NOPTHEO    WHERE  ID = P_ID AND  LANGUAGE_CODE = P_LANGUAGE_CODE ;
    COMMIT;
EXCEPTION    WHEN OTHERS THEN
    ROLLBACK;
    RAISE;
    P_RETURN:= -99;
END;




PROCEDURE PROC_APP_DETAIL_01_DELETED
(
    P_ID IN APP_DETAIL_01.ID % TYPE,
    P_LANGUAGE_CODE IN APP_DETAIL_01.LANGUAGE_CODE % TYPE,
    P_RETURN OUT NUMBER
)
IS
BEGIN
   P_RETURN:= 0;

EXCEPTION    WHEN OTHERS THEN
    ROLLBACK;
    RAISE;
    P_RETURN:= -99 ;
END;




--2END


   -- ENTER FURTHER CODE BELOW AS SPECIFIED IN THE PACKAGE SPEC.
END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_01

-- Start of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_04NH
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_detail_04nh
  IS
 PROCEDURE PROC_APP_DETAIL_04NH_INSERT
(
     P_APP_HEADER_ID IN NUMBER ,
    P_APPCODE IN VARCHAR2 ,
    P_LANGUAGE_CODE IN VARCHAR2,
    P_APPNO IN VARCHAR2,
    P_DUADATE IN DATE ,
    P_LOGOURL IN VARCHAR2,
    P_DACTICHHANGHOA IN NUMBER ,
    P_COLOR IN VARCHAR2,
    P_DESCRIPTION IN VARCHAR2,
    P_HUONGQUYENUUTIEN IN VARCHAR2,
    P_SODON_UT IN VARCHAR2,
    P_NGAYNOPDON_UT IN  DATE ,
    P_NUOCNOPDON_UT IN VARCHAR2,
    P_NGUONGOCDIALY IN VARCHAR2,
    P_CHATLUONG IN VARCHAR2,
    P_DACTINHKHAC IN VARCHAR2,
    P_CDK_NAME_1 IN VARCHAR2,
    P_CDK_ADDRESS_1 IN VARCHAR2,
    P_CDK_PHONE_1 IN VARCHAR2,
    P_CDK_FAX_1 IN VARCHAR2,
    P_CDK_EMAIL_1 IN VARCHAR2,
    P_CDK_NAME_2 IN VARCHAR2,
    P_CDK_ADDRESS_2 IN VARCHAR2,
    P_CDK_PHONE_2 IN VARCHAR2,
    P_CDK_FAX_2 IN VARCHAR2,
    P_CDK_EMAIL_2 IN VARCHAR2,
    P_CDK_NAME_3 IN VARCHAR2,
    P_CDK_ADDRESS_3 IN VARCHAR2,
    P_CDK_PHONE_3 IN VARCHAR2,
    P_CDK_FAX_3 IN VARCHAR2,
    P_CDK_EMAIL_3 IN VARCHAR2,
    P_CDK_NAME_4 IN VARCHAR2,
    P_CDK_ADDRESS_4 IN VARCHAR2,
    P_CDK_PHONE_4 IN VARCHAR2,
    P_CDK_FAX_4 IN VARCHAR2,
    P_CDK_EMAIL_4 IN VARCHAR2,
    P_USED_SPECIAL IN NUMBER  ,
    P_LOAINHANHIEU IN VARCHAR2 ,
    P_CODELOGO IN VARCHAR2 ,
    P_SODON_UT2 IN VARCHAR2 ,
    P_NGAYNOPDON_UT2 IN DATE ,
    P_NUOCNOPDON_UT2 IN VARCHAR2 ,
    P_HUONGQUYENUUTIEN2 IN VARCHAR2 ,
    P_YCCAPPHO1 IN VARCHAR2 ,
    P_YCCAPPHO2 IN VARCHAR2 ,
    P_YCCAPPHO3 IN VARCHAR2 ,
    P_YCCAPPHO4 IN VARCHAR2 ,
    P_THOATHUANKHAC IN VARCHAR2 ,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_APP_DETAIL_04NH_UPDATE
(
    P_ID IN   NUMBER ,
     P_APP_HEADER_ID IN NUMBER,
    P_APPCODE IN VARCHAR2 ,
    P_LANGUAGE_CODE IN VARCHAR2,
    P_APPNO IN VARCHAR2,
    P_DUADATE IN DATE ,
    P_LOGOURL IN VARCHAR2,
    P_DACTICHHANGHOA IN NUMBER ,
    P_COLOR IN VARCHAR2,
    P_DESCRIPTION IN VARCHAR2,
    P_HUONGQUYENUUTIEN IN VARCHAR2,
    P_SODON_UT IN VARCHAR2,
    P_NGAYNOPDON_UT IN date,
    P_NUOCNOPDON_UT IN VARCHAR2,
    P_NGUONGOCDIALY IN VARCHAR2,
    P_CHATLUONG IN VARCHAR2,
    P_DACTINHKHAC IN VARCHAR2,
    P_CDK_NAME_1 IN VARCHAR2,
    P_CDK_ADDRESS_1 IN VARCHAR2,
    P_CDK_PHONE_1 IN VARCHAR2,
    P_CDK_FAX_1 IN VARCHAR2,
    P_CDK_EMAIL_1 IN VARCHAR2,
    P_CDK_NAME_2 IN VARCHAR2,
    P_CDK_ADDRESS_2 IN VARCHAR2,
    P_CDK_PHONE_2 IN VARCHAR2,
    P_CDK_FAX_2 IN VARCHAR2,
    P_CDK_EMAIL_2 IN VARCHAR2,
    P_CDK_NAME_3 IN VARCHAR2,
    P_CDK_ADDRESS_3 IN VARCHAR2,
    P_CDK_PHONE_3 IN VARCHAR2,
    P_CDK_FAX_3 IN VARCHAR2,
    P_CDK_EMAIL_3 IN VARCHAR2,
    P_CDK_NAME_4 IN VARCHAR2,
    P_CDK_ADDRESS_4 IN VARCHAR2,
    P_CDK_PHONE_4 IN VARCHAR2,
    P_CDK_FAX_4 IN VARCHAR2,
    P_CDK_EMAIL_4 IN VARCHAR2,
    P_USED_SPECIAL IN VARCHAR2 ,
    P_LOAINHANHIEU IN VARCHAR2 ,
    P_CODELOGO IN VARCHAR2 ,
    P_SODON_UT2 IN VARCHAR2 ,
    P_NGAYNOPDON_UT2 IN DATE ,
    P_NUOCNOPDON_UT2 IN VARCHAR2 ,
    P_HUONGQUYENUUTIEN2 IN VARCHAR2 ,
    P_YCCAPPHO1 IN VARCHAR2 ,
    P_YCCAPPHO2 IN VARCHAR2 ,
    P_YCCAPPHO3 IN VARCHAR2 ,
    P_YCCAPPHO4 IN VARCHAR2 ,
    P_THOATHUANKHAC IN VARCHAR2 ,
    P_RETURN OUT NUMBER
);



PROCEDURE PROC_APP_DETAIL_04NH_DELETE (

    P_APP_HEADER_ID IN APP_DETAIL_04NH.APP_HEADER_ID % TYPE,
    P_APPCODE IN APP_DETAIL_04NH.APPCODE % TYPE,
    P_LANGUAGE_CODE IN APP_DETAIL_04NH.LANGUAGE_CODE % TYPE,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_APP_04NH_SEARCH
(
 P_STATUS IN VARCHAR2,
 P_LANGUAGECODE IN VARCHAR2,
 P_CURSOR OUT PKG_COMMON.T_CURSOR
);
END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_detail_04nh
IS

PROCEDURE PROC_APP_DETAIL_04NH_INSERT
(
    P_APP_HEADER_ID IN NUMBER ,
    P_APPCODE IN VARCHAR2 ,
    P_LANGUAGE_CODE IN VARCHAR2,
    P_APPNO IN VARCHAR2,
    P_DUADATE IN DATE ,
    P_LOGOURL IN VARCHAR2,
    P_DACTICHHANGHOA IN NUMBER ,
    P_COLOR IN VARCHAR2,
    P_DESCRIPTION IN VARCHAR2,
    P_HUONGQUYENUUTIEN IN VARCHAR2,
    P_SODON_UT IN VARCHAR2,
    P_NGAYNOPDON_UT IN  DATE ,
    P_NUOCNOPDON_UT IN VARCHAR2,
    P_NGUONGOCDIALY IN VARCHAR2,
    P_CHATLUONG IN VARCHAR2,
    P_DACTINHKHAC IN VARCHAR2,
    P_CDK_NAME_1 IN VARCHAR2,
    P_CDK_ADDRESS_1 IN VARCHAR2,
    P_CDK_PHONE_1 IN VARCHAR2,
    P_CDK_FAX_1 IN VARCHAR2,
    P_CDK_EMAIL_1 IN VARCHAR2,
    P_CDK_NAME_2 IN VARCHAR2,
    P_CDK_ADDRESS_2 IN VARCHAR2,
    P_CDK_PHONE_2 IN VARCHAR2,
    P_CDK_FAX_2 IN VARCHAR2,
    P_CDK_EMAIL_2 IN VARCHAR2,
    P_CDK_NAME_3 IN VARCHAR2,
    P_CDK_ADDRESS_3 IN VARCHAR2,
    P_CDK_PHONE_3 IN VARCHAR2,
    P_CDK_FAX_3 IN VARCHAR2,
    P_CDK_EMAIL_3 IN VARCHAR2,
    P_CDK_NAME_4 IN VARCHAR2,
    P_CDK_ADDRESS_4 IN VARCHAR2,
    P_CDK_PHONE_4 IN VARCHAR2,
    P_CDK_FAX_4 IN VARCHAR2,
    P_CDK_EMAIL_4 IN VARCHAR2,
    P_USED_SPECIAL IN NUMBER  ,
    P_LOAINHANHIEU IN VARCHAR2 ,
    P_CODELOGO IN VARCHAR2 ,
    P_SODON_UT2 IN VARCHAR2 ,
    P_NGAYNOPDON_UT2 IN DATE ,
    P_NUOCNOPDON_UT2 IN VARCHAR2 ,
    P_HUONGQUYENUUTIEN2 IN VARCHAR2 ,
    P_YCCAPPHO1 IN VARCHAR2 ,
    P_YCCAPPHO2 IN VARCHAR2 ,
    P_YCCAPPHO3 IN VARCHAR2 ,
    P_YCCAPPHO4 IN VARCHAR2 ,
    P_THOATHUANKHAC IN VARCHAR2 ,
    P_RETURN OUT NUMBER
)
IS
V_ID NUMBER  ;

BEGIN

    P_RETURN:= 0 ;
    SELECT SEQ_APP_DETAIL_01.NEXTVAL INTO V_ID FROM DUAL;

    INSERT INTO APP_DETAIL_04NH
    (
            ID, APP_HEADER_ID, APPCODE,  LANGUAGE_CODE, APPNO, DUADATE, LOGOURL, DACTICHHANGHOA,
            COLOR, DESCRIPTION, HUONGQUYENUUTIEN, SODON_UT, NGAYNOPDON_UT, NUOCNOPDON_UT, NGUONGOCDIALY, CHATLUONG,
            DACTINHKHAC, CDK_NAME_1, CDK_ADDRESS_1, CDK_PHONE_1, CDK_FAX_1, CDK_EMAIL_1, CDK_NAME_2, CDK_ADDRESS_2,
            CDK_PHONE_2, CDK_FAX_2, CDK_EMAIL_2, CDK_NAME_3, CDK_ADDRESS_3, CDK_PHONE_3, CDK_FAX_3, CDK_EMAIL_3,
            CDK_NAME_4, CDK_ADDRESS_4, CDK_PHONE_4, CDK_FAX_4, CDK_EMAIL_4, USED_SPECIAL ,
            LOAINHANHIEU, CODELOGO ,SODON_UT2 ,NGAYNOPDON_UT2,NUOCNOPDON_UT2,HUONGQUYENUUTIEN2 ,YCCAPPHO1,YCCAPPHO2,YCCAPPHO3,YCCAPPHO4 ,
            THOATHUANKHAC
    )
    VALUES
    (
        V_ID, P_APP_HEADER_ID, P_APPCODE, P_LANGUAGE_CODE, P_APPNO, TRUNC(P_DUADATE), P_LOGOURL, P_DACTICHHANGHOA,
        P_COLOR, P_DESCRIPTION, P_HUONGQUYENUUTIEN, P_SODON_UT, TRUNC(P_NGAYNOPDON_UT), P_NUOCNOPDON_UT, P_NGUONGOCDIALY, P_CHATLUONG,
        P_DACTINHKHAC, P_CDK_NAME_1, P_CDK_ADDRESS_1, P_CDK_PHONE_1, P_CDK_FAX_1, P_CDK_EMAIL_1, P_CDK_NAME_2, P_CDK_ADDRESS_2,
        P_CDK_PHONE_2, P_CDK_FAX_2, P_CDK_EMAIL_2, P_CDK_NAME_3, P_CDK_ADDRESS_3, P_CDK_PHONE_3, P_CDK_FAX_3, P_CDK_EMAIL_3,
        P_CDK_NAME_4, P_CDK_ADDRESS_4, P_CDK_PHONE_4, P_CDK_FAX_4, P_CDK_EMAIL_4, P_USED_SPECIAL ,
        P_LOAINHANHIEU , P_CODELOGO ,P_SODON_UT2 ,P_NGAYNOPDON_UT2,P_NUOCNOPDON_UT2,P_HUONGQUYENUUTIEN2 ,P_YCCAPPHO1,P_YCCAPPHO2,
        P_YCCAPPHO3,P_YCCAPPHO4 ,P_THOATHUANKHAC
    );

--COMMIT; KHONG COMMIT DANG DUNG TRACSACTION
EXCEPTION WHEN OTHERS THEN

  P_RETURN:= -99 ;
  RAISE;
END;




PROCEDURE PROC_APP_DETAIL_04NH_UPDATE
(
    P_ID IN   NUMBER ,
    P_APP_HEADER_ID IN NUMBER,
    P_APPCODE IN VARCHAR2 ,
    P_LANGUAGE_CODE IN VARCHAR2,
    P_APPNO IN VARCHAR2,
    P_DUADATE IN DATE ,
    P_LOGOURL IN VARCHAR2,
    P_DACTICHHANGHOA IN NUMBER ,
    P_COLOR IN VARCHAR2,
    P_DESCRIPTION IN VARCHAR2,
    P_HUONGQUYENUUTIEN IN VARCHAR2,
    P_SODON_UT IN VARCHAR2,
    P_NGAYNOPDON_UT IN date,
    P_NUOCNOPDON_UT IN VARCHAR2,
    P_NGUONGOCDIALY IN VARCHAR2,
    P_CHATLUONG IN VARCHAR2,
    P_DACTINHKHAC IN VARCHAR2,
    P_CDK_NAME_1 IN VARCHAR2,
    P_CDK_ADDRESS_1 IN VARCHAR2,
    P_CDK_PHONE_1 IN VARCHAR2,
    P_CDK_FAX_1 IN VARCHAR2,
    P_CDK_EMAIL_1 IN VARCHAR2,
    P_CDK_NAME_2 IN VARCHAR2,
    P_CDK_ADDRESS_2 IN VARCHAR2,
    P_CDK_PHONE_2 IN VARCHAR2,
    P_CDK_FAX_2 IN VARCHAR2,
    P_CDK_EMAIL_2 IN VARCHAR2,
    P_CDK_NAME_3 IN VARCHAR2,
    P_CDK_ADDRESS_3 IN VARCHAR2,
    P_CDK_PHONE_3 IN VARCHAR2,
    P_CDK_FAX_3 IN VARCHAR2,
    P_CDK_EMAIL_3 IN VARCHAR2,
    P_CDK_NAME_4 IN VARCHAR2,
    P_CDK_ADDRESS_4 IN VARCHAR2,
    P_CDK_PHONE_4 IN VARCHAR2,
    P_CDK_FAX_4 IN VARCHAR2,
    P_CDK_EMAIL_4 IN VARCHAR2,
    P_USED_SPECIAL IN VARCHAR2 ,
    P_LOAINHANHIEU IN VARCHAR2 ,
    P_CODELOGO IN VARCHAR2 ,
    P_SODON_UT2 IN VARCHAR2 ,
    P_NGAYNOPDON_UT2 IN DATE ,
    P_NUOCNOPDON_UT2 IN VARCHAR2 ,
    P_HUONGQUYENUUTIEN2 IN VARCHAR2 ,
    P_YCCAPPHO1 IN VARCHAR2 ,
    P_YCCAPPHO2 IN VARCHAR2 ,
    P_YCCAPPHO3 IN VARCHAR2 ,
    P_YCCAPPHO4 IN VARCHAR2 ,
    P_THOATHUANKHAC IN VARCHAR2 ,
    P_RETURN OUT NUMBER
)
IS
BEGIN
    P_RETURN:= 0;
    UPDATE APP_DETAIL_04NH SET
    APPNO = P_APPNO,   DUADATE = TRUNC(P_DUADATE), LOGOURL = P_LOGOURL,
    DACTICHHANGHOA = P_DACTICHHANGHOA,   COLOR = P_COLOR,
    DESCRIPTION = P_DESCRIPTION,   HUONGQUYENUUTIEN = P_HUONGQUYENUUTIEN,  SODON_UT = P_SODON_UT,
    NGAYNOPDON_UT = TRUNC(P_NGAYNOPDON_UT), NUOCNOPDON_UT = P_NUOCNOPDON_UT,
    NGUONGOCDIALY = P_NGUONGOCDIALY,   CHATLUONG = P_CHATLUONG,
    DACTINHKHAC = P_DACTINHKHAC,  CDK_NAME_1 = P_CDK_NAME_1,
    CDK_ADDRESS_1 = P_CDK_ADDRESS_1,   CDK_PHONE_1 = P_CDK_PHONE_1,
    CDK_FAX_1 = P_CDK_FAX_1,  CDK_EMAIL_1 = P_CDK_EMAIL_1,
    CDK_NAME_2 = P_CDK_NAME_2,   CDK_ADDRESS_2 = P_CDK_ADDRESS_2,
    CDK_PHONE_2 = P_CDK_PHONE_2,  CDK_FAX_2 = P_CDK_FAX_2,
    CDK_EMAIL_2 = P_CDK_EMAIL_2,  CDK_NAME_3 = P_CDK_NAME_3,
    CDK_ADDRESS_3 = P_CDK_ADDRESS_3,  CDK_PHONE_3 = P_CDK_PHONE_3,
    CDK_FAX_3 = P_CDK_FAX_3,  CDK_EMAIL_3 = P_CDK_EMAIL_3,
    CDK_NAME_4 = P_CDK_NAME_4,  CDK_ADDRESS_4 = P_CDK_ADDRESS_4,
    CDK_PHONE_4 = P_CDK_PHONE_4,   CDK_FAX_4 = P_CDK_FAX_4,
    CDK_EMAIL_4 = P_CDK_EMAIL_4,  USED_SPECIAL = P_USED_SPECIAL ,
    LOAINHANHIEU =P_LOAINHANHIEU ,
    CODELOGO =  P_CODELOGO ,
    SODON_UT2= P_SODON_UT2 ,
    NGAYNOPDON_UT2= P_NGAYNOPDON_UT2  ,
    NUOCNOPDON_UT2=  P_NUOCNOPDON_UT2  ,
    HUONGQUYENUUTIEN2=  P_HUONGQUYENUUTIEN2,
    YCCAPPHO1 =P_YCCAPPHO1,YCCAPPHO2 =P_YCCAPPHO2,
    YCCAPPHO3=P_YCCAPPHO3,YCCAPPHO4=P_YCCAPPHO4 ,THOATHUANKHAC= P_THOATHUANKHAC

    WHERE APP_HEADER_ID = P_APP_HEADER_ID;
--COMMIT; KHONG COMMIT DANG DUNG TRACSACTION
EXCEPTION WHEN OTHERS THEN

  DBMS_OUTPUT.PUT_LINE(SQLERRM);
  P_RETURN:= -99;
  RAISE;
END;


PROCEDURE PROC_APP_DETAIL_04NH_DELETE (

    P_APP_HEADER_ID IN APP_DETAIL_04NH.APP_HEADER_ID % TYPE,
    P_APPCODE IN APP_DETAIL_04NH.APPCODE % TYPE,
    P_LANGUAGE_CODE IN APP_DETAIL_04NH.LANGUAGE_CODE % TYPE,
    P_RETURN OUT NUMBER
)
IS
BEGIN
 P_RETURN:= 0;
 DELETE  APP_DETAIL_04NH WHERE   APP_HEADER_ID = P_APP_HEADER_ID AND  APPCODE = P_APPCODE AND LANGUAGE_CODE = P_LANGUAGE_CODE ;

EXCEPTION WHEN OTHERS THEN
RAISE;
  P_RETURN:= -99;
END  ;


PROCEDURE PROC_APP_04NH_SEARCH
(
 P_STATUS IN VARCHAR2,
 P_LANGUAGECODE IN VARCHAR2,
 P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
BEGIN
   OPEN P_CURSOR FOR SELECT A.* FROM APP_DETAIL_04NH A INNER JOIN APPLICATION_HEADER B ON A.APP_HEADER_ID = B.ID
   WHERE B.DELETED = 0 AND B.STATUS = TO_NUMBER(P_STATUS)
     AND A.LANGUAGE_CODE  = P_LANGUAGECODE;
EXCEPTION WHEN OTHERS THEN
RAISE;
END;


   -- ENTER FURTHER CODE BELOW AS SPECIFIED IN THE PACKAGE SPEC.
END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_04NH

-- Start of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_PLB01_SDD
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_detail_plb01_sdd
  IS TYPE tcursor IS ref CURSOR;


PROCEDURE Proc_GetBy_ID
(
    p_app_header_id IN number,
    p_language_code IN app_detail_plb01_sdd.language_code % TYPE,
    p_cursor OUT tcursor,
    p_cursorHeader OUT tcursor,
    p_cursor_doc OUT tcursor,
    p_cursor_fee OUT tcursor
);

PROCEDURE Proc_Plb01_Sdd_Insert
(
    p_app_header_id IN app_detail_plb01_sdd.app_header_id % TYPE,
    p_appcode IN app_detail_plb01_sdd.appcode % TYPE,
    p_language_code IN app_detail_plb01_sdd.language_code % TYPE,
    p_request_change_type IN app_detail_plb01_sdd.request_change_type % TYPE,
    p_app_no_change IN app_detail_plb01_sdd.app_no_change % TYPE,
    p_request_to_type IN app_detail_plb01_sdd.request_to_type % TYPE,
    p_request_to_content IN app_detail_plb01_sdd.request_to_content % TYPE,
    p_number_pic IN NUMBER,
    p_number_page IN NUMBER,
    p_return OUT NUMBER
);

PROCEDURE Proc_Plb01_Sdd_Update
(
    p_id IN app_detail_plb01_sdd.DETAIL_ID % TYPE,
    p_app_header_id IN app_detail_plb01_sdd.app_header_id % TYPE,
    p_appcode IN app_detail_plb01_sdd.appcode % TYPE,
    p_language_code IN app_detail_plb01_sdd.language_code % TYPE,
    p_request_change_type IN app_detail_plb01_sdd.request_change_type % TYPE,
    p_app_no_change IN app_detail_plb01_sdd.app_no_change % TYPE,
    p_request_to_type IN app_detail_plb01_sdd.request_to_type % TYPE,
    p_request_to_content IN app_detail_plb01_sdd.request_to_content % TYPE,
    p_number_pic IN NUMBER,
    p_number_page IN NUMBER,
    p_return OUT NUMBER
);

PROCEDURE Proc_Plb01_Sdd_Delete
(
    p_app_header_id IN app_detail_plb01_sdd.app_header_id % TYPE,
    p_appcode IN app_detail_plb01_sdd.appcode % TYPE,
    p_language_code IN app_detail_plb01_sdd.language_code % TYPE,
    p_return OUT number
);
END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_detail_plb01_sdd
IS

PROCEDURE Proc_GetBy_ID
(
    p_app_header_id IN number,
    p_language_code IN app_detail_plb01_sdd.language_code % TYPE,
    p_cursor OUT tcursor,
    p_cursorHeader OUT tcursor,
    p_cursor_doc OUT tcursor,
    p_cursor_fee OUT tcursor
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;

    OPEN p_cursor FOR
    SELECT d.*,ah.* FROM APP_DETAIL_PLB01_SDD d
    JOIN APPLICATION_HEADER ah ON ah.case_code = d.case_code AND ah.LANGUAGUE_CODE = d.language_code AND ah.deleted = 0
    AND ah.case_code = v_case_code ;

    OPEN p_cursorHeader FOR
    SELECT * FROM VIEW_APP_HEADER WHERE id = p_app_header_id;

    --LAY DANH SACH CAC TAI LIEU DINH KEM
    OPEN p_cursor_doc FOR
    SELECT * FROM APP_DOCUMENT A  WHERE app_header_id = p_app_header_id  ORDER BY id;

    OPEN p_cursor_fee FOR
    SELECT * FROM APP_FEE_FIX  WHERE case_code = v_case_code ;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE Proc_Plb01_Sdd_Insert
(
    p_app_header_id IN app_detail_plb01_sdd.app_header_id % TYPE,
    p_appcode IN app_detail_plb01_sdd.appcode % TYPE,
    p_language_code IN app_detail_plb01_sdd.language_code % TYPE,
    p_request_change_type IN app_detail_plb01_sdd.request_change_type % TYPE,
    p_app_no_change IN app_detail_plb01_sdd.app_no_change % TYPE,
    p_request_to_type IN app_detail_plb01_sdd.request_to_type % TYPE,
    p_request_to_content IN app_detail_plb01_sdd.request_to_content % TYPE,
    p_number_pic IN NUMBER,
    p_number_page IN NUMBER,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = p_app_header_id;


    SELECT SEQ_PLB01_SDD.NEXTVAL INTO v_id FROM dual;
    INSERT INTO app_detail_plb01_sdd
    (
        DETAIL_ID, appcode, request_change_type, app_no_change, request_to_type,
        request_to_content, language_code,number_pic,number_page,case_code
    )
    VALUES
    (
        v_id, p_appcode, p_request_change_type, p_app_no_change, p_request_to_type,
        p_request_to_content, p_language_code,p_number_pic,p_number_page,v_case_code
    );

    p_return := 1;

--COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := PKG_COMMON.ERROR;
    RAISE;
END;

PROCEDURE Proc_Plb01_Sdd_Update
(
    p_id IN app_detail_plb01_sdd.DETAIL_ID % TYPE,
    p_app_header_id IN app_detail_plb01_sdd.app_header_id % TYPE,
    p_appcode IN app_detail_plb01_sdd.appcode % TYPE,
    p_language_code IN app_detail_plb01_sdd.language_code % TYPE,
    p_request_change_type IN app_detail_plb01_sdd.request_change_type % TYPE,
    p_app_no_change IN app_detail_plb01_sdd.app_no_change % TYPE,
    p_request_to_type IN app_detail_plb01_sdd.request_to_type % TYPE,
    p_request_to_content IN app_detail_plb01_sdd.request_to_content % TYPE,
    p_number_pic IN NUMBER,
    p_number_page IN NUMBER,
    p_return OUT NUMBER
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = p_app_header_id;
    UPDATE app_detail_plb01_sdd SET
        --app_header_id = p_app_header_id,
        --appcode = p_appcode,
        language_code = p_language_code,
        request_change_type = p_request_change_type,
        app_no_change = p_app_no_change,
        request_to_type = p_request_to_type,
        request_to_content = p_request_to_content,
        number_pic = p_number_pic,
        number_page = p_number_page

    WHERE case_code = v_case_code ;--AND language_code = p_language_code;

    p_return :=p_app_header_id;

--COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := PKG_COMMON.ERROR;
    RAISE;
END;

PROCEDURE Proc_Plb01_Sdd_Delete
(
    p_app_header_id IN app_detail_plb01_sdd.app_header_id % TYPE,
    p_appcode IN app_detail_plb01_sdd.appcode % TYPE,
    p_language_code IN app_detail_plb01_sdd.language_code % TYPE,
    p_return OUT number
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;

    DELETE app_detail_plb01_sdd
    WHERE case_code = v_case_code AND APPCODE = P_APPCODE ; --AND LANGUAGE_CODE = P_LANGUAGE_CODE;

    p_return:= 1;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := PKG_COMMON.ERROR;
    RAISE;
END  ;



END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_PLB01_SDD

-- Start of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_PLB02_CGD
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_detail_plb02_cgd
  IS TYPE tcursor IS ref CURSOR;

PROCEDURE Proc_GetById
(
    p_app_header_id IN NUMBER,
    p_language_code IN VARCHAR2,
    p_cursor OUT tcursor,
    p_cursorHeader OUT tcursor,
    p_cursor_doc OUT tcursor,
    p_cursor_fee OUT tcursor
);

PROCEDURE Proc_Insert
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_master_type IN NUMBER,
    p_second_name IN VARCHAR ,
    p_second_address IN VARCHAR ,
    p_second_phone IN VARCHAR ,
    p_second_fax IN VARCHAR ,
    p_second_email IN VARCHAR ,

    p_customer_code IN VARCHAR2,

    p_transfer_type IN NUMBER,
    p_transfer_appno IN VARCHAR,
    p_return OUT NUMBER
);


PROCEDURE Proc_Update
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,

    p_master_type IN NUMBER,
    p_second_name IN VARCHAR ,
    p_second_address IN VARCHAR ,
    p_second_phone IN VARCHAR ,
    p_second_fax IN VARCHAR ,
    p_second_email IN VARCHAR ,

    p_customer_code IN VARCHAR2,

    p_transfer_type IN NUMBER,
    p_transfer_appno IN VARCHAR,
    p_return OUT NUMBER
);

PROCEDURE Proc_Delete
(

    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_return OUT number
);
END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_detail_plb02_cgd
IS

PROCEDURE Proc_GetById
(
    p_app_header_id IN NUMBER,
    p_language_code IN VARCHAR2,
    p_cursor OUT tcursor,
    p_cursorHeader OUT tcursor,
    p_cursor_doc OUT tcursor,
    p_cursor_fee OUT tcursor
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;

    OPEN p_cursor FOR
    SELECT d.*,ah.* FROM APP_DETAIL_PLB02_CGD d
    JOIN APPLICATION_HEADER ah ON ah.id = d.app_header_id AND ah.LANGUAGUE_CODE = d.language_code AND ah.deleted = 0 AND ah.id = p_app_header_id;

    OPEN p_cursorHeader FOR
    SELECT * FROM VIEW_APP_HEADER WHERE id = p_app_header_id;

    --LAY DANH SACH CAC TAI LIEU DINH KEM
    OPEN p_cursor_doc FOR
    SELECT * FROM APP_DOCUMENT A  WHERE app_header_id = p_app_header_id ORDER BY id;
    OPEN p_cursor_fee FOR
    SELECT * FROM APP_FEE_FIX WHERE case_code = v_case_code ;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE Proc_Insert
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_master_type IN NUMBER,
    p_second_name IN VARCHAR ,
    p_second_address IN VARCHAR ,
    p_second_phone IN VARCHAR ,
    p_second_fax IN VARCHAR ,
    p_second_email IN VARCHAR ,

    p_customer_code IN VARCHAR2,

    p_transfer_type IN NUMBER,
    p_transfer_appno IN VARCHAR,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;


    SELECT SEQ_PLB02_CGD.NEXTVAL INTO v_id FROM dual;
    INSERT INTO APP_DETAIL_PLB02_CGD
    (
        detail_id, app_header_id, appcode,language_code, master_type,
        second_name, second_address, second_phone, second_fax,
        second_email, transfer_type, transfer_appno,customer_code,case_code

    )
    VALUES
    (
        v_id, p_app_header_id, p_appcode,p_language_code, p_master_type,
        p_second_name, p_second_address, p_second_phone, p_second_fax,
        p_second_email, p_transfer_type, p_transfer_appno,p_customer_code, v_case_code
    );

    p_return := 1;

--COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := PKG_COMMON.ERROR;
    RAISE;
END;

PROCEDURE Proc_Update
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,

    p_master_type IN NUMBER,
    p_second_name IN VARCHAR ,
    p_second_address IN VARCHAR ,
    p_second_phone IN VARCHAR ,
    p_second_fax IN VARCHAR ,
    p_second_email IN VARCHAR ,

    p_customer_code IN VARCHAR2,

    p_transfer_type IN NUMBER,
    p_transfer_appno IN VARCHAR,
    p_return OUT NUMBER
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;
    UPDATE APP_DETAIL_PLB02_CGD SET
        master_type = p_master_type,
        second_name = p_second_name,
        second_address = p_second_address,
        second_phone = p_second_phone,
        second_fax = p_second_fax,
        second_email = p_second_email,
        transfer_type = p_transfer_type,
        transfer_appno = p_transfer_appno,
        customer_code = p_customer_code

    WHERE case_code = v_case_code AND language_code = p_language_code;

    p_return := p_app_header_id;

--COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := PKG_COMMON.ERROR;
    RAISE;
END;

PROCEDURE Proc_Delete
(

    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_return OUT number
)
IS
  v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;

    DELETE APP_DETAIL_PLB02_CGD
    WHERE case_code = v_case_code AND APPCODE = P_APPCODE AND LANGUAGE_CODE = P_LANGUAGE_CODE;

    p_return:= 1;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := PKG_COMMON.ERROR;
    RAISE;
END  ;



END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_PLB02_CGD

-- Start of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_PLC05_KN
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_detail_plc05_kn
  IS TYPE tcursor IS ref CURSOR;

PROCEDURE Proc_GetById
(
    p_app_header_id IN NUMBER,
    p_language_code IN VARCHAR2,
    p_cursor OUT tcursor,
    p_cursorHeader OUT tcursor,
    p_cursor_doc OUT tcursor,
    p_cursor_fee OUT tcursor
);

PROCEDURE Proc_Insert
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_customer_code IN VARCHAR2,

    p_times IN app_detail_plc05_kn.times % TYPE,
    p_appeal_type IN app_detail_plc05_kn.appeal_type % TYPE,
    p_appeal_number IN app_detail_plc05_kn.appeal_number % TYPE,
    p_appeal_date IN app_detail_plc05_kn.appeal_date % TYPE,
    p_appeal_appno IN app_detail_plc05_kn.appeal_appno % TYPE,
    p_appeal_degree IN app_detail_plc05_kn.appeal_degree % TYPE,
    p_return OUT NUMBER
);


PROCEDURE Proc_Update
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_customer_code IN VARCHAR2,

    p_times IN app_detail_plc05_kn.times % TYPE,
    p_appeal_type IN app_detail_plc05_kn.appeal_type % TYPE,
    p_appeal_number IN app_detail_plc05_kn.appeal_number % TYPE,
    p_appeal_date IN app_detail_plc05_kn.appeal_date % TYPE,
    p_appeal_appno IN app_detail_plc05_kn.appeal_appno % TYPE,
    p_appeal_degree IN app_detail_plc05_kn.appeal_degree % TYPE,

    p_return OUT NUMBER
);

PROCEDURE Proc_Delete
(

    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_return OUT number
);
END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_detail_plc05_kn
IS

PROCEDURE Proc_GetById
(
    p_app_header_id IN NUMBER,
    p_language_code IN VARCHAR2,
    p_cursor OUT tcursor,
    p_cursorHeader OUT tcursor,
    p_cursor_doc OUT tcursor,
    p_cursor_fee OUT tcursor
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;

    OPEN p_cursor FOR
    SELECT d.*,ah.* FROM APP_DETAIL_PLC05_KN d
    JOIN APPLICATION_HEADER ah ON ah.id = d.app_header_id AND ah.LANGUAGUE_CODE = d.language_code AND ah.deleted = 0 AND ah.id = p_app_header_id;

    OPEN p_cursorHeader FOR
    SELECT * FROM VIEW_APP_HEADER WHERE id = p_app_header_id;

    --LAY DANH SACH CAC TAI LIEU DINH KEM
    OPEN p_cursor_doc FOR
    SELECT * FROM APP_DOCUMENT A  WHERE app_header_id = p_app_header_id  ORDER BY id;

    OPEN p_cursor_fee FOR
    SELECT * FROM APP_FEE_FIX  WHERE case_code = v_case_code ;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE Proc_Insert
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_customer_code IN VARCHAR2,

    p_times IN app_detail_plc05_kn.times % TYPE,
    p_appeal_type IN app_detail_plc05_kn.appeal_type % TYPE,
    p_appeal_number IN app_detail_plc05_kn.appeal_number % TYPE,
    p_appeal_date IN app_detail_plc05_kn.appeal_date % TYPE,
    p_appeal_appno IN app_detail_plc05_kn.appeal_appno % TYPE,
    p_appeal_degree IN app_detail_plc05_kn.appeal_degree % TYPE,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;


    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;
    SELECT SEQ_PLC05_KN.NEXTVAL INTO v_id FROM dual;
    INSERT INTO APP_DETAIL_PLC05_KN
    (
        detail_id, app_header_id, appcode, language_code, times, appeal_type,
        appeal_number, appeal_date, appeal_appno, appeal_degree, customer_code,case_code

    )
    VALUES
    (
        v_id, p_app_header_id, p_appcode, p_language_code, p_times, p_appeal_type,
        p_appeal_number, p_appeal_date, p_appeal_appno, p_appeal_degree, p_customer_code,v_case_code
    );

    p_return := 1;

--COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := PKG_COMMON.ERROR;
    RAISE;
END;

PROCEDURE Proc_Update
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_customer_code IN VARCHAR2,

    p_times IN app_detail_plc05_kn.times % TYPE,
    p_appeal_type IN app_detail_plc05_kn.appeal_type % TYPE,
    p_appeal_number IN app_detail_plc05_kn.appeal_number % TYPE,
    p_appeal_date IN app_detail_plc05_kn.appeal_date % TYPE,
    p_appeal_appno IN app_detail_plc05_kn.appeal_appno % TYPE,
    p_appeal_degree IN app_detail_plc05_kn.appeal_degree % TYPE,

    p_return OUT NUMBER
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;

    UPDATE APP_DETAIL_PLC05_KN SET
        times = p_times,
        appeal_type = p_appeal_type,
        appeal_number = p_appeal_number,
        appeal_date = p_appeal_date,
        appeal_appno = p_appeal_appno,
        appeal_degree = p_appeal_degree,
        customer_code = p_customer_code

    WHERE case_code = v_case_code AND language_code = p_language_code;

    p_return := 1;

--COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := PKG_COMMON.ERROR;
    RAISE;
END;

PROCEDURE Proc_Delete
(

    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_return OUT number
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;


    DELETE APP_DETAIL_PLC05_KN
    WHERE case_code = v_case_code AND APPCODE = P_APPCODE AND LANGUAGE_CODE = P_LANGUAGE_CODE;

    p_return:= 1;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := PKG_COMMON.ERROR;
    RAISE;
END  ;



END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_PLC05_KN

-- Start of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_PLD01_CHDCN
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_detail_pld01_chdcn
  IS TYPE tcursor IS ref CURSOR;

PROCEDURE Proc_GetById
(
    p_app_header_id IN NUMBER,
    p_language_code IN VARCHAR2,
    p_cursor OUT tcursor,
    p_cursorHeader OUT tcursor,
    p_cursor_doc OUT tcursor,
    p_cursor_fee OUT tcursor
);

PROCEDURE Proc_Insert
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_master_type IN NUMBER,
    p_second_name IN VARCHAR ,
    p_second_address IN VARCHAR ,
    p_second_phone IN VARCHAR ,
    p_second_fax IN VARCHAR ,
    p_second_email IN VARCHAR ,

    p_customer_code IN VARCHAR2,

    p_object_contract_type IN NUMBER,
    p_object_contract_no IN VARCHAR,
    p_return OUT NUMBER
);


PROCEDURE Proc_Update
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,

    p_master_type IN NUMBER,
    p_second_name IN VARCHAR ,
    p_second_address IN VARCHAR ,
    p_second_phone IN VARCHAR ,
    p_second_fax IN VARCHAR ,
    p_second_email IN VARCHAR ,

    p_customer_code IN VARCHAR2,

    p_object_contract_type IN NUMBER,
    p_object_contract_no IN VARCHAR,
    p_return OUT NUMBER
);

PROCEDURE Proc_Delete
(

    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_return OUT number
);
END;
/



-- End of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_PLD01_CHDCN

-- Start of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_PLD01_HDCN
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_detail_pld01_hdcn
  IS TYPE tcursor IS ref CURSOR;

PROCEDURE Proc_GetById
(
    p_app_header_id IN NUMBER,
    p_language_code IN VARCHAR2,
    p_cursor OUT tcursor,
    p_cursorHeader OUT tcursor,
    p_cursor_doc OUT tcursor,
    p_cursor_fee OUT tcursor
);

PROCEDURE Proc_Insert
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_master_type IN NUMBER,
    p_second_name IN VARCHAR ,
    p_second_address IN VARCHAR ,
    p_second_phone IN VARCHAR ,
    p_second_fax IN VARCHAR ,
    p_second_email IN VARCHAR ,

    p_customer_code IN VARCHAR2,

    p_object_contract_type IN NUMBER,
    p_object_contract_no IN VARCHAR,
    p_return OUT NUMBER
);


PROCEDURE Proc_Update
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,

    p_master_type IN NUMBER,
    p_second_name IN VARCHAR ,
    p_second_address IN VARCHAR ,
    p_second_phone IN VARCHAR ,
    p_second_fax IN VARCHAR ,
    p_second_email IN VARCHAR ,

    p_customer_code IN VARCHAR2,

    p_object_contract_type IN NUMBER,
    p_object_contract_no IN VARCHAR,
    p_return OUT NUMBER
);

PROCEDURE Proc_Delete
(

    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_return OUT number
);
END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_detail_pld01_hdcn
IS

PROCEDURE Proc_GetById
(
    p_app_header_id IN NUMBER,
    p_language_code IN VARCHAR2,
    p_cursor OUT tcursor,
    p_cursorHeader OUT tcursor,
    p_cursor_doc OUT tcursor,
    p_cursor_fee OUT tcursor
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;

    OPEN p_cursor FOR
    SELECT d.*,ah.* FROM app_detail_plD01_hdcn d
    JOIN APPLICATION_HEADER ah ON ah.id = d.app_header_id AND ah.LANGUAGUE_CODE = d.language_code AND ah.deleted = 0 AND ah.id = p_app_header_id;

    OPEN p_cursorHeader FOR
    SELECT * FROM VIEW_APP_HEADER WHERE id = p_app_header_id;

    --LAY DANH SACH CAC TAI LIEU DINH KEM
    OPEN p_cursor_doc FOR
    SELECT * FROM APP_DOCUMENT A  WHERE app_header_id = p_app_header_id
    --AND  language_code = p_language_code ;
    ORDER BY id;

    OPEN p_cursor_fee FOR
    SELECT * FROM APP_FEE_FIX  WHERE case_code = v_case_code ORDER BY id;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE Proc_Insert
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_master_type IN NUMBER,
    p_second_name IN VARCHAR ,
    p_second_address IN VARCHAR ,
    p_second_phone IN VARCHAR ,
    p_second_fax IN VARCHAR ,
    p_second_email IN VARCHAR ,

    p_customer_code IN VARCHAR2,

    p_object_contract_type IN NUMBER,
    p_object_contract_no IN VARCHAR,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;


    SELECT SEQ_PLD01_HDCN.NEXTVAL INTO v_id FROM dual;
    INSERT INTO APP_DETAIL_PLD01_HDCN
    (
        detail_id, app_header_id, appcode,language_code, master_type,
        second_name, second_address, second_phone, second_fax,
        second_email, object_contract_type, object_contract_no,customer_code,case_code

    )
    VALUES
    (
        v_id, p_app_header_id, p_appcode,p_language_code, p_master_type,
        p_second_name, p_second_address, p_second_phone, p_second_fax,
        p_second_email, p_object_contract_type, p_object_contract_no,p_customer_code,v_case_code
    );

    p_return := 1;

--COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := PKG_COMMON.ERROR;
    RAISE;
END;

PROCEDURE Proc_Update
(
    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,

    p_master_type IN NUMBER,
    p_second_name IN VARCHAR ,
    p_second_address IN VARCHAR ,
    p_second_phone IN VARCHAR ,
    p_second_fax IN VARCHAR ,
    p_second_email IN VARCHAR ,

    p_customer_code IN VARCHAR2,

    p_object_contract_type IN NUMBER,
    p_object_contract_no IN VARCHAR,
    p_return OUT NUMBER
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;
    UPDATE APP_DETAIL_PLD01_HDCN SET
        master_type = p_master_type,
        second_name = p_second_name,
        second_address = p_second_address,
        second_phone = p_second_phone,
        second_fax = p_second_fax,
        second_email = p_second_email,
        object_contract_type = p_object_contract_type,
        object_contract_no = p_object_contract_no,
        customer_code = p_customer_code

    WHERE case_code = v_case_code AND language_code = p_language_code;

    p_return := p_app_header_id;

--COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := PKG_COMMON.ERROR;
    RAISE;
END;

PROCEDURE Proc_Delete
(

    p_app_header_id IN NUMBER,
    p_appcode IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_return OUT number
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;

    DELETE APP_DETAIL_PLD01_HDCN
    WHERE case_code = v_case_code AND APPCODE = P_APPCODE AND LANGUAGE_CODE = P_LANGUAGE_CODE;

    p_return:= P_APP_HEADER_ID;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := PKG_COMMON.ERROR;
    RAISE;
END  ;



END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_PLD01_HDCN

-- Start of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_TM06DKQT
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_detail_tm06dkqt
  IS
  PROCEDURE PROC_TM06DKQT_INSERT
(
    P_APPCODE IN APP_DETAIL_TM06DKQT.APPCODE % TYPE,
    P_APP_HEADER_ID IN APP_DETAIL_TM06DKQT.APP_HEADER_ID % TYPE,
    P_LANGUAGE IN APP_DETAIL_TM06DKQT.LANGUAGE % TYPE,
    P_APPNO IN APP_DETAIL_TM06DKQT.APPNO % TYPE,
    P_THANHVIEN_ND_TC IN APP_DETAIL_TM06DKQT.THANHVIEN_ND_TC % TYPE,
    P_LOGOURL IN APP_DETAIL_TM06DKQT.LOGOURL % TYPE,
    P_DON_GIAY_DKNHCS IN APP_DETAIL_TM06DKQT.DON_GIAY_DKNHCS % TYPE,
    P_REF_APPNO IN APP_DETAIL_TM06DKQT.REF_APPNO % TYPE,
    P_COUNTRY_ID01 IN APP_DETAIL_TM06DKQT.COUNTRY_ID01 % TYPE,
    P_COUNTRY_ID02 IN APP_DETAIL_TM06DKQT.COUNTRY_ID02 % TYPE,
    P_COUNTRY_ID03 IN APP_DETAIL_TM06DKQT.COUNTRY_ID03 % TYPE,
    P_COUNTRY_ID04 IN APP_DETAIL_TM06DKQT.COUNTRY_ID04 % TYPE,
    P_COUNTRY_ID05 IN APP_DETAIL_TM06DKQT.COUNTRY_ID05 % TYPE,
    P_COUNTRY_ID06 IN APP_DETAIL_TM06DKQT.COUNTRY_ID06 % TYPE,
    P_COUNTRY_ID07 IN APP_DETAIL_TM06DKQT.COUNTRY_ID07 % TYPE,
    P_COUNTRY_ID08 IN APP_DETAIL_TM06DKQT.COUNTRY_ID08 % TYPE,
    P_LEPHI IN APP_DETAIL_TM06DKQT.LEPHI % TYPE,
    P_PAGE_REMAIN IN APP_DETAIL_TM06DKQT.PAGE_REMAIN % TYPE,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_TM06DKQT_UPDATE
(
P_ID IN APP_DETAIL_TM06DKQT.ID % TYPE,
P_APPCODE IN APP_DETAIL_TM06DKQT.APPCODE % TYPE,
P_APP_HEADER_ID IN APP_DETAIL_TM06DKQT.APP_HEADER_ID % TYPE,
P_LANGUAGE IN APP_DETAIL_TM06DKQT.LANGUAGE % TYPE,
P_APPNO IN APP_DETAIL_TM06DKQT.APPNO % TYPE,
P_THANHVIEN_ND_TC IN APP_DETAIL_TM06DKQT.THANHVIEN_ND_TC % TYPE,
P_LOGOURL IN APP_DETAIL_TM06DKQT.LOGOURL % TYPE,
P_DON_GIAY_DKNHCS IN APP_DETAIL_TM06DKQT.DON_GIAY_DKNHCS % TYPE,
P_REF_APPNO IN APP_DETAIL_TM06DKQT.REF_APPNO % TYPE,
P_COUNTRY_ID01 IN APP_DETAIL_TM06DKQT.COUNTRY_ID01 % TYPE,
P_COUNTRY_ID02 IN APP_DETAIL_TM06DKQT.COUNTRY_ID02 % TYPE,
P_COUNTRY_ID03 IN APP_DETAIL_TM06DKQT.COUNTRY_ID03 % TYPE,
P_COUNTRY_ID04 IN APP_DETAIL_TM06DKQT.COUNTRY_ID04 % TYPE,
P_COUNTRY_ID05 IN APP_DETAIL_TM06DKQT.COUNTRY_ID05 % TYPE,
P_COUNTRY_ID06 IN APP_DETAIL_TM06DKQT.COUNTRY_ID06 % TYPE,
P_COUNTRY_ID07 IN APP_DETAIL_TM06DKQT.COUNTRY_ID07 % TYPE,
P_COUNTRY_ID08 IN APP_DETAIL_TM06DKQT.COUNTRY_ID08 % TYPE,
P_LEPHI IN APP_DETAIL_TM06DKQT.LEPHI % TYPE,
P_PAGE_REMAIN IN APP_DETAIL_TM06DKQT.PAGE_REMAIN % TYPE,
P_RETURN OUT NUMBER
);
END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_detail_tm06dkqt
IS
 PROCEDURE PROC_TM06DKQT_INSERT
(
    P_APPCODE IN APP_DETAIL_TM06DKQT.APPCODE % TYPE,
    P_APP_HEADER_ID IN APP_DETAIL_TM06DKQT.APP_HEADER_ID % TYPE,
    P_LANGUAGE IN APP_DETAIL_TM06DKQT.LANGUAGE % TYPE,
    P_APPNO IN APP_DETAIL_TM06DKQT.APPNO % TYPE,
    P_THANHVIEN_ND_TC IN APP_DETAIL_TM06DKQT.THANHVIEN_ND_TC % TYPE,
    P_LOGOURL IN APP_DETAIL_TM06DKQT.LOGOURL % TYPE,
    P_DON_GIAY_DKNHCS IN APP_DETAIL_TM06DKQT.DON_GIAY_DKNHCS % TYPE,
    P_REF_APPNO IN APP_DETAIL_TM06DKQT.REF_APPNO % TYPE,
    P_COUNTRY_ID01 IN APP_DETAIL_TM06DKQT.COUNTRY_ID01 % TYPE,
    P_COUNTRY_ID02 IN APP_DETAIL_TM06DKQT.COUNTRY_ID02 % TYPE,
    P_COUNTRY_ID03 IN APP_DETAIL_TM06DKQT.COUNTRY_ID03 % TYPE,
    P_COUNTRY_ID04 IN APP_DETAIL_TM06DKQT.COUNTRY_ID04 % TYPE,
    P_COUNTRY_ID05 IN APP_DETAIL_TM06DKQT.COUNTRY_ID05 % TYPE,
    P_COUNTRY_ID06 IN APP_DETAIL_TM06DKQT.COUNTRY_ID06 % TYPE,
    P_COUNTRY_ID07 IN APP_DETAIL_TM06DKQT.COUNTRY_ID07 % TYPE,
    P_COUNTRY_ID08 IN APP_DETAIL_TM06DKQT.COUNTRY_ID08 % TYPE,
    P_LEPHI IN APP_DETAIL_TM06DKQT.LEPHI % TYPE,
    P_PAGE_REMAIN IN APP_DETAIL_TM06DKQT.PAGE_REMAIN % TYPE,
    P_RETURN OUT NUMBER
)
IS
V_ID NUMBER;
BEGIN
    P_RETURN:= 0;
    SELECT SEQ_APP_DETAIL_TM06DKQT.NEXTVAL INTO V_ID FROM DUAL;
    INSERT INTO APP_DETAIL_TM06DKQT
    (
      ID, APPCODE, APP_HEADER_ID, LANGUAGE, APPNO, THANHVIEN_ND_TC, LOGOURL,
      DON_GIAY_DKNHCS, REF_APPNO,  COUNTRY_ID01, COUNTRY_ID02,
      COUNTRY_ID03, COUNTRY_ID04, COUNTRY_ID05, COUNTRY_ID06, COUNTRY_ID07,
      COUNTRY_ID08, LEPHI, PAGE_REMAIN   )
    VALUES
    (
    V_ID, P_APPCODE, P_APP_HEADER_ID, P_LANGUAGE, P_APPNO, P_THANHVIEN_ND_TC,
    P_LOGOURL, P_DON_GIAY_DKNHCS, P_REF_APPNO,  P_COUNTRY_ID01,
    P_COUNTRY_ID02, P_COUNTRY_ID03, P_COUNTRY_ID04, P_COUNTRY_ID05, P_COUNTRY_ID06,
    P_COUNTRY_ID07, P_COUNTRY_ID08, P_LEPHI, P_PAGE_REMAIN);

P_RETURN := V_ID;

EXCEPTION
WHEN OTHERS THEN
RAISE;
   P_RETURN := -1;

END;



--2.UPDATE

PROCEDURE PROC_TM06DKQT_UPDATE
(
P_ID IN APP_DETAIL_TM06DKQT.ID % TYPE,
P_APPCODE IN APP_DETAIL_TM06DKQT.APPCODE % TYPE,
P_APP_HEADER_ID IN APP_DETAIL_TM06DKQT.APP_HEADER_ID % TYPE,
P_LANGUAGE IN APP_DETAIL_TM06DKQT.LANGUAGE % TYPE,
P_APPNO IN APP_DETAIL_TM06DKQT.APPNO % TYPE,
P_THANHVIEN_ND_TC IN APP_DETAIL_TM06DKQT.THANHVIEN_ND_TC % TYPE,
P_LOGOURL IN APP_DETAIL_TM06DKQT.LOGOURL % TYPE,
P_DON_GIAY_DKNHCS IN APP_DETAIL_TM06DKQT.DON_GIAY_DKNHCS % TYPE,
P_REF_APPNO IN APP_DETAIL_TM06DKQT.REF_APPNO % TYPE,
P_COUNTRY_ID01 IN APP_DETAIL_TM06DKQT.COUNTRY_ID01 % TYPE,
P_COUNTRY_ID02 IN APP_DETAIL_TM06DKQT.COUNTRY_ID02 % TYPE,
P_COUNTRY_ID03 IN APP_DETAIL_TM06DKQT.COUNTRY_ID03 % TYPE,
P_COUNTRY_ID04 IN APP_DETAIL_TM06DKQT.COUNTRY_ID04 % TYPE,
P_COUNTRY_ID05 IN APP_DETAIL_TM06DKQT.COUNTRY_ID05 % TYPE,
P_COUNTRY_ID06 IN APP_DETAIL_TM06DKQT.COUNTRY_ID06 % TYPE,
P_COUNTRY_ID07 IN APP_DETAIL_TM06DKQT.COUNTRY_ID07 % TYPE,
P_COUNTRY_ID08 IN APP_DETAIL_TM06DKQT.COUNTRY_ID08 % TYPE,
P_LEPHI IN APP_DETAIL_TM06DKQT.LEPHI % TYPE,
P_PAGE_REMAIN IN APP_DETAIL_TM06DKQT.PAGE_REMAIN % TYPE,
P_RETURN OUT NUMBER
)
IS
BEGIN
P_RETURN := 0;
UPDATE APP_DETAIL_TM06DKQT SET
APPCODE = P_APPCODE,
APP_HEADER_ID = P_APP_HEADER_ID,
APPNO = P_APPNO,
THANHVIEN_ND_TC = P_THANHVIEN_ND_TC,
LOGOURL = P_LOGOURL,
DON_GIAY_DKNHCS = P_DON_GIAY_DKNHCS,
REF_APPNO = P_REF_APPNO,
COUNTRY_ID01 = P_COUNTRY_ID01,
COUNTRY_ID02 = P_COUNTRY_ID02,
COUNTRY_ID03 = P_COUNTRY_ID03,
COUNTRY_ID04 = P_COUNTRY_ID04,
COUNTRY_ID05 = P_COUNTRY_ID05,
COUNTRY_ID06 = P_COUNTRY_ID06,
COUNTRY_ID07 = P_COUNTRY_ID07,
COUNTRY_ID08 = P_COUNTRY_ID08,
LEPHI = P_LEPHI,
PAGE_REMAIN = P_PAGE_REMAIN
WHERE APP_HEADER_ID = P_ID AND LANGUAGE = P_LANGUAGE;

P_RETURN :=0;
EXCEPTION
WHEN OTHERS THEN

P_RETURN := -1;
RAISE;
END;


PROCEDURE PROC_TM06DKQT_GETBYID
(
  P_ID IN APP_DETAIL_TM06DKQT.ID % TYPE,
  P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
 BEGIN
OPEN P_CURSOR FOR SELECT APP_DETAIL_TM06DKQT.* FROM APP_DETAIL_TM06DKQT WHERE ID = P_ID;

 EXCEPTION
 WHEN OTHERS THEN
 RAISE;
 ROLLBACK;
 END;
END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_DETAIL_TM06DKQT

-- Start of DDL Script for Package LEGALTECH.PKG_APP_DOC_OTHERS
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_doc_others
  IS
 PROCEDURE PROC_APP_DOC_OTHER_INSERT
(
    P_APP_HEADER_ID IN NUMBER ,
    P_DOCUMENTNAME IN VARCHAR2 ,
    P_FILENAME IN VARCHAR2 ,
    P_LANGUAGE_CODE IN VARCHAR2 ,
    P_IDREF IN NUMBER ,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_APP_DOC_OTHER_DEL_BY_ID
(
    P_ID IN NUMBER ,
    P_LANGUAGE_CODE IN VARCHAR2 ,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_APP_DOC_OTHER_DEL_BY_APP
(
    P_APP_HEADER_ID IN NUMBER ,
    P_LANGUAGE_CODE IN VARCHAR2 ,
    P_RETURN OUT NUMBER
);


END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_doc_others
IS

PROCEDURE PROC_APP_DOC_OTHER_INSERT
(
    P_APP_HEADER_ID IN NUMBER ,
    P_DOCUMENTNAME IN VARCHAR2 ,
    P_FILENAME IN VARCHAR2 ,
    P_LANGUAGE_CODE IN VARCHAR2 ,
    P_IDREF IN NUMBER ,
    P_RETURN OUT NUMBER
)
IS
V_ID NUMBER := 0 ;

BEGIN
    P_RETURN:= 0 ;
    SELECT SEQ_APP_DOC_OTHER.NEXTVAL INTO V_ID FROM DUAL;
    INSERT INTO APP_DOCUMENT_OTHERS ( ID, APP_HEADER_ID, DOCUMENTNAME, FILENAME ,  DELETED ,LANGUAGE_CODE ,IDREF )
    VALUES ( V_ID, P_APP_HEADER_ID, P_DOCUMENTNAME,P_FILENAME ,0,P_LANGUAGE_CODE ,P_IDREF );
--KHONG COMMIT INSERT BATH
EXCEPTION WHEN OTHERS THEN
RAISE;
  P_RETURN:= -99 ;
END;



PROCEDURE PROC_APP_DOC_OTHER_DEL_BY_ID
(
    P_ID IN NUMBER ,
    P_LANGUAGE_CODE IN VARCHAR2 ,
    P_RETURN OUT NUMBER
)
IS

BEGIN

 P_RETURN:= 0 ;
  IF(P_LANGUAGE_CODE = PKG_COMMON.VI_VN)THEN
        DELETE APP_DOCUMENT_OTHERS WHERE  ID = P_ID  ;
        ELSE
        DELETE APP_DOCUMENT_OTHERS WHERE  ID = P_ID AND  LANGUAGE_CODE =P_LANGUAGE_CODE ;
  END IF ;

--KHONG COMMIT INSERT BATH
EXCEPTION WHEN OTHERS THEN
RAISE;
  P_RETURN:= -99 ;
END;



PROCEDURE PROC_APP_DOC_OTHER_DEL_BY_APP
(
    P_APP_HEADER_ID IN NUMBER ,
    P_LANGUAGE_CODE IN VARCHAR2 ,
    P_RETURN OUT NUMBER
)
IS

BEGIN
     P_RETURN:= 0;
     IF(P_LANGUAGE_CODE = PKG_COMMON.VI_VN)THEN
       DELETE APP_DOCUMENT_OTHERS WHERE  APP_HEADER_ID = P_APP_HEADER_ID ;
      ELSE
        DELETE APP_DOCUMENT_OTHERS WHERE  APP_HEADER_ID = P_APP_HEADER_ID AND  LANGUAGE_CODE =P_LANGUAGE_CODE ;
      END IF ;



--KHONG COMMIT INSERT BATH
EXCEPTION WHEN OTHERS THEN
RAISE;
  P_RETURN:= -99 ;
END;
   -- ENTER FURTHER CODE BELOW AS SPECIFIED IN THE PACKAGE SPEC.
END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_DOC_OTHERS

-- Start of DDL Script for Package LEGALTECH.PKG_APP_DOCUMENT
-- Generated 20-Thg2-2019 0:04:32 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_document
  IS

PROCEDURE PROC_APP_DOCUMENT_INSERT
(
    P_LANGUAGE_CODE IN APP_DOCUMENT.LANGUAGE_CODE % TYPE,
    P_APP_HEADER_ID IN APP_DOCUMENT.APP_HEADER_ID % TYPE,
    P_DOCUMENT_ID IN APP_DOCUMENT.DOCUMENT_ID % TYPE,
    P_ISUSE IN APP_DOCUMENT.ISUSE % TYPE,
    P_NOTE IN APP_DOCUMENT.NOTE % TYPE,
    P_STATUS IN APP_DOCUMENT.STATUS % TYPE,
    P_DOCUMENT_FILING_DATE IN APP_DOCUMENT.DOCUMENT_FILING_DATE % TYPE,
    P_FILENAME IN APP_DOCUMENT.FILENAME % TYPE,
    P_URL_HARDCOPY IN APP_DOCUMENT.URL_HARDCOPY % TYPE,
    P_CHAR01 IN APP_DOCUMENT.CHAR01 % TYPE,
    P_CHAR02 IN APP_DOCUMENT.CHAR02 % TYPE,
    P_CHAR03 IN APP_DOCUMENT.CHAR03 % TYPE,
    P_CHAR04 IN APP_DOCUMENT.CHAR04 % TYPE,
    P_CHAR05 IN APP_DOCUMENT.CHAR05 % TYPE ,
    P_RETURN OUT NUMBER
) ;

PROCEDURE PROC_APP_DOCUMENT_DELETE
(
    P_ID IN NUMBER ,
    P_LANGUAGE_CODE IN APP_DOCUMENT.LANGUAGE_CODE % TYPE,
    P_APP_HEADER_ID IN APP_DOCUMENT.APP_HEADER_ID % TYPE,
    P_RETURN OUT NUMBER
);


PROCEDURE Proc_GetBy_App_Header
(
    p_app_header_id IN app_detail_plb01_sdd.app_header_id % TYPE,
    p_language_code IN app_detail_plb01_sdd.language_code % TYPE,
    p_cursor_doc OUT pkg_common.t_cursor
);

PROCEDURE PROC_APP_DOCUMENT_DEL_BY_APP
(
    P_LANGUAGE_CODE IN APP_DOCUMENT.LANGUAGE_CODE % TYPE,
    P_APP_HEADER_ID IN APP_DOCUMENT.APP_HEADER_ID % TYPE,
    P_RETURN OUT NUMBER
);
PROCEDURE PROC_APP_TRANSLATE
(

    P_LANGUAGE_CODE_NEW IN APP_DOCUMENT.LANGUAGE_CODE % TYPE,
    p_app_old_id IN APP_DOCUMENT.APP_HEADER_ID % TYPE,
     --ID BAN GHI TIENG VIET
    P_APP_NEW_ID IN NUMBER  ,
    P_RETURN OUT NUMBER
);
END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_document
IS

PROCEDURE PROC_APP_DOCUMENT_INSERT
(
    P_LANGUAGE_CODE IN APP_DOCUMENT.LANGUAGE_CODE % TYPE,
    P_APP_HEADER_ID IN APP_DOCUMENT.APP_HEADER_ID % TYPE,
    P_DOCUMENT_ID IN APP_DOCUMENT.DOCUMENT_ID % TYPE,
    P_ISUSE IN APP_DOCUMENT.ISUSE % TYPE,
    P_NOTE IN APP_DOCUMENT.NOTE % TYPE,
    P_STATUS IN APP_DOCUMENT.STATUS % TYPE,
    P_DOCUMENT_FILING_DATE IN APP_DOCUMENT.DOCUMENT_FILING_DATE % TYPE,
    P_FILENAME IN APP_DOCUMENT.FILENAME % TYPE,
    P_URL_HARDCOPY IN APP_DOCUMENT.URL_HARDCOPY % TYPE,
    P_CHAR01 IN APP_DOCUMENT.CHAR01 % TYPE,
    P_CHAR02 IN APP_DOCUMENT.CHAR02 % TYPE,
    P_CHAR03 IN APP_DOCUMENT.CHAR03 % TYPE,
    P_CHAR04 IN APP_DOCUMENT.CHAR04 % TYPE,
    P_CHAR05 IN APP_DOCUMENT.CHAR05 % TYPE ,
    P_RETURN OUT NUMBER
)
IS
    V_ID NUMBER ;
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;
    P_RETURN:= 0 ;
    SELECT SEQ_APP_DOCUMENT.NEXTVAL INTO V_ID FROM DUAL;

    INSERT INTO APP_DOCUMENT
    (
        ID, LANGUAGE_CODE,case_code, APP_HEADER_ID, DOCUMENT_ID, ISUSE, NOTE, STATUS, DOCUMENT_FILING_DATE, FILENAME, URL_HARDCOPY,
        CHAR01, CHAR02, CHAR03, CHAR04, CHAR05
    )
    VALUES
    (
         V_ID, P_LANGUAGE_CODE,v_case_code, P_APP_HEADER_ID, P_DOCUMENT_ID, P_ISUSE, P_NOTE, P_STATUS, TRUNC(P_DOCUMENT_FILING_DATE), P_FILENAME,
         P_URL_HARDCOPY, P_CHAR01, P_CHAR02, P_CHAR03, P_CHAR04, P_CHAR05
    );

EXCEPTION WHEN OTHERS THEN
RAISE;
 P_RETURN:=-99;
END;


PROCEDURE PROC_APP_DOCUMENT_DELETE
(
    P_ID IN NUMBER ,
    P_LANGUAGE_CODE IN APP_DOCUMENT.LANGUAGE_CODE % TYPE,
    P_APP_HEADER_ID IN APP_DOCUMENT.APP_HEADER_ID % TYPE,
    P_RETURN OUT NUMBER
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;

    P_RETURN:= 0 ;
    IF(P_LANGUAGE_CODE = PKG_COMMON.VI_VN) THEN
        DELETE  APP_DOCUMENT WHERE  ID = P_ID AND  APP_HEADER_ID = P_APP_HEADER_ID  ;
    ELSE
        DELETE  APP_DOCUMENT WHERE  ID = P_ID AND  APP_HEADER_ID = P_APP_HEADER_ID
             AND LANGUAGE_CODE =P_LANGUAGE_CODE ;
    END IF ;

EXCEPTION WHEN OTHERS THEN
RAISE;
 P_RETURN:= -99 ;
END;




PROCEDURE Proc_GetBy_App_Header
(
    p_app_header_id IN app_detail_plb01_sdd.app_header_id % TYPE,
    p_language_code IN app_detail_plb01_sdd.language_code % TYPE,
    p_cursor_doc OUT  pkg_common.t_cursor
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;
    --LAY DANH SACH CAC TAI LIEU DINH KEM
    OPEN p_cursor_doc FOR
    SELECT * FROM APP_DOCUMENT A  WHERE case_code = v_case_code AND  language_code = p_language_code ;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE PROC_APP_DOCUMENT_DEL_BY_APP
(
    P_LANGUAGE_CODE IN APP_DOCUMENT.LANGUAGE_CODE % TYPE,
    P_APP_HEADER_ID IN APP_DOCUMENT.APP_HEADER_ID % TYPE,
    P_RETURN OUT NUMBER
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;
    DELETE  APP_DOCUMENT WHERE case_code = v_case_code;

    /*IF(P_LANGUAGE_CODE = PKG_COMMON.VI_VN) THEN
        DELETE  APP_DOCUMENT WHERE    APP_HEADER_ID = P_APP_HEADER_ID  ;
    ELSE
        DELETE  APP_DOCUMENT WHERE    APP_HEADER_ID = P_APP_HEADER_ID
             AND LANGUAGE_CODE =P_LANGUAGE_CODE ;
    END IF ;*/

     P_RETURN:= 0 ;
EXCEPTION WHEN OTHERS THEN
RAISE;
    P_RETURN:= -99 ;
END;




PROCEDURE PROC_APP_TRANSLATE
(
    P_LANGUAGE_CODE_NEW IN APP_DOCUMENT.LANGUAGE_CODE % TYPE,
    p_app_old_id IN APP_DOCUMENT.APP_HEADER_ID % TYPE,

    --ID BAN GHI TIENG VIET
    P_APP_NEW_ID IN NUMBER  ,
    P_RETURN OUT NUMBER
)
IS
    v_case_code VARCHAR2(50);
BEGIN

    -- xa bn ting anh di
    -- xong insert li
    --DELETE APP_DOCUMENT WHERE APP_HEADER_ID = P_APP_HEADER_ID AND LANGUAGE_CODE ='VI_VN' ;

    -- xa bn dch nu truc d d duyt
    DELETE APP_DOCUMENT WHERE APP_HEADER_ID = P_APP_NEW_ID;

    -- insert t thng cu vo
    INSERT INTO APP_DOCUMENT
    (
        ID,  LANGUAGE_CODE,  APP_HEADER_ID,  DOCUMENT_ID,  ISUSE,
        NOTE,  STATUS,  DOCUMENT_FILING_DATE,  FILENAME,
        URL_HARDCOPY,  CHAR01,  CHAR02,  CHAR03,  CHAR04,  CHAR05, CASE_CODE
    )
    SELECT SEQ_APP_DOCUMENT.NEXTVAL AS ID, P_LANGUAGE_CODE_NEW AS LANGUAGE_CODE  ,P_APP_NEW_ID,  DOCUMENT_ID,  ISUSE,
        NOTE,  STATUS,  DOCUMENT_FILING_DATE,  FILENAME,
        URL_HARDCOPY,  CHAR01,  CHAR02,  CHAR03,  CHAR04,  CHAR05, CASE_CODE
    FROM APP_DOCUMENT
    WHERE APP_HEADER_ID = P_APP_OLD_ID ; -- AND LANGUAGE_CODE = 'EN_US';

    -- UPDATE BAN GHI CU trung ID dch
    UPDATE APPLICATION_HEADER SET ID_VI = P_APP_NEW_ID WHERE ID = P_APP_OLD_ID; --AND LANGUAGUE_CODE ='EN_US';

    UPDATE APPLICATION_HEADER SET ID_VI = P_APP_OLD_ID WHERE ID = P_APP_NEW_ID;

    --update APPLICATION_HEADER a set a.allowtranslate = 0 WHERE ID = P_APP_NEW_ID;

    -- update bn ghi ting vit
    UPDATE APPLICATION_HEADER a SET a.created_by =
    (
        -- ly created by ca bn duc dch
        SELECT created_by FROM APPLICATION_HEADER WHERE deleted = 0 AND id = P_APP_OLD_ID
    )
    WHERE id = P_APP_NEW_ID;

    P_RETURN:=0 ;
EXCEPTION WHEN OTHERS THEN
RAISE;
    P_RETURN:= -99 ;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_DOCUMENT

-- Start of DDL Script for Package LEGALTECH.PKG_APP_FEE_FIX
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_fee_fix
  IS


PROCEDURE PROC_APP_FEE_FIX_INSERT
(
    p_case_code in VARCHAR2,
    --P_APP_HEADER_ID IN APP_FEE_FIX.APP_HEADER_ID % TYPE,
    P_FEE_ID IN APP_FEE_FIX.FEE_ID % TYPE,
    P_ISUSE IN APP_FEE_FIX.ISUSE % TYPE,
    P_NUMBER_OF_PATENT IN APP_FEE_FIX.NUMBER_OF_PATENT % TYPE,
    P_AMOUNT IN APP_FEE_FIX.AMOUNT % TYPE ,
    P_RETURN OUT NUMBER
);

/*
PROCEDURE PROC_APP_FEE_FIX_UPDATE
(
    P_ID IN APP_FEE_FIX.ID % TYPE,
    P_APP_HEADER_ID IN APP_FEE_FIX.APP_HEADER_ID % TYPE,
    P_FEE_ID IN APP_FEE_FIX.FEE_ID % TYPE,
    P_ISUSE IN APP_FEE_FIX.ISUSE % TYPE,
    P_NUMBER_OF_PATENT IN APP_FEE_FIX.NUMBER_OF_PATENT % TYPE,
    P_AMOUNT IN APP_FEE_FIX.AMOUNT % TYPE,
    P_RETURN OUT NUMBER
);*/


PROCEDURE Proc_DeleteBy_Header
(
    --p_app_header_id IN app_detail_plb01_sdd.app_header_id % TYPE,
    p_case_code in VARCHAR2,
    p_language_code IN app_detail_plb01_sdd.language_code % TYPE
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_fee_fix
IS

PROCEDURE PROC_APP_FEE_FIX_INSERT
(
    p_case_code in VARCHAR2,
    --P_APP_HEADER_ID IN APP_FEE_FIX.APP_HEADER_ID % TYPE,
    P_FEE_ID IN APP_FEE_FIX.FEE_ID % TYPE,
    P_ISUSE IN APP_FEE_FIX.ISUSE % TYPE,
    P_NUMBER_OF_PATENT IN APP_FEE_FIX.NUMBER_OF_PATENT % TYPE,
    P_AMOUNT IN APP_FEE_FIX.AMOUNT % TYPE ,
    P_RETURN OUT NUMBER
)
IS
    V_ID NUMBER DEFAULT 0 ;
    v_amount_usd NUMBER;
    --v_appcode VARCHAR2(100);
    v_count NUMBER;
    v_app_code VARCHAR2(100);
BEGIN

    SELECT DISTINCT appcode INTO v_app_code FROM application_header WHERE case_code = p_case_code;

    SELECT COUNT(*) INTO v_count FROM sys_app_fix_charge WHERE appcode = v_app_code AND fee_id = P_FEE_ID;
    IF v_count = 0 THEN
        v_amount_usd := 0;
    ELSE
        SELECT amount_usd INTO v_amount_usd FROM sys_app_fix_charge WHERE appcode = v_app_code AND fee_id = P_FEE_ID;
        v_amount_usd :=  v_amount_usd * P_NUMBER_OF_PATENT;
    END IF;

    P_RETURN:= 0 ;

    SELECT SEQ_APP_FEE_FIX.NEXTVAL INTO V_ID FROM DUAL;

    INSERT INTO APP_FEE_FIX
    (
        ID, case_code, FEE_ID, ISUSE, NUMBER_OF_PATENT, AMOUNT,AMOUNT_USD
    )
    VALUES
    (
        V_ID,p_case_code, P_FEE_ID, P_ISUSE, P_NUMBER_OF_PATENT, P_AMOUNT, v_amount_usd
    );

  -- KHONG COMMIT SU DUNG TRACSACTION

EXCEPTION WHEN OTHERS THEN
    RAISE;
    P_RETURN:= -99 ;
END;



PROCEDURE Proc_DeleteBy_Header
(
    --p_app_header_id IN app_detail_plb01_sdd.app_header_id % TYPE,
    p_case_code in VARCHAR2,
    p_language_code IN app_detail_plb01_sdd.language_code % TYPE
)
IS
BEGIN
    --LAY DANH SACH CAC TAI LIEU DINH KEM
     DELETE APP_FEE_FIX A  WHERE case_code = p_case_code;-- AND  language_code = p_language_code ;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;



   -- Enter further code below as specified in the Package spec.
END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_FEE_FIX

-- Start of DDL Script for Package LEGALTECH.PKG_APP_GET_DATA
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_get_data
  IS

PROCEDURE PROC_APP_TM04NH_GET_BY_ID
(
    P_APP_HEADER_ID IN VARCHAR2,
    P_LANGUAGE IN VARCHAR2,
    P_STATUS IN NUMBER ,
    P_CURSOR OUT PKG_COMMON.T_CURSOR  ,
    P_C_DOC OUT  PKG_COMMON.T_CURSOR ,
    P_C_OTHER OUT  PKG_COMMON.T_CURSOR ,
    P_C_CLASS_DETAIL OUT  PKG_COMMON.T_CURSOR ,
    P_C_FEE OUT  PKG_COMMON.T_CURSOR
);


PROCEDURE PROC_APP_TM06DKQT_GET_BY_ID
(
    P_APP_HEADER_ID IN VARCHAR2,
    P_LANGUAGE IN VARCHAR2,
    P_STATUS IN NUMBER ,
    P_CURSOR OUT PKG_COMMON.T_CURSOR  ,
    P_C_DOC OUT  PKG_COMMON.T_CURSOR ,
    P_C_CLASS_DETAIL OUT  PKG_COMMON.T_CURSOR
);


END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_get_data
IS

PROCEDURE PROC_APP_TM04NH_GET_BY_ID
(
    P_APP_HEADER_ID IN VARCHAR2,
    P_LANGUAGE IN VARCHAR2,
    P_STATUS IN NUMBER ,
    P_CURSOR OUT PKG_COMMON.T_CURSOR  ,
    P_C_DOC OUT  PKG_COMMON.T_CURSOR ,
    P_C_OTHER OUT  PKG_COMMON.T_CURSOR ,
    P_C_CLASS_DETAIL OUT  PKG_COMMON.T_CURSOR ,
    P_C_FEE OUT  PKG_COMMON.T_CURSOR
)
IS
    v_case_code VARCHAR2(50);
    v_count NUMBER;

    v_id_en NUMBER DEFAULT 0;
    v_status_en NUMBER DEFAULT 0;
    v_vi_translate NUMBER DEFAULT 0;
BEGIN
    -- xem c bn dch ko
    SELECT COUNT(*) INTO v_count FROM application_header WHERE ID_VI = P_APP_HEADER_ID AND deleted = 0;
    IF v_count > 0 THEN
        SELECT id,status, 1 INTO v_id_en, v_status_en, v_vi_translate
        FROM application_header WHERE ID_VI = P_APP_HEADER_ID AND deleted = 0;
    END IF;

    SELECT DISTINCT case_code INTO v_case_code FROM application_header WHERE id = P_APP_HEADER_ID;

    -- b diu kin AND  LANGUAGUE_CODE ='EN_US'
    OPEN  P_CURSOR FOR
    SELECT A.* , B.*, v_vi_translate VI_TRANSLATE, v_id_en ID_EN , v_status_en STATUS_EN
    FROM APPLICATION_HEADER A
    LEFT JOIN APP_DETAIL_04NH B ON A.ID = B.APP_HEADER_ID
    WHERE  1 = 1
    --A.LANGUAGUE_CODE = P_LANGUAGE AND -- dangtq b di v gi dch c vit sang anh v nguc li
    AND APP_HEADER_ID = P_APP_HEADER_ID AND STATUS = P_STATUS AND DELETED =0 ;

    --LAY DANH SACH CAC TAI LIEU DINH KEM
    OPEN  P_C_DOC FOR SELECT * FROM APP_DOCUMENT A  WHERE  app_header_id = P_APP_HEADER_ID ;--AND  language_code = P_LANGUAGE ;

    --LAY DANH SACH CAC TAI LIEU KHAC DINH KEM
    OPEN  P_C_OTHER FOR SELECT  * FROM APP_DOCUMENT_OTHERS A  WHERE  app_header_id = P_APP_HEADER_ID  AND DELETED = 0 ; --AND language_code = P_LANGUAGE;

    -- LAY THONG TIN CHI TIET
    OPEN  P_C_CLASS_DETAIL FOR SELECT * FROM APP_CLASS_DETAIL A  WHERE app_header_id = P_APP_HEADER_ID ; --AND  language_code = P_LANGUAGE ;

    OPEN  P_C_FEE FOR SELECT * FROM  APP_FEE_FIX  WHERE case_code= v_case_code ;

EXCEPTION WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE PROC_APP_TM06DKQT_GET_BY_ID
(
    P_APP_HEADER_ID IN VARCHAR2,
    P_LANGUAGE IN VARCHAR2,
    P_STATUS IN NUMBER ,
    P_CURSOR OUT PKG_COMMON.T_CURSOR  ,
    P_C_DOC OUT  PKG_COMMON.T_CURSOR ,
    P_C_CLASS_DETAIL OUT  PKG_COMMON.T_CURSOR
)
IS
BEGIN

    OPEN  P_CURSOR FOR
    SELECT A.* , B.*, C.APPNO AS REF_APPNO_TEXT,
        CT1.NAME AS COUNTRY_ID01_TEXT,
        CT2.NAME AS COUNTRY_ID02_TEXT,
        CT3.NAME AS COUNTRY_ID03_TEXT,
        CT4.NAME AS COUNTRY_ID04_TEXT,
        CT5.NAME AS COUNTRY_ID05_TEXT,
        CT6.NAME AS COUNTRY_ID06_TEXT,
        CT7.NAME AS COUNTRY_ID07_TEXT,
        CT8.NAME AS COUNTRY_ID08_TEXT
     FROM APPLICATION_HEADER A
     LEFT JOIN APP_DETAIL_TM06DKQT B ON A.ID = B.APP_HEADER_ID
     LEFT JOIN APP_DETAIL_04NH C ON B.REF_APPNO = C.APP_HEADER_ID
     LEFT JOIN COUNTRY CT1 ON B.COUNTRY_ID01 = CT1.COUNTRY_ID
     LEFT JOIN COUNTRY CT2 ON B.COUNTRY_ID02 = CT2.COUNTRY_ID
     LEFT JOIN COUNTRY CT3 ON B.COUNTRY_ID03 = CT3.COUNTRY_ID
     LEFT JOIN COUNTRY CT4 ON B.COUNTRY_ID04 = CT4.COUNTRY_ID
     LEFT JOIN COUNTRY CT5 ON B.COUNTRY_ID05 = CT5.COUNTRY_ID
     LEFT JOIN COUNTRY CT6 ON B.COUNTRY_ID06 = CT6.COUNTRY_ID
     LEFT JOIN COUNTRY CT7 ON B.COUNTRY_ID07 = CT7.COUNTRY_ID
     LEFT JOIN COUNTRY CT8 ON B.COUNTRY_ID08 = CT8.COUNTRY_ID

     WHERE  A.LANGUAGUE_CODE =P_LANGUAGE   AND  B.APP_HEADER_ID = P_APP_HEADER_ID  AND STATUS = P_STATUS AND
            DELETED =0 AND B.LANGUAGE = P_LANGUAGE
           --  AND C.LANGUAGE_CODE = P_LANGUAGE -- khong lay ngon ngu o bang APP_DETAIL_04NH do refapno co the lay tu ngon ngu khac
             ;

    --LAY DANH SACH CAC TAI LIEU DINH KEM
    OPEN  P_C_DOC FOR SELECT  * FROM APP_DOCUMENT A  WHERE  app_header_id = P_APP_HEADER_ID AND  language_code = P_LANGUAGE ;

    --LAY DANH SACH CAC TAI LIEU KHAC DINH KEM
    OPEN  P_C_CLASS_DETAIL FOR SELECT * FROM APP_CLASS_DETAIL A  WHERE  app_header_id = P_APP_HEADER_ID AND  language_code = P_LANGUAGE ;

EXCEPTION WHEN OTHERS THEN
    RAISE;
END  ;
END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_GET_DATA

-- Start of DDL Script for Package LEGALTECH.PKG_APP_HEADER
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_header
  IS
/*APP_HEADER_STATUS_LUUTAM CONSTANT NUMBER(1) := 1;
APP_HEADER_STATUS_CHOPHANLOAI CONSTANT NUMBER(1) := 2;
APP_HEADER_STATUS_DAGUI2LS CONSTANT NUMBER(1) := 3;
APP_HEADER_STATUS_LS_DA_CF CONSTANT NUMBER(1) := 4;
APP_HEADER_STATUS_CHO_KH_CF CONSTANT NUMBER(1) := 5;
APP_HEADER_STATUS_KH_DA_CF CONSTANT NUMBER(1) := 6;
APP_HEADER_STATUS_KH_DA_RJ CONSTANT NUMBER(2) := 61;
APP_HEADER_STATUS_FILLING CONSTANT NUMBER(1) := 7;*/

PROCEDURE proc_update_status
(
    p_case_code IN VARCHAR2,
    p_status IN NUMBER,
    p_notes IN VARCHAR2,
    p_modify_by IN VARCHAR2,
    p_modify_date IN DATE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE proc_update_employee
(
    p_case_code IN VARCHAR2,
    p_employee IN NUMBER,
    p_notes IN VARCHAR2,
    p_modify_by IN VARCHAR2,
    p_modify_date IN DATE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE proc_update_admin
(
    p_case_code IN VARCHAR2,
    p_admin IN NUMBER,
    p_notes IN VARCHAR2,
    p_modify_by IN VARCHAR2,
    p_modify_date IN DATE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE proc_update_filing
(
    p_case_code IN VARCHAR2,
    p_status IN NUMBER,
    p_app_no IN VARCHAR2,
    p_filing_date IN DATE,
    p_expected_accept_date IN DATE,
    p_url_copy IN VARCHAR2,
    p_url_translate IN VARCHAR2,
    p_notes IN VARCHAR2,
    p_comment_filling in VARCHAR2,
    p_modify_by IN VARCHAR2,
    p_modify_date IN DATE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE proc_update_url_billing
(
    p_case_code IN VARCHAR2,
    p_billing_id IN NUMBER,
    p_url_billing IN VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE PROC_APPLICATION_HEADER_SEARCH
(
    p_user_name IN VARCHAR2,
    P_SEARCH_FROM_HOME IN NUMBER , --hungtd them de searh o home
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT pkg_common.t_cursor
);


PROCEDURE PROC_APP_HEADER_INSERT
(
    P_APPCODE IN APPLICATION_HEADER.APPCODE % TYPE,
    P_MASTER_NAME IN APPLICATION_HEADER.MASTER_NAME % TYPE,
    P_MASTER_ADDRESS IN APPLICATION_HEADER.MASTER_ADDRESS % TYPE,
    P_MASTER_PHONE IN APPLICATION_HEADER.MASTER_PHONE % TYPE,
    P_MASTER_FAX IN VARCHAR ,
    P_MASTER_EMAIL IN VARCHAR ,
    P_REP_MASTER_TYPE IN APPLICATION_HEADER.REP_MASTER_TYPE % TYPE,
    P_REP_MASTER_NAME IN APPLICATION_HEADER.REP_MASTER_NAME % TYPE,
    P_REP_MASTER_ADDRESS IN APPLICATION_HEADER.REP_MASTER_ADDRESS % TYPE,
    P_REP_MASTER_PHONE IN APPLICATION_HEADER.REP_MASTER_PHONE % TYPE,
    P_REP_MASTER_FAX IN APPLICATION_HEADER.REP_MASTER_FAX % TYPE,
    P_REP_MASTER_EMAIL IN APPLICATION_HEADER.REP_MASTER_EMAIL % TYPE,
    P_SEND_DATE IN APPLICATION_HEADER.SEND_DATE % TYPE,
    P_STATUS IN APPLICATION_HEADER.STATUS % TYPE,
    P_CREATED_BY IN APPLICATION_HEADER.CREATED_BY % TYPE,
    P_CREATED_DATE IN APPLICATION_HEADER.CREATED_DATE % TYPE,
    P_LANGUAGUE_CODE IN APPLICATION_HEADER.LANGUAGUE_CODE % TYPE  ,
    P_ADDRESS IN VARCHAR2  ,
    P_DATENO IN VARCHAR2 ,
    P_MONTHS IN VARCHAR2 ,
    P_YEARS IN VARCHAR2 ,
    P_CLIENT_REFERENCE IN VARCHAR2,
    P_CASE_NAME IN VARCHAR2,
    P_DDSHCN IN VARCHAR2,
    P_MADDSHCN IN VARCHAR2,
    p_App_No IN VARCHAR2,
    p_App_Degree IN VARCHAR2,
    P_RETURN OUT NUMBER,
    p_return_case_code OUT VARCHAR2
);


PROCEDURE PROC_APP_HEADER_UPDATE
(
    P_ID IN NUMBER ,
    P_APPCODE IN APPLICATION_HEADER.APPCODE % TYPE,
    P_MASTER_NAME IN APPLICATION_HEADER.MASTER_NAME % TYPE,
    P_MASTER_ADDRESS IN APPLICATION_HEADER.MASTER_ADDRESS % TYPE,
    P_MASTER_PHONE IN APPLICATION_HEADER.MASTER_PHONE % TYPE,
    P_MASTER_FAX IN VARCHAR ,
    P_MASTER_EMAIL IN VARCHAR ,
    P_REP_MASTER_TYPE IN APPLICATION_HEADER.REP_MASTER_TYPE % TYPE,
    P_REP_MASTER_NAME IN APPLICATION_HEADER.REP_MASTER_NAME % TYPE,
    P_REP_MASTER_ADDRESS IN APPLICATION_HEADER.REP_MASTER_ADDRESS % TYPE,
    P_REP_MASTER_PHONE IN APPLICATION_HEADER.REP_MASTER_PHONE % TYPE,
    P_REP_MASTER_FAX IN APPLICATION_HEADER.REP_MASTER_FAX % TYPE,

    P_REP_MASTER_EMAIL IN APPLICATION_HEADER.REP_MASTER_EMAIL % TYPE,
    P_SEND_DATE IN APPLICATION_HEADER.SEND_DATE % TYPE,
    P_STATUS IN APPLICATION_HEADER.STATUS % TYPE,
    P_MODIFY_BY IN APPLICATION_HEADER.MODIFY_BY % TYPE,
    P_MODIFY_DATE IN APPLICATION_HEADER.MODIFY_DATE % TYPE,
    P_LANGUAGUE_CODE IN APPLICATION_HEADER.LANGUAGUE_CODE % TYPE  ,
    P_ADDRESS IN VARCHAR2  ,
    P_DATENO IN VARCHAR2 ,
    P_MONTHS IN VARCHAR2 ,
    P_YEARS IN VARCHAR2 ,
    P_CLIENT_REFERENCE IN VARCHAR2,
    P_CASE_NAME IN VARCHAR2,
    P_DDSHCN IN VARCHAR2,
     P_MADDSHCN IN VARCHAR2,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_APP_HEADER_DELETED
(
    P_ID IN NUMBER ,
    P_LANGUAGUE_CODE IN VARCHAR2 ,
    P_RETURN OUT NUMBER
);

PROCEDURE proc_getByAppNo
(
    p_appNo IN VARCHAR2,
    p_user_name IN VARCHAR2,
    p_languague_code IN VARCHAR2 ,
    p_cursor OUT pkg_common.t_cursor
);

PROCEDURE proc_getByCaseCode_billing
(
    p_case_code IN VARCHAR2,
    p_user_name IN VARCHAR2,
    p_language_code IN VARCHAR2 ,
    p_cursor OUT pkg_common.t_cursor,
    p_cursor_detail OUT pkg_common.t_cursor
);

PROCEDURE proc_getByCaseCode
(
    p_case_code IN VARCHAR2,
    p_language_code IN VARCHAR2 ,
    p_cursor OUT pkg_common.t_cursor
);

PROCEDURE proc_getByCaseCode_todo
(
    p_case_code IN VARCHAR2,
    p_user_name IN VARCHAR2,
    p_language_code IN VARCHAR2 ,
    p_cursor OUT pkg_common.t_cursor
);

PROCEDURE proc_getById
(
    p_id IN NUMBER,
    p_languague_code IN VARCHAR2 ,
    p_cursor OUT pkg_common.t_cursor
);

PROCEDURE proc_getAfter_Filling
(
    p_case_code IN VARCHAR2,
    p_user_name IN VARCHAR2,
    p_language_code IN VARCHAR2 ,
    p_cursor_app OUT pkg_common.t_cursor,
    p_cursor_todo OUT pkg_common.t_cursor,
    p_cursor_billing OUT pkg_common.t_cursor,
    p_cursor_docketing OUT pkg_common.t_cursor,
    p_cursor_notice OUT pkg_common.t_cursor,
    p_cursor_remind OUT pkg_common.t_cursor
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_header
IS

PROCEDURE PROC_APPLICATION_HEADER_SEARCH
(
    p_user_name IN VARCHAR2,
    P_SEARCH_FROM_HOME IN NUMBER, --hungtd them de searh o home
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_APP_CODE VARCHAR2(30) DEFAULT 'ALL';
    v_case_code VARCHAR2(100) DEFAULT 'ALL';
    v_case_name VARCHAR2(100) DEFAULT 'ALL';
    V_LANGUAGE VARCHAR2(5) DEFAULT 'ALL';
    V_FROM NUMBER ;
    V_TO NUMBER;

    v_count NUMBER;
    v_user_type NUMBER;
BEGIN

    SELECT COUNT(*) INTO v_count FROM s_users s WHERE s.username = p_user_name AND s.deleted = 0;
    IF v_count = 0 THEN
        OPEN P_CURSOR FOR
        SELECT  A.* FROM view_app_header A WHERE  1 = 0;
        RETURN;
    END IF;



    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP
        IF V_INDEX = 0 THEN
            V_APP_CODE := ITEM.CONDITION;
        ELSIF V_INDEX = 1 THEN
            V_STATUS := ITEM.CONDITION;
        ELSIF V_INDEX = 2 THEN
            v_case_code := ITEM.CONDITION;
        ELSIF V_INDEX = 3 THEN
            v_case_name := ITEM.CONDITION;
        ELSIF V_INDEX = 4 THEN
            V_LANGUAGE := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;

    V_CONDITION := ' 1 = 1 ';
    IF V_APP_CODE <> 'ALL' THEN
        V_CONDITION := V_CONDITION || ' AND A.APPCODE = ''' || V_APP_CODE || '''';
    END IF;

    IF V_STATUS <> 'ALL' THEN
        V_CONDITION := V_CONDITION || ' AND A.STATUS = ' || V_STATUS;
    END IF;

    IF v_case_code <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.CASE_CODE) LIKE ''%' || UPPER(v_case_code) || '%'' ';
    END IF;

    IF v_case_name <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.case_name) LIKE ''%' || UPPER(v_case_name) || '%'' ';
    END IF;

    /*IF V_LANGUAGE <> 'ALL' THEN
        IF(V_LANGUAGE = 'VI_VN') THEN
            V_CONDITION :=  V_CONDITION || ' AND (A.LANGUAGUE_CODE LIKE ''%' || UPPER(V_LANGUAGE) || '%'' OR A.ID_VI >= 0 ) ';
        ELSE
            V_CONDITION :=  V_CONDITION || ' AND A.LANGUAGUE_CODE LIKE ''%' || UPPER(V_LANGUAGE) || '%'' ';
        END IF ;
    END IF;*/


    IF P_SEARCH_FROM_HOME = 1 THEN
        --HUNGTD NEU GOP CHUNG TAT CA DIEU KIEN TIM KIEM
        V_CONDITION := ' UPPER(A.APPCODE) LIKE  ''%' || UPPER(P_SEARCH_KEY) || '%'' ';
        V_CONDITION :=  V_CONDITION || ' OR  UPPER(A.STATUS_NAME) LIKE  ''%' || UPPER(P_SEARCH_KEY) || '%'' ';
        V_CONDITION :=  V_CONDITION || ' OR UPPER(A.CASE_CODE) LIKE  ''%' || UPPER(P_SEARCH_KEY) || '%'' ';
        V_CONDITION :=  V_CONDITION || ' OR UPPER(A.CASE_NAME) LIKE  ''%' || UPPER(P_SEARCH_KEY) || '%'' ';
        V_CONDITION :=  V_CONDITION || ' OR UPPER(A.MASTER_NAME) LIKE  ''%' || UPPER(P_SEARCH_KEY) || '%'' ';
        V_CONDITION :=  V_CONDITION || ' OR UPPER(A.REP_MASTER_NAME) LIKE  ''%' || UPPER(P_SEARCH_KEY) || '%'' ';
    END IF;


    -- l?y th?ng tin user type
    SELECT s.TYPE INTO v_user_type FROM s_users s WHERE s.username = p_user_name AND s.deleted = 0;
    IF v_user_type = pkg_common.USER_TYPE_LAWER THEN
        V_CONDITION :=  V_CONDITION || ' AND A.LAWER_USER_NAME = ''' || p_user_name || '''';
    ELSIF v_user_type = pkg_common.USER_TYPE_CUSTOMER THEN
        V_CONDITION :=  V_CONDITION || ' AND A.CREATED_BY = ''' || p_user_name || '''';
    ELSIF v_user_type = pkg_common.USER_TYPE_EMPOYEE THEN
        V_CONDITION :=  V_CONDITION || ' AND A.EMPLOYEE_NAME = ''' || p_user_name || '''';
    END IF;

    --V_SQL := 'SELECT  A.* FROM view_app_header A WHERE   ';

    V_SQL := 'SELECT * FROM
    (
        SELECT RANK() OVER (PARTITION BY case_name ORDER BY id) AS myrank,
        b.* FROM view_app_header b
    ) A WHERE  myrank = 1 AND ';

    V_SQL :=  V_SQL || V_CONDITION;

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.CREATED_DATE DESC';
    END IF;

    --PKG_LOG.logmsg(V_SQL);
    --commit;


    V_TOTAL_COUNT := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_TOTAL_COUNT INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;




    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

-- dangtq
PROCEDURE proc_update_status
(
    p_case_code IN VARCHAR2,
    p_status IN NUMBER,
    p_notes IN VARCHAR2,
    p_modify_by IN VARCHAR2,
    p_modify_date IN DATE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    v_count NUMBER;
    v_billing_id NUMBER;
    v_case_code_billing VARCHAR2(50) DEFAULT '';

    v_id_tran NUMBER DEFAULT 0;
BEGIN

    UPDATE APPLICATION_HEADER
    SET status = p_status,
        notes = p_notes,
        modify_by = p_modify_by,
        modify_date = p_modify_date,
        status_date = p_modify_date
    WHERE case_code = p_case_code;

    SELECT COUNT(*) INTO v_count FROM APPLICATION_HEADER WHERE case_code = p_case_code;
    IF v_count > 0 THEN
        SELECT NVL(id_vi,0) INTO v_id_tran FROM APPLICATION_HEADER WHERE case_code = p_case_code;
    END IF;

    -- update b?n ghi d?ch
    IF v_id_tran > 0 THEN
        UPDATE APPLICATION_HEADER
        SET status = p_status,
            notes = p_notes,
            modify_by = p_modify_by,
            modify_date = p_modify_date,
            status_date = p_modify_date
        WHERE id = v_id_tran;
    END IF;

    -- Update trang thai review
    --UPDATE b_todos SET  status = pkg_common.TODO_STATUS_COMPLETED, processor_date = SYSDATE
    --WHERE TYPE = pkg_common.TODO_TYPE_APP AND case_code = p_case_code AND status = pkg_common.TODO_STATUS_REVIEW;

    -- insert todo
    --SELECT case_code INTO v_case_code FROM application_header WHERE id = p_id AND LANGUAGUE_CODE = p_language_code;
    pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_APP,p_case_code,p_language_code);

    -- update billing
    IF p_status = pkg_common.APP_STATUS_WAIT_KH_CONFIRM THEN
        SELECT COUNT(*) INTO v_count FROM application_header a WHERE case_code = p_case_code AND ROWNUM = 1;
        IF v_count > 0 THEN
            SELECT a.billing_id_advise INTO v_billing_id FROM application_header a WHERE case_code = p_case_code AND ROWNUM = 1;

            UPDATE billing_header SET status = pkg_common.BILLING_H_STATUS_APPROVE,modify_by = p_modify_by, modify_date = SYSDATE
            WHERE billing_id = v_billing_id AND status = pkg_common.BILLING_H_STATUS_REVIEW;
            SELECT COUNT(*) INTO v_count FROM billing_header WHERE billing_id = v_billing_id ;
            IF v_count > 0 THEN

                SELECT case_code INTO v_case_code_billing FROM billing_header WHERE billing_id = v_billing_id ;

                UPDATE B_TODOS SET STATUS = PKG_COMMON.TODO_STATUS_COMPLETED, PROCESSOR_DATE = SYSDATE
                WHERE TYPE = PKG_COMMON.TODO_TYPE_BILLING AND STATUS = PKG_COMMON.TODO_STATUS_REVIEW
                AND CASE_CODE = v_case_code_billing;

            END IF;
        END IF;
    END IF;
    p_return := 0;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

-- dangtq
PROCEDURE proc_update_employee
(
    p_case_code IN VARCHAR2,
    p_employee IN NUMBER,
    p_notes IN VARCHAR2,
    p_modify_by IN VARCHAR2,
    p_modify_date IN DATE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    --v_case_code VARCHAR2(50) DEFAULT '';
    v_count NUMBER;
    v_id_tran NUMBER DEFAULT 0;
BEGIN

    -- thong tin header
    --SELECT case_code INTO v_case_code FROM application_header WHERE id = p_id;

    UPDATE APPLICATION_HEADER
    SET employee = p_employee,
        status = pkg_common.APP_STATUS_GRANT_EMPLOYEE,
        notes = p_notes,
        modify_by = p_modify_by,
        modify_date = p_modify_date,
        status_date = p_modify_date
    WHERE case_code = p_case_code;

    -- update b?n ghi d?ch
    SELECT COUNT(*) INTO v_count FROM APPLICATION_HEADER WHERE case_code = p_case_code;
    IF v_count > 0 THEN
        SELECT NVL(id_vi,0) INTO v_id_tran FROM APPLICATION_HEADER WHERE case_code = p_case_code;
    END IF;

    IF v_id_tran > 0 THEN
        UPDATE APPLICATION_HEADER
        SET employee = p_employee,
            status = pkg_common.APP_STATUS_GRANT_EMPLOYEE,
            notes = p_notes,
            modify_by = p_modify_by,
            modify_date = p_modify_date,
            status_date = p_modify_date
        WHERE id = v_id_tran;
    END IF;

    -- Update trang thai review
    --UPDATE b_todos SET  status = pkg_common.TODO_STATUS_COMPLETED, processor_date = SYSDATE
    --WHERE TYPE = pkg_common.TODO_TYPE_APP AND case_code = p_case_code AND status = pkg_common.TODO_STATUS_REVIEW;

    -- insert todo
    pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_APP,p_case_code,p_language_code);

    p_return := 0;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

-- dangtq
PROCEDURE proc_update_admin
(
    p_case_code IN VARCHAR2,
    p_admin IN NUMBER,
    p_notes IN VARCHAR2,
    p_modify_by IN VARCHAR2,
    p_modify_date IN DATE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    --v_case_code VARCHAR2(50) DEFAULT '';
    v_count NUMBER;
    v_id_tran NUMBER DEFAULT 0;
BEGIN

    -- thong tin header
    --SELECT case_code INTO v_case_code FROM application_header WHERE id = p_id;

    UPDATE APPLICATION_HEADER
    SET admin_id = p_admin,
        status = pkg_common.APP_STATUS_WAIT_GRANT_LAWER,
        notes = p_notes,
        modify_by = p_modify_by,
        modify_date = p_modify_date,
        status_date = p_modify_date
    WHERE case_code = p_case_code;

    -- update b?n ghi d?ch
    SELECT COUNT(*) INTO v_count FROM APPLICATION_HEADER WHERE case_code = p_case_code;
    IF v_count > 0 THEN
        SELECT NVL(id_vi,0) INTO v_id_tran FROM APPLICATION_HEADER WHERE case_code = p_case_code;
    END IF;

    IF v_id_tran > 0 THEN
        UPDATE APPLICATION_HEADER
        SET admin_id = p_admin,
            status = pkg_common.APP_STATUS_WAIT_GRANT_LAWER,
            notes = p_notes,
            modify_by = p_modify_by,
            modify_date = p_modify_date,
            status_date = p_modify_date
        WHERE id = v_id_tran;
    END IF;

    -- insert todo
    pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_APP,p_case_code,p_language_code);

    p_return := 0;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_update_url_billing
(
    p_case_code IN VARCHAR2,
    p_billing_id IN NUMBER,
    p_url_billing IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    v_count NUMBER;
    v_id_tran NUMBER DEFAULT 0;
BEGIN

    UPDATE APPLICATION_HEADER a
    SET URL_BILLING = p_url_billing,a.billing_id_advise = p_billing_id
    WHERE case_code = p_case_code;

    -- update b?n ghi d?ch
    SELECT COUNT(*) INTO v_count FROM APPLICATION_HEADER WHERE case_code = p_case_code;
    IF v_count > 0 THEN
        SELECT NVL(id_vi,0) INTO v_id_tran FROM APPLICATION_HEADER WHERE case_code = p_case_code;
    END IF;

    IF v_id_tran > 0 THEN
        UPDATE APPLICATION_HEADER a
        SET URL_BILLING = p_url_billing,a.billing_id_advise = p_billing_id
        WHERE id = v_id_tran;
    END IF;

    p_return := 1;

EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

PROCEDURE proc_update_filing
(
    p_case_code IN VARCHAR2,
    p_status IN NUMBER,
    p_app_no IN VARCHAR2,
    p_filing_date IN DATE,
    p_expected_accept_date IN DATE,
    p_url_copy IN VARCHAR2,
    p_url_translate IN VARCHAR2,
    p_notes IN VARCHAR2,
    p_comment_filling in VARCHAR2,
    p_modify_by IN VARCHAR2,
    p_modify_date IN DATE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    --v_case_code VARCHAR2(50) DEFAULT ''
    v_count NUMBER;
    v_id_tran NUMBER DEFAULT 0;
BEGIN

    -- thong tin header
    --SELECT case_code INTO v_case_code FROM application_header WHERE id = p_id;

    UPDATE APPLICATION_HEADER
    SET status = p_status,
        comment_filling = p_comment_filling,
        modify_by = p_modify_by,
        modify_date = p_modify_date,
        status_date = p_modify_date,
        filing_date = p_filing_date,
        expected_accept_date = p_expected_accept_date,
        url_copy_filing = p_url_copy,
        app_no = p_app_no,
        notes = p_notes,
        URL_TRANSLATE_FILING = p_url_translate
    WHERE case_code = p_case_code;

    -- update b?n ghi d?ch
    SELECT COUNT(*) INTO v_count FROM APPLICATION_HEADER WHERE case_code = p_case_code;
    IF v_count > 0 THEN
        SELECT NVL(id_vi,0) INTO v_id_tran FROM APPLICATION_HEADER WHERE case_code = p_case_code;
    END IF;

    IF v_id_tran > 0 THEN
        UPDATE APPLICATION_HEADER
        SET status = p_status,
            comment_filling = p_comment_filling,
            modify_by = p_modify_by,
            modify_date = p_modify_date,
            status_date = p_modify_date,
            filing_date = p_filing_date,
            expected_accept_date = p_expected_accept_date,
            url_copy_filing = p_url_copy,
            app_no = p_app_no,
            notes = p_notes,
            URL_TRANSLATE_FILING = p_url_translate
        WHERE id = v_id_tran;
    END IF;

    -- Update trang thai review
    --UPDATE b_todos SET  status = pkg_common.TODO_STATUS_COMPLETED, processor_date = SYSDATE
    --WHERE TYPE = pkg_common.TODO_TYPE_APP AND case_code = p_case_code AND status = pkg_common.TODO_STATUS_REVIEW;

    -- insert todo
    --SELECT case_code INTO v_case_code FROM application_header WHERE id = p_id AND LANGUAGUE_CODE = p_language_code;
    pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_APP,p_case_code,p_language_code);

    p_return := 0;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;


PROCEDURE PROC_APP_HEADER_INSERT
(
    P_APPCODE IN APPLICATION_HEADER.APPCODE % TYPE,
    P_MASTER_NAME IN APPLICATION_HEADER.MASTER_NAME % TYPE,
    P_MASTER_ADDRESS IN APPLICATION_HEADER.MASTER_ADDRESS % TYPE,
    P_MASTER_PHONE IN APPLICATION_HEADER.MASTER_PHONE % TYPE,
    P_MASTER_FAX IN VARCHAR ,
    P_MASTER_EMAIL IN VARCHAR ,
    P_REP_MASTER_TYPE IN APPLICATION_HEADER.REP_MASTER_TYPE % TYPE,
    P_REP_MASTER_NAME IN APPLICATION_HEADER.REP_MASTER_NAME % TYPE,
    P_REP_MASTER_ADDRESS IN APPLICATION_HEADER.REP_MASTER_ADDRESS % TYPE,
    P_REP_MASTER_PHONE IN APPLICATION_HEADER.REP_MASTER_PHONE % TYPE,
    P_REP_MASTER_FAX IN APPLICATION_HEADER.REP_MASTER_FAX % TYPE,
    P_REP_MASTER_EMAIL IN APPLICATION_HEADER.REP_MASTER_EMAIL % TYPE,
    P_SEND_DATE IN APPLICATION_HEADER.SEND_DATE % TYPE,
    P_STATUS IN APPLICATION_HEADER.STATUS % TYPE,
    P_CREATED_BY IN APPLICATION_HEADER.CREATED_BY % TYPE,
    P_CREATED_DATE IN APPLICATION_HEADER.CREATED_DATE % TYPE,
    P_LANGUAGUE_CODE IN APPLICATION_HEADER.LANGUAGUE_CODE % TYPE  ,
    P_ADDRESS IN VARCHAR2  ,
    P_DATENO IN VARCHAR2 ,
    P_MONTHS IN VARCHAR2 ,
    P_YEARS IN VARCHAR2 ,
    P_CLIENT_REFERENCE IN VARCHAR2,
    P_CASE_NAME IN VARCHAR2,
    P_DDSHCN IN VARCHAR2,
    P_MADDSHCN IN VARCHAR2,
    p_App_No IN VARCHAR2,
    p_App_Degree IN VARCHAR2,
    P_RETURN OUT NUMBER,
    p_return_case_code OUT VARCHAR2
)
IS
    V_ID NUMBER;

    V_ID_CASE_CODE NUMBER;
    V_CASE_CODE VARCHAR2(50);
    PLOG_RETURN  VARCHAR2(2000);
BEGIN

    SELECT SEQ_APPLICATION_HEADER.NEXTVAL INTO V_ID FROM DUAL;

    SELECT SEQ_GENCODE.NEXTVAL INTO V_ID_CASE_CODE FROM DUAL;

    V_CASE_CODE := P_APPCODE || to_char(SYSDATE,'yyyyMMdd') || V_ID_CASE_CODE;

    --TRA RA ID DE INSERT CAC BANG LIEN QUAN

    INSERT INTO APPLICATION_HEADER
    (
        ID, APPCODE, MASTER_NAME, MASTER_ADDRESS, MASTER_PHONE,
        REP_MASTER_TYPE, REP_MASTER_NAME, REP_MASTER_ADDRESS, REP_MASTER_PHONE, REP_MASTER_FAX,
        REP_MASTER_EMAIL, SEND_DATE, STATUS, DELETED, CREATED_BY, CREATED_DATE ,MASTER_FAX  ,MASTER_EMAIL ,
        LANGUAGUE_CODE ,ADDRESS ,DATENO,MONTHS,YEARS,Case_code,CLIENT_REFERENCE,CASE_NAME,STATUS_DATE, DDSHCN , MADDSHCN, app_no, App_Degree
    )
    VALUES
    (
        V_ID, P_APPCODE, P_MASTER_NAME, P_MASTER_ADDRESS, P_MASTER_PHONE,
        P_REP_MASTER_TYPE, P_REP_MASTER_NAME, P_REP_MASTER_ADDRESS, P_REP_MASTER_PHONE, P_REP_MASTER_FAX, P_REP_MASTER_EMAIL,
        P_SEND_DATE, P_STATUS,  0, P_CREATED_BY, P_CREATED_DATE,P_MASTER_FAX  ,P_MASTER_EMAIL ,
        P_LANGUAGUE_CODE,P_ADDRESS ,P_DATENO,P_MONTHS,P_YEARS,V_CASE_CODE,P_CLIENT_REFERENCE,P_CASE_NAME,P_CREATED_DATE,P_DDSHCN ,P_MADDSHCN,
        p_App_No, p_App_Degree
    );

    IF P_STATUS = pkg_common.APP_STATUS_WAIT_GRANT_ADMIN AND P_STATUS <>  pkg_common.APP_STATUS_HISTORY THEN
        pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_APP,V_CASE_CODE,P_LANGUAGUE_CODE);
    END IF;

    --COMMIT;

    P_RETURN := V_ID;
    p_return_case_code :=  V_CASE_CODE;
EXCEPTION WHEN OTHERS THEN
    P_RETURN:= -1 ;
    p_return_case_code := '';
    PLOG_RETURN := SUBSTR(SQLCODE,1,500) || SUBSTR(SQLERRM,1,500);
    pkg_log.log_error(PLOG_RETURN,'PROC_APP_HEADER_INSERT');
    RAISE;
END;

PROCEDURE PROC_APP_HEADER_UPDATE
(
    P_ID IN NUMBER ,
    P_APPCODE IN APPLICATION_HEADER.APPCODE % TYPE,
    P_MASTER_NAME IN APPLICATION_HEADER.MASTER_NAME % TYPE,
    P_MASTER_ADDRESS IN APPLICATION_HEADER.MASTER_ADDRESS % TYPE,
    P_MASTER_PHONE IN APPLICATION_HEADER.MASTER_PHONE % TYPE,
    P_MASTER_FAX IN VARCHAR ,
    P_MASTER_EMAIL IN VARCHAR ,
    P_REP_MASTER_TYPE IN APPLICATION_HEADER.REP_MASTER_TYPE % TYPE,
    P_REP_MASTER_NAME IN APPLICATION_HEADER.REP_MASTER_NAME % TYPE,
    P_REP_MASTER_ADDRESS IN APPLICATION_HEADER.REP_MASTER_ADDRESS % TYPE,
    P_REP_MASTER_PHONE IN APPLICATION_HEADER.REP_MASTER_PHONE % TYPE,
    P_REP_MASTER_FAX IN APPLICATION_HEADER.REP_MASTER_FAX % TYPE,
    P_REP_MASTER_EMAIL IN APPLICATION_HEADER.REP_MASTER_EMAIL % TYPE,
    P_SEND_DATE IN APPLICATION_HEADER.SEND_DATE % TYPE,
    P_STATUS IN APPLICATION_HEADER.STATUS % TYPE,
    P_MODIFY_BY IN APPLICATION_HEADER.MODIFY_BY % TYPE,
    P_MODIFY_DATE IN APPLICATION_HEADER.MODIFY_DATE % TYPE,
    P_LANGUAGUE_CODE IN APPLICATION_HEADER.LANGUAGUE_CODE % TYPE  ,
    P_ADDRESS IN VARCHAR2  ,
    P_DATENO IN VARCHAR2 ,
    P_MONTHS IN VARCHAR2 ,
    P_YEARS IN VARCHAR2 ,
    P_CLIENT_REFERENCE IN VARCHAR2,
    P_CASE_NAME IN VARCHAR2,
    P_DDSHCN IN VARCHAR2,
    P_MADDSHCN IN VARCHAR2,
    P_RETURN OUT NUMBER
)
IS
    v_status NUMBER;
    v_case_code VARCHAR2(50) DEFAULT '';
BEGIN

    SELECT DISTINCT case_code, status INTO v_case_code, v_status
    FROM APPLICATION_HEADER WHERE ID = P_ID; --;AND LANGUAGUE_CODE = P_LANGUAGUE_CODE;

    UPDATE APPLICATION_HEADER SET
        --APPCODE = P_APPCODE, KHONG DUOC SUA
        MASTER_NAME = P_MASTER_NAME,
        MASTER_ADDRESS = P_MASTER_ADDRESS,
        MASTER_PHONE = P_MASTER_PHONE,
        REP_MASTER_TYPE = P_REP_MASTER_TYPE,
        REP_MASTER_NAME = P_REP_MASTER_NAME,
        REP_MASTER_ADDRESS = P_REP_MASTER_ADDRESS,
        REP_MASTER_PHONE = P_REP_MASTER_PHONE,
        REP_MASTER_FAX = P_REP_MASTER_FAX,
        REP_MASTER_EMAIL = P_REP_MASTER_EMAIL,
        --SEND_DATE = P_SEND_DATE,
        STATUS = P_STATUS,
        MODIFY_BY = P_MODIFY_BY,
        MODIFY_DATE = P_MODIFY_DATE ,
        MASTER_EMAIL=P_MASTER_EMAIL ,
        MASTER_FAX= P_MASTER_FAX ,
        ADDRESS = P_ADDRESS , DATENO =P_DATENO ,MONTHS =P_MONTHS ,YEARS =P_YEARS,
        CLIENT_REFERENCE = P_CLIENT_REFERENCE,
        CASE_NAME = P_CASE_NAME,
        --USER_PROCESSING = P_MODIFY_BY ,
        DDSHCN = P_DDSHCN ,MADDSHCN =P_MADDSHCN

    WHERE ID = P_ID ;--AND LANGUAGUE_CODE = P_LANGUAGUE_CODE;

    IF P_STATUS != PKG_COMMON.APP_STATUS_SAVE_TEMP AND  P_STATUS != V_STATUS THEN
        PKG_TODOS.PROC_DO_INSERT(PKG_COMMON.TODO_TYPE_APP,V_CASE_CODE,P_LANGUAGUE_CODE);
    END IF;

    P_RETURN:= 0 ;
EXCEPTION WHEN OTHERS THEN
    P_RETURN:=PKG_COMMON.ERROR ;
    ROLLBACK ;
    RAISE;
END;

PROCEDURE PROC_APP_HEADER_DELETED
(
    P_ID IN NUMBER ,
    P_LANGUAGUE_CODE IN VARCHAR2 ,
    P_RETURN OUT NUMBER
)
IS
    v_count NUMBER;
    v_id_tran NUMBER DEFAULT 0;
BEGIN
    P_RETURN:= 0 ;

    --NEU XOA TIENG VIET THI UPDATE CA TIENG ANH
    /*IF(P_LANGUAGUE_CODE = PKG_COMMON.VI_VN)THEN
        UPDATE APPLICATION_HEADER SET  DELETED = PKG_COMMON.DELETED WHERE  ID = P_ID ;
    ELSE
        UPDATE APPLICATION_HEADER SET  DELETED =PKG_COMMON.DELETED WHERE  ID = P_ID  AND LANGUAGUE_CODE = P_LANGUAGUE_CODE;
    END IF;*/

    UPDATE APPLICATION_HEADER SET  DELETED = PKG_COMMON.DELETED WHERE  ID = P_ID ;

    -- update b?n ghi d?ch
    SELECT COUNT(*) INTO v_count FROM APPLICATION_HEADER WHERE id = P_ID;
    IF v_count > 0 THEN
        SELECT NVL(id_vi,0) INTO v_id_tran FROM APPLICATION_HEADER WHERE id = P_ID;
    END IF;

    IF v_id_tran > 0 THEN
        UPDATE APPLICATION_HEADER SET  DELETED = PKG_COMMON.DELETED WHERE ID = v_id_tran ;
    END IF;

    RETURN ;
EXCEPTION WHEN OTHERS THEN
    P_RETURN:=-99 ;
    ROLLBACK ;
    RAISE;
END ;

PROCEDURE proc_getByAppNo
(
    p_appNo IN VARCHAR2,
    p_user_name IN VARCHAR2,
    p_languague_code IN VARCHAR2 ,
    p_cursor OUT pkg_common.t_cursor
)
IS
BEGIN
    OPEN p_cursor FOR SELECT * FROM view_app_header WHERE app_no = p_appNo AND ROWNUM = 1;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END ;

-- d?ng cho billing
PROCEDURE proc_getByCaseCode_billing
(
    p_case_code IN VARCHAR2,
    p_user_name IN VARCHAR2,
    p_language_code IN VARCHAR2 ,
    p_cursor OUT pkg_common.t_cursor,
    p_cursor_detail OUT pkg_common.t_cursor
)
IS
    v_id NUMBER;
    v_app_country NUMBER;           -- don thuoc nuoc nao
    v_customer_country NUMBER;      -- khach hang thuoc nuoc nao

    v_currency_type VARCHAR2(3) DEFAULT 'VND';   -- loai tien te, 0-vnd, 1-usd
BEGIN

    -- lay thong tin ve app_header
    SELECT id,nvl(app_country,pkg_common.COUNTRY_VN) ,nvl(customer_country,pkg_common.COUNTRY_VN),currency_type
    INTO v_id,v_app_country,v_customer_country,v_currency_type
    FROM view_app_header WHERE upper(case_code) = upper(p_case_code) AND ROWNUM = 1; -- AND LANGUAGUE_CODE = p_language_code;

    OPEN p_cursor FOR SELECT * FROM view_app_header WHERE upper(case_code) = upper(p_case_code) AND ROWNUM = 1;--AND LANGUAGUE_CODE = p_language_code;

    OPEN p_cursor_detail FOR
    SELECT nvl(description,'') AS biling_detail_name,
        decode(v_currency_type,pkg_common.CURRENCY_VND, nvl(aff.amount,0),nvl(aff.amount_usd,0)) nation_fee,
        decode(v_currency_type,pkg_common.CURRENCY_VND, nvl(sa.amount_represent,0),nvl(sa.amount_represent_usd,0)) represent_fee,

       --nvl(aff.amount,0)  AS nation_fee, nvl(amount_represent,0) AS represent_fee,
       0 AS service_fee, pkg_common.BILLING_DETAIL_TYPE_APP AS TYPE, aff.id AS ref_id
    FROM app_fee_fix aff
    JOIN application_header ah ON ah.case_code = aff.case_code
    JOIN sys_app_fix_charge sa ON sa.appcode = ah.appcode and sa.fee_id = aff.fee_id
    WHERE aff.case_code = p_case_code AND aff.status = pkg_common.APP_FEE_STATUS_NOT_USE
    AND aff.amount > 0

    UNION

    SELECT name AS biling_detail_name, 0 AS nation_fee, 0 AS represent_fee,
        --(nvl(hours_adjust,0) * nvl(hourly_rate,0)) AS service_fee,
        decode(v_currency_type,pkg_common.CURRENCY_VND, (nvl(hours_adjust,0) * nvl(hourly_rate,0)) ,(nvl(hours_adjust,0) * nvl(hourly_rate_usd,0))) service_fee,
        pkg_common.BILLING_DETAIL_TYPE_TIMESHEET AS TYPE, t.id AS ref_id
    FROM timesheet t
    JOIN s_users u ON u.username = t.created_by
    WHERE t.app_case_code = p_case_code AND t.status = pkg_common.TIME_SHEET_STATUS_APPROVE AND STATUS_BILLING = pkg_common.APP_FEE_STATUS_NOT_USE;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END ;

PROCEDURE proc_getByCaseCode
(
    p_case_code IN VARCHAR2,
    p_language_code IN VARCHAR2 ,
    p_cursor OUT pkg_common.t_cursor
)
IS
BEGIN

    IF p_language_code <> '-1' THEN
        OPEN p_cursor FOR
        SELECT * FROM view_app_header WHERE upper(case_code) = upper(p_case_code) AND LANGUAGUE_CODE = p_language_code;
    ELSE
        OPEN p_cursor FOR
        SELECT * FROM view_app_header WHERE upper(case_code) = upper(p_case_code) AND ROWNUM = 1 ; --AND LANGUAGUE_CODE = p_language_code;
    END IF;



EXCEPTION
WHEN OTHERS THEN
    RAISE;
END ;

PROCEDURE proc_getByCaseCode_todo
(
    p_case_code IN VARCHAR2,
    p_user_name IN VARCHAR2,
    p_language_code IN VARCHAR2 ,
    p_cursor OUT pkg_common.t_cursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT * FROM view_app_header WHERE upper(case_code) = upper(p_case_code) AND ROWNUM = 1 ; -- AND LANGUAGUE_CODE = p_language_code;


EXCEPTION
WHEN OTHERS THEN
    RAISE;
END ;


PROCEDURE proc_getById
(
    p_id IN NUMBER,
    p_languague_code IN VARCHAR2 ,
    p_cursor OUT pkg_common.t_cursor
)
IS
BEGIN
    OPEN p_cursor FOR SELECT * FROM view_app_header WHERE id = p_id;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END ;


PROCEDURE proc_getAfter_Filling
(
    p_case_code IN VARCHAR2,
    p_user_name IN VARCHAR2,
    p_language_code IN VARCHAR2 ,
    p_cursor_app OUT pkg_common.t_cursor,
    p_cursor_todo OUT pkg_common.t_cursor,
    p_cursor_billing OUT pkg_common.t_cursor,
    p_cursor_docketing OUT pkg_common.t_cursor,
    p_cursor_notice OUT pkg_common.t_cursor,
    p_cursor_remind OUT pkg_common.t_cursor
)
IS
    v_count NUMBER;

    v_id_en NUMBER DEFAULT 0;
    v_status_en NUMBER DEFAULT 0;
    v_vi_translate NUMBER DEFAULT 0;
BEGIN
    -- xem c? b?n d?ch ko
    SELECT COUNT(*) INTO v_count FROM application_header WHERE case_code = p_case_code AND deleted = 0;
    IF v_count > 0 THEN
        SELECT id,status, 1 INTO v_id_en, v_status_en, v_vi_translate
        FROM application_header WHERE case_code = p_case_code AND deleted = 0;
    END IF;

    OPEN p_cursor_app FOR
    SELECT a.*, v_vi_translate VI_TRANSLATE, v_id_en ID_EN , v_status_en STATUS_EN FROM view_app_header a WHERE upper(case_code) = upper(p_case_code) AND ROWNUM = 1 ; -- AND LANGUAGUE_CODE = p_language_code;

    OPEN p_cursor_todo FOR
    SELECT a.*, ROWNUM AS STT
    FROM
    (
        SELECT * FROM VIEW_TODOS r
        WHERE r.case_code = p_case_code AND r.status = 0 AND r.processor_by = p_user_name
        ORDER BY r.TODO_ID  DESC
    ) a ;

    OPEN p_cursor_billing FOR
    SELECT * FROM view_billing_header r WHERE r.APP_CASE_CODE = p_case_code ORDER BY r.BILLING_ID  DESC;

    OPEN p_cursor_docketing FOR
    SELECT * FROM view_docking r WHERE r.APP_CASE_CODE = p_case_code ORDER BY r.DOCKING_ID  DESC;

    OPEN p_cursor_notice FOR
    SELECT * FROM view_notice_app r WHERE r.case_code = p_case_code ORDER BY r.id  DESC;

    OPEN p_cursor_remind FOR
    SELECT a.*, ROWNUM AS STT
    FROM
    (
        SELECT * FROM B_REMIND A WHERE A.case_code = p_case_code ORDER BY A.REMIND_ID  DESC
    ) a ;


EXCEPTION
WHEN OTHERS THEN
    RAISE;
END ;


END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_HEADER

-- Start of DDL Script for Package LEGALTECH.PKG_APP_LAWER
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_lawer
    IS TYPE tcursor IS ref CURSOR;

PROCEDURE proc_get_appgrant4Lawer
(
    p_lawer_id  IN NUMBER,
    p_user_type IN NUMBER,
    p_language_code VARCHAR2,
    p_cursor OUT tcursor
);

PROCEDURE proc_grant_app2_lawer
(
    --p_application_header_id IN NUMBER,
    p_case_code VARCHAR2,
    p_lawer_id  IN NUMBER,
    p_status IN NUMBER,
    p_notes VARCHAR2,
    p_language_code VARCHAR2,
    p_created_by VARCHAR2,
    p_created_date DATE,
    p_re_grant NUMBER,
    p_return OUT NUMBER
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_lawer
IS

PROCEDURE proc_get_appgrant4Lawer
(
    p_lawer_id  IN NUMBER,
    p_user_type IN NUMBER,
    p_language_code VARCHAR2,
    p_cursor OUT tcursor
)
IS
BEGIN

    IF p_user_type = pkg_common.USER_TYPE_ADMIN THEN
        OPEN p_cursor FOR
        SELECT ah.case_code, ah.appcode AS app_code, sa.appname AS app_name,Client_Reference,Case_Name,
        0 Lawer_Id, p_language_code AS Language_Code
        FROM application_header ah
        JOIN sys_application sa ON ah.appcode = sa.appcode  AND ah.LANGUAGUE_CODE = sa.LANGUAGECODE
        WHERE DELETED = 0 AND languague_code = p_language_code;
        RETURN;
    END IF;

    OPEN p_cursor FOR
    SELECT ah.case_code, ah.appcode AS app_code, sa.appname AS app_name,Client_Reference,Case_Name, al.Lawer_Id,al.Language_Code
    FROM app_lawer al
    JOIN application_header ah ON ah.case_code = al.case_code AND al.language_code = ah.languague_code
    JOIN sys_application sa ON ah.appcode = sa.appcode  AND ah.LANGUAGUE_CODE = sa.LANGUAGECODE
    WHERE al.lawer_id = p_lawer_id AND al.deleted = 0;

END;

PROCEDURE proc_grant_app2_lawer
(
    --p_application_header_id IN NUMBER,
    p_case_code VARCHAR2,
    p_lawer_id  IN NUMBER,
    p_status IN NUMBER,
    p_notes VARCHAR2,
    p_language_code VARCHAR2,
    p_created_by VARCHAR2,
    p_created_date DATE,
    p_re_grant NUMBER,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    v_lawer_name VARCHAR2(200) DEFAULT '';

    v_count NUMBER;
    v_id_tran NUMBER DEFAULT 0;
    v_case_code_trans VARCHAR2(200);
BEGIN

    -- lay thong tin username
    SELECT COUNT(*) INTO v_count FROM s_users WHERE id = p_lawer_id;
    IF v_count <> 0 THEN
        SELECT username INTO v_lawer_name FROM s_users WHERE id = p_lawer_id;
    END IF;

    -- update het cac thang dc phan loai truoc do ve deleted = 1
    UPDATE app_lawer SET deleted = 1 WHERE case_code = p_case_code;

    SELECT SEQ_APP_LAWER.NEXTVAL into v_id FROM dual;
    INSERT INTO app_lawer
    (
        id, case_code,lawer_id,notes,language_code,created_by,created_date
    )
    VALUES
    (
        v_id, p_case_code,p_lawer_id,p_notes,p_language_code,p_created_by,p_created_date
    );

    -- neu la phan lan dau
    UPDATE APPLICATION_HEADER
    SET status = p_status, --pkg_common.APP_STATUS_GRANT_LAWER,
        status_date = p_created_date,
        modify_by = p_created_by,
        notes = p_notes
    WHERE case_code = p_case_code;

    -- insert todo
    -- neu phan loai lai cho luat su thi thang xu ly phai la luat su
    IF p_re_grant = 1 THEN
        pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_APP,p_case_code,p_language_code, pkg_common.DEFAULT_LAWER);
    ELSE
        pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_APP,p_case_code,p_language_code);
    END IF;

    -- update bn ghi dch
    SELECT COUNT(*) INTO v_count FROM APPLICATION_HEADER WHERE case_code = p_case_code;
    IF v_count > 0 THEN
        SELECT NVL(id_vi,0),case_code INTO v_id_tran,v_case_code_trans FROM APPLICATION_HEADER WHERE case_code = p_case_code;
    END IF;

    UPDATE app_lawer SET deleted = 1 WHERE case_code = v_case_code_trans;

    IF v_id_tran > 0 THEN
        UPDATE APPLICATION_HEADER
        SET status = p_status, --pkg_common.APP_STATUS_GRANT_LAWER,
            status_date = p_created_date,
            modify_by = p_created_by,
            notes = p_notes
        WHERE id = v_id_tran;
    END IF;

    SELECT SEQ_APP_LAWER.NEXTVAL into v_id FROM dual;
    INSERT INTO app_lawer
    (
        id, case_code,lawer_id,notes,language_code,created_by,created_date
    )
    VALUES
    (
        v_id, v_case_code_trans,p_lawer_id,p_notes,p_language_code,p_created_by,p_created_date
    );

    p_return := v_id;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_LAWER

-- Start of DDL Script for Package LEGALTECH.PKG_APP_NOTICE_INFO
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_app_notice_info
  IS TYPE tcursor IS ref CURSOR;

PROCEDURE proc_getBy_CaseCode
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_cursor OUT tcursor
);

PROCEDURE proc_getALlBy_CaseCode
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_cursor OUT tcursor
);

PROCEDURE proc_get_number
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_cursor OUT tcursor
);

PROCEDURE Proc_App_Notice_Info_Insert
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_number IN app_notice_info.notice_number % TYPE,
    p_notice_date IN app_notice_info.notice_date % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_notice_url IN app_notice_info.notice_url % TYPE,
    p_notice_trans_url IN app_notice_info.notice_trans_url % TYPE,
    p_result IN app_notice_info.result % TYPE,
    p_accept_date IN app_notice_info.accept_date % TYPE,
    p_exp_date IN app_notice_info.exp_date % TYPE,
    p_accept_url IN app_notice_info.accept_url % TYPE,
    p_reject_reason IN app_notice_info.reject_reason % TYPE,
    p_status IN app_notice_info.status % TYPE,
    p_advise_replies IN app_notice_info.advise_replies % TYPE,
    p_billing_id IN app_notice_info.billing_id % TYPE,
    p_billing_url IN app_notice_info.billing_url % TYPE,
    p_replies_deadline IN app_notice_info.replies_deadline % TYPE,
    p_created_by IN app_notice_info.created_by % TYPE,
    p_note IN VARCHAR2,
    p_return OUT NUMBER
);


PROCEDURE proc_update_status
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_status IN app_notice_info.status % TYPE,
    p_result IN app_notice_info.result % TYPE,
    p_accept_date IN DATE,
    p_note IN VARCHAR2,
    p_modify_by IN app_notice_info.modify_by % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
);

-- admin/khach hang review
PROCEDURE proc_review_accept
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_status IN app_notice_info.status % TYPE,
    p_note IN VARCHAR2,
    p_modify_by IN app_notice_info.modify_by % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
);

-- admin/khach hang review
PROCEDURE proc_review_reject
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_status IN app_notice_info.status % TYPE,
    p_advise_replies IN app_notice_info.advise_replies % TYPE,
    p_advise_replies_trans IN app_notice_info.advise_replies_trans % TYPE,
    p_replies_date IN app_notice_info.replies_date % TYPE,
    p_note IN VARCHAR2,
    p_modify_by IN app_notice_info.modify_by % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE proc_ls_update_deadline
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_status IN app_notice_info.status % TYPE,
    p_replies_date IN app_notice_info.replies_date % TYPE,
    p_next_deadline IN app_notice_info.replies_deadline % TYPE,
    p_replies_url IN app_notice_info.replies_url % TYPE,
    p_note IN VARCHAR2,
    p_modify_by IN app_notice_info.modify_by % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE proc_ls_update_cv_auto
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_cv_answer_url IN app_notice_info.cv_answer_url % TYPE,
    p_modify_by IN app_notice_info.modify_by % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_app_notice_info
IS

PROCEDURE proc_getBy_CaseCode
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_cursor OUT tcursor
)
IS
    v_id NUMBER DEFAULT 0;
    v_count NUMBER;
BEGIN

    -- so lan
    IF p_notice_type != -1 THEN
        SELECT COUNT(*) INTO v_count FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;
    ELSE
        -- so lan
        SELECT COUNT(*) INTO v_count FROM app_notice_info WHERE case_code = p_case_code;
    END IF;

    IF v_count > 0 THEN
        IF p_notice_type != -1 THEN
            SELECT MAX(id) INTO v_id FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;
        ELSE
            SELECT MAX(id) INTO v_id FROM app_notice_info WHERE case_code = p_case_code;
        END IF;
    END IF;

    OPEN p_cursor FOR SELECT * FROM view_notice_app WHERE id = v_id;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_getALlBy_CaseCode
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_cursor OUT tcursor
)
IS
BEGIN

    OPEN p_cursor FOR SELECT * FROM view_notice_app WHERE case_code = p_case_code ORDER BY id DESC;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_get_number
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_cursor OUT tcursor
)
IS
    v_id NUMBER DEFAULT 0;
    v_count NUMBER;
BEGIN

    -- so lan
    SELECT COUNT(*) + 1 INTO v_count FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;

    OPEN p_cursor FOR SELECT v_count AS count_number FROM dual;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE Proc_App_Notice_Info_Insert
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_number IN app_notice_info.notice_number % TYPE,
    p_notice_date IN app_notice_info.notice_date % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_notice_url IN app_notice_info.notice_url % TYPE,
    p_notice_trans_url IN app_notice_info.notice_trans_url % TYPE,
    p_result IN app_notice_info.result % TYPE,
    p_accept_date IN app_notice_info.accept_date % TYPE,
    p_exp_date IN app_notice_info.exp_date % TYPE,
    p_accept_url IN app_notice_info.accept_url % TYPE,
    p_reject_reason IN app_notice_info.reject_reason % TYPE,
    p_status IN app_notice_info.status % TYPE,
    p_advise_replies IN app_notice_info.advise_replies % TYPE,
    p_billing_id IN app_notice_info.billing_id % TYPE,
    p_billing_url IN app_notice_info.billing_url % TYPE,
    p_replies_deadline IN app_notice_info.replies_deadline % TYPE,
    p_created_by IN app_notice_info.created_by % TYPE,
    p_note IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;

    v_count NUMBER;
    v_times NUMBER;
BEGIN

    -- so lan
    SELECT COUNT(*) + 1 INTO v_times FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;

    SELECT seq_APP_NOTICE_INFO.nextval INTO v_id FROM dual;
    INSERT INTO app_notice_info
    (
        id, case_code, notice_number, notice_date, notice_type,times, notice_url,notice_trans_url, result, accept_date, exp_date, accept_url,
        number_result, reject_reason, status, advise_replies,billing_id, billing_url, created_by, created_date, notes, replies_deadline

    )
    VALUES
    (
        v_id, p_case_code, p_notice_number, p_notice_date, p_notice_type,v_times, p_notice_url,p_notice_trans_url, p_result, p_accept_date, p_exp_date, p_accept_url,
        v_times, p_reject_reason, p_status, p_advise_replies,p_billing_id, p_billing_url, p_created_by, SYSDATE, p_note ,p_replies_deadline
    );

    -- update cac ngay thong bao
    IF p_notice_type = pkg_common.NOTICE_TYPE_FORM AND p_result = pkg_common.NOTICE_RESULT_ACCEPT THEN
        UPDATE application_header SET ACCEPT_DATE = p_accept_date WHERE case_code = p_case_code and deleted = 0;

    ELSIF p_notice_type = pkg_common.NOTICE_TYPE_PUBLIC AND p_result = pkg_common.NOTICE_RESULT_ACCEPT THEN
        UPDATE application_header SET PUBLIC_DATE = p_accept_date WHERE case_code = p_case_code and deleted = 0;

    ELSIF p_notice_type = pkg_common.NOTICE_TYPE_CONTENT AND p_result = pkg_common.NOTICE_RESULT_ACCEPT THEN
        UPDATE application_header SET ACCEPT_CONTENT_DATE = p_accept_date WHERE case_code = p_case_code and deleted = 0;

    ELSIF p_notice_type = pkg_common.NOTICE_TYPE_GRANT AND p_result = pkg_common.NOTICE_RESULT_ACCEPT THEN
        UPDATE application_header SET GRANT_DATE = p_accept_date WHERE case_code = p_case_code and deleted = 0;

    ELSIF p_notice_type = pkg_common.NOTICE_TYPE_GRANT_PUBLIC AND p_result = pkg_common.NOTICE_RESULT_ACCEPT THEN
        UPDATE application_header SET GRANT_PUBLIC_DATE = p_accept_date WHERE case_code = p_case_code and deleted = 0;
    END IF;

    -- insert vao todo
    --pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_APP,p_case_code,'VI_VN');

    p_return := v_id;
COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

PROCEDURE proc_update_status
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_status IN app_notice_info.status % TYPE,
    p_result IN app_notice_info.result % TYPE,
    p_accept_date IN DATE,
    p_note IN VARCHAR2,
    p_modify_by IN app_notice_info.modify_by % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    v_count NUMBER;

    v_billing_id NUMBER;
    v_case_code_billing VARCHAR2(50) DEFAULT '';
BEGIN

    -- so lan
    SELECT COUNT(*) INTO v_count FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;
    IF v_count > 0 THEN
        SELECT MAX(id) INTO v_id FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;

        UPDATE app_notice_info SET status = p_status, notes = p_note WHERE id = v_id;
    END IF;

    -- update vao note de dung cho todo
    UPDATE application_header SET notes = p_note WHERE case_code = p_case_code and deleted = 0;

    -- update cac ngay thong bao
    IF TO_CHAR(p_accept_date,'dd/MM/yyyy') <> '01/01/0001' THEN
        IF p_notice_type = pkg_common.NOTICE_TYPE_FORM AND p_result = pkg_common.NOTICE_RESULT_ACCEPT THEN
            UPDATE application_header SET ACCEPT_DATE = p_accept_date WHERE case_code = p_case_code and deleted = 0;

        ELSIF p_notice_type = pkg_common.NOTICE_TYPE_PUBLIC AND p_result = pkg_common.NOTICE_RESULT_ACCEPT THEN
            UPDATE application_header SET PUBLIC_DATE = p_accept_date WHERE case_code = p_case_code and deleted = 0;

        ELSIF p_notice_type = pkg_common.NOTICE_TYPE_CONTENT AND p_result = pkg_common.NOTICE_RESULT_ACCEPT THEN
            UPDATE application_header SET ACCEPT_CONTENT_DATE = p_accept_date WHERE case_code = p_case_code and deleted = 0;

        ELSIF p_notice_type = pkg_common.NOTICE_TYPE_GRANT AND p_result = pkg_common.NOTICE_RESULT_ACCEPT THEN
            UPDATE application_header SET GRANT_DATE = p_accept_date WHERE case_code = p_case_code and deleted = 0;

        ELSIF p_notice_type = pkg_common.NOTICE_TYPE_GRANT_PUBLIC AND p_result = pkg_common.NOTICE_RESULT_ACCEPT THEN
            UPDATE application_header SET GRANT_PUBLIC_DATE = p_accept_date WHERE case_code = p_case_code and deleted = 0;
        END IF;

    END IF;

    -- insert vao todo
    pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_APP,p_case_code,p_language_code);

    -- nu admin duyt thi update thng billing d
    IF p_status = pkg_common.ADMIN_DUYETGUICHOKHACHHANG THEN

        IF v_count > 0 THEN
            SELECT billing_id INTO v_billing_id FROM app_notice_info WHERE id = v_id;

            -- update billing
            UPDATE billing_header SET status = pkg_common.BILLING_H_STATUS_APPROVE,modify_by = p_modify_by, modify_date = SYSDATE
            WHERE billing_id = v_billing_id AND status = pkg_common.BILLING_H_STATUS_REVIEW;

            SELECT COUNT(*) INTO v_count FROM billing_header WHERE billing_id = v_billing_id ;
            IF v_count > 0 THEN

                SELECT case_code INTO v_case_code_billing FROM billing_header WHERE billing_id = v_billing_id ;

                UPDATE B_TODOS SET STATUS = PKG_COMMON.TODO_STATUS_COMPLETED, PROCESSOR_DATE = SYSDATE
                WHERE TYPE = PKG_COMMON.TODO_TYPE_BILLING AND STATUS = PKG_COMMON.TODO_STATUS_REVIEW
                AND CASE_CODE = v_case_code_billing;

            END IF;
        END IF;


    END IF;

    p_return := 1;
COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

-- admin/khach hang review
PROCEDURE proc_review_accept
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_status IN app_notice_info.status % TYPE,
    p_note IN VARCHAR2,
    p_modify_by IN app_notice_info.modify_by % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    v_count NUMBER;

    v_billing_id NUMBER;
    v_case_code_billing VARCHAR2(50) DEFAULT '';
BEGIN

    -- so lan
    SELECT COUNT(*) INTO v_count FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;
    IF v_count > 0 THEN
        SELECT MAX(id) INTO v_id FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;

        UPDATE app_notice_info SET
            status = p_status,
            modify_by = p_modify_by,
            modify_date = SYSDATE,
            notes = p_note
        WHERE id = v_id;
    END IF;

    -- update vao note de dung cho todo
    UPDATE application_header SET notes = p_note WHERE case_code = p_case_code and deleted = 0;

    -- insert vao todo
    pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_APP,p_case_code,p_language_code);

    -- nu admin duyt thi update thng billing d
    IF p_status = pkg_common.ADMIN_DUYETGUICHOKHACHHANG THEN

        IF v_count > 0 THEN
            SELECT billing_id INTO v_billing_id FROM app_notice_info WHERE id = v_id;

            -- update billing
            UPDATE billing_header SET status = pkg_common.BILLING_H_STATUS_APPROVE,modify_by = p_modify_by, modify_date = SYSDATE
            WHERE billing_id = v_billing_id AND status = pkg_common.BILLING_H_STATUS_REVIEW;

            SELECT COUNT(*) INTO v_count FROM billing_header WHERE billing_id = v_billing_id ;
            IF v_count > 0 THEN

                SELECT case_code INTO v_case_code_billing FROM billing_header WHERE billing_id = v_billing_id ;

                UPDATE B_TODOS SET STATUS = PKG_COMMON.TODO_STATUS_COMPLETED, PROCESSOR_DATE = SYSDATE
                WHERE TYPE = PKG_COMMON.TODO_TYPE_BILLING AND STATUS = PKG_COMMON.TODO_STATUS_REVIEW
                AND CASE_CODE = v_case_code_billing;

            END IF;
        END IF;


    END IF;

    p_return := 1;
COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

-- admin/khach hang review
PROCEDURE proc_review_reject
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_status IN app_notice_info.status % TYPE,
    p_advise_replies IN app_notice_info.advise_replies % TYPE,
    p_advise_replies_trans IN app_notice_info.advise_replies_trans % TYPE,
    p_replies_date IN app_notice_info.replies_date % TYPE,
    p_note IN VARCHAR2,
    p_modify_by IN app_notice_info.modify_by % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    v_count NUMBER;

    v_billing_id NUMBER;
    v_case_code_billing VARCHAR2(50) DEFAULT '';
BEGIN

    -- so lan
    SELECT COUNT(*) INTO v_count FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;
    IF v_count > 0 THEN
        SELECT MAX(id) INTO v_id FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;

        UPDATE app_notice_info SET
            status = p_status,
            advise_replies = p_advise_replies,
            advise_replies_trans = p_advise_replies_trans,
            replies_date = DECODE(TO_CHAR(p_replies_date,'dd/mm/yyyy'), NULL, replies_date, '01/01/0001', replies_date, TRUNC(p_replies_date)),
            modify_by = p_modify_by,
            modify_date = SYSDATE,
            notes = p_note
        WHERE id = v_id;
    END IF;

    -- update vao note de dung cho todo
    UPDATE application_header SET notes = p_note WHERE case_code = p_case_code and deleted = 0;

    -- insert vao todo
    pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_APP,p_case_code,p_language_code);

    -- nu admin duyt thi update thng billing d
    IF p_status = pkg_common.ADMIN_DUYETGUICHOKHACHHANG THEN

        IF v_count > 0 THEN
            SELECT billing_id INTO v_billing_id FROM app_notice_info WHERE id = v_id;

            -- update billing
            UPDATE billing_header SET status = pkg_common.BILLING_H_STATUS_APPROVE,modify_by = p_modify_by, modify_date = SYSDATE
            WHERE billing_id = v_billing_id AND status = pkg_common.BILLING_H_STATUS_REVIEW;

            SELECT COUNT(*) INTO v_count FROM billing_header WHERE billing_id = v_billing_id ;
            IF v_count > 0 THEN

                SELECT case_code INTO v_case_code_billing FROM billing_header WHERE billing_id = v_billing_id ;

                UPDATE B_TODOS SET STATUS = PKG_COMMON.TODO_STATUS_COMPLETED, PROCESSOR_DATE = SYSDATE
                WHERE TYPE = PKG_COMMON.TODO_TYPE_BILLING AND STATUS = PKG_COMMON.TODO_STATUS_REVIEW
                AND CASE_CODE = v_case_code_billing;

            END IF;
        END IF;


    END IF;

    p_return := 1;
COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

-- lut su update deadline
PROCEDURE proc_ls_update_deadline
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_status IN app_notice_info.status % TYPE,
    p_replies_date IN app_notice_info.replies_date % TYPE,
    p_next_deadline IN app_notice_info.replies_deadline % TYPE,
    p_replies_url IN app_notice_info.replies_url % TYPE,
    p_note IN VARCHAR2,
    p_modify_by IN app_notice_info.modify_by % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    v_count NUMBER;

    v_billing_id NUMBER;
    v_case_code_billing VARCHAR2(50) DEFAULT '';
BEGIN

    -- so lan
    SELECT COUNT(*) INTO v_count FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;
    IF v_count > 0 THEN
        SELECT MAX(id) INTO v_id FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;

        UPDATE app_notice_info SET
            status = p_status,
            replies_date = p_replies_date,
            replies_deadline = p_next_deadline,
            replies_url = p_replies_url,
            modify_by = p_modify_by,
            modify_date = SYSDATE,
            notes = p_note
        WHERE id = v_id;
    END IF;

    -- update vao note de dung cho todo
    UPDATE application_header SET notes = p_note WHERE case_code = p_case_code and deleted = 0;

    -- insert vao todo
    pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_APP,p_case_code,p_language_code);

    -- nu admin duyt thi update thng billing d
    IF p_status = pkg_common.ADMIN_DUYETGUICHOKHACHHANG THEN

        IF v_count > 0 THEN
            SELECT billing_id INTO v_billing_id FROM app_notice_info WHERE id = v_id;

            -- update billing
            UPDATE billing_header SET status = pkg_common.BILLING_H_STATUS_APPROVE,modify_by = p_modify_by, modify_date = SYSDATE
            WHERE billing_id = v_billing_id AND status = pkg_common.BILLING_H_STATUS_REVIEW;

            SELECT COUNT(*) INTO v_count FROM billing_header WHERE billing_id = v_billing_id ;
            IF v_count > 0 THEN

                SELECT case_code INTO v_case_code_billing FROM billing_header WHERE billing_id = v_billing_id ;

                UPDATE B_TODOS SET STATUS = PKG_COMMON.TODO_STATUS_COMPLETED, PROCESSOR_DATE = SYSDATE
                WHERE TYPE = PKG_COMMON.TODO_TYPE_BILLING AND STATUS = PKG_COMMON.TODO_STATUS_REVIEW
                AND CASE_CODE = v_case_code_billing;

            END IF;
        END IF;


    END IF;

    p_return := 1;
COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

-- update file cng van tr li cc t dng h thng kt xut ra
PROCEDURE proc_ls_update_cv_auto
(
    p_case_code IN app_notice_info.case_code % TYPE,
    p_notice_type IN app_notice_info.notice_type % TYPE,
    p_cv_answer_url IN app_notice_info.cv_answer_url % TYPE,
    p_modify_by IN app_notice_info.modify_by % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    v_count NUMBER;

    v_billing_id NUMBER;
    v_case_code_billing VARCHAR2(50) DEFAULT '';
BEGIN

    -- so lan
    SELECT COUNT(*) INTO v_count FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;
    IF v_count > 0 THEN
        SELECT MAX(id) INTO v_id FROM app_notice_info WHERE case_code = p_case_code AND notice_type = p_notice_type;

        UPDATE app_notice_info SET
            cv_answer_url = p_cv_answer_url,
            modify_by = p_modify_by,
            modify_date = SYSDATE
        WHERE id = v_id;
    END IF;


    p_return := 1;
COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APP_NOTICE_INFO

-- Start of DDL Script for Package LEGALTECH.PKG_APPCLASS_DETAIL
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_appclass_detail
  IS

PROCEDURE PROC_APP_CLASS_DETAIL_INSERT
(

    P_TEXTINPUT IN APP_CLASS_DETAIL.TEXTINPUT % TYPE,
    P_CODE IN APP_CLASS_DETAIL.CODE % TYPE ,
    P_APP_HEADER_ID IN NUMBER ,
    P_LANGUAGE_CODE IN VARCHAR2 ,
    P_IDREF IN NUMBER ,
    P_RETURN OUT NUMBER
);
PROCEDURE PROC_APP_CLASS_DETAIL_DELETE
(

    P_APP_HEADER_ID IN NUMBER ,
    P_LANGUAGE_CODE IN VARCHAR2 ,
    P_RETURN OUT NUMBER
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_appclass_detail
IS

PROCEDURE PROC_APP_CLASS_DETAIL_INSERT
(

    P_TEXTINPUT IN APP_CLASS_DETAIL.TEXTINPUT % TYPE,
    P_CODE IN APP_CLASS_DETAIL.CODE % TYPE ,
    P_APP_HEADER_ID IN NUMBER ,
    P_LANGUAGE_CODE IN VARCHAR2 ,
    p_idref IN NUMBER ,
    P_RETURN OUT NUMBER
)
IS
V_ID NUMBER := 0 ;

BEGIN
    P_RETURN:= 0;
    SELECT SEQ_APP_CLASS_DETAIL.NEXTVAL INTO V_ID FROM DUAL;
    INSERT INTO APP_CLASS_DETAIL
    (
        ID, TEXTINPUT, CODE ,  APP_HEADER_ID  ,language_code ,idref
    )
    VALUES
    (
        V_ID, P_TEXTINPUT, P_CODE ,P_APP_HEADER_ID ,P_LANGUAGE_CODE,p_idref
    );

--KHONG COMMIT INSERT BATH
EXCEPTION WHEN OTHERS THEN
RAISE;
  P_RETURN:= PKG_COMMON.ERROR ;
END;



PROCEDURE PROC_APP_CLASS_DETAIL_DELETE
(

    P_APP_HEADER_ID IN NUMBER ,
    P_LANGUAGE_CODE IN VARCHAR2 ,
    P_RETURN OUT NUMBER
)
IS
BEGIN

     /*IF(P_LANGUAGE_CODE = PKG_COMMON.VI_VN)THEN
        DELETE APP_CLASS_DETAIL WHERE  APP_HEADER_ID = P_APP_HEADER_ID ;
     ELSE
        DELETE APP_CLASS_DETAIL WHERE  APP_HEADER_ID = P_APP_HEADER_ID AND language_code =P_LANGUAGE_CODE ;
     END IF  ;*/

    DELETE APP_CLASS_DETAIL WHERE  APP_HEADER_ID = P_APP_HEADER_ID ;
    P_RETURN:= 0 ;

--KHONG COMMIT INSERT BATH
EXCEPTION WHEN OTHERS THEN
RAISE;
  P_RETURN:= -99 ;
END;

   -- ENTER FURTHER CODE BELOW AS SPECIFIED IN THE PACKAGE SPEC.
END;
/


-- End of DDL Script for Package LEGALTECH.PKG_APPCLASS_DETAIL

-- Start of DDL Script for Package LEGALTECH.PKG_COMMON
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_common
  IS

TYPE t_cursor IS ref CURSOR ;

GROUP_ID_CUSTOMER_DEFAULT CONSTANT NUMBER(5) := 3;

COUNTRY_VN CONSTANT NUMBER(5) := 234;
CURRENCY_VND CONSTANT VARCHAR2(5) := 'VND';
CURRENCY_USD CONSTANT VARCHAR2(5) := 'USD';

-- trang thai nguoi dung
-- luu trong allcode voi cdname='USER_STATUS'
USER_STATUS_STOPPED CONSTANT NUMBER(1) := 0 ;
USER_STATUS_ACTIVE CONSTANT NUMBER(1) := 1;

USER_TYPE_SUPPER_ADMIN CONSTANT NUMBER(1) := 0;
USER_TYPE_ADMIN CONSTANT NUMBER(1) := 1;
USER_TYPE_LAWER CONSTANT NUMBER(1) := 2;
USER_TYPE_CUSTOMER CONSTANT NUMBER(1) := 3;
USER_TYPE_EMPOYEE CONSTANT NUMBER(1) := 4;

-- loai chuc nang
-- luu trong allcode voi cdname='FUNCTION_TYPE'
FN_NO_REQUIRED_LOGIN CONSTANT NUMBER(1) := 0;
FN_MENU CONSTANT NUMBER(1) := 1;
FN_INNER CONSTANT NUMBER(1) := 2;
FN_IMMEDIATE_SELF CONSTANT NUMBER(1) := 3;

-- Loai gia su dung luu trong allcode voi cdname='UNIT_PRICE_TYPE'
UNIT_PRICE_TYPE_M CONSTANT CHAR(1) := 'M';
UNIT_PRICE_TYPE_G CONSTANT CHAR(1) := 'G';

-- Gioi tinh luu trong allcode voi cdname='SEX_TYPE'
MALE CONSTANT CHAR(1) := 'M';
FEMALE CONSTANT CHAR(1) := 'F';

--MA LOI TRA VE
ERROR NUMBER :=-99 ;
SUCESS NUMBER :=0 ;

--NGON NGU HIEN THI
VI_VN VARCHAR2(5) :='VI_VN' ;
EN_US VARCHAR2(5) :='EN_US' ;

DELETED NUMBER :=1 ;

USER_ADMIN VARCHAR2(5) :='admin' ;
USER_SUPPER_ADMIN VARCHAR2(20) := 'SuperAdmin' ;
DEFAULT_LAWER VARCHAR2(5) :='LAWER';
DEFAULT_CUSTOMER VARCHAR2(10) :='CUSTOMER';
DEFAULT_PROCESOR VARCHAR2(10) :='DEFAULT';


-- TIME SHEET
TIME_SHEET_STATUS_NEW CONSTANT NUMBER(1) := 0;
TIME_SHEET_STATUS_APPROVE CONSTANT NUMBER(1) := 1;
TIME_SHEET_STATUS_REJECT CONSTANT NUMBER(1) := 2;

TIME_SHEET_TYPE_APP CONSTANT NUMBER(1) := 1;
TIME_SHEET_TYPE_SEARCH CONSTANT NUMBER(1) := 2;
TIME_SHEET_TYPE_QUESTION CONSTANT NUMBER(1) := 3;

-- FEE
APP_FEE_STATUS_NOT_USE CONSTANT NUMBER(1) := 0;
APP_FEE_STATUS_USE CONSTANT NUMBER(1) := 1;

-- APP STATUS
APP_STATUS_HISTORY CONSTANT NUMBER(1) := -2;              -- du lieu qua khu
APP_STATUS_SAVE_TEMP CONSTANT NUMBER(1) := 1;             -- Luu tam
APP_STATUS_WAIT_GRANT_ADMIN CONSTANT NUMBER(1) := 2;      -- da gui cho phan loai cho admin
APP_STATUS_WAIT_GRANT_LAWER CONSTANT NUMBER(1) := 3;      -- cho phan loai cho ls
APP_STATUS_GRANT_LAWER CONSTANT NUMBER(1) := 4;           -- da phan loai, cho LS phan hoi
APP_STATUS_LAWER_CONFIRMED CONSTANT NUMBER(1) := 5;       -- LS DA CONFIRM
APP_STATUS_WAIT_KH_CONFIRM CONSTANT NUMBER(1) := 6;       -- CHO KHACH HANG CONFIRM
APP_STATUS_KH_CONFIRMED CONSTANT NUMBER(1) := 7;          -- KHACH HANG DA CONFIRM
APP_STATUS_KH_REJECT CONSTANT NUMBER(1) := 8;             -- KHACH HANG TU CHOI
APP_STATUS_GRANT_EMPLOYEE CONSTANT NUMBER(1) := 9;        -- DA PHAN LOAI CHO NHAN VIEN
APP_STATUS_DANOPDON CONSTANT NUMBER(2) := 10;             -- NHAN VIEN DA NOP DON
APP_STATUS_ADVICE_FILING CONSTANT NUMBER(2) := 11;        -- LUAT SU ADVICE FILING XONG
APP_STATUS_GUIKETQUA_ADVICE CONSTANT NUMBER(2) := 12;     -- ADMIN GUI KET QUA CHO KHACH HANG
APP_STATUS_ADMIN_REJECT_ADVICE CONSTANT NUMBER(2) := 13;  -- ADMIN REJECT ADVICE FILLING CUA LUAT SU

--- SAU ADVISE
CUSTOMER_REVIEW_ADVISE CONSTANT NUMBER(2) := 14;          -- KHACH HANG REIEW_ADVISE
CHAPNHAN_THONGBAO_HINHTHUC CONSTANT NUMBER(2) := 15;       -- CHAP NHAN THONG BAO HINH THUC
TUCHOI_THONGBAO_HINHTHUC CONSTANT NUMBER(2) := 16;         -- TU CHOI THONG BAO HINH THUC

CONGBO_DON CONSTANT NUMBER(2) := 17;                      -- CONG BO DON
CHAPNHAN_THONGBAO_NOIDUNG CONSTANT NUMBER(2) := 18;       -- CHAP NHAN THONG BAO NOI DUNG
TUCHOI_THONGBAO_NOIDUNG CONSTANT NUMBER(2) := 19;         -- TU CHOI THONG BAO NOI DUNG
THONGBAO_CAPBANG CONSTANT NUMBER(2) := 20;                -- THONG BAO CAP BANG
CONGBO_BANG CONSTANT NUMBER(2) := 20;                     -- CONG BO BANG

------ SUB STATUS
CUC_TRALOI CONSTANT NUMBER(1) := 0;                       -- CUC TRA LOI
LUATSU_GUICHOADMINDUYET CONSTANT NUMBER(1) := 1;          -- LS UPDATE KET QUA CHO ADMIN DUYET
ADMIN_DUYETGUICHOKHACHHANG CONSTANT NUMBER(1) := 2;       -- ADMIN DUYET VA GUI CHO KHACH HANG
ADMIN_TUCHOIDUYET CONSTANT NUMBER(1) := 3;                -- ADMIN DUYET VA GUI CHO KHACH HANG
KHACHHANG_REVIEW_TRALOI CONSTANT NUMBER(1) := 4;          -- KH REVIEW TRA LOI
LUATSU_DICHTRALOICUC CONSTANT NUMBER(1) := 5;             -- LS DICH XONG THI GUI ADMIN
ADMIN_DUYET_TRALOICUC CONSTANT NUMBER(1) := 6;            -- ADMIN DUYET TRA LOI CUC
ADMIN_TUCHOI_TRALOICUC CONSTANT NUMBER(1) := 7;           -- ADMIN TU CHOI DUYET TRA LOI CUC
LUATSU_UPDATE_TB CONSTANT NUMBER(1) := 8;                 -- LS THONG BAO TRA LO CHO KH

-- NOTICE_TYPE
NOTICE_TYPE_FORM CONSTANT NUMBER(1) := 1;                 -- HINH THUC
NOTICE_TYPE_PUBLIC CONSTANT NUMBER(1) := 2;               -- CONG BO
NOTICE_TYPE_CONTENT CONSTANT NUMBER(1) := 3;              -- NOI DUNG
NOTICE_TYPE_GRANT CONSTANT NUMBER(1) := 4;                -- CAP BANG
NOTICE_TYPE_GRANT_PUBLIC CONSTANT NUMBER(1) := 5;         -- CONG BO BANG

-- NOTICE_RESULT
NOTICE_RESULT_ACCEPT CONSTANT NUMBER(1) := 1;             -- CHAP NHAN
NOTICE_RESULT_REJECT CONSTANT NUMBER(1) := 2;             -- TU CHOI

-- SEARCH STATUS
SEARCH_STATUS_NEW CONSTANT NUMBER(1) := 1;                  -- MOI GUI CHO PHAN LOAI CHO LUAT SU
SEARCH_STATUS_GRANT_LAWER CONSTANT NUMBER(1) := 2;          -- DA PHAN LOAI CHO LUAT SU, CHO LUAT SU TRA LOI
SEARCH_STATUS_LAWER_CONFIRMED  CONSTANT NUMBER(1) := 3;     -- LUAT SU DA TRA LOI, CHO ADMIN DUYET
SEARCH_STATUS_ADMIN_CONFIRMED CONSTANT NUMBER(1) := 4;      -- ADMIN DA CONFIRM VA GUI KET QUA CHO KHACH HANG

-- WIKI
WIKI_STATUS_NEW CONSTANT NUMBER(1) := 2;        -- CHO DUYET
WIKI_STATUS_REJECT CONSTANT NUMBER(1) := 4;    -- DA TU CHOI


-- register info
REGISTER_STATUS_NEW CONSTANT NUMBER(1) := 0;        -- cho xu ly
REGISTER_STATUS_PROCESSED CONSTANT NUMBER(1) := 1;    -- da xu ly

-- TODO TYPE
TODO_TYPE_APP CONSTANT NUMBER(1) := 1;
TODO_TYPE_QUESTION CONSTANT NUMBER(1) := 2;
TODO_TYPE_SEARCH CONSTANT NUMBER(1) := 3;
TODO_TYPE_TIMESHEET CONSTANT NUMBER(1) := 4;
TODO_TYPE_BILLING CONSTANT NUMBER(1) := 5;

TODO_TYPE_WIKI CONSTANT NUMBER(1) := 6;

TODO_TYPE_REGISTER CONSTANT NUMBER(1) := 7;

-- TODO STATUS
TODO_STATUS_REVIEW CONSTANT NUMBER(1) := 0;
TODO_STATUS_COMPLETED CONSTANT NUMBER(1) := 1;

-- DOCKING
DOCKING_STATUS_WAIT_ORIGINAL CONSTANT NUMBER(1) := 1;
DOCKING_STATUS_WAIT_TRANSLATE CONSTANT NUMBER(1) := 2;
DOCKING_STATUS_COMPLETED CONSTANT NUMBER(1) := 3;


-- REMIND STATUS
REMIND_STATUS_NEW CONSTANT NUMBER(1) := 0;
REMIND_STATUS_REVIEW CONSTANT NUMBER(1) := 1;
REMIND_STATUS_COMPLETED CONSTANT NUMBER(1) := 2;

-- RIMIND TYPE
REMIND_TYPE_APP CONSTANT NUMBER(1) := 1;
REMIND_TYPE_DOC CONSTANT NUMBER(1) := 2;
REMIND_TYPE_BILL CONSTANT NUMBER(1) := 3;


-- BILLING
BILLING_TYPE_APP CONSTANT NUMBER(1) := 1;
BILLING_TYPE_SEARCH CONSTANT NUMBER(1) := 2;
BILLING_TYPE_QUESTION CONSTANT NUMBER(1) := 2;

BILLING_DETAIL_TYPE_APP CONSTANT NUMBER(1) := 1;
BILLING_DETAIL_TYPE_TIMESHEET CONSTANT NUMBER(1) := 2;
BILLING_DETAIL_TYPE_SERVICE CONSTANT NUMBER(1) := 3;
BILLING_DETAIL_TYPE_SEARCH CONSTANT NUMBER(1) := 4;
BILLING_DETAIL_TYPE_OTHERS CONSTANT NUMBER(1) := 5;

BILLING_H_STATUS_REVIEW CONSTANT NUMBER(1) := 1;
BILLING_H_STATUS_APPROVE CONSTANT NUMBER(1) := 2;
BILLING_H_STATUS_REJECT CONSTANT NUMBER(1) := 3;

BILLING_P_STATUS_PAYMENT CONSTANT NUMBER(1) := 1;
BILLING_P_STATUS_PAID CONSTANT NUMBER(1) := 2;

---WIKI STATUS


END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_common
IS


END;
/


-- End of DDL Script for Package LEGALTECH.PKG_COMMON

-- Start of DDL Script for Package LEGALTECH.PKG_BILLING
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_billing
    IS TYPE TCURSOR IS REF CURSOR;

PROCEDURE proc_biling_search
(
    p_user_name IN VARCHAR2,
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);

PROCEDURE proc_billing_getall
(
    p_cursor out tcursor
);

PROCEDURE proc_get_casecode
(
    p_return OUT VARCHAR2
);

PROCEDURE proc_billing_delete
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_language_code IN billing_header.language_code % TYPE,
    p_modify_by IN billing_header.modify_by % TYPE,
    p_modify_date IN billing_header.modify_date % TYPE,
    p_return OUT NUMBER
);

PROCEDURE proc_billing_getbyid
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_app_case_code IN VARCHAR2 ,
    p_language_code IN VARCHAR2 ,
    p_cursor out tcursor,
    p_cursor_detail OUT pkg_common.t_cursor,
    p_cursor_header OUT pkg_common.t_cursor
);

PROCEDURE proc_billing_getbycode
(
    p_case_code IN billing_header.CASE_CODE % TYPE,
    p_language_code IN VARCHAR2 ,
    p_cursor out tcursor,
    p_cursor_detail OUT pkg_common.t_cursor,
    p_cursor_header OUT pkg_common.t_cursor
);

PROCEDURE Proc_Billing_Header_Insert
(
    p_case_code IN billing_header.case_code % TYPE,
    p_billing_type IN billing_header.billing_type % TYPE,
    p_app_case_code IN billing_header.app_case_code % TYPE,
    p_billing_date IN billing_header.billing_date % TYPE,
    p_deadline IN billing_header.deadline % TYPE,
    p_request_by IN billing_header.request_by % TYPE,
    p_approve_by IN billing_header.approve_by % TYPE,
    p_status IN billing_header.status % TYPE,
    p_total_pre_tex IN billing_header.total_pre_tex % TYPE,
    p_tex_fee IN billing_header.tex_fee % TYPE,
    p_total_amount IN billing_header.total_amount % TYPE,
    p_currency IN billing_header.currency % TYPE,
    p_currency_rate IN billing_header.currency_rate % TYPE,
    --p_total_foeign IN billing_header.total_foeign % TYPE,
    p_created_by IN billing_header.created_by % TYPE,
    p_created_date IN billing_header.created_date % TYPE,
    p_language_code IN billing_header.language_code % TYPE,
    p_notes IN VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE Proc_Billing_Detail_Insert
(
    p_billing_id IN billing_detail.billing_id % TYPE,
    p_biling_detail_name IN billing_detail.biling_detail_name % TYPE,
    p_ref_id IN NUMBER,
    p_type IN billing_detail.type % TYPE,
    p_nation_fee IN billing_detail.nation_fee % TYPE,
    p_represent_fee IN billing_detail.represent_fee % TYPE,
    p_service_fee IN billing_detail.service_fee % TYPE,
    p_return OUT NUMBER
);

PROCEDURE proc_billing_header_update
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_billing_date IN billing_header.billing_date % TYPE,
    p_deadline IN billing_header.deadline % TYPE,
    p_total_pre_tex IN billing_header.total_pre_tex % TYPE,
    p_tex_fee IN billing_header.tex_fee % TYPE,
    p_total_amount IN billing_header.total_amount % TYPE,
    p_currency IN billing_header.currency % TYPE,
    p_currency_rate IN billing_header.currency_rate % TYPE,
    --p_total_foeign IN billing_header.total_foeign % TYPE,
    p_modify_by IN billing_header.modify_by % TYPE,
    p_modify_date IN billing_header.modify_date % TYPE,
    p_language_code IN billing_header.language_code % TYPE,
    p_return OUT NUMBER
);

PROCEDURE proc_billing_updateStatus
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_language_code IN billing_header.language_code % TYPE,
    p_status IN billing_header.status % TYPE,
    p_modify_by IN billing_header.modify_by % TYPE,
    p_modify_date IN billing_header.modify_date % TYPE,
    p_return OUT NUMBER
);

PROCEDURE proc_billing_update_payStatus
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_language_code IN billing_header.language_code % TYPE,
    p_status IN billing_header.status % TYPE,
    p_modify_by IN billing_header.modify_by % TYPE,
    p_modify_date IN billing_header.modify_date % TYPE,
    p_return OUT NUMBER
);

PROCEDURE proc_delete_detail
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_return OUT NUMBER
);

PROCEDURE proc_get_billing_detail
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_app_case_code IN VARCHAR2 ,
    p_language_code IN VARCHAR2 ,
    p_cursor_detail out tcursor
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_billing
IS

PROCEDURE proc_biling_search
(
    p_user_name IN VARCHAR2,
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_PAY_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_APP_CASE_CODE VARCHAR2(50) DEFAULT 'ALL';
    V_LAWER VARCHAR2(100) DEFAULT 'ALL';
    V_CUSTOMER VARCHAR2(500) DEFAULT 'ALL';

    V_DOCKING_TYPE VARCHAR2(3) DEFAULT 'ALL';
    V_DOCUMENT_TYPE VARCHAR2(3) DEFAULT 'ALL';

    V_FROM NUMBER ;
    V_TO NUMBER;

    v_count NUMBER;
    v_user_type NUMBER;
BEGIN

    SELECT COUNT(*) INTO v_count FROM s_users s WHERE s.username = p_user_name AND s.deleted = 0;
    IF v_count = 0 THEN
        OPEN P_CURSOR FOR
        SELECT  A.* FROM VIEW_BILLING_HEADER A WHERE  1 = 0;
        RETURN;
    END IF;

    -- khng cho php khch v nhn vin x l xem billing
    IF v_user_type = pkg_common.USER_TYPE_EMPOYEE OR v_user_type = pkg_common.USER_TYPE_CUSTOMER THEN
        OPEN P_CURSOR FOR
        SELECT  A.* FROM VIEW_BILLING_HEADER A WHERE  1 = 0;
        RETURN;
    END IF;

    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_APP_CASE_CODE := ITEM.CONDITION;
        ELSIF V_INDEX = 1 THEN
            V_LAWER := ITEM.CONDITION;
        ELSIF V_INDEX = 2 THEN
            V_CUSTOMER := ITEM.CONDITION;
        ELSIF V_INDEX = 3 THEN
            V_STATUS := ITEM.CONDITION;
        ELSIF V_INDEX = 4 THEN
            V_PAY_STATUS := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;

    IF V_APP_CASE_CODE <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.APP_CASE_CODE) LIKE ''%' || UPPER(V_APP_CASE_CODE) || '%'' ';
    END IF;

    IF V_LAWER <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.LAWER_NAME) LIKE ''%' || UPPER(V_LAWER) || '%'' ';
    END IF;

    IF V_STATUS <> 'ALL' THEN
        V_CONDITION := V_CONDITION || ' AND A.STATUS = ' || V_STATUS;
    END IF;

    IF V_PAY_STATUS <> 'ALL' THEN
        V_CONDITION := V_CONDITION || ' AND A.PAY_STATUS = ' || V_PAY_STATUS;
    END IF;

    -- ly thng tin user type
    SELECT s.TYPE INTO v_user_type FROM s_users s WHERE s.username = p_user_name AND s.deleted = 0;
    IF v_user_type = pkg_common.USER_TYPE_LAWER THEN
        V_CONDITION :=  V_CONDITION || ' AND A.REQUEST_BY = ''' || p_user_name || '''';
    END IF;

    V_SQL := 'SELECT  A.* FROM VIEW_BILLING_HEADER A WHERE 1 = 1 ';
    V_SQL :=  V_SQL || V_CONDITION;

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.BILLING_ID DESC';
    END IF;

    DBMS_OUTPUT.PUT_LINE(V_SQL);


    V_TOTAL_COUNT := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_TOTAL_COUNT INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;

    --PKG_LOG.LOGMSGALL(V_SQL);


    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_billing_getall
(
    p_cursor out tcursor
)
IS
BEGIN
    OPEN p_cursor FOR SELECT * FROM VIEW_BILLING_HEADER ORDER BY billing_id DESC;
END;

PROCEDURE proc_billing_getbyid
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_app_case_code IN VARCHAR2 ,
    p_language_code IN VARCHAR2 ,
    p_cursor out tcursor,
    p_cursor_detail OUT pkg_common.t_cursor,
    p_cursor_header OUT pkg_common.t_cursor
)
IS
    --v_app_case_code VARCHAR2(50) DEFAULT '';
BEGIN
    --SELECT app_case_code INTO v_app_case_code FROM billing_header WHERE billing_id = p_billing_id AND language_code = p_language_code;

    OPEN P_CURSOR FOR
        SELECT * FROM VIEW_BILLING_HEADER WHERE billing_id = p_billing_id ;--AND language_code = p_language_code;

    OPEN p_cursor_detail FOR
        SELECT * FROM billing_detail
        WHERE billing_id = p_billing_id AND (nation_fee > 0 OR represent_fee > 0 OR service_fee > 0) ORDER BY BILLING_DETAIL_ID;

    IF INSTR(p_app_case_code,'SEARCH') > 0 THEN
        OPEN p_cursor_header FOR
            SELECT * FROM view_search
            WHERE case_code = p_app_case_code;
    ELSE
        OPEN p_cursor_header FOR
            SELECT * FROM view_app_header
            WHERE case_code = p_app_case_code AND ROWNUM = 1;-- AND languague_code = p_language_code;

    END IF ;



EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_billing_getbycode
(
    p_case_code IN billing_header.CASE_CODE % TYPE,
    p_language_code IN VARCHAR2 ,
    p_cursor out tcursor,
    p_cursor_detail OUT pkg_common.t_cursor,
    p_cursor_header OUT pkg_common.t_cursor
)
IS
    v_app_case_code VARCHAR2(50) DEFAULT '';
    v_billing_id NUMBER;
BEGIN
    SELECT app_case_code,billing_id INTO v_app_case_code,v_billing_id
    FROM billing_header WHERE CASE_CODE = p_case_code ;--AND language_code = p_language_code;

    OPEN P_CURSOR FOR
        SELECT * FROM VIEW_BILLING_HEADER WHERE CASE_CODE = p_case_code ;--AND language_code = p_language_code;

    OPEN p_cursor_detail FOR
        SELECT * FROM billing_detail
        WHERE billing_id = v_billing_id AND (nation_fee > 0 OR represent_fee > 0 OR service_fee > 0) ORDER BY BILLING_DETAIL_ID;

    IF INSTR(v_app_case_code,'SEARCH') > 0 THEN
        OPEN p_cursor_header FOR
            SELECT * FROM view_search
            WHERE case_code = v_app_case_code;
    ELSE
        OPEN p_cursor_header FOR
        SELECT * FROM view_app_header
        WHERE case_code = v_app_case_code AND ROWNUM = 1;-- AND languague_code = p_language_code;
    END IF ;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_get_casecode
(
    p_return OUT VARCHAR2
)
IS
    V_ID_CASE_CODE NUMBER;
    V_CASE_CODE VARCHAR2(50) DEFAULT '';
BEGIN

    SELECT SEQ_GENCODE.NEXTVAL INTO V_ID_CASE_CODE FROM DUAL;

    V_CASE_CODE := 'BILL' || to_char(SYSDATE,'yyyyMMdd') || V_ID_CASE_CODE;
    p_return := V_CASE_CODE;

EXCEPTION
WHEN OTHERS THEN
    p_return := '';
    RAISE;
END;

PROCEDURE Proc_Billing_Header_Insert
(
    p_case_code IN billing_header.case_code % TYPE,
    p_billing_type IN billing_header.billing_type % TYPE,
    p_app_case_code IN billing_header.app_case_code % TYPE,
    p_billing_date IN billing_header.billing_date % TYPE,
    p_deadline IN billing_header.deadline % TYPE,
    p_request_by IN billing_header.request_by % TYPE,
    p_approve_by IN billing_header.approve_by % TYPE,
    p_status IN billing_header.status % TYPE,
    p_total_pre_tex IN billing_header.total_pre_tex % TYPE,
    p_tex_fee IN billing_header.tex_fee % TYPE,
    p_total_amount IN billing_header.total_amount % TYPE,
    p_currency IN billing_header.currency % TYPE,
    p_currency_rate IN billing_header.currency_rate % TYPE,
    --p_total_foeign IN billing_header.total_foeign % TYPE,
    p_created_by IN billing_header.created_by % TYPE,
    p_created_date IN billing_header.created_date % TYPE,
    p_language_code IN billing_header.language_code % TYPE,
    p_notes IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;

    V_ID_CASE_CODE NUMBER;
    V_CASE_CODE VARCHAR2(50) DEFAULT '';
BEGIN

    IF LENGTH(p_case_code) = 0 THEN
        SELECT SEQ_GENCODE.NEXTVAL INTO V_ID_CASE_CODE FROM DUAL;
        V_CASE_CODE := 'BILL' || to_char(SYSDATE,'yyyyMMdd') || V_ID_CASE_CODE;
    ELSE
        V_CASE_CODE := p_case_code;
    END IF;

    SELECT seq_BILLING_HEADER.nextval INTO v_id FROM dual;
    INSERT INTO billing_header
    (
        billing_id, case_code, billing_type, app_case_code, billing_date, deadline, request_by, approve_by, status,
        total_pre_tex, tex_fee, total_amount, currency, currency_rate, created_by, created_date, language_code, notes

    )
    VALUES
    (
        v_id, V_CASE_CODE, p_billing_type, p_app_case_code, p_billing_date, p_deadline, p_request_by, p_approve_by, p_status,
        p_total_pre_tex, p_tex_fee, p_total_amount, p_currency, p_currency_rate, p_created_by, p_created_date, p_language_code, p_notes
    );

    -- insert todo
    pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_BILLING,p_case_code,p_language_code);

    p_return := v_id;

EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

PROCEDURE proc_billing_header_update
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_billing_date IN billing_header.billing_date % TYPE,
    p_deadline IN billing_header.deadline % TYPE,
    p_total_pre_tex IN billing_header.total_pre_tex % TYPE,
    p_tex_fee IN billing_header.tex_fee % TYPE,
    p_total_amount IN billing_header.total_amount % TYPE,
    p_currency IN billing_header.currency % TYPE,
    p_currency_rate IN billing_header.currency_rate % TYPE,
    --p_total_foeign IN billing_header.total_foeign % TYPE,
    p_modify_by IN billing_header.modify_by % TYPE,
    p_modify_date IN billing_header.modify_date % TYPE,
    p_language_code IN billing_header.language_code % TYPE,
    p_return OUT NUMBER
)
IS
BEGIN
    UPDATE billing_header SET
        billing_date = p_billing_date,
        deadline = p_deadline,
        total_pre_tex = p_total_pre_tex,
        tex_fee = p_tex_fee,
        total_amount = p_total_amount,
        currency = p_currency,
        currency_rate = p_currency_rate,
        --total_foeign = p_total_foeign,
        modify_by = p_modify_by,
        modify_date = p_modify_date

    WHERE billing_id = p_billing_id;

    p_return := p_billing_id;

EXCEPTION
WHEN OTHERS THEN
    ROLLBACK;
    RAISE;
END;

PROCEDURE proc_billing_delete
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_language_code IN billing_header.language_code % TYPE,
    p_modify_by IN billing_header.modify_by % TYPE,
    p_modify_date IN billing_header.modify_date % TYPE,
    p_return OUT NUMBER
)
IS
    v_case_code VARCHAR2(50) DEFAULT '';
    v_app_case_code VARCHAR2(50) DEFAULT '';
    v_status NUMBER;
BEGIN

    -- thong tin billing
    SELECT case_code,status,app_case_code INTO v_case_code,v_status,v_app_case_code FROM billing_header WHERE billing_id = p_billing_id;

    IF v_status = pkg_common.BILLING_H_STATUS_APPROVE THEN
        p_return := -2;
        RETURN;
    END IF;

    UPDATE  billing_header SET deleted = 1, modify_by = p_modify_by, modify_date = p_modify_date
    WHERE billing_id = p_billing_id ;--AND language_code = p_language_code;

    IF INSTR(v_app_case_code,'SEARCH') > 0 THEN
        UPDATE search_fee SET status = pkg_common.APP_FEE_STATUS_NOT_USE
        WHERE id IN
        (
            SELECT ref_id FROM billing_detail WHERE billing_id = p_billing_id AND TYPE = pkg_common.BILLING_DETAIL_TYPE_SEARCH
        );
    ELSE
        UPDATE app_fee_fix SET status = pkg_common.APP_FEE_STATUS_NOT_USE
        WHERE id IN
        (
            SELECT ref_id FROM billing_detail WHERE billing_id = p_billing_id AND TYPE = pkg_common.BILLING_DETAIL_TYPE_APP
        );
    END IF ;



    UPDATE timesheet SET status = pkg_common.APP_FEE_STATUS_NOT_USE
    WHERE id IN
    (
        SELECT ref_id FROM billing_detail WHERE billing_id = p_billing_id AND TYPE = pkg_common.BILLING_DETAIL_TYPE_TIMESHEET
    );

    DELETE billing_detail WHERE billing_id = p_billing_id;

    -- xoa nhung thang nao dang review
    DELETE b_todos WHERE TYPE = pkg_common.TODO_TYPE_BILLING AND case_code = v_case_code AND status = pkg_common.TODO_STATUS_REVIEW;

    p_return := 1;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_billing_update_payStatus
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_language_code IN billing_header.language_code % TYPE,
    p_status IN billing_header.status % TYPE,
    p_modify_by IN billing_header.modify_by % TYPE,
    p_modify_date IN billing_header.modify_date % TYPE,
    p_return OUT NUMBER
)
IS
    v_case_code VARCHAR2(50) DEFAULT '';
    v_pay_status NUMBER;
BEGIN

    -- thong tin billing
    SELECT case_code,pay_status INTO v_case_code,v_pay_status FROM billing_header WHERE billing_id = p_billing_id;

    IF v_pay_status = pkg_common.BILLING_H_STATUS_APPROVE THEN
        p_return := -2;
        RETURN;
    END IF;

    UPDATE  billing_header SET pay_status = p_status, modify_by = p_modify_by, modify_date = p_modify_date
    WHERE billing_id = p_billing_id AND language_code = p_language_code;

    -- Update trang thai review
    UPDATE b_todos SET  status = pkg_common.TODO_STATUS_COMPLETED, processor_date = SYSDATE
    WHERE TYPE = pkg_common.TODO_TYPE_BILLING AND case_code = v_case_code AND status = pkg_common.TODO_STATUS_REVIEW;

    p_return := 1;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_billing_updateStatus
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_language_code IN billing_header.language_code % TYPE,
    p_status IN billing_header.status % TYPE,
    p_modify_by IN billing_header.modify_by % TYPE,
    p_modify_date IN billing_header.modify_date % TYPE,
    p_return OUT NUMBER
)
IS
    v_case_code VARCHAR2(50) DEFAULT '';
    v_status NUMBER;
BEGIN

    -- thong tin billing
    SELECT case_code,status INTO v_case_code,v_status FROM billing_header WHERE billing_id = p_billing_id;

    IF v_status = pkg_common.BILLING_H_STATUS_APPROVE THEN
        p_return := -2;
        RETURN;
    END IF;

    UPDATE  billing_header SET status = p_status, modify_by = p_modify_by, modify_date = p_modify_date
    WHERE billing_id = p_billing_id AND language_code = p_language_code;

    IF p_status = pkg_common.BILLING_H_STATUS_APPROVE THEN
        UPDATE  billing_header SET pay_status = pkg_common.BILLING_P_STATUS_PAYMENT
        WHERE billing_id = p_billing_id AND language_code = p_language_code;
    END IF;

    -- Update trang thai review
    UPDATE b_todos SET  status = pkg_common.TODO_STATUS_COMPLETED, processor_date = SYSDATE
    WHERE TYPE = pkg_common.TODO_TYPE_BILLING AND case_code = v_case_code AND status = pkg_common.TODO_STATUS_REVIEW;

    -- insert todo
    pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_BILLING,v_case_code,p_language_code);

    p_return := 1;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE Proc_Billing_Detail_Insert
(
    p_billing_id IN billing_detail.billing_id % TYPE,
    p_biling_detail_name IN billing_detail.biling_detail_name % TYPE,
    p_ref_id IN NUMBER,
    p_type IN billing_detail.type % TYPE,
    p_nation_fee IN billing_detail.nation_fee % TYPE,
    p_represent_fee IN billing_detail.represent_fee % TYPE,
    p_service_fee IN billing_detail.service_fee % TYPE,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
BEGIN


    SELECT seq_BILLING_DETAIL.nextval INTO v_id FROM dual;
    INSERT INTO billing_detail
    (
        billing_detail_id, billing_id, biling_detail_name, type, nation_fee, represent_fee, service_fee, ref_id
    )
    VALUES
    (
        v_id, p_billing_id, p_biling_detail_name, p_type, p_nation_fee, p_represent_fee, p_service_fee, p_ref_id
    );

    IF p_type = pkg_common.BILLING_DETAIL_TYPE_APP THEN
        UPDATE app_fee_fix SET status = pkg_common.APP_FEE_STATUS_USE WHERE id = p_ref_id;
    ELSIF p_type = pkg_common.BILLING_DETAIL_TYPE_SEARCH THEN
        UPDATE SEARCH_FEE SET status = pkg_common.APP_FEE_STATUS_USE WHERE id = p_ref_id;
    ELSIF p_type = pkg_common.BILLING_DETAIL_TYPE_TIMESHEET THEN
        UPDATE timesheet SET STATUS_BILLING = pkg_common.APP_FEE_STATUS_USE WHERE id = p_ref_id;
    END IF;

    p_return := 1;

EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

PROCEDURE proc_delete_detail
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_return OUT NUMBER
)
IS
    v_case_code VARCHAR2(50) DEFAULT '';
    v_app_case_code VARCHAR2(50) DEFAULT '';
    v_status NUMBER;
BEGIN

    -- thong tin billing
    SELECT case_code,status,app_case_code INTO v_case_code,v_status,v_app_case_code FROM billing_header WHERE billing_id = p_billing_id;

    IF INSTR(v_app_case_code,'SEARCH') > 0 THEN
        UPDATE search_fee SET status = pkg_common.APP_FEE_STATUS_NOT_USE
        WHERE id IN
        (
            SELECT ref_id FROM billing_detail WHERE billing_id = p_billing_id AND TYPE = pkg_common.BILLING_DETAIL_TYPE_SEARCH
        );
    ELSE
        UPDATE app_fee_fix SET status = pkg_common.APP_FEE_STATUS_NOT_USE
        WHERE id IN
        (
            SELECT ref_id FROM billing_detail WHERE billing_id = p_billing_id AND TYPE = pkg_common.BILLING_DETAIL_TYPE_APP
        );
    END IF ;

    -- update timesheet nu c
    UPDATE timesheet SET status = pkg_common.APP_FEE_STATUS_NOT_USE
    WHERE id IN
    (
        SELECT ref_id FROM billing_detail WHERE billing_id = p_billing_id AND TYPE = pkg_common.BILLING_DETAIL_TYPE_TIMESHEET
    )
    AND status = pkg_common.APP_FEE_STATUS_USE
    ;

    DELETE billing_detail WHERE billing_id = p_billing_id;

    -- xoa nhung thang nao dang review
    --DELETE b_todos WHERE TYPE = pkg_common.TODO_TYPE_BILLING AND case_code = v_case_code AND status = pkg_common.TODO_STATUS_REVIEW;

    p_return := 1;

--COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_get_billing_detail
(
    p_billing_id IN billing_header.billing_id % TYPE,
    p_app_case_code IN VARCHAR2 ,
    p_language_code IN VARCHAR2 ,
    p_cursor_detail out tcursor
)
IS
BEGIN

    OPEN p_cursor_detail FOR
        SELECT * FROM billing_detail
        WHERE billing_id = p_billing_id AND (nation_fee > 0 OR represent_fee > 0 OR service_fee > 0) ORDER BY BILLING_DETAIL_ID;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_BILLING

-- Start of DDL Script for Package LEGALTECH.PKG_DOCKING
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_docking
    IS TYPE TCURSOR IS REF CURSOR;

PROCEDURE proc_docking_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);


PROCEDURE proc_docking_getall
(
    p_cursor out tcursor
);

PROCEDURE proc_docking_getbyid
(
    p_docking_id IN docking.docking_id % TYPE,
    p_cursor out tcursor
);

PROCEDURE proc_getby_doc_case_code
(
    p_doc_case_code IN docking.case_code % TYPE,
    p_cursor out tcursor
);

PROCEDURE Proc_Docking_Insert
(
    p_app_case_code IN docking.app_case_code % TYPE,
    p_docking_type IN docking.docking_type % TYPE,
    p_document_name IN docking.document_name % TYPE,
    p_document_type IN docking.document_type % TYPE,
    p_status IN docking.status % TYPE,
    p_deadline IN docking.deadline % TYPE,
    p_isshowcustomer IN docking.isshowcustomer % TYPE,
    p_in_out_date IN docking.in_out_date % TYPE,
    p_created_by IN docking.created_by % TYPE,
    p_created_date IN docking.created_date % TYPE,
    p_place_submit IN docking.place_submit  % TYPE,
    p_url IN docking.url % TYPE,
    p_filename IN docking.filename % TYPE,
    p_notes IN docking.notes  % TYPE,
    p_language_code IN docking.language_code % TYPE,
    p_return OUT NUMBER
);

PROCEDURE Proc_Docking_Insert_tran
(
    p_app_case_code IN docking.app_case_code % TYPE,
    p_docking_type IN docking.docking_type % TYPE,
    p_document_name IN docking.document_name % TYPE,
    p_document_type IN docking.document_type % TYPE,
    p_status IN docking.status % TYPE,
    p_deadline IN docking.deadline % TYPE,
    p_isshowcustomer IN docking.isshowcustomer % TYPE,
    p_in_out_date IN docking.in_out_date % TYPE,
    p_created_by IN docking.created_by % TYPE,
    p_created_date IN docking.created_date % TYPE,
    p_place_submit IN docking.place_submit  % TYPE,
    p_url IN docking.url % TYPE,
    p_filename IN docking.filename % TYPE,
    p_notes IN docking.notes  % TYPE,
    p_language_code IN docking.language_code % TYPE,
    p_return OUT NUMBER
);



PROCEDURE proc_docking_update
(
    p_docking_id IN docking.docking_id % TYPE,
    p_docking_type IN docking.docking_type % TYPE,
    p_document_name IN docking.document_name % TYPE,
    p_document_type IN docking.document_type % TYPE,
    p_deadline IN docking.deadline % TYPE,
    p_isshowcustomer IN docking.isshowcustomer % TYPE,
    p_in_out_date IN docking.in_out_date % TYPE,
    p_modify_by IN docking.modify_by % TYPE,
    p_modify_date IN docking.modify_date % TYPE,
    p_place_submit IN docking.place_submit  % TYPE,
    p_url IN docking.url % TYPE,
    p_filename IN docking.filename % TYPE,
    p_notes IN docking.notes  % TYPE,
    p_language_code IN docking.language_code % TYPE,
    p_return OUT NUMBER
);

PROCEDURE proc_docking_delete
(
    p_docking_id IN docking.docking_id % TYPE,
    p_language_code IN docking.language_code % TYPE,
    p_modify_by IN docking.modify_by % TYPE,
    p_modify_date IN docking.modify_date % TYPE,
    p_return OUT NUMBER
);

PROCEDURE proc_docking_updateStatus
(
    p_docking_id IN docking.docking_id % TYPE,
    p_language_code IN docking.language_code % TYPE,
    p_status IN docking.status % TYPE,
    p_modify_by IN docking.modify_by % TYPE,
    p_modify_date IN docking.modify_date % TYPE,
    p_return OUT NUMBER
);

PROCEDURE proc_getby_app_case_code
(
    p_app_case_code IN docking.case_code % TYPE,
    p_cursor out tcursor
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_docking
IS

PROCEDURE proc_docking_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_APP_CASE_CODE VARCHAR2(30) DEFAULT 'ALL';
    v_DOC_NAME VARCHAR2(100) DEFAULT 'ALL';

    V_DOCKING_TYPE VARCHAR2(3) DEFAULT 'ALL';
    V_DOCUMENT_TYPE VARCHAR2(3) DEFAULT 'ALL';

    V_FROM NUMBER ;
    V_TO NUMBER;
BEGIN


    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_APP_CASE_CODE := ITEM.CONDITION;
        ELSIF V_INDEX = 1 THEN
            v_DOC_NAME := ITEM.CONDITION;
        ELSIF V_INDEX = 2 THEN
            V_STATUS := ITEM.CONDITION;
        ELSIF V_INDEX = 3 THEN
            V_DOCKING_TYPE := ITEM.CONDITION;
        ELSIF V_INDEX = 4 THEN
            V_DOCUMENT_TYPE := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;

    IF V_APP_CASE_CODE <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.APP_CASE_CODE) LIKE ''%' || UPPER(V_APP_CASE_CODE) || '%'' ';
    END IF;

    IF v_DOC_NAME <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.DOCUMENT_NAME) LIKE ''%' || UPPER(v_DOC_NAME) || '%'' ';
    END IF;

    IF V_STATUS <> 'ALL' THEN
        V_CONDITION := V_CONDITION || ' AND A.STATUS = ' || V_STATUS;
    END IF;

    IF V_DOCKING_TYPE <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND A.DOCKING_TYPE = ' || V_DOCKING_TYPE;
    END IF;

    IF V_DOCUMENT_TYPE <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND A.DOCUMENT_TYPE = ' || V_DOCUMENT_TYPE;
    END IF;


    V_SQL := 'SELECT  A.* FROM view_docking A WHERE 1 = 1 ';
    V_SQL :=  V_SQL || V_CONDITION;

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.DOCKING_ID DESC';
    END IF;

    DBMS_OUTPUT.PUT_LINE(V_SQL);


    V_TOTAL_COUNT := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_TOTAL_COUNT INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;

    --PKG_LOG.LOGMSGALL(V_SQL);


    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE proc_docking_getall
(
    p_cursor out tcursor
)
IS
BEGIN
    OPEN p_cursor FOR SELECT * FROM view_docking ORDER BY DOCKING_ID DESC;
END;


PROCEDURE proc_docking_getbyid
(
    p_docking_id IN docking.docking_id % TYPE,
    p_cursor out tcursor
)
IS
BEGIN
    OPEN P_CURSOR FOR SELECT * FROM view_docking WHERE docking_id = p_docking_id;
END;

PROCEDURE proc_getby_doc_case_code
(
    p_doc_case_code IN docking.case_code % TYPE,
    p_cursor out tcursor
)
IS
BEGIN
    OPEN P_CURSOR FOR SELECT * FROM view_docking WHERE case_code = p_doc_case_code;
END;

PROCEDURE Proc_Docking_Insert
(
    p_app_case_code IN docking.app_case_code % TYPE,
    p_docking_type IN docking.docking_type % TYPE,
    p_document_name IN docking.document_name % TYPE,
    p_document_type IN docking.document_type % TYPE,
    p_status IN docking.status % TYPE,
    p_deadline IN docking.deadline % TYPE,
    p_isshowcustomer IN docking.isshowcustomer % TYPE,
    p_in_out_date IN docking.in_out_date % TYPE,
    p_created_by IN docking.created_by % TYPE,
    p_created_date IN docking.created_date % TYPE,
    p_place_submit IN docking.place_submit  % TYPE,
    p_url IN docking.url % TYPE,
    p_filename IN docking.filename % TYPE,
    p_notes IN docking.notes  % TYPE,
    p_language_code IN docking.language_code % TYPE,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    V_CASE_CODE VARCHAR2(50);
    V_ID_CASE_CODE NUMBER;
    PLOG_RETURN  VARCHAR2(2000);
BEGIN

    -- tao case code
    SELECT SEQ_GENCODE.NEXTVAL INTO V_ID_CASE_CODE FROM DUAL;
    V_CASE_CODE := 'DOC' || to_char(SYSDATE,'yyyyMMdd') || V_ID_CASE_CODE;


    SELECT seq_DOCKING.nextval INTO v_id FROM dual;
    INSERT INTO docking
    (
        docking_id, case_code, app_case_code, docking_type, document_name, document_type, status, deadline, isshowcustomer,
        in_out_date, created_by, created_date, language_code, url, notes,place_submit,filename
    )
    VALUES
    (
        v_id, V_CASE_CODE, p_app_case_code, p_docking_type, p_document_name, p_document_type, p_status, p_deadline, p_isshowcustomer,
        p_in_out_date, p_created_by, p_created_date, p_language_code, p_url, p_notes,p_place_submit,p_filename
    );

    --pkg_remind.proc_insert(pkg_common.REMIND_TYPE_DOC,V_CASE_CODE,v_Content,p_created_by,p_created_date,v_processor_by,pkg_common.REMIND_STATUS_NEW,p_language_code);
    pkg_remind.proc_do_insert(pkg_common.REMIND_TYPE_DOC,V_CASE_CODE,p_language_code);


    p_return := v_id;
COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    PLOG_RETURN := SUBSTR(SQLCODE,1,500) || SUBSTR(SQLERRM,1,500);
    pkg_log.log_error(PLOG_RETURN,'Proc_Docking_Insert');
    RAISE;
END;

PROCEDURE Proc_Docking_Insert_tran
(
    p_app_case_code IN docking.app_case_code % TYPE,
    p_docking_type IN docking.docking_type % TYPE,
    p_document_name IN docking.document_name % TYPE,
    p_document_type IN docking.document_type % TYPE,
    p_status IN docking.status % TYPE,
    p_deadline IN docking.deadline % TYPE,
    p_isshowcustomer IN docking.isshowcustomer % TYPE,
    p_in_out_date IN docking.in_out_date % TYPE,
    p_created_by IN docking.created_by % TYPE,
    p_created_date IN docking.created_date % TYPE,
    p_place_submit IN docking.place_submit  % TYPE,
    p_url IN docking.url % TYPE,
    p_filename IN docking.filename % TYPE,
    p_notes IN docking.notes  % TYPE,
    p_language_code IN docking.language_code % TYPE,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    V_CASE_CODE VARCHAR2(50);
    V_ID_CASE_CODE NUMBER;
    PLOG_RETURN  VARCHAR2(2000);
BEGIN

    -- tao case code
    SELECT SEQ_GENCODE.NEXTVAL INTO V_ID_CASE_CODE FROM DUAL;
    V_CASE_CODE := 'DOC' || to_char(SYSDATE,'yyyyMMdd') || V_ID_CASE_CODE;


    SELECT seq_DOCKING.nextval INTO v_id FROM dual;
    INSERT INTO docking
    (
        docking_id, case_code, app_case_code, docking_type, document_name, document_type, status, deadline, isshowcustomer,
        in_out_date, created_by, created_date, language_code, url, notes,place_submit,filename
    )
    VALUES
    (
        v_id, V_CASE_CODE, p_app_case_code, p_docking_type, p_document_name, p_document_type, p_status, p_deadline, p_isshowcustomer,
        p_in_out_date, p_created_by, p_created_date, p_language_code, p_url, p_notes,p_place_submit,p_filename
    );

    --pkg_remind.proc_insert(pkg_common.REMIND_TYPE_DOC,V_CASE_CODE,v_Content,p_created_by,p_created_date,v_processor_by,pkg_common.REMIND_STATUS_NEW,p_language_code);
    pkg_remind.proc_do_insert(pkg_common.REMIND_TYPE_DOC,V_CASE_CODE,p_language_code);


    p_return := v_id;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    PLOG_RETURN := SUBSTR(SQLCODE,1,500) || SUBSTR(SQLERRM,1,500);
    pkg_log.log_error(PLOG_RETURN,'Proc_Docking_Insert');
    RAISE;
END;

PROCEDURE proc_docking_update
(
    p_docking_id IN docking.docking_id % TYPE,
    p_docking_type IN docking.docking_type % TYPE,
    p_document_name IN docking.document_name % TYPE,
    p_document_type IN docking.document_type % TYPE,

    p_deadline IN docking.deadline % TYPE,
    p_isshowcustomer IN docking.isshowcustomer % TYPE,
    p_in_out_date IN docking.in_out_date % TYPE,
    p_modify_by IN docking.modify_by % TYPE,
    p_modify_date IN docking.modify_date % TYPE,
    p_place_submit IN docking.place_submit  % TYPE,
    p_url IN docking.url % TYPE,
    p_filename IN docking.filename % TYPE,
    p_notes IN docking.notes  % TYPE,
    p_language_code IN docking.language_code % TYPE,
    p_return OUT NUMBER
)
IS
BEGIN
    UPDATE docking SET
        docking_type = p_docking_type,
        document_name = p_document_name,
        document_type = p_document_type,
        deadline = p_deadline,
        isshowcustomer = p_isshowcustomer,
        in_out_date = p_in_out_date,
        modify_by = p_modify_by,
        modify_date = p_modify_date,
        notes = p_notes, place_submit = p_place_submit,
        url = decode(p_url,NULL, url, p_url),
        filename = decode(p_filename,NULL, filename, p_filename)

    WHERE docking_id = p_docking_id AND language_code = p_language_code;

    p_return := p_docking_id;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

PROCEDURE proc_docking_delete
(
    p_docking_id IN docking.docking_id % TYPE,
    p_language_code IN docking.language_code % TYPE,
    p_modify_by IN docking.modify_by % TYPE,
    p_modify_date IN docking.modify_date % TYPE,
    p_return OUT NUMBER
)
IS
    v_case_code VARCHAR2(50);
BEGIN
    SELECT CASE_CODE INTO v_case_code FROM docking WHERE docking_id = p_docking_id;

    UPDATE docking SET deleted = 1, modify_by = p_modify_by, modify_date = p_modify_date
    WHERE docking_id = p_docking_id AND language_code = p_language_code;

    -- xoa het remind
    DELETE b_remind WHERE TYPE = pkg_common.REMIND_TYPE_APP AND case_code = v_case_code;

    p_return := 1;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_docking_updateStatus
(
    p_docking_id IN docking.docking_id % TYPE,
    p_language_code IN docking.language_code % TYPE,
    p_status IN docking.status % TYPE,
    p_modify_by IN docking.modify_by % TYPE,
    p_modify_date IN docking.modify_date % TYPE,
    p_return OUT NUMBER
)
IS
    v_case_code VARCHAR2(50);
BEGIN
    SELECT CASE_CODE INTO v_case_code FROM docking WHERE docking_id = p_docking_id;

    UPDATE  docking SET status = p_status, modify_by = p_modify_by, modify_date = p_modify_date
    WHERE docking_id = p_docking_id AND language_code = p_language_code;

    -- update lai trang thai remind bao da hoan thanh
    UPDATE b_remind SET  status = pkg_common.REMIND_STATUS_REVIEW, processor_date = SYSDATE
    WHERE TYPE = pkg_common.REMIND_TYPE_APP AND case_code = v_case_code AND status = pkg_common.REMIND_STATUS_COMPLETED;

    p_return := 1;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE proc_getby_app_case_code
(
    p_app_case_code IN docking.case_code % TYPE,
    p_cursor out tcursor
)
IS
BEGIN
    OPEN P_CURSOR FOR SELECT * FROM view_docking WHERE app_case_code = p_app_case_code;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_DOCKING

-- Start of DDL Script for Package LEGALTECH.PKG_LOG
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_log
 is TYPE tcursor IS REF Cursor ;
   TYPE t_array IS TABLE OF VARCHAR2(50) INDEX BY BINARY_INTEGER;

PROCEDURE LOGMSG
(
    P_MSG IN NVARCHAR2
);

PROCEDURE LOG_ERROR
(
    P_ERROR_MESSAGE IN VARCHAR2,
    P_PACKAGE_NAME IN VARCHAR2
);

PROCEDURE LOGMSGALL
(
    P_MSG IN VARCHAR2
);



END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_log
IS



-- HAM LUU LOG HE THONG PHUC VU LUU VET
PROCEDURE LOGMSG
(
    P_MSG IN NVARCHAR2
)
IS
    P_SYSDATE DATE ;
    V_SEQLOG NUMBER ;
BEGIN
    SELECT SEQ_LOG.NEXTVAL INTO V_SEQLOG FROM DUAL ;
    P_SYSDATE :=SYSDATE ;
    INSERT INTO WLOG(ID,MSG,DATES) VALUES(V_SEQLOG,P_MSG,P_SYSDATE);


EXCEPTION
WHEN OTHERS THEN
    RAISE ;
END ;

PROCEDURE LOG_ERROR
(
    P_ERROR_MESSAGE IN VARCHAR2,
    P_PACKAGE_NAME IN VARCHAR2
)
IS
   P_SYSDATE DATE ;
   V_SEQLOG NUMBER ;
   V_MSG VARCHAR2(2000) DEFAULT '';
BEGIN
    P_SYSDATE :=SYSDATE ;
    SELECT seq_log.NEXTVAL INTO V_SEQLOG FROM dual;
    INSERT INTO log_error(id,log_timestamp,error_message,package_name)
    VALUES(V_SEQLOG,P_SYSDATE,P_ERROR_MESSAGE,P_PACKAGE_NAME);

--COMMIT ;
EXCEPTION
WHEN OTHERS THEN
RAISE ;
END ;



PROCEDURE LOGMSGALL
(
    P_MSG IN VARCHAR2
)
IS
    P_SYSDATE DATE ;
   V_SEQLOG NUMBER ;
   V_MSG VARCHAR2(16000) DEFAULT '';
BEGIN
    SELECT SEQ_LOG.NEXTVAL INTO V_SEQLOG FROM DUAL ;
    P_SYSDATE :=SYSDATE ;

    V_MSG:=SUBSTR(P_MSG,1,4000);
    INSERT INTO WLOG(ID,MSG,DATES) VALUES(V_SEQLOG,V_MSG,P_SYSDATE);

    V_MSG:=SUBSTR(P_MSG,4001,4000);
    INSERT INTO WLOG(ID,MSG,DATES) VALUES(V_SEQLOG,V_MSG,P_SYSDATE);

    V_MSG:=SUBSTR(P_MSG,8001,4000);
    INSERT INTO WLOG(ID,MSG,DATES) VALUES(V_SEQLOG,V_MSG,P_SYSDATE);

    V_MSG:=SUBSTR(P_MSG,12001,4000);
    INSERT INTO WLOG(ID,MSG,DATES) VALUES(V_SEQLOG,V_MSG,P_SYSDATE);

    V_MSG:=SUBSTR(P_MSG,16001,4000);
    INSERT INTO WLOG(ID,MSG,DATES) VALUES(V_SEQLOG,V_MSG,P_SYSDATE);

    V_MSG:=SUBSTR(P_MSG,20001,4000);
    INSERT INTO WLOG(ID,MSG,DATES) VALUES(V_SEQLOG,V_MSG,P_SYSDATE);

--COMMIT ;
EXCEPTION
WHEN OTHERS THEN
    RAISE ;
END;





END;
/


-- End of DDL Script for Package LEGALTECH.PKG_LOG

-- Start of DDL Script for Package LEGALTECH.PKG_GET_CUSTOMER_INFO
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_get_customer_info
  IS

--LAY THONG TIN CHU DON, NGUOI DAI DIEN,
--CHU DON KHAC
 PROCEDURE PROC_THONG_TIN_CHU_DON_NDD
    (
     P_USER IN VARCHAR2 ,
     P_LANGUAGE IN VARCHAR2 ,
     P_APPCODE IN VARCHAR2 ,
     P_CURSOR OUT PKG_LOG.TCURSOR
    );



END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_get_customer_info
IS
 --LAY THONG TIN CHU DON, NGUOI DAI DIEN,
--CHU DON KHAC
 PROCEDURE PROC_THONG_TIN_CHU_DON_NDD
(
     P_USER IN VARCHAR2 ,
     P_LANGUAGE IN VARCHAR2 ,
     P_APPCODE IN VARCHAR2 ,
     P_CURSOR OUT PKG_LOG.TCURSOR
)
IS
V_SQL VARCHAR2(4000) ;
V_CONDITION VARCHAR2(2000) ;

 BEGIN

 V_SQL:='SELECT  A.APPCODE, A.MASTER_NAME ,A.MASTER_ADDRESS,A.MASTER_PHONE,A.MASTER_EMAIL,A.MASTER_FAX,
            A.REP_MASTER_TYPE ,A.REP_MASTER_NAME,A.REP_MASTER_ADDRESS,A.REP_MASTER_PHONE,A.REP_MASTER_FAX,A.REP_MASTER_EMAIL ,
            B.CDK_NAME_1 ,B.CDK_ADDRESS_1,B.CDK_PHONE_1,B.CDK_FAX_1,B.CDK_EMAIL_1,
            B.CDK_NAME_2,B.CDK_ADDRESS_2,B.CDK_PHONE_2,B.CDK_FAX_2,B.CDK_EMAIL_2,
            B.CDK_NAME_3,B.CDK_ADDRESS_3,B.CDK_PHONE_3,B.CDK_FAX_3,B.CDK_EMAIL_3,
            B.CDK_NAME_4,B.CDK_ADDRESS_4,B.CDK_PHONE_4,B.CDK_FAX_4,B.CDK_EMAIL_4 ,A.LANGUAGUE_CODE AS LANGUAGE
            FROM  APPLICATION_HEADER A  INNER JOIN APP_DETAIL_04NH B ON A.ID =B.APP_HEADER_ID WHERE  A.DELETED =0  ';

    IF(P_USER IS NOT NULL ) THEN
        V_CONDITION := ' AND UPPER(CREATED_BY) = ''' || UPPER(P_USER) || '''';
    END IF ;

    IF(P_LANGUAGE IS NOT NULL ) THEN
        V_CONDITION :=V_CONDITION ||  ' AND UPPER(LANGUAGUE_CODE) = ''' || UPPER(P_LANGUAGE) || '''';
    END IF ;

    IF(P_APPCODE IS NOT NULL ) THEN
        V_CONDITION :=V_CONDITION ||  ' AND UPPER(APPCODE) = ''' || UPPER(P_APPCODE) || '''';
    END IF ;

    IF(V_CONDITION  IS NOT NULL ) THEN
        V_SQL:=V_SQL || V_CONDITION ;
    END IF;

    OPEN P_CURSOR FOR  V_SQL ;

    --pkg_log.LOGMSG('xx:' || V_SQL);

 EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;
   -- ENTER FURTHER CODE BELOW AS SPECIFIED IN THE PACKAGE SPEC.
END;
/


-- End of DDL Script for Package LEGALTECH.PKG_GET_CUSTOMER_INFO

-- Start of DDL Script for Package LEGALTECH.PKG_LAWER_INFO
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_lawer_info
 IS TYPE tcursor IS ref CURSOR;

PROCEDURE proc_lawer_getall
(
    p_cursor out tcursor
);

PROCEDURE proc_lawer_search
(
    p_search_key IN VARCHAR2,
    p_from IN VARCHAR2,
    p_to IN VARCHAR2,
    p_sort_type IN VARCHAR2,
    p_total_record OUT NUMBER,
    p_cursor out tcursor
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_lawer_info
IS

PROCEDURE proc_lawer_getall
(
    p_cursor out tcursor
)
IS
BEGIN
    OPEN P_CURSOR FOR SELECT * FROM view_users WHERE TYPE = pkg_common.USER_TYPE_LAWER ORDER BY fullname;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_lawer_search
(
    p_search_key IN VARCHAR2,
    p_from IN VARCHAR2,
    p_to IN VARCHAR2,
    p_sort_type IN VARCHAR2,
    p_total_record OUT NUMBER,
    p_cursor out tcursor
)
IS
    v_sql VARCHAR2(32000) DEFAULT '';
    v_condition VARCHAR2(4000) DEFAULT '';
    v_total_count VARCHAR2(32000) DEFAULT '';

    v_index NUMBER DEFAULT 0;
    CURSOR v_cur_condition IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(p_search_key,'|'));

    v_status VARCHAR2(3) DEFAULT 'ALL';
    v_lawer_name VARCHAR2(100) DEFAULT 'ALL';

    v_from NUMBER ;
    v_to NUMBER;
BEGIN
    -- lay ra cac dk tim kiem
    FOR ITEM IN v_cur_condition LOOP

        IF v_index = 0 THEN
            v_lawer_name := ITEM.CONDITION;
        END IF;

        v_index := v_index + 1;
    END LOOP;

    IF v_lawer_name <> 'ALL' THEN
        v_condition :=  v_condition || ' AND UPPER(A.fullname) LIKE ''%' || UPPER(v_lawer_name) || '%'' ';
    END IF;


    v_sql := 'SELECT * FROM view_users A WHERE 1 = 1 ';

    v_sql :=  v_sql || v_condition;

    IF p_sort_type <> 'ALL' THEN
        v_sql :=  v_sql || p_sort_type;
    ELSE
        v_sql :=  v_sql || ' ORDER BY A.fullname';
    END IF;

    dbms_output.put_line(v_sql);


    v_total_count := 'SELECT COUNT(*) FROM (' || v_sql || ')';
    EXECUTE IMMEDIATE v_total_count INTO v_total_count;

    v_from := p_from ;
    v_to := p_to;

    IF p_from = '0' AND p_to = '0' THEN
        v_from := '1' ;
        v_to := v_total_count;
    END IF;

    v_sql := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || v_sql || ') V ) a WHERE STT BETWEEN ' || v_from || ' AND ' || v_to;
    OPEN P_CURSOR FOR v_sql;
    --pkg_log.logmsg(v_sql);


    p_total_record := v_total_count;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_LAWER_INFO

-- Start of DDL Script for Package LEGALTECH.PKG_NEWS
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_news
  IS

PROCEDURE PROC_NEW_GET_BY_PAGE (

 P_LANGUAGE IN VARCHAR2,
 P_TITLE IN VARCHAR2,
 P_NGAYCONGBO IN DATE ,
 P_START IN NUMBER ,
 P_END IN NUMBER  ,
 P_CUSOR OUT PKG_LOG.TCURSOR ,
 P_TOTALRECORD OUT NUMBER
);

PROCEDURE PROC_NEW_GET_BY_ID (
 P_ID IN VARCHAR2,
 P_LANGUAGE IN VARCHAR2,
 P_CUSOR OUT PKG_LOG.TCURSOR
 );

 PROCEDURE PROC_NEW_GET_PAGE(
 P_KEYSEARCH IN VARCHAR2  ,
 P_FROM IN NUMBER ,
 P_TO IN NUMBER ,
 P_LANGUAGE IN VARCHAR2,
 P_ORDERBY  IN VARCHAR2 ,
 P_CUSOR OUT PKG_LOG.TCURSOR,
 P_RECORD OUT NUMBER
);


PROCEDURE PROC_NEWS_INSERT
(
    P_TITLE IN NEWS.TITLE % TYPE,
    P_HEADER IN NEWS.HEADER % TYPE,
    P_IMAGEHEADER IN NEWS.IMAGEHEADER % TYPE,
    P_LANGUAGECODE IN NEWS.LANGUAGECODE % TYPE,
    P_CONTENT IN NEWS.CONTENT % TYPE,
    P_STATUS IN NEWS.STATUS % TYPE,
    P_CATEGORIES_ID IN NEWS.CATEGORIES_ID % TYPE,
    P_ARTICLES_TYPE IN NEWS.ARTICLES_TYPE % TYPE,
    P_CREATEDBY IN NEWS.CREATEDBY % TYPE,
    P_CREATEDDATE IN NEWS.CREATEDDATE % TYPE,
    P_COUNTRYID IN NUMBER ,
    P_RETURN OUT NUMBER
) ;



PROCEDURE PROC_NEWS_UPDATE
(
    P_ID IN NEWS.ID % TYPE,
    P_TITLE IN NEWS.TITLE % TYPE,
    P_HEADER IN NEWS.HEADER % TYPE,
    P_IMAGEHEADER IN NEWS.IMAGEHEADER % TYPE,
    P_LANGUAGECODE IN NEWS.LANGUAGECODE % TYPE,
    P_CONTENT IN NEWS.CONTENT % TYPE,
    P_STATUS IN NEWS.STATUS % TYPE,
    P_CATEGORIES_ID IN NEWS.CATEGORIES_ID % TYPE,
    P_ARTICLES_TYPE IN NEWS.ARTICLES_TYPE % TYPE,
    P_MODIFIEDBY IN NEWS.MODIFIEDBY % TYPE,
    P_MODIFIEDDATE IN NEWS.MODIFIEDDATE % TYPE,
    P_COUNTRYID IN NUMBER ,
    P_RETURN OUT NUMBER
) ;


PROCEDURE PROC_NEWS_DELETED
(
    P_ID IN NEWS.ID % TYPE,
    P_LANGUAGECODE IN NEWS.LANGUAGECODE % TYPE,
    P_MODIFIEDBY IN VARCHAR2,
    P_MODIFIEDDATE IN DATE ,
    P_RETURN OUT NUMBER
) ;


PROCEDURE PROC_NEWS_UPDATE_STATUS
(
    P_ID IN NEWS.ID % TYPE,
    P_LANGUAGECODE IN NEWS.LANGUAGECODE % TYPE,
    P_STATUS IN NUMBER ,
    P_ACTIONBY IN VARCHAR2,
    P_ACTIONDATE  IN DATE ,
    P_RETURN OUT NUMBER
) ;

PROCEDURE PROC_NEW_HOME_SHOW (
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);


PROCEDURE PROC_NEWS_STATIC (
 pLanguage in varchar2 ,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);


END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_news
IS

PROCEDURE PROC_NEW_GET_BY_PAGE (
 P_LANGUAGE IN VARCHAR2,
 P_TITLE IN VARCHAR2,
 P_NGAYCONGBO IN DATE ,
 P_START IN NUMBER ,
 P_END IN NUMBER  ,
 P_CUSOR OUT PKG_LOG.TCURSOR ,
 P_TOTALRECORD OUT NUMBER
)
IS
V_TOTALREC NUMBER;
BEGIN
  SELECT COUNT (0) INTO V_TOTALREC FROM NEWS WHERE  STATUS = 7 AND LANGUAGECODE = P_LANGUAGE AND deleted = 0 ;


    OPEN P_CUSOR FOR SELECT  * FROM  NEWS WHERE  STATUS = 7 AND LANGUAGECODE = P_LANGUAGE AND deleted = 0 ;
    P_TOTALRECORD := V_TOTALREC ;
EXCEPTION WHEN OTHERS THEN
  P_TOTALRECORD := 0 ;
    RAISE;
END ;


PROCEDURE PROC_NEW_GET_BY_ID (
 P_ID IN VARCHAR2,
 P_LANGUAGE IN VARCHAR2,
 P_CUSOR OUT PKG_LOG.TCURSOR
)
IS
BEGIN
    OPEN P_CUSOR FOR SELECT  * FROM  NEWS WHERE  ID = P_ID AND LANGUAGECODE = P_LANGUAGE AND deleted = 0 ;
EXCEPTION WHEN OTHERS THEN

    RAISE;
END ;

PROCEDURE PROC_NEW_GET_PAGE(
 P_KEYSEARCH IN VARCHAR2  ,
 P_FROM IN NUMBER ,
 P_TO IN NUMBER ,
 P_LANGUAGE IN VARCHAR2,
 P_ORDERBY  IN VARCHAR2 ,
 P_CUSOR OUT PKG_LOG.TCURSOR,
 P_RECORD OUT NUMBER
)
IS
V_SQL VARCHAR2(8000) ;
V_SQLTOTAL VARCHAR2(8000) ;
V_CONDITION VARCHAR2(3000) ;
V_INDEX NUMBER :=0 ;
V_TITLE VARCHAR2(250) ;   -- TIEU DE BAI VIET
V_CREATEDBY VARCHAR2(50); -- NGUOI VIET BAI
V_DATECREATE DATE :=NULL ;     -- NGAY TAO
V_DATEPUBLIC DATE :=NULL  ;    -- NGAY XUAT BAN
V_FROM NUMBER :=0 ;
V_TO NUMBER :=0 ;
V_TOTAL_RECORD NUMBER :=0 ;
 CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_KEYSEARCH,'|'));

BEGIN

    V_SQL := 'SELECT A.ID, A.TITLE, A.HEADER, A.IMAGEHEADER, A.LANGUAGECODE,A.CONTENT, A.STATUS,
       A.CATEGORIES_ID, A.ARTICLES_TYPE, A.HOTTYPE, A.CREATEDBY, A.CREATEDDATE, A.MODIFIEDBY, A.MODIFIEDDATE,
       A.PUBLICTIME, A.PUBLICBY, A.UNPUBLICBY, A.UNPUBLICDATE, A.DELETED ,B.NAME AS COUNTRY, B.COUNTRY_ID   FROM NEWS A  LEFT JOIN COUNTRY B ON A.COUNTRY_ID = B.COUNTRY_ID  WHERE  A.DELETED=0  AND A.LANGUAGECODE = ''' || P_LANGUAGE || '''' ;

    V_SQLTOTAL := 'SELECT COUNT(1) FROM NEWS A WHERE A.DELETED=0 AND A.LANGUAGECODE = ''' || P_LANGUAGE || '''';

    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
         V_TITLE := ITEM.CONDITION;
        ELSIF V_INDEX = 1 THEN
         V_CREATEDBY:=ITEM.CONDITION;
        ELSIF V_INDEX = 2 THEN
         V_DATECREATE:=ITEM.CONDITION;
        ELSIF V_INDEX = 3 THEN
         V_DATEPUBLIC:=ITEM.CONDITION;
        END IF;
        V_INDEX := V_INDEX + 1;
    END LOOP;

    IF(V_TITLE IS NOT NULL ) THEN
     V_CONDITION:= V_CONDITION || ' AND  ( UPPER(A.TITLE) LIKE ''%' ||  UPPER(V_TITLE) || '%''' ||  ' OR  UPPER(A.HEADER) LIKE  ''%' ||  UPPER(V_TITLE) || '%'' )';
    END IF ;

    IF  V_CREATEDBY IS NOT NULL THEN
     V_CONDITION:= V_CONDITION || ' AND  ( UPPER(A.CREATEDBY) LIKE ''%' ||  UPPER(V_CREATEDBY) || '%'' OR UPPER(A.PUBLICBY) LIKE ''%' ||  UPPER(V_CREATEDBY) || '%'')'  ;
    END IF;


    IF  V_DATECREATE IS NOT NULL THEN
     V_CONDITION:= V_CONDITION || ' AND   TRUNC(A.CREATEDDATE) = ''' ||  TRUNC(V_DATECREATE)  || ''''  ;
    END IF;

    IF  V_DATECREATE IS NOT NULL THEN
     V_CONDITION:= V_CONDITION || ' AND   TRUNC(A.PUBLICTIME) = ''' ||  TRUNC(V_DATEPUBLIC)  || ''''  ;
    END IF;


    IF(V_CONDITION IS NOT NULL ) THEN
    V_SQL:=V_SQL || V_CONDITION ;
    V_SQLTOTAL:=V_SQLTOTAL || V_CONDITION ;
    END IF;


     EXECUTE IMMEDIATE V_SQLTOTAL INTO  V_TOTAL_RECORD  ;

    V_FROM := P_FROM ;
    V_TO := P_TO;
    P_RECORD:= V_TOTAL_RECORD ;
    IF P_FROM = 0 AND P_TO = 0 THEN
        V_FROM := 1;
        V_TO :=V_TOTAL_RECORD  ;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;

    OPEN P_CUSOR FOR V_SQL;


EXCEPTION WHEN OTHERS THEN

    RAISE;
END ;




PROCEDURE PROC_NEWS_INSERT
(
    P_TITLE IN NEWS.TITLE % TYPE,
    P_HEADER IN NEWS.HEADER % TYPE,
    P_IMAGEHEADER IN NEWS.IMAGEHEADER % TYPE,
    P_LANGUAGECODE IN NEWS.LANGUAGECODE % TYPE,
    P_CONTENT IN NEWS.CONTENT % TYPE,
    P_STATUS IN NEWS.STATUS % TYPE,
    P_CATEGORIES_ID IN NEWS.CATEGORIES_ID % TYPE,
    P_ARTICLES_TYPE IN NEWS.ARTICLES_TYPE % TYPE,
    P_CREATEDBY IN NEWS.CREATEDBY % TYPE,
    P_CREATEDDATE IN NEWS.CREATEDDATE % TYPE,
    P_COUNTRYID IN NUMBER ,
    P_RETURN OUT NUMBER
)
IS
    V_ID  NUMBER:=0 ;
BEGIN
    SELECT SEQ_NEWS.NEXTVAL INTO V_ID FROM DUAL;
    INSERT INTO NEWS
    (
        ID, TITLE, HEADER, IMAGEHEADER, LANGUAGECODE, CONTENT, STATUS, CATEGORIES_ID, ARTICLES_TYPE,
        CREATEDBY, CREATEDDATE ,  COUNTRY_ID  )
    VALUES
    (
        V_ID, P_TITLE, P_HEADER, P_IMAGEHEADER, P_LANGUAGECODE, P_CONTENT, P_STATUS, P_CATEGORIES_ID, P_ARTICLES_TYPE,
        P_CREATEDBY, TRUNC(P_CREATEDDATE) ,P_COUNTRYID
     );

     P_RETURN:= V_ID ;

COMMIT;
EXCEPTION WHEN OTHERS THEN
    P_RETURN:=-1 ;


    RAISE;
END;



PROCEDURE PROC_NEWS_UPDATE
(
    P_ID IN NEWS.ID % TYPE,
    P_TITLE IN NEWS.TITLE % TYPE,
    P_HEADER IN NEWS.HEADER % TYPE,
    P_IMAGEHEADER IN NEWS.IMAGEHEADER % TYPE,
    P_LANGUAGECODE IN NEWS.LANGUAGECODE % TYPE,
    P_CONTENT IN NEWS.CONTENT % TYPE,
    P_STATUS IN NEWS.STATUS % TYPE,
    P_CATEGORIES_ID IN NEWS.CATEGORIES_ID % TYPE,
    P_ARTICLES_TYPE IN NEWS.ARTICLES_TYPE % TYPE,
    P_MODIFIEDBY IN NEWS.MODIFIEDBY % TYPE,
    P_MODIFIEDDATE IN NEWS.MODIFIEDDATE % TYPE,
    P_COUNTRYID IN NUMBER ,
    P_RETURN OUT NUMBER
)
IS

BEGIN
     UPDATE  NEWS SET  TITLE = P_TITLE , HEADER =P_HEADER ,
             IMAGEHEADER =P_IMAGEHEADER ,CONTENT =P_CONTENT ,CATEGORIES_ID= P_CATEGORIES_ID ,
             MODIFIEDBY =P_MODIFIEDBY ,MODIFIEDDATE = P_MODIFIEDDATE ,
             COUNTRY_ID =P_COUNTRYID
              WHERE  ID =P_ID AND  LANGUAGECODE =P_LANGUAGECODE ;

     IF(P_LANGUAGECODE = 'VI_VN') THEN
        UPDATE  NEWS SET   CATEGORIES_ID= P_CATEGORIES_ID  WHERE       ID =P_ID  ;
     END IF ;


  IF(P_STATUS NOT IN (6,7)) THEN
    UPDATE  NEWS SET   STATUS = P_STATUS ,MODIFIEDBY =P_MODIFIEDBY , MODIFIEDDATE  =P_MODIFIEDDATE    WHERE  ID =P_ID AND  LANGUAGECODE =P_LANGUAGECODE ;
  ELSIF (P_STATUS = 6 ) THEN
    UPDATE  NEWS SET   STATUS = P_STATUS ,unpublicby =P_MODIFIEDBY , unpublicdate  =P_MODIFIEDDATE    WHERE  ID =P_ID AND  LANGUAGECODE =P_LANGUAGECODE ;
  ELSIF (P_STATUS  = 7 ) THEN
    UPDATE  NEWS SET   STATUS = P_STATUS ,publicby =P_MODIFIEDBY , publictime  = P_MODIFIEDDATE    WHERE  ID =P_ID AND  LANGUAGECODE =P_LANGUAGECODE ;
  END IF;



     P_RETURN:= P_ID ;

COMMIT;
EXCEPTION WHEN OTHERS THEN
    P_RETURN:=-1 ;

    RAISE;
END;




PROCEDURE PROC_NEWS_DELETED
(
    P_ID IN NEWS.ID % TYPE,
    P_LANGUAGECODE IN NEWS.LANGUAGECODE % TYPE,
    P_MODIFIEDBY IN VARCHAR2,
    P_MODIFIEDDATE IN DATE ,
    P_RETURN OUT NUMBER
)
IS

BEGIN
     UPDATE  NEWS SET   DELETED =1 , MODIFIEDBY =P_MODIFIEDBY , MODIFIEDDATE  =P_MODIFIEDDATE  WHERE  ID =P_ID AND  LANGUAGECODE =P_LANGUAGECODE ;

     IF(P_LANGUAGECODE = 'VI_VN') THEN
        UPDATE  NEWS SET   DELETED =1   WHERE       ID =P_ID  ;
     END IF ;

     P_RETURN:= P_ID ;

COMMIT;
EXCEPTION WHEN OTHERS THEN
    P_RETURN:=-1 ;

    RAISE;
END;


PROCEDURE PROC_NEWS_UPDATE_STATUS
(
    P_ID IN NEWS.ID % TYPE,
    P_LANGUAGECODE IN NEWS.LANGUAGECODE % TYPE,
    P_STATUS IN NUMBER ,
    P_ACTIONBY IN VARCHAR2,
    P_ACTIONDATE  IN DATE ,
    P_RETURN OUT NUMBER
)
IS

BEGIN

 IF(P_STATUS NOT IN (6,7)) THEN
  UPDATE  NEWS SET   STATUS = P_STATUS ,MODIFIEDBY =P_ACTIONBY , MODIFIEDDATE  =P_ACTIONDATE    WHERE  ID =P_ID AND  LANGUAGECODE =P_LANGUAGECODE ;
 ELSIF (P_STATUS = 6 ) THEN
  UPDATE  NEWS SET   STATUS = P_STATUS ,unpublicby =P_ACTIONBY , unpublicdate  =P_ACTIONDATE    WHERE  ID =P_ID AND  LANGUAGECODE =P_LANGUAGECODE ;
 ELSIF (P_STATUS  = 7 ) THEN
  UPDATE  NEWS SET   STATUS = P_STATUS ,publicby =P_ACTIONBY , publictime  = P_ACTIONDATE    WHERE  ID =P_ID AND  LANGUAGECODE =P_LANGUAGECODE ;
 END IF;

  P_RETURN:=  P_ID ;

COMMIT;
EXCEPTION WHEN OTHERS THEN
    P_RETURN:=-1 ;

    RAISE;
END;



PROCEDURE PROC_NEW_HOME_SHOW (
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
 V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_HOSTTYPE VARCHAR2(5);
    V_LANGUAGE VARCHAR2(10);
    V_CATEGORY VARCHAR2(100) ;
     V_TITLE VARCHAR2(300) ;
    V_FROM NUMBER ;
    V_TO NUMBER;
BEGIN


 FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_STATUS := ITEM.CONDITION;
        ELSIF V_INDEX = 1 THEN
            V_HOSTTYPE := ITEM.CONDITION;
        ELSIF V_INDEX = 2 THEN
            V_LANGUAGE := ITEM.CONDITION;
        ELSIF V_INDEX = 3 THEN
         V_CATEGORY := ITEM.CONDITION;
         ELSIF V_INDEX = 4 THEN
            V_TITLE := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;

    IF V_STATUS <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.STATUS) = ''' || V_STATUS || ''' ';
    END IF;

    IF V_HOSTTYPE <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.HOTTYPE) = ''' || UPPER(V_HOSTTYPE) || ''' ';
    END IF;

    IF V_LANGUAGE <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.LANGUAGECODE) = ''' || UPPER(V_LANGUAGE) || ''' ';
    END IF;

    IF V_CATEGORY <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.categories_id) = ''' || UPPER(V_CATEGORY) || ''' ';
    END IF;

   IF V_TITLE <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.TITLE)  LIKE  ''%' || UPPER(V_TITLE) || '%'' ';
    END IF;

    V_SQL := 'SELECT  A.* ,B.NAME AS COUNTRY  FROM NEWS A LEFT JOIN COUNTRY B ON A.COUNTRY_ID = B.COUNTRY_ID WHERE 1 = 1 AND A.DELETED=0';
    V_SQL :=  V_SQL || V_CONDITION;


    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || P_SORT_TYPE;
    ELSE
        IF(V_STATUS =7) THEN
        V_SQL :=  V_SQL || ' ORDER BY A.PUBLICTIME DESC ';
        ELSIF (V_STATUS =6) THEN
        V_SQL :=  V_SQL || ' ORDER BY A.UNPUBLICDATE DESC';
        ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.CREATEDDATE DESC';
        END IF ;
    END IF;
    V_TOTAL_COUNT := 'SELECT COUNT(*) FROM (' || V_SQL || ')';

    EXECUTE IMMEDIATE V_TOTAL_COUNT INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;

    OPEN P_CURSOR FOR V_SQL;
    P_TOTAL_RECORD := V_TOTAL_COUNT;

--pkg_log.LOGMSG(V_SQL);
--COMMIT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END ;




PROCEDURE PROC_NEWS_STATIC (
 PLANGUAGE IN VARCHAR2 ,
 P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS

BEGIN

    OPEN P_CURSOR FOR SELECT  A.* ,B.NAME AS COUNTRY FROM NEWS A
      INNER JOIN ALLCODE C ON A.CATEGORIES_ID = C.CDVAL AND  C.CDNAME ='ARTICLES'
      LEFT JOIN COUNTRY B ON A.COUNTRY_ID = B.COUNTRY_ID WHERE 1 = 1 AND A.DELETED=0 AND A.STATUS =7
      AND A.CATEGORIES_ID IN  ('MEBS','ABOT','FETU') AND A.LANGUAGECODE = PLANGUAGE;

EXCEPTION WHEN OTHERS THEN

    RAISE;
END ;




   -- ENTER FURTHER CODE BELOW AS SPECIFIED IN THE PACKAGE SPEC.
END;
/


-- End of DDL Script for Package LEGALTECH.PKG_NEWS

-- Start of DDL Script for Package LEGALTECH.PKG_ORDERS
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_orders
    IS TYPE TCURSOR IS REF CURSOR;
PROCEDURE proc_order_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);


PROCEDURE proc_insert
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,
    p_content IN VARCHAR2,
    p_request_by IN VARCHAR2,
    p_request_date IN DATE,
    p_processor_by IN VARCHAR2,
    p_status IN NUMBER,
    p_language_code IN VARCHAR2
);

END;
/



-- End of DDL Script for Package LEGALTECH.PKG_ORDERS

-- Start of DDL Script for Package LEGALTECH.PKG_REGISTOR
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_registor
  IS
PROCEDURE PROC_REGISTOR_INSERT
(
    P_FISTNAME   VARCHAR2,
    P_LASTNAME   VARCHAR2 ,
    P_PHONE      VARCHAR2 ,
    P_EMAIL    VARCHAR2 ,
    P_COMPANY     VARCHAR2 ,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_REGISTOR_UPDATE
(
    P_ID NUMBER ,
    P_FISTNAME   VARCHAR2,
    P_LASTNAME   VARCHAR2 ,
    P_PHONE      VARCHAR2 ,
    P_EMAIL    VARCHAR2 ,
    P_COMPANY     VARCHAR2 ,
    P_MODIFIEDBY VARCHAR2 ,
    P_STATUS  NUMBER  ,
      P_KEYSECRET VARCHAR2,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_REGISTOR_DELETED
(
    P_ID NUMBER ,
    P_MODIFIEDBY VARCHAR2 ,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_REGISTOR_GETALL
(
 P_SEARCH_KEY IN VARCHAR2,
 P_FROM IN  NUMBER ,
 P_TO   IN NUMBER ,
 P_TOTAL OUT NUMBER ,
 P_CURSOR OUT PKG_COMMON.T_CURSOR
);

PROCEDURE PROC_REGISTOR_GETBYID
(
 P_ID IN NUMBER  ,
 P_CURSOR OUT PKG_COMMON.T_CURSOR
);


PROCEDURE PROC_REGISTOR_CASECODE
(
 P_CASECODE IN VARCHAR2  ,
 P_CURSOR OUT PKG_COMMON.T_CURSOR
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_registor
IS

PROCEDURE PROC_REGISTOR_INSERT
(
    P_FISTNAME   VARCHAR2,
    P_LASTNAME   VARCHAR2 ,
    P_PHONE      VARCHAR2 ,
    P_EMAIL    VARCHAR2 ,
    P_COMPANY     VARCHAR2 ,
    P_RETURN OUT NUMBER
)
IS
    V_ID NUMBER;

   V_CASE_CODE VARCHAR2(100);
   V_ID_CASE_CODE VARCHAR2(100);
BEGIN

     SELECT SEQ_GENCODE.NEXTVAL INTO V_ID_CASE_CODE FROM DUAL;

    V_CASE_CODE := 'REGISTER' || to_char(SYSDATE,'yyyyMMdd') || V_ID_CASE_CODE;
    -- DANG KY ROI THI THONG BAO DA DANG KY
    P_RETURN := 0 ;
    SELECT  COUNT(*) INTO V_ID FROM REGISTERINFO WHERE   phone = P_PHONE OR UPPER( email )= UPPER( P_EMAIL) ;
    IF(V_ID>0) THEN
     P_RETURN:=-22;
      RETURN  ;
    END IF ;

    SELECT SEQ_REGISTOR.NEXTVAL INTO V_ID FROM DUAL;

    INSERT INTO REGISTERINFO ( ID,  FISTNAME,  LASTNAME,  PHONE,  EMAIL,  COMPANY,
        DELETED,  STATUS,  DESCRIPTION,  CREATEDATE, CASE_CODE )
    VALUES( V_ID, P_FISTNAME,  P_LASTNAME, P_PHONE, P_EMAIL,  P_COMPANY, 0,0,'',SYSDATE, V_CASE_CODE);

    P_RETURN:= V_ID;


 -- insert todo
    pkg_todos.proc_do_insert_register(pkg_common.TODO_TYPE_REGISTER,V_CASE_CODE,'');


    COMMIT;

EXCEPTION
WHEN OTHERS THEN
    P_RETURN:= -99 ;
    RAISE;
    ROLLBACK;
END;


PROCEDURE PROC_REGISTOR_UPDATE
(
    P_ID NUMBER ,
    P_FISTNAME   VARCHAR2,
    P_LASTNAME   VARCHAR2 ,
    P_PHONE      VARCHAR2 ,
    P_EMAIL    VARCHAR2 ,
    P_COMPANY     VARCHAR2 ,
    P_MODIFIEDBY VARCHAR2 ,
    P_STATUS  NUMBER  ,
    P_KEYSECRET VARCHAR2,  --123456
    P_RETURN OUT NUMBER
)
IS

    V_EMAIL VARCHAR2(50);
    V_PHONE VARCHAR2(50);
    V_FISTNAME VARCHAR2(50);
    V_LASTNAME VARCHAR2(50);

    V_EXITS NUMBER ;

    V_CASE_CODE VARCHAR2(200);

    v_id_user NUMBER;
BEGIN

    SELECT a.case_code INTO V_CASE_CODE  FROM  REGISTERINFO a WHERE a.id = P_ID;

    -- DANG KY ROI THI THONG BAO DA DANG KY
    P_RETURN := 0 ;

    -- CHI XAC NHAN DA XU LY THOI CHU KO LAM GI
    UPDATE REGISTERINFO SET MODIFIEDBY = P_MODIFIEDBY ,MODIFIEDDATE = SYSDATE   ,
    STATUS = P_STATUS  WHERE  ID = P_ID ;

    SELECT EMAIL ,PHONE,FISTNAME,LASTNAME INTO V_EMAIL ,V_PHONE ,V_FISTNAME, V_LASTNAME
    FROM REGISTERINFO
    WHERE ID = P_ID;

    SELECT COUNT(1) INTO V_EXITS FROM  S_USERS WHERE USERNAME = V_EMAIL ;
    IF(V_EXITS <1) THEN

        SELECT seq_s_users.NEXTVAL INTO v_id_user FROM dual;
        INSERT INTO  S_USERS(ID ,USERNAME,PASSWORD,FULLNAME,EMAIL,STATUS,TYPE,PHONE,DELETED ,COUNTRY,LOGINFIRST )
        VALUES(v_id_user,V_EMAIL,P_KEYSECRET,V_FISTNAME||V_LASTNAME ,V_EMAIL,1,'3',V_PHONE,0,234,0 ) ;

        -- insert nhm quyn
        INSERT INTO s_group_user(groupId, userId)
        VALUES(pkg_common.GROUP_ID_CUSTOMER_DEFAULT, v_id_user);
    END IF;

     -- insert todo
    pkg_todos.proc_do_insert_register(pkg_common.TODO_TYPE_REGISTER,V_CASE_CODE,'');

    COMMIT;

EXCEPTION
WHEN OTHERS THEN
    P_RETURN:= -99 ;
    RAISE;
    ROLLBACK;


END;



PROCEDURE PROC_REGISTOR_DELETED
(
    P_ID NUMBER ,
    P_MODIFIEDBY VARCHAR2 ,
    P_RETURN OUT NUMBER
)
IS
BEGIN
    -- DANG KY ROI THI THONG BAO DA DANG KY
    P_RETURN := 0 ;
    UPDATE  REGISTERINFO SET  deleted =1 , modifiedby = P_MODIFIEDBY ,  modifieddate = SYSDATE   WHERE  id = P_ID ;

    COMMIT;

EXCEPTION
WHEN OTHERS THEN
    P_RETURN:= -99 ;
    RAISE;
    ROLLBACK;
END;

PROCEDURE PROC_REGISTOR_GETALL
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN  NUMBER ,
    P_TO   IN NUMBER ,
    P_TOTAL OUT NUMBER ,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
    V_SQL VARCHAR2(4000) ;
    V_SQL_TOTAL VARCHAR2(4000) ;
    V_FROM NUMBER ;
    V_TO NUMBER;
    CURSOR V_CUR_CONDITION IS
            SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));
    V_NAME  VARCHAR2(50) ;
    V_PHONE  VARCHAR2(50) ;
    V_EMAIL  VARCHAR2(100) ;
    V_COMPANY  VARCHAR2(200) ;
    V_INDEX NUMBER  :=0  ;
    V_CONDITION VARCHAR2(2000) ;
BEGIN

    FOR ITEM IN V_CUR_CONDITION LOOP
        IF V_INDEX = 0 THEN
            V_NAME := ITEM.CONDITION;
        ELSIF V_INDEX = 1 THEN
            V_PHONE := ITEM.CONDITION;
        ELSIF V_INDEX = 2 THEN
            V_EMAIL := ITEM.CONDITION;
        ELSIF V_INDEX = 3 THEN
            V_COMPANY := ITEM.CONDITION;
        END IF;
        V_INDEX := V_INDEX + 1;
    END LOOP;

    V_SQL := '  SELECT  * FROM REGISTERINFO WHERE  DELETED = 0   ';

    IF(V_NAME IS NOT NULL AND  V_NAME <> 'ALL' ) THEN
        V_CONDITION := V_CONDITION || ' AND ( UPPER(FISTNAME) LIKE ''%' || UPPER(V_NAME) || '%'' OR UPPER(LASTNAME) LIKE ''%' ||  UPPER(V_NAME) || '%'') ';
    END IF ;

    IF(V_PHONE IS NOT NULL AND V_PHONE <> 'ALL'  ) THEN
        V_CONDITION := V_CONDITION || ' AND PHONE LIKE ''%' || V_PHONE || '%''' ;
    END IF ;

    IF(V_EMAIL IS NOT NULL  AND V_EMAIL <> 'ALL'  ) THEN
        V_CONDITION := V_CONDITION || ' AND UPPER(EMAIL) LIKE ''%' || UPPER(V_EMAIL) || '%''' ;
    END IF ;

    IF(V_COMPANY IS NOT NULL  AND V_COMPANY <> 'ALL'  ) THEN
        V_CONDITION := V_CONDITION || ' AND UPPER(company) LIKE ''%' || UPPER(V_COMPANY) || '%''' ;
    END IF ;
    V_SQL:=V_SQL || V_CONDITION ;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    V_SQL_TOTAL := 'SELECT COUNT(*) FROM (' || V_SQL || ')';

    EXECUTE IMMEDIATE V_SQL_TOTAL INTO P_TOTAL;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := P_TOTAL;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    --pkg_log.LOGMSG(V_SQL);

    OPEN P_CURSOR FOR V_SQL;

END;



PROCEDURE PROC_REGISTOR_GETBYID
(
 P_ID IN NUMBER  ,
 P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS

BEGIN

  OPEN P_CURSOR FOR SELECT  * FROM  REGISTERINFO WHERE  DELETED = 0  AND  ID = P_ID;

END;

PROCEDURE PROC_REGISTOR_CASECODE
(
 P_CASECODE IN VARCHAR2  ,
 P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS

BEGIN

  OPEN P_CURSOR FOR SELECT  * FROM  REGISTERINFO WHERE  DELETED = 0  AND  CASE_CODE = P_CASECODE;

END;

   -- Enter further code below as specified in the Package spec.
END;
/


-- End of DDL Script for Package LEGALTECH.PKG_REGISTOR

-- Start of DDL Script for Package LEGALTECH.PKG_REMIND
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_remind
    IS TYPE TCURSOR IS REF CURSOR;
PROCEDURE proc_remind_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);


PROCEDURE proc_do_insert
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2
);

PROCEDURE proc_insert
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,
    p_content IN VARCHAR2,
    p_request_by IN VARCHAR2,
    p_request_date IN DATE,
    p_processor_by IN VARCHAR2,
    p_status IN NUMBER,
    p_language_code IN VARCHAR2,
    p_active_date DATE
);

PROCEDURE proc_remind_home_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);


PROCEDURE proc_auto_change_remind
(
    p_retunr OUT NUMBER
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_remind
    IS

PROCEDURE proc_remind_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_PROCESSOR_BY VARCHAR2(200) DEFAULT 'ALL';
    V_REQUEST_BY VARCHAR2(200) DEFAULT 'ALL';

    V_FROM NUMBER ;
    V_TO NUMBER;
BEGIN


    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_STATUS := ITEM.CONDITION;
        ELSIF V_INDEX = 1 THEN
            V_REQUEST_BY := ITEM.CONDITION;
        ELSIF V_INDEX = 2 THEN
            V_PROCESSOR_BY := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;

    IF V_PROCESSOR_BY <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.PROCESSOR_BY) = ''' || UPPER(V_PROCESSOR_BY) || ''' ';
    END IF;

    IF V_REQUEST_BY <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.REQUEST_BY) = ''' || UPPER(V_REQUEST_BY) || ''' ';
    END IF;

    IF V_STATUS <> 'ALL' THEN
        V_CONDITION := V_CONDITION || ' AND A.STATUS = ' || V_STATUS;
    END IF;

    V_SQL := 'SELECT  A.* FROM VIEW_REMIND A WHERE 1 = 1 ';
    V_SQL :=  V_SQL || V_CONDITION;


    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.REMIND_ID DESC';
    END IF;

    dbms_output.put_line(V_SQL);

    V_TOTAL_COUNT := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_TOTAL_COUNT INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;

    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_do_insert
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2
)
IS
    v_id NUMBER;
    v_Content VARCHAR2(500) DEFAULT '';

    v_created_by VARCHAR2(200) DEFAULT '';
    v_created_by_app VARCHAR2(200) DEFAULT '';
    v_request_by VARCHAR2(200) DEFAULT '';
    v_request_date DATE DEFAULT SYSDATE;
    v_processor_by VARCHAR2(200) DEFAULT '';
    v_processor_by_2 VARCHAR2(200) DEFAULT '';
    v_user_admin VARCHAR2(50) DEFAULT '';
    v_lawer VARCHAR2(50) DEFAULT '';
    v_app_id NUMBER;

    v_status_app NUMBER;
    v_app_case_code VARCHAR2(50) DEFAULT '';        -- case code theo don
    v_status_billing NUMBER;
    v_pay_status_billing NUMBER;

    v_status_doc NUMBER;
    p_active_date DATE;

    v_modify_by VARCHAR2(50) DEFAULT '';
    v_employee VARCHAR2(50) DEFAULT '';

    PLOG_RETURN varchar2(2000);
BEGIN

    -- neu viec phai lam lien quan toi don
    IF p_type = pkg_common.REMIND_TYPE_DOC THEN

        SELECT status, app_case_code, deadline - 7,created_by
        INTO v_status_doc, v_app_case_code, p_active_date,v_created_by
        FROM docking WHERE case_code = p_case_code;

        -- lay content
        IF p_language_code = pkg_common.VI_VN THEN
            SELECT content INTO v_Content FROM allcode WHERE cdname = 'DOCKING' and cdtype = 'STATUS' AND cdval = v_status_doc;
            v_Content := v_Content;
        ELSE
            SELECT content_eng INTO v_Content FROM allcode WHERE cdname = 'DOCKING' and cdtype = 'STATUS' AND  cdval = v_status_doc;
            v_Content := v_Content;
        END IF;

        -- nguoi yeu cau la thang tao docking nay
        v_request_by := v_created_by;

        -- lay thang dc phan
        IF v_status_doc = pkg_common.DOCKING_STATUS_WAIT_TRANSLATE THEN
            -- ban dich thi thang xu ly la luat su
            SELECT lawer_user_name INTO v_processor_by FROM view_app_header WHERE case_code = v_app_case_code;
        ELSIF v_status_doc = pkg_common.DOCKING_STATUS_WAIT_ORIGINAL THEN
            -- neu la ban goc thi cho khach hang
            SELECT created_by INTO v_processor_by FROM application_header WHERE case_code = v_app_case_code;
        END IF;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.REMIND_STATUS_NEW,p_language_code,p_active_date);


    ELSIF p_type = pkg_common.REMIND_TYPE_APP THEN

        -- lay trang thai cua app
        SELECT a.id,a.status,created_by,a.modify_by,s.username employee
        INTO v_app_id,v_status_app,v_created_by_app,v_modify_by,v_employee
        FROM application_header a
        LEFT JOIN s_users s ON s.id = a.employee
        WHERE case_code = p_case_code AND LANGUAGUE_CODE = p_language_code;

    ELSIF p_type = pkg_common.REMIND_TYPE_BILL THEN

        -- lay thong tin billing
        SELECT status,app_case_code,nvl(pay_status,-1) into v_status_billing,v_app_case_code,v_pay_status_billing
        FROM billing_header WHERE case_code = p_case_code;

    END IF;

EXCEPTION
WHEN OTHERS THEN
    PLOG_RETURN := SUBSTR(SQLCODE,1,500) || SUBSTR(SQLERRM,1,500);
    pkg_log.log_error(PLOG_RETURN,'proc_do_insert');
    RAISE;
END;


-- mac dinh them moi trang thai cua n la moi tao chua active
-- se co thread de update trang thai sau
PROCEDURE proc_insert
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,
    p_content IN VARCHAR2,
    p_request_by IN VARCHAR2,
    p_request_date IN DATE,
    p_processor_by IN VARCHAR2,
    p_status IN NUMBER,
    p_language_code IN VARCHAR2,
    p_active_date DATE
)
IS
    v_id NUMBER;
BEGIN

    SELECT seq_remind.NEXTVAL INTO v_id FROM dual;

    INSERT INTO B_REMIND
    (
        remind_id, type, case_code, content, request_by,
        request_date, processor_by, status, language_code,ACTIVE_DATE
    )
    VALUES
    (
        v_id,p_type,p_case_code,p_content,p_request_by, p_request_date,
        p_processor_by,p_status, p_language_code,p_active_date
    );

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE proc_remind_home_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_TYPE VARCHAR2(10) DEFAULT 'ALL';
    V_USERNAME VARCHAR2(50) DEFAULT 'ALL';

    V_FROM NUMBER ;
    V_TO NUMBER;

BEGIN


    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
             V_USERNAME := UPPER(ITEM.CONDITION);
        END IF;
        V_INDEX := V_INDEX + 1;
    END LOOP;

    V_CONDITION :=  V_CONDITION || ' AND UPPER(A.PROCESSOR_BY) = ''' || UPPER(V_USERNAME) || ''' ';

    V_SQL := 'SELECT  A.* FROM VIEW_REMIND A WHERE A.STATUS = 0 ';
    V_SQL :=  V_SQL || V_CONDITION;


    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.REMIND_ID DESC';
    END IF;

    dbms_output.put_line(V_SQL);

    V_TOTAL_COUNT := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_TOTAL_COUNT INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;

    P_TOTAL_RECORD := V_TOTAL_COUNT;




EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE proc_auto_change_remind
(
    p_retunr OUT NUMBER
)
IS
BEGIN

    UPDATE b_remind set status = pkg_common.REMIND_STATUS_REVIEW
    WHERE status = pkg_common.REMIND_STATUS_NEW AND TRUNC(active_date) = TRUNC(sysdate);

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


END;
/


-- End of DDL Script for Package LEGALTECH.PKG_REMIND

-- Start of DDL Script for Package LEGALTECH.PKG_S_FUNCTION
-- Generated 20-Thg2-2019 0:04:33 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_s_function
  IS TYPE tcursor IS REF Cursor;

PROCEDURE proc_Function_GetById
(
    p_functionId NUMBER,
    p_cursor OUT tcursor
);

PROCEDURE proc_Function_GetAll
(
    p_cursor OUT tcursor
);

PROCEDURE proc_GetAllFnsRequiredLogin
(
    p_cursor OUT tcursor
);

PROCEDURE proc_GetAllFnsNoRequiredLogin
(
    p_cursor OUT tcursor
);

PROCEDURE proc_Function_Find
(
    p_functionName IN VARCHAR2,
    p_functionType IN VARCHAR2,
    p_href IN VARCHAR2,
    p_parentId IN VARCHAR2,
    p_level IN VARCHAR2,

    p_orderBy IN VARCHAR2,
    p_startAt IN NUMBER,
    p_endAt IN NUMBER,
    p_totalRecord OUT NUMBER,
    p_cursor OUT tcursor
);

PROCEDURE proc_Function_AddNew
(
    p_functionName IN s_functions.FunctionName % type,
    p_displayName IN s_functions.DisplayName % type,
    p_functionType IN s_functions.FunctionType % type,
    p_hrefGet IN s_functions.HrefGet % type,
    p_hrefPost IN s_functions.HrefPost % type,
    p_position IN s_functions.Position % type,
    p_parentId IN s_functions.ParentId % type,
    p_lev IN s_functions.Lev % type,
    p_menuId IN s_functions.MenuId % type,

    p_return OUT NUMBER
);

PROCEDURE proc_Function_Edit
(
    p_functionId IN s_functions.id % type,
    p_functionName IN s_functions.FunctionName % type,
    p_displayName IN s_functions.DisplayName % type,
    p_functionType IN s_functions.FunctionType % type,
    p_hrefGet IN s_functions.HrefGet % type,
    p_hrefPost IN s_functions.HrefPost % type,
    p_position IN s_functions.Position % type,
    p_parentId IN s_functions.ParentId % type,
    p_lev IN s_functions.Lev % type,
    p_menuId IN s_functions.MenuId % type,

    p_return OUT NUMBER
);

PROCEDURE proc_Function_Delete
(
    p_functionId IN NUMBER,
    p_return OUT NUMBER
);

PROCEDURE proc_GetAllInnerFunction
(
    p_functionId NUMBER,
    p_cursor OUT tcursor
);


END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_s_function
IS

PROCEDURE proc_Function_GetById
(
    p_functionId NUMBER,
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT a.*, t.content AS FunctionTypeDisplayName
    FROM s_functions a
    LEFT JOIN allcode t ON t.cdname='FUNCTION_TYPE' AND to_char(a.functionType) = t.cdval
    WHERE a.id = p_functionId;

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_Function_GetAll
(
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT * FROM s_functions;

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_GetAllFnsRequiredLogin
(
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT * FROM s_functions WHERE functionType != pkg_common.FN_NO_REQUIRED_LOGIN;

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_GetAllFnsNoRequiredLogin
(
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT * FROM s_functions WHERE functionType = pkg_common.FN_NO_REQUIRED_LOGIN;

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_Function_Find
(
    p_functionName IN VARCHAR2,
    p_functionType IN VARCHAR2,
    p_href IN VARCHAR2,
    p_parentId IN VARCHAR2,
    p_level IN VARCHAR2,

    p_orderBy IN VARCHAR2,
    p_startAt IN NUMBER,
    p_endAt IN NUMBER,
    p_totalRecord OUT NUMBER,
    p_cursor OUT tcursor
)
IS
    V_SQL VARCHAR2(16000) DEFAULT '';
    V_SQL_COUNT_TOTAL VARCHAR2(16000) DEFAULT '';
    V_CONDITION VARCHAR2(8000) DEFAULT '';
    V_ORDERBY VARCHAR(500) DEFAULT '';
BEGIN
    IF(LENGTH(p_functionName) > 0) THEN
        V_CONDITION:= V_CONDITION || ' AND ( UPPER(a.FunctionName) LIKE UPPER(''%' || p_functionName || '%'') '
        || ' AND UPPER(a.DisplayName) LIKE UPPER(''%' || p_functionName || '%'') )';
    END IF;

    IF(LENGTH(p_functionType) > 0) THEN
        V_CONDITION:= V_CONDITION || ' AND UPPER(a.FunctionType) IN (' || p_functionType || ')';
    ELSE
        V_CONDITION:= V_CONDITION || ' AND UPPER(a.FunctionType) NOT IN (' || pkg_common.FN_INNER || ')';
    END IF;

    IF(LENGTH(p_href) > 0) THEN
        V_CONDITION:= V_CONDITION || ' AND ( UPPER(a.HrefGet) LIKE UPPER(''%' || p_href || '%'') '
        || ' AND UPPER(a.HrefPost) LIKE UPPER(''%' || p_functionName || '%'') )';
    END IF;

    IF(LENGTH(p_parentId) > 0) THEN
        V_CONDITION:= V_CONDITION || ' AND a.Id IN (' || p_parentId || ')';
    END IF;

    IF(LENGTH(p_level) > 0) THEN
        V_CONDITION:= V_CONDITION || ' AND a.Lev IN (' || p_level || ')';
    END IF;

    IF (LENGTH(p_orderby) > 0)  THEN
        V_ORDERBY := ' ORDER BY ' || p_orderby;
    ELSE
        V_ORDERBY := ' ORDER BY Id ASC ';
    END IF;

    V_SQL:=
    'SELECT a.*, t.content AS FunctionTypeDisplayName
    FROM s_functions a
    LEFT JOIN allcode t ON t.cdname=''FUNCTION_TYPE'' AND to_char(a.functionType) = t.cdval
    WHERE 1=1 ' || V_CONDITION || V_ORDERBY;

    V_SQL_COUNT_TOTAL:= 'SELECT COUNT(*) FROM s_functions a WHERE 1=1 ' || V_CONDITION;

    EXECUTE IMMEDIATE V_SQL_COUNT_TOTAL INTO p_totalRecord ;
    IF p_totalRecord IS NULL THEN
        p_totalRecord := 0;
    END IF;

    IF p_endAt <> 0 THEN
        V_SQL := 'SELECT * FROM ( SELECT ROWNUM AS Stt, a.* FROM  ( ' || V_SQL   ||' ) a ) where Stt >= '|| p_startAt ||' and Stt <= ' || p_endAt;
    ELSE
        V_SQL := 'SELECT ROWNUM STT, a.* FROM  ( ' || V_SQL  || ') a ' ;
    END IF;

    OPEN p_cursor FOR V_SQL;

    EXCEPTION
    WHEN OTHERS THEN
    raise_application_error(-20005, V_SQL_COUNT_TOTAL);
    --RAISE;
END;

PROCEDURE proc_Function_AddNew
(
    p_functionName IN s_functions.FunctionName % type,
    p_displayName IN s_functions.DisplayName % type,
    p_functionType IN s_functions.FunctionType % type,
    p_hrefGet IN s_functions.HrefGet % type,
    p_hrefPost IN s_functions.HrefPost % type,
    p_position IN s_functions.Position % type,
    p_parentId IN s_functions.ParentId % type,
    p_lev IN s_functions.Lev % type,
    p_menuId IN s_functions.MenuId % type,

    p_return OUT NUMBER
)
IS
    V_FunctionIdAdd NUMBER DEFAULT 0;
BEGIN
    SELECT seq_s_functions.NEXTVAL INTO V_FunctionIdAdd FROM dual;
    INSERT INTO s_functions a (a.id, a.FunctionName, a.DisplayName, a.FunctionType, a.HrefGet, a.HrefPost,
        a.Position, a.ParentId, a.Lev,a.MenuId)
    VALUES (V_FunctionIdAdd, p_functionName, p_displayName, p_functionType, p_hrefGet, p_hrefPost,
        p_position, p_parentId, p_lev, p_menuId);

    COMMIT;
    p_return:= V_FunctionIdAdd;

    EXCEPTION
    WHEN OTHERS THEN
        p_return:= -1301;
    RAISE;
END;

PROCEDURE proc_Function_Edit
(
    p_functionId IN s_functions.id % type,
    p_functionName IN s_functions.FunctionName % type,
    p_displayName IN s_functions.DisplayName % type,
    p_functionType IN s_functions.FunctionType % type,
    p_hrefGet IN s_functions.HrefGet % type,
    p_hrefPost IN s_functions.HrefPost % type,
    p_position IN s_functions.Position % type,
    p_parentId IN s_functions.ParentId % type,
    p_lev IN s_functions.Lev % type,
    p_menuId IN s_functions.MenuId % type,

    p_return OUT NUMBER
)
IS
BEGIN
    UPDATE s_functions SET
    FunctionName = p_functionName,
    DisplayName = p_displayName,
    FunctionType = p_functionType,
    HrefGet = p_hrefGet,
    HrefPost = p_hrefPost,
    Position = p_position,
    ParentId = p_parentId,
    Lev = p_lev,
    MenuId = p_menuId
    WHERE id = p_functionId;

    COMMIT;
    p_return:= 1303;

    EXCEPTION
    WHEN OTHERS THEN
        p_return:= -1304;
    RAISE;
END;

PROCEDURE proc_Function_Delete
(
    p_functionId IN NUMBER,
    p_return OUT NUMBER
)
IS
BEGIN
    DELETE FROM s_functions WHERE id = p_functionId;
    DELETE FROM s_group_function WHERE functionId = p_functionId;
    COMMIT;
        p_return:= 1307;

    EXCEPTION
    WHEN OTHERS THEN
        p_return:= -1308;
    RAISE;

END;

PROCEDURE proc_GetAllInnerFunction
(
    p_functionId NUMBER,
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT a.* FROM s_functions a WHERE a.parentId = p_functionId AND a.functionType = pkg_common.FN_INNER;

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_S_FUNCTION

-- Start of DDL Script for Package LEGALTECH.PKG_S_GROUPS
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_s_groups
  IS TYPE tcursor IS REF Cursor;

PROCEDURE proc_GroupUser_GetById
(
    p_groupId NUMBER,
    p_cursor OUT tcursor
);

PROCEDURE proc_GroupUser_GetAll
(
    p_cursor OUT tcursor
);

PROCEDURE proc_GroupUser_Find
(
    p_groupName IN VARCHAR2,

    p_orderBy IN VARCHAR2,
    p_startAt IN NUMBER,
    p_endAt IN NUMBER,
    p_totalRecord OUT NUMBER,
    p_cursor OUT tcursor
);

PROCEDURE proc_GroupUser_AddNew
(
    p_groupName IN s_groups.name % type,
    p_notes IN VARCHAR2,
    p_createdby IN s_groups.createdby % type,

    p_return OUT NUMBER
);

PROCEDURE proc_GroupUser_Edit
(
    p_groupId IN s_groups.id % type,
    p_groupName IN s_groups.name % type,
    p_notes IN VARCHAR2,
    p_modifiedBy IN s_groups.modifiedby % type,

    p_return OUT NUMBER
);

PROCEDURE proc_GroupUser_Delete
(
    p_groupId IN s_groups.id % type,
    p_modifiedBy IN s_groups.modifiedby % type,

    p_return OUT NUMBER
);

-- function and group
PROCEDURE proc_SetupFunctionToGroup
(
    p_groupId IN NUMBER,
    p_functionId IN NUMBER,
    p_return OUT NUMBER
);

PROCEDURE proc_DeleteFunctionFromGroup
(
    p_groupId IN NUMBER,
    p_return OUT NUMBER
);

PROCEDURE proc_GetAllFunctionInGroup
(
    p_groupId IN NUMBER,
    p_cursor OUT tcursor
);


END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_s_groups
IS

PROCEDURE proc_GroupUser_GetById
(
    p_groupId NUMBER,
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT a.* FROM s_groups a WHERE a.id = p_groupId AND a.deleted=0;

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_GroupUser_GetAll
(
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT a.* FROM s_groups a WHERE a.deleted=0 ORDER BY NLSSORT(UPPER(a.name), 'NLS_SORT=BINARY_AI') ASC;

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_GroupUser_Find
(
    p_groupName IN VARCHAR2,

    p_orderBy IN VARCHAR2,
    p_startAt IN NUMBER,
    p_endAt IN NUMBER,
    p_totalRecord OUT NUMBER,
    p_cursor OUT tcursor
)
IS
    V_SQL VARCHAR2(16000) DEFAULT '';
    V_SQL_COUNT_TOTAL VARCHAR2(16000) DEFAULT '';
    V_CONDITION VARCHAR2(8000) DEFAULT '';
    V_ORDERBY VARCHAR(500) DEFAULT '';
BEGIN
    V_CONDITION:= V_CONDITION || ' AND a.deleted=0 ';

    IF(LENGTH(p_groupName) > 0) THEN
        V_CONDITION:= V_CONDITION || ' AND UPPER(a.Name) LIKE UPPER(''%' || p_groupName || '%'')';
    END IF;

    IF (LENGTH(p_orderby) > 0)  THEN
        V_ORDERBY := ' ORDER BY ' || p_orderby;
    ELSE
        V_ORDERBY := ' ORDER BY LastTimeUpdated DESC ';
    END IF;

    V_SQL:=
    'SELECT a.*, NVL(b.NumberUsersInGroup, 0) AS NumberUsersInGroup, NVL(a.modifiedDate, a.createdDate) AS LastTimeUpdated
     FROM s_groups a
     LEFT JOIN (
         SELECT SUM(userId) AS NumberUsersInGroup, groupId FROM s_group_user GROUP BY groupId
     ) b
     ON a.id = b.groupId
     WHERE 1=1 ' || V_CONDITION || V_ORDERBY;

    V_SQL_COUNT_TOTAL:= 'SELECT COUNT(*) FROM s_groups a WHERE 1=1 ' || V_CONDITION;

    EXECUTE IMMEDIATE V_SQL_COUNT_TOTAL INTO p_totalRecord ;
    IF p_totalRecord IS NULL THEN
        p_totalRecord := 0;
    END IF;

    IF p_endAt <> 0 THEN
        V_SQL := 'SELECT * FROM ( SELECT ROWNUM AS STT, a.* FROM  ( ' || V_SQL   ||' ) a ) where STT >= '|| p_startAt ||' and STT <= ' || p_endAt;
    ELSE
        V_SQL := 'SELECT ROWNUM STT, a.* FROM  ( ' || V_SQL  || ') a ' ;
    END IF;

    OPEN p_cursor FOR V_SQL;

    EXCEPTION
    WHEN OTHERS THEN
    raise_application_error(-20005, V_SQL_COUNT_TOTAL);
    --RAISE;
END;

PROCEDURE proc_GroupUser_AddNew
(
    p_groupName IN s_groups.name % type,
    p_notes IN VARCHAR2,
    p_createdby IN s_groups.createdby % type,

    p_return OUT NUMBER
)
IS
    V_EXISTED NUMBER DEFAULT 0;
BEGIN
    SELECT COUNT(*) INTO V_EXISTED FROM s_groups a WHERE UPPER(a.name) = UPPER(p_groupName) AND a.deleted = 0;

    IF(V_EXISTED = 0) THEN
        INSERT INTO s_groups a (a.id, a.name, a.createdBy, a.createddate, a.deleted,a.notes)
        VALUES (seq_s_groups.nextval, p_groupName, p_createdby, SYSDATE, 0,p_notes);
        COMMIT;
        p_return:= 1100;
    ELSE
        p_return:= -1102;
    END IF;

EXCEPTION
WHEN OTHERS THEN
    p_return:= -1101;
RAISE;
END;

PROCEDURE proc_GroupUser_Edit
(
    p_groupId IN s_groups.id % type,
    p_groupName IN s_groups.name % type,
    p_notes IN VARCHAR2,
    p_modifiedBy IN s_groups.modifiedby % type,

    p_return OUT NUMBER
)
IS
    V_EXISTED NUMBER DEFAULT 0;
BEGIN
    SELECT COUNT(*) INTO V_EXISTED FROM s_groups a WHERE a.id = p_groupId AND a.deleted = 0;

    IF(V_EXISTED = 1) THEN
        SELECT COUNT(*) INTO V_EXISTED FROM s_groups a WHERE UPPER(a.name) = UPPER(p_groupName) AND a.id <> p_groupId AND a.deleted = 0;

        IF(V_EXISTED = 0) THEN
            UPDATE s_groups
            SET name = p_groupName, notes = p_notes,
                modifiedby = p_modifiedBy, modifiedDate = SYSDATE
            WHERE deleted=0 AND id=p_groupId;

            COMMIT;
            p_return:= 1103;
        ELSE
            p_return:= -1105;
        END IF;
    ELSE
        p_return:= -1106;
    END IF;

    EXCEPTION
    WHEN OTHERS THEN
        p_return:= -1104;
    RAISE;
END;

PROCEDURE proc_GroupUser_Delete
(
    p_groupId IN s_groups.id % type,
    p_modifiedBy IN s_groups.modifiedby % type,

    p_return OUT NUMBER
)
IS
    V_EXISTED NUMBER DEFAULT 0;
BEGIN

    SELECT COUNT(*) INTO V_EXISTED FROM s_groups a WHERE a.id = p_groupId AND a.deleted = 0;

    IF(V_EXISTED = 1) THEN
        SELECT COUNT(*) INTO V_EXISTED FROM s_group_user a WHERE a.groupId = p_groupId;

        IF(V_EXISTED = 0) THEN
            UPDATE s_groups SET deleted=1 WHERE id = p_groupId;
            DELETE FROM s_group_user WHERE groupId = p_groupId;
            DELETE FROM s_group_function WHERE groupId = p_groupId;

            COMMIT;
            p_return:= 1107;
        ELSE
            p_return:= -1109;
        END IF;
    ELSE
        p_return:= -1110;
    END IF;

    EXCEPTION
    WHEN OTHERS THEN
        p_return:= -1108;
    RAISE;
END;


-- function and group
PROCEDURE proc_SetupFunctionToGroup
(
    p_groupId IN NUMBER,
    p_functionId IN NUMBER,
    p_return OUT NUMBER
)
IS
BEGIN
    p_return:=-1;
    INSERT INTO s_group_function a (a.groupId, a.functionId) VALUES (p_groupId, p_functionId);
    -- no commit since use insert batch
    p_return:=1;
    EXCEPTION
    WHEN OTHERS THEN
        p_return:=-1;
    RAISE;
END;


PROCEDURE proc_DeleteFunctionFromGroup
(
    p_groupId IN NUMBER,
    p_return OUT NUMBER
)
IS
BEGIN
    p_return:=-1;
    DELETE FROM s_group_function a WHERE a.groupId = p_groupId;
    -- no commit this proc this next step after proc_DeleteFunctionFromGroup executed success
    p_return:= 1;
    EXCEPTION
    WHEN OTHERS THEN
        p_return:=-1;
    RAISE;
END;


PROCEDURE proc_GetAllFunctionInGroup
(
    p_groupId IN NUMBER,
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT fn.*, DECODE(gf.functionId, null, 0, 1) AS FunctionAddedToGroup
    FROM s_functions fn
    LEFT JOIN s_group_function gf
    ON fn.id = gf.functionId AND gf.groupId = p_groupId
    WHERE fn.functiontype = pkg_common.FN_MENU
    ORDER BY fn.position;

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;



END;
/


-- End of DDL Script for Package LEGALTECH.PKG_S_GROUPS

-- Start of DDL Script for Package LEGALTECH.PKG_S_MENU
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_s_menu
  IS TYPE tcursor IS REF Cursor;

PROCEDURE proc_Menu_GetAll
(
    p_cursor OUT tcursor
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_s_menu
IS

PROCEDURE proc_Menu_GetAll
(
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT * FROM s_menu ORDER BY position ASC;

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_S_MENU

-- Start of DDL Script for Package LEGALTECH.PKG_S_USERS
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_s_users
  IS TYPE tcursor IS REF Cursor;

PROCEDURE proc_User_CheckLogin
(
    p_username IN VARCHAR2,
    p_password  IN VARCHAR2,
    p_return    OUT NUMBER
);

PROCEDURE proc_User_GetById
(
    p_userId NUMBER,
    p_cursor OUT tcursor
);

PROCEDURE proc_User_GetByUsername
(
    p_username VARCHAR2,
    p_cursor OUT tcursor
);

PROCEDURE proc_User_GetBy_Type
(
    p_user_type IN NUMBER,
    p_cursor OUT tcursor
);

PROCEDURE proc_User_GetAll
(
    p_cursor OUT tcursor
);

PROCEDURE proc_User_GetAllUserId
(
    p_groupId NUMBER,
    p_cursor OUT tcursor
);

PROCEDURE proc_user_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);

PROCEDURE proc_User_Find
(
    p_userName IN VARCHAR2,
    p_fullName IN VARCHAR2,
    p_type IN VARCHAR2,
    p_status IN VARCHAR2,
    p_orderBy IN VARCHAR2,
    p_startAt IN NUMBER,
    p_endAt IN NUMBER,
    p_totalRecord OUT NUMBER,
    p_cursor OUT tcursor
);

PROCEDURE proc_User_AddNew
(
    p_username IN s_users.username % type,
    p_password IN s_users.password % type,
    p_fullName IN s_users.fullName % type,
    p_address IN s_users.address % type,
    p_DateOfBirth IN s_users.DateOfBirth % type,
    p_Sex IN s_users.Sex % type,
    p_Email IN s_users.Email % type,
    p_Phone IN s_users.Phone % type,
    p_fax IN VARCHAR2,
    p_Status In s_users.Status % type,
    p_type IN s_users.type % type,

    p_country IN s_users.country % TYPE,
    p_company_name IN s_users.company_name % TYPE,
    p_main_business IN s_users.main_business % TYPE,
    p_title IN s_users.title % TYPE,
    p_copyto IN s_users.copyto % TYPE,
    p_face_link IN s_users.face_link % TYPE,
    p_linkedin_link IN s_users.linkedin_link % TYPE,
    p_wechat_link IN s_users.wechat_link % TYPE,
    p_other_link IN s_users.other_link % TYPE,
    p_reason_select IN s_users.reason_select % TYPE,
    p_request_credit IN s_users.request_credit % TYPE,
    p_customer_code IN s_users.customer_code % TYPE,
    p_contact_person IN s_users.contact_person % TYPE,
    p_other_type IN s_users.other_type % TYPE,
    p_hourly_rate IN s_users.hourly_rate % TYPE,
    p_hourly_rate_usd IN s_users.hourly_rate % TYPE,
    p_GroupId IN VARCHAR2,
    p_createdby IN s_users.createdby % type,
    p_return OUT NUMBER
);

PROCEDURE proc_User_Edit
(
    p_userId   IN s_users.id % type,
    p_fullName IN s_users.fullName % type,
    p_address IN s_users.address % type,
    p_DateOfBirth IN s_users.DateOfBirth % type,
    p_Sex IN s_users.Sex % type,
    p_Email IN s_users.Email % type,
    p_Phone IN s_users.Phone % type,
    p_fax IN VARCHAR2,
    p_Status In s_users.Status % type,
    p_type IN s_users.type % type,

    p_country IN s_users.country % TYPE,
    p_company_name IN s_users.company_name % TYPE,
    p_main_business IN s_users.main_business % TYPE,
    p_title IN s_users.title % TYPE,
    p_copyto IN s_users.copyto % TYPE,
    p_face_link IN s_users.face_link % TYPE,
    p_linkedin_link IN s_users.linkedin_link % TYPE,
    p_wechat_link IN s_users.wechat_link % TYPE,
    p_other_link IN s_users.other_link % TYPE,
    p_reason_select IN s_users.reason_select % TYPE,
    p_request_credit IN s_users.request_credit % TYPE,
    p_customer_code IN s_users.customer_code % TYPE,
    p_contact_person IN s_users.contact_person % TYPE,
    p_other_type IN s_users.other_type % TYPE,
    p_hourly_rate IN s_users.hourly_rate % TYPE,
    p_hourly_rate_usd IN s_users.hourly_rate % TYPE,
    p_GroupId IN VARCHAR2,
    p_modifiedBy IN s_users.modifiedby % type,
    p_return OUT NUMBER
);

PROCEDURE proc_User_Delete
(
    p_userId IN NUMBER,
    p_modifiedby VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE proc_User_ChangePassword
(
    p_userId   IN s_users.id % type,
    p_oldPwd IN s_users.fullName % type,
    p_newPwd IN s_users.DateOfBirth % type,
    p_modifiedBy IN s_users.modifiedby % type,

    p_return OUT NUMBER
);

PROCEDURE proc_user_reset_pass
(
    p_user_name   IN s_users.username % type,
    p_password IN s_users.password % type,
    p_re_password IN s_users.password % type,
    p_modifiedBy IN s_users.modifiedby % type,
    p_return OUT NUMBER
);

PROCEDURE proc_User_GetAllUserRoles
(
    p_userId IN NUMBER,
    p_cursor OUT tcursor
);

PROCEDURE proc_User_GetAllSelfGroup
(
    p_userId NUMBER,
    p_cursor OUT tcursor
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_s_users
IS

PROCEDURE proc_User_CheckLogin
(
    p_username  IN VARCHAR2,
    p_password  IN VARCHAR2,
    p_return    OUT NUMBER
)
IS
BEGIN
    p_return:= 0;
    SELECT COUNT(*) INTO p_return FROM s_users
    WHERE username = p_username AND password = p_password AND status = pkg_common.USER_STATUS_ACTIVE AND deleted = 0;

    IF(p_return <> 1) THEN
        SELECT COUNT(*) INTO p_return FROM s_users
        WHERE username = p_username AND password = p_password AND status=pkg_common.USER_STATUS_STOPPED AND deleted = 0;

        IF(p_return = 0) THEN
            p_return:= -1002;
        ELSE
            p_return:= -1003;
        END IF;
    ELSE
        p_return:= 1000;
    END IF;


    EXCEPTION
    WHEN OTHERS THEN
        p_return:= -1001; -- failed
    RAISE;
END;

PROCEDURE proc_User_GetById
(
    p_userId NUMBER,
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT * FROM view_users a WHERE a.id = p_userId;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_User_GetByUsername
(
    p_username VARCHAR2,
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT * FROM view_users a WHERE a.username = p_username;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_User_GetBy_Type
(
    p_user_type IN NUMBER,
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT * FROM view_users a WHERE a.type = p_user_type ORDER BY fullname;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_User_GetAll
(
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT * FROM view_users a ORDER BY username;

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_User_GetAllUserId
(
    p_groupId NUMBER,
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT a.id
    FROM view_users a
    WHERE a.deleted = 0 AND a.id IN (SELECT userId FROM s_group_user WHERE groupId = p_groupId);

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_user_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    v_userName VARCHAR2(100) DEFAULT 'ALL';
    v_fullName VARCHAR2(250) DEFAULT 'ALL';
    v_type VARCHAR2(3) DEFAULT 'ALL';
    v_status VARCHAR2(3) DEFAULT 'ALL';


    V_FROM NUMBER ;
    V_TO NUMBER;
BEGIN

    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            v_userName := ITEM.CONDITION;
        ELSIF V_INDEX = 1 THEN
            v_fullName := ITEM.CONDITION;
        ELSIF V_INDEX = 2 THEN
            v_type := ITEM.CONDITION;
        ELSIF V_INDEX = 3 THEN
            v_status := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;

    IF v_userName <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(a.Username) LIKE UPPER(''%' || v_userName || '%'')';
    END IF;

    IF v_fullName <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(a.FullName) LIKE UPPER(''%' || v_fullName || '%'')';
    END IF;


    IF v_type <> 'ALL' THEN
        V_CONDITION:= V_CONDITION || ' AND UPPER(a.type) IN (' || v_type || ')';
    END IF;

    IF v_status <> 'ALL' THEN
        V_CONDITION:= V_CONDITION || ' AND a.status IN (' || v_status || ')';
    END IF;


    V_SQL := 'SELECT  A.* FROM view_users A WHERE 1 = 1 ';
    V_SQL :=  V_SQL || V_CONDITION;

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.ID DESC';
    END IF;

    DBMS_OUTPUT.PUT_LINE(V_SQL);


    V_TOTAL_COUNT := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_TOTAL_COUNT INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;

    --PKG_LOG.LOGMSGALL(V_SQL);


    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_User_Find
(
    p_userName IN VARCHAR2,
    p_fullName IN VARCHAR2,
    p_type IN VARCHAR2,
    p_status IN VARCHAR2,
    p_orderBy IN VARCHAR2,
    p_startAt IN NUMBER,
    p_endAt IN NUMBER,
    p_totalRecord OUT NUMBER,
    p_cursor OUT tcursor
)
IS
    V_SQL VARCHAR2(16000) DEFAULT '';
    V_SQL_COUNT_TOTAL VARCHAR2(16000) DEFAULT '';
    V_CONDITION VARCHAR2(8000) DEFAULT '';
    V_ORDERBY VARCHAR(500) DEFAULT '';
BEGIN
    V_CONDITION:= V_CONDITION || ' AND a.deleted=0 ';

    IF(LENGTH(p_fullName) > 0) THEN
        V_CONDITION:= V_CONDITION || ' AND UPPER(a.FullName) LIKE UPPER(''%' || p_fullName || '%'')';
    END IF;

    IF(LENGTH(p_userName) > 0) THEN
        V_CONDITION:= V_CONDITION || ' AND UPPER(a.Username) LIKE UPPER(''%' || p_userName || '%'')';
    END IF;

    IF(LENGTH(p_type) > 0) THEN
        V_CONDITION:= V_CONDITION || ' AND UPPER(a.type) IN (' || p_type || ')';
    END IF;

    IF(LENGTH(p_status) > 0) THEN
        V_CONDITION:= V_CONDITION || ' AND a.status IN (' || p_status || ')';
    END IF;

    IF (LENGTH(p_orderby) > 0)  THEN
        V_ORDERBY := ' ORDER BY ' || p_orderby;
    ELSE
        V_ORDERBY := ' ORDER BY LastTimeUpdated DESC ';
    END IF;

    V_SQL := 'SELECT * from view_users a WHERE 1=1 ' || V_CONDITION || V_ORDERBY;

    V_SQL_COUNT_TOTAL:= 'SELECT COUNT(*) FROM s_users a WHERE 1 = 1 ' || V_CONDITION;

    EXECUTE IMMEDIATE V_SQL_COUNT_TOTAL INTO p_totalRecord ;
    IF p_totalRecord IS NULL THEN
        p_totalRecord := 0;
    END IF;

    IF p_endAt <> 0 THEN
        V_SQL := 'SELECT * FROM ( SELECT ROWNUM AS STT, a.* FROM  ( ' || V_SQL   ||' ) a ) where STT >= '|| p_startAt ||' and STT <= ' || p_endAt;
    ELSE
        V_SQL := 'SELECT ROWNUM STT, a.* FROM  ( ' || V_SQL  || ') a ' ;
    END IF;

    OPEN p_cursor FOR V_SQL;

EXCEPTION
WHEN OTHERS THEN
    raise_application_error(-20005, V_SQL_COUNT_TOTAL);
    --RAISE;
END;

PROCEDURE proc_User_Delete
(
    p_userId IN NUMBER,
    p_modifiedby VARCHAR2,
    p_return OUT NUMBER
)
IS
    V_EXISTED NUMBER DEFAULT 0;
    V_USER_ACTIVE NUMBER DEFAULT 0;
BEGIN
    SELECT COUNT(*) INTO V_EXISTED FROM s_users a WHERE a.id = p_userId AND a.deleted = 0;

    IF(V_EXISTED = 1) THEN
        SELECT a.status INTO V_USER_ACTIVE FROM s_users a WHERE a.id = p_userId AND a.deleted = 0;

        IF(V_USER_ACTIVE <> pkg_common.USER_STATUS_ACTIVE) THEN
            UPDATE s_users a SET a.deleted = 1, a.modifiedby = p_modifiedby, a.modifieddate = SYSDATE
            WHERE a.id = p_userId;

            DELETE FROM s_group_user WHERE userId=p_userId;

            COMMIT;
            p_return:= p_userId;
        ELSE
            p_return:= -1208; -- user dang hoat dong
        END IF;
    ELSE
        p_return:= -1209; -- tai khoan khong ton tai
    END IF;

EXCEPTION
WHEN OTHERS THEN
     p_return:= -1207;
    RAISE;
END;

PROCEDURE proc_User_ChangePassword
(
    p_userId   IN s_users.id % type,
    p_oldPwd IN s_users.fullName % type,
    p_newPwd IN s_users.DateOfBirth % type,
    p_modifiedBy IN s_users.modifiedby % type,

    p_return OUT NUMBER
)
IS
    V_EXISTED NUMBER DEFAULT 0;
BEGIN
    SELECT COUNT(*) INTO V_EXISTED FROM s_users a WHERE a.id = p_userId AND a.deleted = 0;

    IF(V_EXISTED = 1) THEN
        SELECT COUNT(*) INTO V_EXISTED FROM s_users a WHERE a.id = p_userId AND a.deleted = 0 AND a.password = p_oldPwd;

        IF(V_EXISTED = 1) THEN
            UPDATE s_users SET
            password = p_newPwd,
            modifiedby = p_modifiedBy,
            modifieddate = SYSDATE
            WHERE id = p_userId;

            COMMIT;
            p_return := 1216;
        ELSE
            p_return := -1215; -- wrong password
        END IF;
    ELSE
        p_return := -1214; -- data invalid
    END IF;

    EXCEPTION
    WHEN OTHERS THEN
        p_return:= -1213;
    RAISE;
END;

PROCEDURE proc_user_reset_pass
(
    p_user_name   IN s_users.username % type,
    p_password IN s_users.password % type,
    p_re_password IN s_users.password % type,
    p_modifiedBy IN s_users.modifiedby % type,
    p_return OUT NUMBER
)
IS
BEGIN

    UPDATE s_users SET password = p_password, modifiedby = p_modifiedBy, modifieddate = SYSDATE
    WHERE username = p_user_name and deleted = 0;
    p_return := 0;
EXCEPTION
WHEN OTHERS THEN
    p_return:= -1;
    RAISE;
END;


PROCEDURE proc_User_GetAllUserRoles
(
    p_userId IN NUMBER,
    p_cursor OUT tcursor
)
IS
BEGIN
    IF (p_userId <> -99) THEN
        OPEN p_cursor FOR
        SELECT * FROM s_functions f
        WHERE f.deleted = 0 AND f.functionType = pkg_common.FN_IMMEDIATE_SELF OR f.id IN (
            SELECT DISTINCT functionId
            FROM s_group_function
            WHERE groupId IN (
                SELECT groupId FROM s_group_user WHERE userId=p_userId
            )
        ) ORDER BY  menuid , position  ;
    ELSE
        OPEN p_cursor FOR
        SELECT * FROM s_functions f WHERE deleted = 0 ORDER BY   menuid , position  ;
    END IF;

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_User_GetAllSelfGroup
(
    p_userId NUMBER,
    p_cursor OUT tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT DISTINCT GroupId FROM s_group_user WHERE UserId = p_userId;

    EXCEPTION
    WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_User_AddNew
(
    p_username IN s_users.username % type,
    p_password IN s_users.password % type,
    p_fullName IN s_users.fullName % type,
    p_address IN s_users.address % type,
    p_DateOfBirth IN s_users.DateOfBirth % type,
    p_Sex IN s_users.Sex % type,
    p_Email IN s_users.Email % type,
    p_Phone IN s_users.Phone % type,
    p_fax IN VARCHAR2,
    p_Status In s_users.Status % type,
    p_type IN s_users.type % type,

    p_country IN s_users.country % TYPE,
    p_company_name IN s_users.company_name % TYPE,
    p_main_business IN s_users.main_business % TYPE,
    p_title IN s_users.title % TYPE,
    p_copyto IN s_users.copyto % TYPE,
    p_face_link IN s_users.face_link % TYPE,
    p_linkedin_link IN s_users.linkedin_link % TYPE,
    p_wechat_link IN s_users.wechat_link % TYPE,
    p_other_link IN s_users.other_link % TYPE,
    p_reason_select IN s_users.reason_select % TYPE,
    p_request_credit IN s_users.request_credit % TYPE,
    p_customer_code IN s_users.customer_code % TYPE,
    p_contact_person IN s_users.contact_person % TYPE,
    p_other_type IN s_users.other_type % TYPE,
    p_hourly_rate IN s_users.hourly_rate % TYPE,
    p_hourly_rate_usd IN s_users.hourly_rate % TYPE,
    p_GroupId IN VARCHAR2,
    p_createdby IN s_users.createdby % type,
    p_return OUT NUMBER
)
IS
    V_EXISTED NUMBER DEFAULT 0;
    V_USERID NUMBER DEFAULT 0;
BEGIN
    SELECT COUNT(*) INTO V_EXISTED FROM s_users a
    WHERE UPPER(a.username) = UPPER(p_username) AND a.deleted = 0;
    IF(V_EXISTED = 0) THEN
        SELECT seq_s_users.NEXTVAL INTO V_USERID FROM dual;

        INSERT INTO s_users a
        (
            a.id, a.Username, a.Password, a.FullName, address, a.DateOfBirth, a.Sex, a.Email, a.Phone,
            a.TYPE, a.Status, a.createdBy, a.createddate, a.deleted,
            fax, country, company_name, main_business, title, copyto, face_link, linkedin_link, wechat_link, other_link,
            reason_select, request_credit, other_type, hourly_rate,customer_code,contact_person,hourly_rate_usd

        )
        VALUES
        (
            V_USERID, p_username, p_password, p_fullName,p_address, p_DateOfBirth, p_Sex, p_Email, p_Phone,
            p_type, p_Status, p_createdby ,SYSDATE, 0,
            p_fax, p_country, p_company_name, p_main_business, p_title, p_copyto, p_face_link, p_linkedin_link, p_wechat_link, p_other_link,
            p_reason_select, p_request_credit, p_other_type, p_hourly_rate, p_customer_code,p_contact_person,p_hourly_rate_usd
        );

        IF(LENGTH(p_GroupId) > 0) THEN
            INSERT INTO s_group_user(groupId, userId)
            VALUES(p_GroupId, V_USERID);
        END IF;

        COMMIT;
        p_return:= 1200;
    ELSE
        p_return:= -1202;
    END IF;

    EXCEPTION
    WHEN OTHERS THEN
        p_return:= -1201;
    RAISE;
END;

PROCEDURE proc_User_Edit
(
    p_userId   IN s_users.id % type,
    p_fullName IN s_users.fullName % type,
    p_address IN s_users.address % type,
    p_DateOfBirth IN s_users.DateOfBirth % type,
    p_Sex IN s_users.Sex % type,
    p_Email IN s_users.Email % type,
    p_Phone IN s_users.Phone % type,
    p_fax IN VARCHAR2,
    p_Status In s_users.Status % type,
    p_type IN s_users.type % type,

    p_country IN s_users.country % TYPE,
    p_company_name IN s_users.company_name % TYPE,
    p_main_business IN s_users.main_business % TYPE,
    p_title IN s_users.title % TYPE,
    p_copyto IN s_users.copyto % TYPE,
    p_face_link IN s_users.face_link % TYPE,
    p_linkedin_link IN s_users.linkedin_link % TYPE,
    p_wechat_link IN s_users.wechat_link % TYPE,
    p_other_link IN s_users.other_link % TYPE,
    p_reason_select IN s_users.reason_select % TYPE,
    p_request_credit IN s_users.request_credit % TYPE,
    p_customer_code IN s_users.customer_code % TYPE,
    p_contact_person IN s_users.contact_person % TYPE,
    p_other_type IN s_users.other_type % TYPE,
    p_hourly_rate IN s_users.hourly_rate % TYPE,
    p_hourly_rate_usd IN s_users.hourly_rate % TYPE,
    p_GroupId IN VARCHAR2,
    p_modifiedBy IN s_users.modifiedby % type,
    p_return OUT NUMBER
)
IS
    V_EXISTED NUMBER DEFAULT 0;
BEGIN
    SELECT COUNT(*) INTO V_EXISTED FROM s_users a
    WHERE a.id = p_userId AND a.deleted = 0;

    IF(V_EXISTED = 1) THEN

        UPDATE s_users SET
            FullName = p_fullName, address = p_address, DateOfBirth = p_DateOfBirth, Sex = p_Sex,
            Email = p_Email, Phone = p_Phone,
            TYPE = p_type, Status = p_Status,
            country = p_country,
            face_link = p_face_link,
            linkedin_link = p_linkedin_link,
            wechat_link = p_wechat_link,
            other_link = p_other_link,

            MODIFIEDDATE = SYSDATE,
            ModifiedBy = p_modifiedBy,
            loginfirst =1
        WHERE id = p_userId;

        IF p_type = pkg_common.USER_TYPE_LAWER THEN
            UPDATE s_users SET
                other_type = p_other_type,
                hourly_rate = p_hourly_rate,
                hourly_rate_usd = p_hourly_rate_usd,  loginfirst =1
            WHERE id = p_userId;
        ELSIF p_type = pkg_common.USER_TYPE_CUSTOMER THEN
            UPDATE s_users SET
                company_name = p_company_name,
                main_business = p_main_business,
                title = p_title, copyto = p_copyto,
                reason_select = p_reason_select,
                request_credit = p_request_credit,
                contact_person = p_contact_person,
                customer_code =  p_customer_code,  loginfirst =1
            WHERE id = p_userId;
        END IF;


        DELETE FROM s_group_user WHERE userId = p_userId;
        IF(LENGTH(p_GroupId) > 0) THEN
            INSERT INTO s_group_user(groupId, userId)
            VALUES(p_GroupId, p_userId);
        END IF;

        COMMIT;
        p_return:= p_userId;
    ELSE
        p_return:= -1205;
    END IF;

EXCEPTION
WHEN OTHERS THEN
    p_return:= -1204;
RAISE;
END;


END;
/


-- End of DDL Script for Package LEGALTECH.PKG_S_USERS

-- Start of DDL Script for Package LEGALTECH.PKG_SEARCH_CLASS_DETAIL
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_search_class_detail
  IS

PROCEDURE proc_insert
(

    p_textinput IN search_class_detail.TEXTINPUT % TYPE,
    p_code IN search_class_detail.CODE % TYPE ,
    p_seach_id IN NUMBER ,
    p_language_code IN VARCHAR2 ,
    p_return OUT NUMBER
);

PROCEDURE proc_delete
(

    p_search_id IN NUMBER ,
    p_language_code IN VARCHAR2 ,
    p_return OUT NUMBER
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_search_class_detail
IS

PROCEDURE proc_insert
(
    p_textinput IN search_class_detail.TEXTINPUT % TYPE,
    p_code IN search_class_detail.CODE % TYPE ,
    p_seach_id IN NUMBER ,
    p_language_code IN VARCHAR2 ,
    p_return OUT NUMBER
)
IS
    V_ID NUMBER := 0 ;
BEGIN
    P_RETURN:= 0;
    SELECT SEQ_SEARCH_CLASS_DETAIL.NEXTVAL INTO V_ID FROM DUAL;
    INSERT INTO SEARCH_CLASS_DETAIL
    (
        id, textinput, code, search_id, language_code
    )
    values
    (
        v_id, p_textinput, p_code, p_seach_id, p_language_code
    );

EXCEPTION
WHEN OTHERS THEN
    RAISE;
    P_RETURN:= -1;
END;



PROCEDURE proc_delete
(

    p_search_id IN NUMBER ,
    p_language_code IN VARCHAR2 ,
    p_return OUT NUMBER
)
IS
BEGIN
     DELETE SEARCH_CLASS_DETAIL WHERE search_id = p_search_id ;
     p_return := 0;


--KHONG COMMIT INSERT BATH
EXCEPTION
WHEN OTHERS THEN
    RAISE;
    p_return:= -1 ;
END;


END;
/


-- End of DDL Script for Package LEGALTECH.PKG_SEARCH_CLASS_DETAIL

-- Start of DDL Script for Package LEGALTECH.PKG_SEARCH_FEE
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_search_fee
  IS

-- dng cho billing
PROCEDURE proc_getByCaseCode_billing
(
    p_case_code IN VARCHAR2,
    p_user_name IN VARCHAR2,
    p_language_code IN VARCHAR2 ,
    p_cursor OUT pkg_common.t_cursor,
    p_cursor_detail OUT pkg_common.t_cursor
);

PROCEDURE proc_insert
(
    p_search_id IN search_fee.search_id % TYPE,
    p_country_id IN search_fee.country_id % TYPE,
    p_search_object IN search_fee.search_object % TYPE,
    p_search_type IN search_fee.search_type % TYPE,
    p_number_of_class IN search_fee.number_of_class % TYPE,
    p_amount IN search_fee.amount % TYPE,
    p_amount_usd IN search_fee.amount_usd % TYPE,
    p_return OUT NUMBER
);

PROCEDURE proc_delete_BySearchId
(
    p_search_id IN search_fee.search_id % TYPE,
    p_return OUT NUMBER
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_search_fee
IS
-- dng cho billing
PROCEDURE proc_getByCaseCode_billing
(
    p_case_code IN VARCHAR2,
    p_user_name IN VARCHAR2,
    p_language_code IN VARCHAR2 ,
    p_cursor OUT pkg_common.t_cursor,
    p_cursor_detail OUT pkg_common.t_cursor
)
IS
    v_id NUMBER;
    -- v_search_country NUMBER;     -- don thuoc nuoc nao
    v_customer_country NUMBER;      -- khach hang thuoc nuoc nao

    v_currency_type VARCHAR2(3) DEFAULT 'VND';   -- loai tien te, 0-vnd, 1-usd
BEGIN

    -- lay thong tin ve search header
    SELECT search_id,nvl(customer_country,pkg_common.COUNTRY_VN),currency_type
    INTO v_id,v_customer_country,v_currency_type
    FROM view_search WHERE upper(case_code) = upper(p_case_code);

    OPEN p_cursor FOR SELECT * FROM view_search WHERE upper(case_code) = upper(p_case_code);

    -- thng tin fee
    OPEN p_cursor_detail FOR
    SELECT A1.CONTENT || ' - ' || A2.CONTENT AS biling_detail_name,

       decode(v_currency_type,pkg_common.CURRENCY_VND, amount ,amount_usd) service_fee,
       pkg_common.BILLING_DETAIL_TYPE_SEARCH AS TYPE, A.id AS ref_id
    FROM SEARCH_FEE A
    LEFT JOIN ALLCODE A1 ON A.SEARCH_TYPE = A1.CDVAL AND A1.CDNAME = 'SEARCH_OBJECT' AND A1.CDTYPE =  'SEARCHTYPE'
    LEFT JOIN ALLCODE A2 ON A.SEARCH_OBJECT = A2.CDVAL AND A2.CDNAME = 'SEARCH_OBJECT' AND A2.CDTYPE =  'OBJECT'
    JOIN search_header sh ON sh.search_id = a.search_id
    WHERE sh.case_code = p_case_code AND A.status = pkg_common.APP_FEE_STATUS_NOT_USE
    AND A.amount > 0

    UNION

    -- thong tin timesheet
    SELECT name AS biling_detail_name,
        decode(v_currency_type,pkg_common.CURRENCY_VND, (nvl(hours_adjust,0) * nvl(hourly_rate,0)) ,(nvl(hours_adjust,0) * nvl(hourly_rate_usd,0))) service_fee,
        pkg_common.BILLING_DETAIL_TYPE_TIMESHEET AS TYPE, t.id AS ref_id
    FROM timesheet t
    JOIN s_users u ON u.username = t.created_by
    WHERE t.case_code = p_case_code AND t.status = pkg_common.TIME_SHEET_STATUS_APPROVE AND STATUS_BILLING = pkg_common.APP_FEE_STATUS_NOT_USE;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END ;


PROCEDURE proc_insert
(
    p_search_id IN search_fee.search_id % TYPE,
    p_country_id IN search_fee.country_id % TYPE,
    p_search_object IN search_fee.search_object % TYPE,
    p_search_type IN search_fee.search_type % TYPE,
    p_number_of_class IN search_fee.number_of_class % TYPE,
    p_amount IN search_fee.amount % TYPE,
    p_amount_usd IN search_fee.amount_usd % TYPE,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
BEGIN

    SELECT seq_SEARCH_FEE.NEXTVAL INTO v_id FROM dual;
    INSERT INTO search_fee
    (
        id,search_id, country_id, search_object, search_type, number_of_class, amount, amount_usd

    )
    VALUES
    (
        v_id, p_search_id, p_country_id, p_search_object, p_search_type, p_number_of_class, p_amount, p_amount_usd
    );

    p_return := v_id;

    --COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

PROCEDURE proc_delete_BySearchId
(
    p_search_id IN search_fee.search_id % TYPE,
    p_return OUT NUMBER
)
IS
BEGIN

    DELETE search_fee WHERE search_id = p_search_id;
    p_return := p_search_id;
    --COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;


END;
/


-- End of DDL Script for Package LEGALTECH.PKG_SEARCH_FEE

-- Start of DDL Script for Package LEGALTECH.PKG_SEARCH_OBJECTS
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_search_objects
 IS TYPE TCURSOR IS REF CURSOR;


PROCEDURE PROC_SEARCH_HEADER_INSERT
(
    P_CASE_CODE IN SEARCH_HEADER.CASE_CODE % TYPE,
    P_CLIENT_REFERENCE IN SEARCH_HEADER.CLIENT_REFERENCE % TYPE,
    P_CASE_NAME IN SEARCH_HEADER.CASE_NAME % TYPE,
    P_REQUEST_DATE IN SEARCH_HEADER.REQUEST_DATE % TYPE,
    P_RESPONSE_DATE IN SEARCH_HEADER.RESPONSE_DATE % TYPE,
    P_STATUS IN SEARCH_HEADER.STATUS % TYPE,
    P_COUNTRY_ID IN NUMBER,
    P_CREATED_BY IN SEARCH_HEADER.CREATED_BY % TYPE,
    P_CREATED_DATE IN SEARCH_HEADER.CREATED_DATE % TYPE,
    P_LANGUAGE_CODE IN SEARCH_HEADER.LANGUAGE_CODE % TYPE,
    P_NOTES in VARCHAR2,
    P_RETURN OUT NUMBER
);


PROCEDURE PROC_SEARCH_HEADER_UPDATE
(
    P_SEARCH_ID IN SEARCH_HEADER.SEARCH_ID % TYPE,
    P_CASE_CODE IN SEARCH_HEADER.CASE_CODE % TYPE,
    P_CLIENT_REFERENCE IN SEARCH_HEADER.CLIENT_REFERENCE % TYPE,
    P_CASE_NAME IN SEARCH_HEADER.CASE_NAME % TYPE,
    P_REQUEST_DATE IN SEARCH_HEADER.REQUEST_DATE % TYPE,
    P_RESPONSE_DATE IN SEARCH_HEADER.RESPONSE_DATE % TYPE,
    P_STATUS IN SEARCH_HEADER.STATUS % TYPE,
    P_LAWER_ID IN SEARCH_HEADER.LAWER_ID % TYPE,
    P_MODIFIED_BY IN SEARCH_HEADER.MODIFIED_BY % TYPE,
    P_MODIFIED_DATE IN SEARCH_HEADER.MODIFIED_DATE % TYPE,
    P_NOTES in VARCHAR2,
    P_RETURN OUT NUMBER
);


PROCEDURE PROC_SEARCH_HEADER_GETBYID
(
    P_SEARCH_ID IN SEARCH_HEADER.SEARCH_ID % TYPE,
    P_CURSOR OUT TCURSOR,
    P_DETAIL_CURSOR OUT TCURSOR,
    P_QUETION_CURSOR OUT TCURSOR,
    p_cursor_class OUT TCURSOR
);


PROCEDURE PROC_SEARCH_GETBY_CASECODE
(
    P_CASECODE IN SEARCH_HEADER.CASE_CODE % TYPE,
    P_CURSOR OUT TCURSOR,
    P_DETAIL_CURSOR OUT TCURSOR,
    P_QUETION_CURSOR OUT TCURSOR,
    p_cursor_class OUT TCURSOR
);

PROCEDURE PROC_SEARCH_HEADER_DELETE
(
    P_SEARCH_ID IN SEARCH_HEADER.SEARCH_ID % TYPE,
    p_user_name IN VARCHAR2,
    p_language in VARCHAR2,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_SEARCH_OBJECT_SEARCH
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);

PROCEDURE PROC_SEARCH_DETAIL_INSERT
(
    P_SEARCH_ID IN SEARCH_DETAIL.SEARCH_ID % TYPE,
    P_SEARCH_OBJECT IN SEARCH_DETAIL.SEARCH_OBJECT % TYPE,
    P_SEARCH_TYPE IN SEARCH_DETAIL.SEARCH_TYPE % TYPE,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_SEARCH_DETAIL_DELETE
(
    P_SEARCH_ID IN SEARCH_DETAIL.ID % TYPE,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_SEARCH_QUESTION_INSERT
(
    P_SEARCH_ID IN SEARCH_QUESTION.SEARCH_ID % TYPE,
    P_SUBJECT IN SEARCH_QUESTION.SUBJECT % TYPE,
    P_CONTENT IN SEARCH_QUESTION.CONTENT % TYPE,
    P_RESULT IN SEARCH_QUESTION.RESULT % TYPE,
    P_FILE_URL IN  SEARCH_QUESTION.FILE_URL % TYPE,
    P_FILE_URL02 IN  SEARCH_QUESTION.FILE_URL02 % TYPE,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_SEARCH_QUESTION_UPDATE
(
    P_SEARCH_ID IN SEARCH_QUESTION.SEARCH_ID % TYPE,
    P_CONTENT IN SEARCH_QUESTION.CONTENT % TYPE,
    P_RESULT IN SEARCH_QUESTION.RESULT % TYPE,
    P_FILE_URL IN  SEARCH_QUESTION.FILE_URL % TYPE,
    P_FILE_URL02 IN  SEARCH_QUESTION.FILE_URL02 % TYPE,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_SEARCH_QUESTION_DELETE
(
    P_SEARCH_ID IN SEARCH_DETAIL.ID % TYPE,
    P_RETURN OUT NUMBER
);


PROCEDURE PROC_GRANT_SEARCH2_LAWER
(
    p_case_code VARCHAR2,
    p_lawer_id IN NUMBER,
    p_notes IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_modified_by IN VARCHAR2,
    p_return out number
);

PROCEDURE proc_admin_comment
(
    p_case_code VARCHAR2,
    p_notes IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_modified_by IN VARCHAR2,
    p_return out number
);

PROCEDURE PROC_RESULT_SEARCH
(
    P_CASE_CODE VARCHAR2,
    P_NOTES IN VARCHAR2,
    P_RESULT IN VARCHAR2,
    P_FILE_URL_01 IN VARCHAR2,
    P_FILE_URL02 IN VARCHAR2,
    P_LANGUAGE_CODE VARCHAR2,
    p_modified_by VARCHAR2,
    P_RETURN OUT NUMBER
);

PROCEDURE proc_update_url_billing
(
    p_case_code IN VARCHAR2,
    p_url_billing IN VARCHAR2,
    p_return OUT NUMBER
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_search_objects
IS


PROCEDURE PROC_SEARCH_HEADER_INSERT
(
    P_CASE_CODE IN SEARCH_HEADER.CASE_CODE % TYPE,
    P_CLIENT_REFERENCE IN SEARCH_HEADER.CLIENT_REFERENCE % TYPE,
    P_CASE_NAME IN SEARCH_HEADER.CASE_NAME % TYPE,
    P_REQUEST_DATE IN SEARCH_HEADER.REQUEST_DATE % TYPE,
    P_RESPONSE_DATE IN SEARCH_HEADER.RESPONSE_DATE % TYPE,
    P_STATUS IN SEARCH_HEADER.STATUS % TYPE,
    P_COUNTRY_ID IN NUMBER,
    P_CREATED_BY IN SEARCH_HEADER.CREATED_BY % TYPE,
    P_CREATED_DATE IN SEARCH_HEADER.CREATED_DATE % TYPE,
    P_LANGUAGE_CODE IN SEARCH_HEADER.LANGUAGE_CODE % TYPE,
    P_NOTES in VARCHAR2,
    P_RETURN OUT NUMBER
)
IS
   V_ID NUMBER;
   V_COUNT NUMBER;
   V_CASE_CODE VARCHAR2(100);
   V_ID_CASE_CODE VARCHAR2(100);
   v_admin_id NUMBER;
BEGIN
    SELECT SEQ_GENCODE.NEXTVAL INTO V_ID_CASE_CODE FROM DUAL;

    V_CASE_CODE := 'SEARCH' || to_char(SYSDATE,'yyyyMMdd') || V_ID_CASE_CODE;

    -- lay user ADMIN
    SELECT COUNT(*) INTO V_COUNT FROM s_users WHERE country = P_COUNTRY_ID AND TYPE = pkg_common.USER_TYPE_ADMIN;
    IF V_COUNT > 0 THEN
        SELECT id INTO v_admin_id FROM s_users WHERE country = P_COUNTRY_ID AND TYPE = pkg_common.USER_TYPE_ADMIN;
    ELSE
        SELECT id INTO v_admin_id FROM s_users WHERE username = pkg_common.USER_ADMIN;
    END IF;

    SELECT SEQ_SEARCH_HEADER.NEXTVAL INTO V_ID FROM DUAL;
    INSERT INTO SEARCH_HEADER
    (
        SEARCH_ID, CASE_CODE, CLIENT_REFERENCE, CASE_NAME, REQUEST_DATE, RESPONSE_DATE,
        STATUS, COUNTRY_ID, CREATED_BY, CREATED_DATE,  LANGUAGE_CODE, NOTE
     )
    VALUES
    (
        V_ID, V_CASE_CODE, P_CLIENT_REFERENCE, P_CASE_NAME, P_REQUEST_DATE, TRUNC(P_RESPONSE_DATE),
        P_STATUS, P_COUNTRY_ID, P_CREATED_BY, TRUNC(P_CREATED_DATE),  P_LANGUAGE_CODE, P_NOTES
    );

    -- insert todo
    pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_SEARCH,V_CASE_CODE,p_language_code);

    P_RETURN := V_ID;

    --COMMIT;
EXCEPTION
WHEN OTHERS THEN
RAISE;
END;


PROCEDURE PROC_SEARCH_HEADER_UPDATE
(
    P_SEARCH_ID IN SEARCH_HEADER.SEARCH_ID % TYPE,
    P_CASE_CODE IN SEARCH_HEADER.CASE_CODE % TYPE,
    P_CLIENT_REFERENCE IN SEARCH_HEADER.CLIENT_REFERENCE % TYPE,
    P_CASE_NAME IN SEARCH_HEADER.CASE_NAME % TYPE,
    P_REQUEST_DATE IN SEARCH_HEADER.REQUEST_DATE % TYPE,
    P_RESPONSE_DATE IN SEARCH_HEADER.RESPONSE_DATE % TYPE,
    P_STATUS IN SEARCH_HEADER.STATUS % TYPE,
    P_LAWER_ID IN SEARCH_HEADER.LAWER_ID % TYPE,
    P_MODIFIED_BY IN SEARCH_HEADER.MODIFIED_BY % TYPE,
    P_MODIFIED_DATE IN SEARCH_HEADER.MODIFIED_DATE % TYPE,
    P_NOTES in VARCHAR2,
    P_RETURN OUT NUMBER
)
IS
V_COUNT NUMBER;
BEGIN


    P_RETURN := 0;
    UPDATE SEARCH_HEADER SET
        SEARCH_ID = P_SEARCH_ID,
        --CASE_CODE = P_CASE_CODE,
        CLIENT_REFERENCE = P_CLIENT_REFERENCE,
        CASE_NAME = P_CASE_NAME,
        STATUS = P_STATUS,
        --REQUEST_DATE = TRUNC(P_REQUEST_DATE),
        --RESPONSE_DATE = TRUNC(P_RESPONSE_DATE),
        --LAWER_ID = P_LAWER_ID,
        MODIFIED_BY = P_MODIFIED_BY,
        MODIFIED_DATE = TRUNC(P_MODIFIED_DATE)
    WHERE SEARCH_ID = P_SEARCH_ID;

    --COMMIT;
EXCEPTION
WHEN OTHERS THEN
    ROLLBACK;
    P_RETURN := -1;
    RAISE;
END;


PROCEDURE PROC_SEARCH_HEADER_GETBYID
(
    P_SEARCH_ID IN SEARCH_HEADER.SEARCH_ID % TYPE,
    P_CURSOR OUT TCURSOR,
    P_DETAIL_CURSOR OUT TCURSOR,
    P_QUETION_CURSOR OUT TCURSOR,
    p_cursor_class OUT TCURSOR
)
IS
 BEGIN
    OPEN P_CURSOR FOR
    SELECT A.* FROM View_Search A WHERE  A.SEARCH_ID = P_SEARCH_ID;

    OPEN P_DETAIL_CURSOR FOR
    SELECT A.*, CASE WHEN A.STT = 1 THEN 1 ELSE 0 END AS IS_FIRST FROM
    (
        SELECT ROWNUM AS STT, B.* FROM
        (
            SELECT A.*,  A1.CONTENT AS SEARCH_TYPE_NAME,  A2.CONTENT AS SEARCH_OBJECT_NAME
            FROM SEARCH_DETAIL A
            LEFT JOIN ALLCODE A1 ON A.SEARCH_TYPE = A1.CDVAL AND A1.CDNAME = 'SEARCH_OBJECT' AND A1.CDTYPE =  'SEARCHTYPE'
            LEFT JOIN  ALLCODE A2 ON A.SEARCH_OBJECT = A2.CDVAL AND A2.CDNAME = 'SEARCH_OBJECT' AND A2.CDTYPE =  'OBJECT'
            WHERE A.SEARCH_ID = P_SEARCH_ID
            ORDER BY ID
        ) B
    ) A;

    OPEN P_QUETION_CURSOR FOR SELECT * FROM SEARCH_QUESTION A
    WHERE A.SEARCH_ID = P_SEARCH_ID;

    OPEN p_cursor_class FOR SELECT * FROM SEARCH_CLASS_DETAIL A WHERE A.SEARCH_ID = P_SEARCH_ID;
EXCEPTION
WHEN OTHERS THEN
RAISE;
END;

PROCEDURE PROC_SEARCH_GETBY_CASECODE
(
    P_CASECODE IN SEARCH_HEADER.CASE_CODE % TYPE,
    P_CURSOR OUT TCURSOR,
    P_DETAIL_CURSOR OUT TCURSOR,
    P_QUETION_CURSOR OUT TCURSOR,
    p_cursor_class OUT TCURSOR
)
IS
    V_SEARCHID NUMBER;
BEGIN

    SELECT SEARCH_ID INTO V_SEARCHID FROM  SEARCH_HEADER WHERE UPPER(CASE_CODE) = UPPER(P_CASECODE) AND DELETED = 0 ;

    OPEN P_CURSOR FOR
    SELECT A.* FROM VIEW_SEARCH A WHERE A.SEARCH_ID = V_SEARCHID;

    OPEN P_DETAIL_CURSOR FOR
    SELECT A.*, CASE WHEN A.STT = 1 THEN 1 ELSE 0 END AS IS_FIRST FROM
    (
        SELECT ROWNUM AS STT, B.* FROM
        (
            SELECT A.*,  A1.CONTENT AS SEARCH_TYPE_NAME,  A2.CONTENT AS SEARCH_OBJECT_NAME
            FROM SEARCH_DETAIL A
            LEFT JOIN ALLCODE A1 ON A.SEARCH_TYPE = A1.CDVAL AND A1.CDNAME = 'SEARCH_OBJECT' AND A1.CDTYPE =  'SEARCHTYPE'
            LEFT JOIN  ALLCODE A2 ON A.SEARCH_OBJECT = A2.CDVAL AND A2.CDNAME = 'SEARCH_OBJECT' AND A2.CDTYPE =  'OBJECT'
            WHERE A.SEARCH_ID = V_SEARCHID
            ORDER BY ID
        ) B
    ) A;

    OPEN P_QUETION_CURSOR FOR SELECT * FROM SEARCH_QUESTION A
    WHERE A.SEARCH_ID = V_SEARCHID;

    OPEN p_cursor_class FOR SELECT * FROM SEARCH_CLASS_DETAIL A WHERE A.SEARCH_ID = V_SEARCHID;

EXCEPTION
WHEN OTHERS THEN
RAISE;
END;


PROCEDURE PROC_SEARCH_HEADER_DELETE
(
    P_SEARCH_ID IN SEARCH_HEADER.SEARCH_ID % TYPE,
    p_user_name IN VARCHAR2,
    p_language in VARCHAR2,
    P_RETURN OUT NUMBER
)
IS
    v_case_code VARCHAR2(50) DEFAULT '';
    v_status NUMBER;
BEGIN

    -- thong tin billing
    SELECT case_code,status INTO v_case_code,v_status FROM search_header WHERE SEARCH_ID = P_SEARCH_ID;


    UPDATE SEARCH_HEADER A SET A.DELETED = 1, modified_by = p_user_name, modified_date = SYSDATE
    WHERE A.SEARCH_ID = P_SEARCH_ID;
    UPDATE SEARCH_DETAIL A SET A.DELETED = 1 WHERE A.SEARCH_ID = P_SEARCH_ID;
    UPDATE SEARCH_QUESTION A SET A.DELETED = 1 WHERE A.SEARCH_ID = P_SEARCH_ID;

    DELETE b_todos WHERE TYPE = pkg_common.TODO_TYPE_SEARCH AND case_code = v_case_code AND status = pkg_common.TODO_STATUS_REVIEW;

    P_RETURN := 0;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
    P_RETURN := -1;
END;

PROCEDURE PROC_SEARCH_OBJECT_SEARCH
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR

)

 IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_SQL_TOTAL VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));



    V_FROM NUMBER ;
    V_TO NUMBER;
    V_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_CASECODE VARCHAR2(100) DEFAULT 'ALL';
    V_CLIENTREF VARCHAR2(100) DEFAULT 'ALL';
    V_REQUEST_BY VARCHAR2(100) DEFAULT 'ALL';
    V_PROCESS_BY VARCHAR2(100) DEFAULT 'ALL';
BEGIN

   --PKG_LOG.LOGMSG('vao 1'); commit;
    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_STATUS := ITEM.CONDITION;
        END IF;
        IF V_INDEX = 1 THEN
            V_CASECODE := ITEM.CONDITION;
        END IF;
        IF V_INDEX = 2 THEN
            V_CLIENTREF := ITEM.CONDITION;
        END IF;
        IF V_INDEX = 3 THEN
            V_REQUEST_BY := ITEM.CONDITION;
        END IF;
        IF V_INDEX = 4 THEN
            V_PROCESS_BY := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;

 --  PKG_LOG.LOGMSG('vao 2'); commit;
    IF V_STATUS <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND A.STATUS IN  (' || V_STATUS || ') ';
    END IF;

    IF V_CASECODE <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND A.CASE_CODE LIKE  ''%' || V_CASECODE || '%'' ';
    END IF;

    IF V_CLIENTREF <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND A.CLIENT_REFERENCE LIKE  ''%' || V_CLIENTREF || '%'' ';
    END IF;

    IF V_CLIENTREF <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND ( A.CREATED_BY LIKE  ''%' || V_REQUEST_BY || '%''  OR US.FULLNAME LIKE  ''%' || V_REQUEST_BY || '%'' )';
    END IF;

    IF V_PROCESS_BY <> 'ALL' THEN
    -- CHO NAY TAM THOI LAY NHU NGUOI TAO
        V_CONDITION :=  V_PROCESS_BY || ' AND ( A.CREATED_BY LIKE  ''%' || V_REQUEST_BY || '%''  OR USER.FULLNAME LIKE  ''%' || V_REQUEST_BY || '%'' )';
    END IF;

    V_SQL := 'SELECT * from view_search A where 1 = 1 ';

    V_SQL :=  V_SQL || V_CONDITION;

    IF P_SORT_TYPE <> 'ALL' AND LENGTH(P_SORT_TYPE) > 0   THEN
        V_SQL :=  V_SQL || ' ORDER BY ' || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.MODIFIED_BY DESC';
    END IF;


    --PKG_LOG.LOGMSG(V_SQL); COMMIT;
    V_SQL_TOTAL := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_SQL_TOTAL INTO V_SQL_TOTAL;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_SQL_TOTAL;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;
    P_TOTAL_RECORD := V_SQL_TOTAL;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE PROC_SEARCH_DETAIL_INSERT
(
    P_SEARCH_ID IN SEARCH_DETAIL.SEARCH_ID % TYPE,
    P_SEARCH_OBJECT IN SEARCH_DETAIL.SEARCH_OBJECT % TYPE,
    P_SEARCH_TYPE IN SEARCH_DETAIL.SEARCH_TYPE % TYPE,
    P_RETURN OUT NUMBER
)
IS
    V_ID NUMBER;
BEGIN

    SELECT SEQ_SEARCH_DETAIL.NEXTVAL INTO V_ID FROM DUAL;
    INSERT INTO SEARCH_DETAIL
    (
        ID,  SEARCH_ID, SEARCH_OBJECT, SEARCH_TYPE
    )
    VALUES
    (
        V_ID, P_SEARCH_ID,P_SEARCH_OBJECT,  P_SEARCH_TYPE
    );

    P_RETURN := V_ID;

    --COMMIT;
EXCEPTION
WHEN OTHERS THEN
    P_RETURN := -1;
    ROLLBACK;
    RAISE;
END;


PROCEDURE PROC_SEARCH_DETAIL_DELETE
(
    P_SEARCH_ID IN SEARCH_DETAIL.ID % TYPE,
    P_RETURN OUT NUMBER
)
IS
    V_ID NUMBER;
BEGIN
    P_RETURN := 0;
    DELETE FROM SEARCH_DETAIL A WHERE A.SEARCH_ID = P_SEARCH_ID;

    --COMMIT;
EXCEPTION
WHEN OTHERS THEN
    P_RETURN := -1;
    ROLLBACK;
    RAISE;
END;


PROCEDURE PROC_SEARCH_QUESTION_INSERT
(
    P_SEARCH_ID IN SEARCH_QUESTION.SEARCH_ID % TYPE,
    P_SUBJECT IN SEARCH_QUESTION.SUBJECT % TYPE,
    P_CONTENT IN SEARCH_QUESTION.CONTENT % TYPE,
    P_RESULT IN SEARCH_QUESTION.RESULT % TYPE,
    P_FILE_URL IN  SEARCH_QUESTION.FILE_URL % TYPE,
    P_FILE_URL02 IN  SEARCH_QUESTION.FILE_URL02 % TYPE,
    P_RETURN OUT NUMBER
)
IS
V_ID  NUMBER;
BEGIN

    SELECT SEQ_SEARCH_QUESTION.NEXTVAL INTO V_ID FROM DUAL;
    INSERT INTO SEARCH_QUESTION
    (
        QUESTION_ID, SEARCH_ID, SUBJECT, CONTENT, RESULT, FILE_URL, FILE_URL02
    )
    VALUES
    (
        V_ID, P_SEARCH_ID, P_SUBJECT, P_CONTENT, P_RESULT, P_FILE_URL, P_FILE_URL02
    );

    P_RETURN := V_ID;

    --COMMIT;
EXCEPTION
WHEN OTHERS THEN
    P_RETURN := -1;
    RAISE;
END;


PROCEDURE PROC_SEARCH_QUESTION_UPDATE
(
    P_SEARCH_ID IN SEARCH_QUESTION.SEARCH_ID % TYPE,
    P_CONTENT IN SEARCH_QUESTION.CONTENT % TYPE,
    P_RESULT IN SEARCH_QUESTION.RESULT % TYPE,
    P_FILE_URL IN  SEARCH_QUESTION.FILE_URL % TYPE,
    P_FILE_URL02 IN  SEARCH_QUESTION.FILE_URL02 % TYPE,
    P_RETURN OUT NUMBER
)
IS
BEGIN
    P_RETURN := 0;
    UPDATE SEARCH_QUESTION A
    SET a.CONTENT = P_CONTENT,
        A.RESULT = P_RESULT , FILE_URL = P_FILE_URL,
        FILE_URL02 = P_FILE_URL02
    WHERE A.SEARCH_ID = P_SEARCH_ID;

    --COMMIT;
EXCEPTION
WHEN OTHERS THEN
    P_RETURN := -1;
    RAISE;
END;


PROCEDURE PROC_SEARCH_QUESTION_DELETE
(
    P_SEARCH_ID IN SEARCH_DETAIL.ID % TYPE,
    P_RETURN OUT NUMBER
)
IS
    V_ID NUMBER;
BEGIN
    P_RETURN := 0;
    DELETE FROM SEARCH_QUESTION A WHERE A.SEARCH_ID = P_SEARCH_ID;


    --COMMIT;
EXCEPTION
WHEN OTHERS THEN
    P_RETURN := -1;
    ROLLBACK;
    RAISE;
END;

PROCEDURE PROC_GRANT_SEARCH2_LAWER
(
    p_case_code VARCHAR2,
    p_lawer_id IN NUMBER,
    p_notes IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_modified_by IN VARCHAR2,
    p_return out number
)
IS
BEGIN

    UPDATE SEARCH_HEADER
    SET STATUS = PKG_COMMON.SEARCH_STATUS_GRANT_LAWER,
        MODIFIED_DATE = SYSDATE,
        MODIFIED_BY = p_modified_by,
        lawer_id = P_LAWER_ID,
        NOTE = P_NOTES
        --USER_PROCESSING = V_LAWER_NAME
        --ADMIN_ID = V_ADMIN_ID
    WHERE CASE_CODE = P_CASE_CODE;


    -- UPDATE TRANG THAI REVIEW
    -- INSERT TODO
    PKG_TODOS.PROC_DO_INSERT(PKG_COMMON.TODO_TYPE_SEARCH,P_CASE_CODE,P_LANGUAGE_CODE);

    P_RETURN := 0;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_admin_comment
(
    p_case_code VARCHAR2,
    p_notes IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_modified_by IN VARCHAR2,
    p_return out number
)
IS
BEGIN

    UPDATE SEARCH_HEADER
    SET STATUS = PKG_COMMON.SEARCH_STATUS_ADMIN_CONFIRMED,
        MODIFIED_DATE = SYSDATE,
        MODIFIED_BY = p_modified_by,
        NOTE = P_NOTES
    WHERE CASE_CODE = P_CASE_CODE;

    -- INSERT TODO
    PKG_TODOS.PROC_DO_INSERT(PKG_COMMON.TODO_TYPE_SEARCH,P_CASE_CODE,P_LANGUAGE_CODE);

    P_RETURN := 0;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE PROC_RESULT_SEARCH
(
    P_CASE_CODE VARCHAR2,
    P_NOTES IN VARCHAR2,
    P_RESULT IN VARCHAR2,
    P_FILE_URL_01 IN VARCHAR2,
    P_FILE_URL02 IN VARCHAR2,
    P_LANGUAGE_CODE VARCHAR2,
    p_modified_by VARCHAR2,
    P_RETURN OUT NUMBER
)
IS
    V_ID NUMBER;
    V_LAWER_NAME VARCHAR2(200) DEFAULT '';
    V_COUNT NUMBER;

    --V_CASE_CODE VARCHAR2(50) DEFAULT '';
    V_SEARCH_ID NUMBER;
BEGIN
    SELECT SEARCH_ID INTO V_SEARCH_ID FROM SEARCH_HEADER A WHERE A.CASE_CODE = P_CASE_CODE;

    -- update header
    UPDATE SEARCH_HEADER
    SET STATUS = PKG_COMMON.SEARCH_STATUS_LAWER_CONFIRMED,
        MODIFIED_DATE = SYSDATE,
        MODIFIED_BY = p_modified_by,
        RESPONSE_DATE = SYSDATE,
        NOTE = P_NOTES
    WHERE SEARCH_ID = V_SEARCH_ID;


    -- update question
    UPDATE SEARCH_QUESTION  A SET A.RESULT = P_RESULT,file_url = P_FILE_URL_01,file_url02 = P_FILE_URL02 WHERE SEARCH_ID = V_SEARCH_ID;


    -- UPDATE TRANG THAI REVIEW -> da cho vao trong todo roi
    -- INSERT TODO
    PKG_TODOS.PROC_DO_INSERT(PKG_COMMON.TODO_TYPE_SEARCH,P_CASE_CODE,P_LANGUAGE_CODE);


    P_RETURN := 0;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_update_url_billing
(
    p_case_code IN VARCHAR2,
    p_url_billing IN VARCHAR2,
    p_return OUT NUMBER
)
IS
BEGIN

    UPDATE search_header
    SET URL_BILLING = p_url_billing
    WHERE case_code = p_case_code;

    p_return := 1;

EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_SEARCH_OBJECTS

-- Start of DDL Script for Package LEGALTECH.PKG_SYS_APPLICATION
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_sys_application
  IS

PROCEDURE PROC_SYS_APPLICATION_GETALL
(
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);

PROCEDURE proc_sys_app_fix_charge_getall
(
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);

PROCEDURE PROC_SYS_APP_FIX_GET_BY_ID
(
    P_ID IN NUMBER  ,
    P_APPCODE IN VARCHAR2   ,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);

PROCEDURE PROC_SYS_APP_FIX_UPDATE
(
    P_ID IN NUMBER ,
    P_APPCODE IN VARCHAR2 ,
    p_amount IN NUMBER ,
    p_amount_usd IN NUMBER ,
    p_amount_represent IN NUMBER ,
    p_amount_represent_usd IN NUMBER ,
    P_CHAR01 IN VARCHAR2 ,
    P_DESCRIPTION IN VARCHAR2 ,
    P_RETURN OUT NUMBER
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_sys_application
IS

PROCEDURE PROC_SYS_APPLICATION_GETALL
(
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS

BEGIN
    OPEN P_CURSOR FOR
    SELECT * FROM SYS_APPLICATION WHERE DISPLAY = 1 ORDER BY LISTORD ;
END;

PROCEDURE PROC_SYS_APP_FIX_CHARGE_GETALL
(
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS

BEGIN
    OPEN P_CURSOR FOR
  SELECT A.ID, A.APPCODE,B.APPNAME TITLE, A.FEE_ID, NVL(A.AMOUNT,0) AMOUNT, NVL(A.CHAR01,0 ) CHAR01 , A.CHAR02,
       A.CHAR03, A.DESCRIPTION, A.ORDERBY, A.ORDERBY,A.amount_usd,A.amount_represent,A.amount_represent_usd
  FROM SYS_APP_FIX_CHARGE A  INNER JOIN  SYS_APPLICATION B ON A.APPCODE = B.APPCODE AND B.LANGUAGECODE ='VI_VN' ORDER BY APPCODE;
END;



PROCEDURE PROC_SYS_APP_FIX_GET_BY_ID
(
    P_ID IN NUMBER ,
    P_APPCODE IN VARCHAR2 ,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS

BEGIN
    OPEN P_CURSOR FOR   SELECT A.ID, A.APPCODE, B.APPNAME TITLE, A.FEE_ID, NVL(A.AMOUNT,0) AMOUNT, NVL(A.CHAR01,0 ) CHAR01 , A.CHAR02,
       A.CHAR03, A.DESCRIPTION, A.ORDERBY,A.amount_usd,A.amount_represent,A.amount_represent_usd
  FROM SYS_APP_FIX_CHARGE A
  INNER JOIN  SYS_APPLICATION B ON A.APPCODE = B.APPCODE AND B.LANGUAGECODE ='VI_VN'
  WHERE A.ID =P_ID AND A.APPCODE =P_APPCODE ORDER BY A.APPCODE ;
END;


PROCEDURE PROC_SYS_APP_FIX_UPDATE
(
    p_id IN NUMBER ,
    p_appcode IN VARCHAR2 ,
    p_amount IN NUMBER ,
    p_amount_usd IN NUMBER ,
    p_amount_represent IN NUMBER ,
    p_amount_represent_usd IN NUMBER ,
    p_char01 IN VARCHAR2 ,
    p_description IN VARCHAR2 ,
    p_return OUT NUMBER
)
IS

BEGIN
     UPDATE  SYS_APP_FIX_CHARGE
     SET amount = P_AMOUNT,
        amount_usd = p_amount_usd,
        amount_represent = p_amount_represent,
        amount_represent_usd = p_amount_represent_usd,
        char01 = P_CHAR01 , description =P_DESCRIPTION
     WHERE id = P_ID AND appcode  = P_APPCODE   ;
     P_RETURN :=0;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
     P_RETURN := -2 ;
     RAISE;
END;



END;
/


-- End of DDL Script for Package LEGALTECH.PKG_SYS_APPLICATION

-- Start of DDL Script for Package LEGALTECH.PKG_SYS_SEARCH_FIX
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_sys_search_fix
  IS

PROCEDURE proc_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);

PROCEDURE proc_getall
(
    p_cursor OUT PKG_COMMON.T_CURSOR
);

PROCEDURE Proc_Sys_Search_Fee_Insert
(
    p_country_id IN NUMBER,
    p_search_object IN NUMBER,
    p_search_type IN NUMBER,
    p_amount IN NUMBER,
    p_amount_usd IN NUMBER,
    p_created_by IN VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE proc_sys_search_fee_update
(
    p_id IN sys_search_fee.id % TYPE,
    p_country_id IN sys_search_fee.country_id % TYPE,
    p_search_object IN sys_search_fee.search_object % TYPE,
    p_search_type IN sys_search_fee.search_type % TYPE,
    p_amount IN sys_search_fee.amount % TYPE,
    p_amount_usd IN sys_search_fee.amount_usd % TYPE,
    p_modified_by in VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE proc_get_by_id
(
    p_id IN sys_search_fee.id % TYPE,
    p_cursor out pkg_common.T_CURSOR
);

PROCEDURE proc_delete
(
    p_id IN sys_search_fee.id % TYPE,
    p_modified_by in VARCHAR2,
    p_return OUT NUMBER
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_sys_search_fix
IS

PROCEDURE proc_getall
(
    p_cursor OUT PKG_COMMON.T_CURSOR
)
IS

BEGIN
    OPEN P_CURSOR FOR
    SELECT a.*, A1.CONTENT AS SEARCH_TYPE_NAME,  A2.CONTENT AS SEARCH_OBJECT_NAME, c.name AS country_name
    FROM sys_search_fee A
    LEFT JOIN ALLCODE A1 ON A.SEARCH_TYPE = A1.CDVAL AND A1.CDNAME = 'SEARCH_OBJECT' AND A1.CDTYPE =  'SEARCHTYPE'
    LEFT JOIN  ALLCODE A2 ON A.SEARCH_OBJECT = A2.CDVAL AND A2.CDNAME = 'SEARCH_OBJECT' AND A2.CDTYPE =  'OBJECT'
    JOIN country c ON c.country_id = a.country_id
    WHERE deleted = 0
    ORDER BY A.country_id,id DESC;
END;

PROCEDURE proc_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_COUNTRY VARCHAR2(5) DEFAULT 'ALL';

    V_OBJECT VARCHAR2(3) DEFAULT 'ALL';
    V_TYPE VARCHAR2(3) DEFAULT 'ALL';

    V_FROM NUMBER ;
    V_TO NUMBER;
BEGIN


    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_COUNTRY := ITEM.CONDITION;
        ELSIF V_INDEX = 1 THEN
            V_OBJECT := ITEM.CONDITION;
        ELSIF V_INDEX = 2 THEN
            V_TYPE := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;

    IF V_COUNTRY <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND A.COUNTRY_ID = ' || V_COUNTRY;
    END IF;

    IF V_OBJECT <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND A.SEARCH_OBJECT = ' || V_OBJECT;
    END IF;

    IF V_TYPE <> 'ALL' THEN
        V_CONDITION := V_CONDITION || ' AND A.SEARCH_TYPE = ' || V_TYPE;
    END IF;


    V_SQL := 'SELECT a.* FROM view_sys_search_fee A WHERE 1 = 1 ';
    V_SQL :=  V_SQL || V_CONDITION;

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.COUNTRY_ID desc,A.search_object,search_type';
    END IF;

    DBMS_OUTPUT.PUT_LINE(V_SQL);


    V_TOTAL_COUNT := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_TOTAL_COUNT INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;

    --PKG_LOG.LOGMSGALL(V_SQL);


    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE Proc_Sys_Search_Fee_Insert
(
    p_country_id IN NUMBER,
    p_search_object IN NUMBER,
    p_search_type IN NUMBER,
    p_amount IN NUMBER,
    p_amount_usd IN NUMBER,
    p_created_by IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    v_count NUMBER;
BEGIN

    SELECT COUNT(*) INTO v_count FROM sys_search_fee
    WHERE deleted = 0 AND country_id = p_country_id AND search_object = p_search_object AND search_type = p_search_type;

    IF v_count > 0 THEN
        p_return := -2;
        RETURN;
    END IF;

    SELECT seq_SYS_SEARCH_FEE.NEXTVAL INTO v_id FROM dual;
    INSERT INTO sys_search_fee
    (
        id, country_id, search_object, search_type, amount, amount_usd,created_by,created_date

    )
    VALUES
    (
        v_id, p_country_id, p_search_object, p_search_type, p_amount, p_amount_usd, p_created_by, sysdate
    );

    p_return := v_id;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;


PROCEDURE proc_sys_search_fee_update
(
    p_id IN sys_search_fee.id % TYPE,
    p_country_id IN sys_search_fee.country_id % TYPE,
    p_search_object IN sys_search_fee.search_object % TYPE,
    p_search_type IN sys_search_fee.search_type % TYPE,
    p_amount IN sys_search_fee.amount % TYPE,
    p_amount_usd IN sys_search_fee.amount_usd % TYPE,
    p_modified_by in VARCHAR2,
    p_return OUT NUMBER
)
IS
BEGIN
    UPDATE sys_search_fee SET
        --country_id = p_country_id,
        --search_object = p_search_object,
        --search_type = p_search_type,
        amount = p_amount,
        amount_usd = p_amount_usd,
        modified_by = p_modified_by,
        modified_date = SYSDATE
    WHERE id = p_id;
    p_return := p_id;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

PROCEDURE proc_get_by_id
(
    p_id IN sys_search_fee.id % TYPE,
    p_cursor OUT pkg_common.T_CURSOR
)
IS
BEGIN
    OPEN P_CURSOR FOR
    SELECT a.*  FROM view_sys_search_fee A WHERE a.id = p_id;
END;


PROCEDURE proc_delete
(
    p_id IN sys_search_fee.id % TYPE,
    p_modified_by in VARCHAR2,
    p_return OUT NUMBER
)
IS
BEGIN
    UPDATE sys_search_fee SET deleted = 1, modified_by = p_modified_by,modified_date = SYSDATE
    WHERE id = p_id;
    p_return := p_id;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_SYS_SEARCH_FIX

-- Start of DDL Script for Package LEGALTECH.PKG_TIMESHEET
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_timesheet
  IS TYPE tcursor IS ref CURSOR;


PROCEDURE proc_timesheet_getall
(
    p_cursor out tcursor
);

PROCEDURE proc_timesheet_search
(
    p_user_name IN VARCHAR2,
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    p_column IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);


PROCEDURE proc_timesheet_getbyid
(
    p_id IN timesheet.id % TYPE,
    p_cursor out tcursor
);

PROCEDURE proc_getbycasecode
(
    p_case_code IN timesheet.case_code % TYPE,
    p_cursor out tcursor
);

PROCEDURE proc_timesheet_getby_lawer
(
    p_lawer_id IN timesheet.lawer_id % TYPE,
    p_cursor out tcursor
);

PROCEDURE Proc_Timesheet_Insert
(
    p_name IN timesheet.name % TYPE,
    --p_app_header_id IN timesheet.app_header_id % TYPE,
    p_app_case_code IN VARCHAR2,
    p_lawer_id IN timesheet.lawer_id % TYPE,
    p_time_date IN timesheet.time_date % TYPE,
    p_from_time IN timesheet.from_time % TYPE,
    p_to_time IN timesheet.to_time % TYPE,
    p_hours IN timesheet.hours % TYPE,
    p_hours_adjust IN timesheet.hours_adjust % TYPE,
    p_notes IN timesheet.notes % TYPE,
    p_status IN timesheet.status % TYPE,
    p_created_by IN timesheet.created_by % TYPE,
    p_created_date IN timesheet.created_date % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE proc_timesheet_update
(
    p_id IN timesheet.id % TYPE,
    p_name IN timesheet.name % TYPE,
    p_time_date IN timesheet.time_date % TYPE,
    p_from_time IN timesheet.from_time % TYPE,
    p_to_time IN timesheet.to_time % TYPE,
    p_hours IN timesheet.hours % TYPE,
    p_hours_adjust IN timesheet.hours_adjust % TYPE,
    p_notes IN timesheet.notes % TYPE,
    p_modify_by IN timesheet.modify_by % TYPE,
    p_modify_date IN timesheet.modify_date % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
);

PROCEDURE proc_timesheet_delete
(
    p_id IN timesheet.id % TYPE,
    p_modify_by IN timesheet.modify_by % TYPE,
    p_modify_date IN timesheet.modify_date % TYPE,
    p_return OUT NUMBER
);


PROCEDURE proc_timesheet_approve
(
    p_id IN timesheet.id % TYPE,
    p_status IN timesheet.status % TYPE,
    p_reject_reason IN timesheet.reject_reason % TYPE,
    p_notes IN timesheet.notes % TYPE,
    p_modify_by IN timesheet.modify_by % TYPE,
    p_modify_date IN timesheet.modify_date % TYPE,
    p_return OUT NUMBER
);
END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_timesheet
IS

PROCEDURE proc_timesheet_getall
(
    p_cursor out tcursor
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT * FROM view_timesheet t
    ORDER BY t.app_case_code, t.id DESC;
END;

PROCEDURE proc_timesheet_getbyid
(
    p_id IN timesheet.id % TYPE,
    p_cursor out tcursor
)
IS
BEGIN
    OPEN p_cursor FOR SELECT * FROM view_timesheet t
    WHERE t.id = p_id
    ORDER BY t.app_case_code, t.id DESC;
END;

PROCEDURE proc_getbycasecode
(
    p_case_code IN timesheet.case_code % TYPE,
    p_cursor out tcursor
)
IS
BEGIN
    OPEN p_cursor FOR SELECT * FROM view_timesheet t
    WHERE t.case_code = p_case_code
    ORDER BY t.app_case_code, t.id DESC;
END;


PROCEDURE proc_timesheet_getby_lawer
(
    p_lawer_id IN timesheet.lawer_id % TYPE,
    p_cursor out tcursor
)
IS
BEGIN
    OPEN P_CURSOR FOR SELECT * FROM view_timesheet t
    WHERE t.lawer_id = p_lawer_id
    ORDER BY t.app_case_code, t.id DESC;
END;

PROCEDURE Proc_Timesheet_Insert
(
    p_name IN timesheet.name % TYPE,
    --p_app_header_id IN timesheet.app_header_id % TYPE,
    p_app_case_code IN VARCHAR2,
    p_lawer_id IN timesheet.lawer_id % TYPE,
    p_time_date IN timesheet.time_date % TYPE,
    p_from_time IN timesheet.from_time % TYPE,
    p_to_time IN timesheet.to_time % TYPE,
    p_hours IN timesheet.hours % TYPE,
    p_hours_adjust IN timesheet.hours_adjust % TYPE,
    p_notes IN timesheet.notes % TYPE,
    p_status IN timesheet.status % TYPE,
    p_created_by IN timesheet.created_by % TYPE,
    p_created_date IN timesheet.created_date % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    v_id NUMBER;
    V_ID_CASE_CODE NUMBER;
    V_CASE_CODE VARCHAR2(50) DEFAULT '';
    v_type NUMBER DEFAULT pkg_common.TIME_SHEET_TYPE_APP;
    --v_app_case_code VARCHAR2(50) DEFAULT '';
    --v_status_ap NUMBER;
BEGIN

    -- thong tin billing
    --SELECT case_code,status INTO v_app_case_code,v_status_ap FROM application_header
    --WHERE id = p_app_header_id AND LANGUAGUE_CODE = p_language_code;

    SELECT SEQ_GENCODE.NEXTVAL INTO V_ID_CASE_CODE FROM DUAL;

    V_CASE_CODE := 'TIMESHEET' || to_char(SYSDATE,'yyyyMMdd') || V_ID_CASE_CODE;

    IF INSTR(p_app_case_code,'SEARCH') > 0 THEN
        v_type := pkg_common.TIME_SHEET_TYPE_SEARCH;
    END IF ;

    SELECT SEQ_TIMESHEET.nextval INTO v_id FROM dual;
    INSERT INTO timesheet
    (
        id,case_code,name, app_case_code, lawer_id, time_date,from_time,to_time, hours,hours_adjust, notes, status, created_by, created_date, TYPE

    )
    VALUES
    (
        v_id,V_CASE_CODE,p_name, p_app_case_code, p_lawer_id, p_time_date,p_from_time,p_to_time, p_hours,p_hours_adjust, p_notes, p_status, p_created_by, p_created_date, v_type
    );

    -- insert todo
    pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_TIMESHEET,V_CASE_CODE,p_language_code);

    p_return := v_id;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

PROCEDURE proc_timesheet_update
(
    p_id IN timesheet.id % TYPE,
    p_name IN timesheet.name % TYPE,
    p_time_date IN timesheet.time_date % TYPE,
    p_from_time IN timesheet.from_time % TYPE,
    p_to_time IN timesheet.to_time % TYPE,
    p_hours IN timesheet.hours % TYPE,
    p_hours_adjust IN timesheet.hours_adjust % TYPE,
    p_notes IN timesheet.notes % TYPE,
    p_modify_by IN timesheet.modify_by % TYPE,
    p_modify_date IN timesheet.modify_date % TYPE,
    p_language_code IN VARCHAR2,
    p_return OUT NUMBER
)
IS
    v_status NUMBER;
    v_status_update NUMBER;
    V_CASE_CODE VARCHAR2(50) DEFAULT '';
BEGIN

    SELECT case_code, status INTO V_CASE_CODE, v_status FROM timesheet WHERE id = p_id;

    IF v_status = pkg_common.TIME_SHEET_STATUS_REJECT THEN
        v_status_update := pkg_common.TIME_SHEET_STATUS_NEW;
    ELSE
        v_status_update :=  v_status;
    END IF;

    UPDATE timesheet SET
        name = p_name,
        time_date = p_time_date,
        from_time = p_from_time,
        to_time = p_to_time,
        hours = p_hours,
        hours_adjust = p_hours_adjust,
        notes = p_notes,
        status = v_status_update,
        modify_by = p_modify_by,
        modify_date = TRUNC(p_modify_date)
    WHERE id = p_id;

    -- insert todo
    IF v_status = pkg_common.TIME_SHEET_STATUS_REJECT AND v_status_update = pkg_common.TIME_SHEET_STATUS_NEW THEN
        --pkg_log.logmsg('here');
        pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_TIMESHEET,V_CASE_CODE,p_language_code);
    END IF;

    p_return := p_id;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

PROCEDURE proc_timesheet_delete
(
    p_id IN timesheet.id % TYPE,
    p_modify_by IN timesheet.modify_by % TYPE,
    p_modify_date IN timesheet.modify_date % TYPE,
    p_return OUT NUMBER
)
IS
    v_case_code VARCHAR2(50) DEFAULT '';
    v_status NUMBER;
BEGIN

    -- thong tin billing
    SELECT case_code,status INTO v_case_code,v_status FROM view_timesheet WHERE id = p_id;

    UPDATE timesheet SET
        deleted = 1,
        modify_by = p_modify_by,
        modify_date = TRUNC(p_modify_date)
    WHERE id = p_id;

    -- xoa nhung thang nao dang review
    DELETE b_todos WHERE TYPE = pkg_common.TODO_TYPE_TIMESHEET AND case_code = v_case_code AND status = pkg_common.TODO_STATUS_REVIEW;

    p_return := p_id;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

PROCEDURE proc_timesheet_approve
(
    p_id IN timesheet.id % TYPE,
    p_status IN timesheet.status % TYPE,
    p_reject_reason IN timesheet.reject_reason % TYPE,
    p_notes IN timesheet.notes % TYPE,
    p_modify_by IN timesheet.modify_by % TYPE,
    p_modify_date IN timesheet.modify_date % TYPE,
    p_return OUT NUMBER
)
IS

    v_case_code VARCHAR2(50) DEFAULT '';
    v_status NUMBER;
BEGIN

    -- thong tin billing
    SELECT case_code,status INTO v_case_code,v_status FROM view_timesheet WHERE id = p_id;

    UPDATE timesheet SET
        status = p_status,
        reject_reason = decode(p_status, pkg_common.TIME_SHEET_STATUS_APPROVE, '', p_reject_reason),
        modify_by = p_modify_by,
        modify_date = TRUNC(p_modify_date),
        notes = p_notes
    WHERE id = p_id;

    -- insert todo
    IF p_status = pkg_common.TIME_SHEET_STATUS_REJECT THEN
        pkg_todos.proc_do_insert(pkg_common.TODO_TYPE_TIMESHEET,V_CASE_CODE,'');
    ELSE
         -- Update trang thai review
        UPDATE b_todos SET  status = pkg_common.TODO_STATUS_COMPLETED, processor_date = SYSDATE
        WHERE TYPE = pkg_common.TODO_TYPE_TIMESHEET AND case_code = v_case_code AND status = pkg_common.TODO_STATUS_REVIEW;
    END IF;

    p_return := p_id;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
    p_return := -1;
    RAISE;
END;

PROCEDURE proc_timesheet_search
(
    p_user_name IN VARCHAR2,
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    p_column IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_CASE_CODE VARCHAR2(30) DEFAULT 'ALL';
    V_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_LAWER VARCHAR2(100) DEFAULT 'ALL';

    V_FROM NUMBER ;
    V_TO NUMBER;

    v_count NUMBER;
    v_user_type NUMBER;
BEGIN

    SELECT COUNT(*) INTO v_count FROM s_users s WHERE s.username = p_user_name AND s.deleted = 0;
    IF v_count = 0 THEN
        OPEN P_CURSOR FOR
        SELECT  A.* FROM VIEW_TIMESHEET A WHERE  1 = 0;
        RETURN;
    END IF;

    -- khng cho php khch v nhn vin x l xem timesheet
    IF v_user_type = pkg_common.USER_TYPE_EMPOYEE OR v_user_type = pkg_common.USER_TYPE_CUSTOMER THEN
        OPEN P_CURSOR FOR
        SELECT  A.* FROM VIEW_TIMESHEET A WHERE  1 = 0;
        RETURN;
    END IF;

    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_CASE_CODE := ITEM.CONDITION;
        ELSIF V_INDEX = 1 THEN
            V_STATUS := ITEM.CONDITION;
        ELSIF V_INDEX = 2 THEN
            V_LAWER := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;

    IF V_CASE_CODE <> 'ALL' THEN
        V_CONDITION := V_CONDITION || ' AND UPPER(T.APP_CASE_CODE) LIKE ''%' || UPPER(V_CASE_CODE) || '%'' ';
    END IF;

    IF V_STATUS <> 'ALL' THEN
        V_CONDITION := V_CONDITION || ' AND T.STATUS = ' || V_STATUS;
    END IF;

    IF V_LAWER <> 'ALL' THEN
        --V_CONDITION :=  V_CONDITION || ' AND UPPER(L.LAWER_ID) LIKE ''%' || UPPER(V_LAWER) || '%'' ';
        V_CONDITION :=  V_CONDITION || ' AND UPPER(LAWER_ID) = ' || V_LAWER;
    END IF;

    -- ly thng tin user type
    SELECT s.TYPE INTO v_user_type FROM s_users s WHERE s.username = p_user_name AND s.deleted = 0;
    IF v_user_type = pkg_common.USER_TYPE_LAWER THEN
        V_CONDITION :=  V_CONDITION || ' AND T.CREATED_BY = ''' || p_user_name || '''';
    END IF;


    V_SQL := 'SELECT * FROM VIEW_TIMESHEET t WHERE 1 = 1 ';

    V_SQL :=  V_SQL || V_CONDITION;

    --pkg_log.LOGMSG(V_SQL);

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || ' ORDER BY ' || p_column || ' ' || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY T.APP_CASE_CODE, T.ID DESC';
    END IF;

    DBMS_OUTPUT.PUT_LINE(V_SQL);


    V_TOTAL_COUNT := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_TOTAL_COUNT INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;
    --PKG_LOG.LOGMSG(V_SQL);


    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_TIMESHEET

-- Start of DDL Script for Package LEGALTECH.PKG_TODOS
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_todos
    IS TYPE TCURSOR IS REF CURSOR;

PROCEDURE proc_Todo_GetByCaseCode
(
    p_app_id IN NUMBER,
    p_processor_by in VARCHAR2,
    p_cursor OUT PKG_COMMON.T_CURSOR
);

PROCEDURE proc_UpdateTodo_ByCaseCode
(
    p_app_id IN NUMBER,
    p_processor_by in VARCHAR2
);

PROCEDURE proc_todo_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_USER_NAME IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);


PROCEDURE proc_do_insert
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,
    p_language_code IN VARCHAR2,
    p_hard_processor IN VARCHAR2 DEFAULT 'DEFAULT'
);

PROCEDURE proc_do_insert_application
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_hard_processor IN VARCHAR2,
    p_language_code IN VARCHAR2
);

PROCEDURE proc_do_insert_billing
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2
);

PROCEDURE proc_do_insert_timesheet
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2
);

PROCEDURE proc_do_insert_search
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2
);

PROCEDURE proc_insert
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,
    p_content IN VARCHAR2,
    p_request_by IN VARCHAR2,
    p_request_date IN DATE,
    p_processor_by IN VARCHAR2,
    p_status IN NUMBER,
    p_language_code IN VARCHAR2
);

PROCEDURE proc_todo_home_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR

);
PROCEDURE PROC_NOTIFI_GETBY_APPS
(
 P_KEYSEARCH IN VARCHAR2,
 P_CURSOR OUT PKG_COMMON.T_CURSOR,
 P_CURSOR_RIMIND OUT PKG_COMMON.T_CURSOR
);

PROCEDURE proc_get_notify
(
    P_USERNAME IN VARCHAR2,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
);


PROCEDURE proc_do_insert_wiki
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2
);

PROCEDURE proc_do_insert_register
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2
);


END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_todos
    IS

PROCEDURE proc_Todo_GetByCaseCode
(
    p_app_id IN NUMBER ,
    p_processor_by in VARCHAR2,
    p_cursor OUT PKG_COMMON.T_CURSOR
)
IS
    v_case_code VARCHAR2(50);
BEGIN
    SELECT case_code INTO v_case_code FROM application_header a WHERE a.id = p_app_id;
    OPEN p_cursor FOR SELECT * FROM view_todos a WHERE case_code = v_case_code AND status = 0 AND a.processor_by = p_processor_by;
END;

PROCEDURE proc_UpdateTodo_ByCaseCode
(
    p_app_id IN NUMBER,
    p_processor_by in VARCHAR2
)
IS
    v_case_code VARCHAR2(50);
BEGIN
    SELECT case_code INTO v_case_code FROM application_header a WHERE a.id = p_app_id;
    UPDATE b_todos a SET a.status = 1, a.processor_date = SYSDATE WHERE case_code = v_case_code AND status = 0 AND a.processor_by = p_processor_by;
COMMIT;
END;

PROCEDURE proc_todo_search
(
    P_SEARCH_KEY IN VARCHAR2,
    p_user_name IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_PROCESSOR_BY VARCHAR2(200) DEFAULT 'ALL';
    V_REQUEST_BY VARCHAR2(200) DEFAULT 'ALL';

    V_FROM NUMBER ;
    V_TO NUMBER;
    V_CASE_CODE VARCHAR2(200) DEFAULT 'ALL';
    V_TYPE VARCHAR2(50) DEFAULT 'TODO';
BEGIN

    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_TYPE := ITEM.CONDITION;
        ELSIF V_INDEX = 1 THEN
            V_CASE_CODE := ITEM.CONDITION;
        ELSIF V_INDEX = 2 THEN
            V_STATUS := ITEM.CONDITION;
        ELSIF V_INDEX = 3 THEN
            V_REQUEST_BY := ITEM.CONDITION;
        ELSIF V_INDEX = 4 THEN
            V_PROCESSOR_BY := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;


    V_SQL := 'SELECT  A.* FROM VIEW_TODOS A WHERE A.STATUS = 0 ';
    -- type
    IF V_TYPE =  'TODO' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.PROCESSOR_BY) = ''' || UPPER(P_USER_NAME) || ''' ';
    ELSIF V_TYPE =  'ORDER' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.request_by) = ''' || UPPER(P_USER_NAME) || ''' ';
    ELSIF V_TYPE =  'REMIND' THEN
        V_SQL := 'SELECT  A.* FROM VIEW_REMIND A WHERE A.STATUS = 0 ';
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.PROCESSOR_BY) = ''' || UPPER(P_USER_NAME) || ''' ';
    END IF;

    IF V_CASE_CODE <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.CASE_CODE) = ''' || UPPER(V_CASE_CODE) || ''' ';
    END IF;

    IF V_PROCESSOR_BY <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.PROCESSOR_BY) LIKE ''%' || UPPER(V_PROCESSOR_BY) || '%'' ';
    END IF;

    IF V_REQUEST_BY <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.REQUEST_BY) LIKE ''%' || UPPER(V_REQUEST_BY) || '%'' ';
    END IF;

    IF V_STATUS <> 'ALL' THEN
        V_CONDITION := V_CONDITION || ' AND A.STATUS = ' || V_STATUS;
    END IF;

    dbms_output.put_line(V_CONDITION);
    V_SQL :=  V_SQL || V_CONDITION;
    dbms_output.put_line(V_SQL);

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || P_SORT_TYPE;
    ELSE
        IF V_TYPE =  'REMIND' THEN
            V_SQL :=  V_SQL || ' ORDER BY A.REMIND_ID DESC';
        ELSE
            V_SQL :=  V_SQL || ' ORDER BY A.todo_id DESC';
        END IF;
    END IF;



    V_TOTAL_COUNT := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_TOTAL_COUNT INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;

    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_do_insert
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2,
    p_hard_processor IN VARCHAR2 DEFAULT 'DEFAULT'
)
IS

    PLOG_RETURN varchar2(2000);
BEGIN

    -- neu viec phai lam lien quan toi don
    IF p_type = pkg_common.TODO_TYPE_APP THEN
        proc_do_insert_application(p_type, p_case_code,p_hard_processor, p_language_code);

    ELSIF p_type = pkg_common.TODO_TYPE_BILLING THEN
        proc_do_insert_billing(p_type, p_case_code, p_language_code);

    ELSIF p_type = pkg_common.TODO_TYPE_TIMESHEET THEN
        proc_do_insert_timesheet(p_type, p_case_code, p_language_code);

    ELSIF p_type = pkg_common.TODO_TYPE_SEARCH THEN
        proc_do_insert_search(p_type, p_case_code, p_language_code);

    END IF;

EXCEPTION
WHEN OTHERS THEN
    PLOG_RETURN := SUBSTR(SQLCODE,1,500) || SUBSTR(SQLERRM,1,500);
    pkg_log.log_error(PLOG_RETURN,'proc_do_insert');
    RAISE;
END;

PROCEDURE proc_do_insert_application
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_hard_processor IN VARCHAR2,
    p_language_code IN VARCHAR2
)
IS
    v_count NUMBER;
    -- thong tin app
    v_app_case_code VARCHAR2(50);
    v_app_id NUMBER;
    v_status_app NUMBER;
    v_status_notice NUMBER;

    v_lawer VARCHAR2(50) DEFAULT '';
    v_modify_by VARCHAR2(50) DEFAULT '';
    v_created_by VARCHAR2(200);
    v_employee VARCHAR2(50) DEFAULT '';
    v_user_admin VARCHAR2(50) DEFAULT '';

    -- actor
    v_request_by VARCHAR2(200) DEFAULT '';
    v_request_date DATE DEFAULT SYSDATE;
    v_processor_by VARCHAR2(200) DEFAULT '';
    v_processor_by_2 VARCHAR2(200) DEFAULT '';
    v_Content VARCHAR2(2000);

BEGIN

    UPDATE B_TODOS SET STATUS = PKG_COMMON.TODO_STATUS_COMPLETED, PROCESSOR_DATE = SYSDATE
    WHERE TYPE = PKG_COMMON.TODO_TYPE_APP AND CASE_CODE = P_CASE_CODE AND STATUS = PKG_COMMON.TODO_STATUS_REVIEW;

    -- lay trang thai cua app
    SELECT a.id,a.status,created_by,a.modify_by,s.username employee,notes,s1.username AS admin_name
    INTO v_app_id,v_status_app,v_created_by,v_modify_by,v_employee, v_Content,v_user_admin
    FROM application_header a
    LEFT JOIN s_users s ON s.id = a.employee
    LEFT JOIN s_users s1 ON s1.id = a.admin_id
    WHERE case_code = p_case_code AND ROWNUM = 1; --AND LANGUAGUE_CODE = p_language_code;

    dbms_output.put_line('v_status_app ' || v_status_app);
    dbms_output.put_line('v_created_by ' || v_created_by);
    dbms_output.put_line('v_modify_by ' || v_modify_by);


    IF v_status_app != pkg_common.APP_STATUS_WAIT_GRANT_ADMIN AND v_status_app != pkg_common.APP_STATUS_WAIT_GRANT_LAWER THEN
        -- lay user admin, vs luat xu
        SELECT a.created_by,u.username INTO v_user_admin, v_lawer FROM app_lawer a
        JOIN s_users u ON u.id = a.lawer_id
        WHERE case_code = p_case_code AND a.deleted = 0;

        dbms_output.put_line('v_user_admin ' || v_user_admin);
        dbms_output.put_line('v_lawer ' || v_lawer);
    END IF;

    IF v_status_app = pkg_common.APP_STATUS_WAIT_GRANT_ADMIN THEN

        SELECT content INTO v_Content FROM allcode WHERE cdname = 'TODO' and cdtype = 'CONTENT' AND cdval = 2;

        -- nguoi yeu cau la khach hang - la thang tao don
        v_request_by := v_created_by;

        -- lay nguoi duoc phan viec la SUPPER ADMIN
        v_processor_by := pkg_common.USER_SUPPER_ADMIN;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

    -- khach hang da gui cho admin phan cong
    ELSIF v_status_app = pkg_common.APP_STATUS_WAIT_GRANT_LAWER THEN

        -- nguoi yeu cau la khach hang - la thang tao don
        v_request_by := v_modify_by;

        -- lay nguoi duoc phan viec la ADMIN
        v_processor_by := v_user_admin;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

    -- da phan cho luat su, cho luat xu phan hoi / da nop don
    -- modify_by/lawer
    ELSIF v_status_app = pkg_common.APP_STATUS_GRANT_LAWER OR v_status_app = pkg_common.APP_STATUS_ADMIN_REJECT_ADVICE  OR v_status_app = pkg_common.APP_STATUS_ADMIN_REJECT_ADVICE THEN

        -- lay user admin, vs luat xu
        SELECT a.created_by,u.username INTO v_user_admin, v_lawer FROM app_lawer a
        JOIN s_users u ON u.id = a.lawer_id
        WHERE case_code = p_case_code AND a.deleted = 0;

        -- thang yc l admin
        v_request_by := v_user_admin;

        -- thang xu ly la luat su
        v_processor_by := v_lawer;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);
    ELSIF v_status_app = pkg_common.APP_STATUS_DANOPDON THEN

        -- lay user admin, vs luat xu
        SELECT a.created_by,u.username INTO v_user_admin, v_lawer FROM app_lawer a
        JOIN s_users u ON u.id = a.lawer_id
        WHERE case_code = p_case_code AND a.deleted = 0;

        -- thang yc l NHAN VIEN NOP DON
        v_request_by := v_employee;

        -- thang xu ly la luat su
        v_processor_by := v_lawer;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);
    -- luat xu da confirm, khach hang da confirm, khach hang tu choi
    -- modify_by/admin
    ELSIF v_status_app = pkg_common.APP_STATUS_LAWER_CONFIRMED OR v_status_app = pkg_common.APP_STATUS_KH_CONFIRMED OR v_status_app = pkg_common.APP_STATUS_KH_REJECT THEN

        -- lay user admin, vs luat xu
        SELECT a.created_by,u.username INTO v_user_admin, v_lawer FROM app_lawer a
        JOIN s_users u ON u.id = a.lawer_id
        WHERE case_code = p_case_code AND a.deleted = 0;

        -- thang yc l thang update trang thai
        v_request_by := v_modify_by; -- v_lawer;

        -- thang xu ly la admin
        v_processor_by := v_user_admin;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

    -- da phan loai cho nhan vien
    -- modify_by/nvien
    ELSIF v_status_app = pkg_common.APP_STATUS_GRANT_EMPLOYEE THEN
        -- lay user admin, vs luat xu
        SELECT a.created_by,u.username INTO v_user_admin, v_lawer FROM app_lawer a
        JOIN s_users u ON u.id = a.lawer_id
        WHERE case_code = p_case_code AND a.deleted = 0;

        -- thang yc l thang update trang thai
        v_request_by := v_modify_by;

        -- thang xu ly la admin
        v_processor_by := v_employee;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

    -- cho khach hang confirm / advice filing ---> modifyby/khach_hang
    ELSIF v_status_app = pkg_common.APP_STATUS_WAIT_KH_CONFIRM OR v_status_app = pkg_common.APP_STATUS_GUIKETQUA_ADVICE THEN

        -- nguoi yeu cau la admin (chinh la thang xu ly gan nhat)
        v_request_by := v_modify_by;

        -- xu ly la khach hang
        v_processor_by := v_created_by;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

    ELSIF v_status_app = pkg_common.APP_STATUS_ADVICE_FILING THEN

        -- nguoi yeu cau la admin (chinh la thang xu ly gan nhat)
        v_request_by := v_modify_by;

        -- xem co add cung thang xu ly hay khong
        IF p_hard_processor = pkg_common.DEFAULT_PROCESOR THEN
            -- xu ly la admin
            v_processor_by := v_user_admin;
        ELSIF p_hard_processor = pkg_common.DEFAULT_LAWER THEN
            -- xu ly la luat xu
            v_processor_by := v_lawer;
        END IF;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

        -- khach hang review advise thi gui lai cho luat su
    ELSIF v_status_app = pkg_common.CUSTOMER_REVIEW_ADVISE THEN

        -- nguoi yeu cau la admin (chinh la thang xu ly gan nhat)
        v_request_by := v_created_by;

        v_processor_by := v_lawer;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

        --
    ELSIF v_status_app = pkg_common.CHAPNHAN_THONGBAO_HINHTHUC
        OR v_status_app = pkg_common.TUCHOI_THONGBAO_HINHTHUC

        OR v_status_app = pkg_common.CONGBO_DON

        OR v_status_app = pkg_common.CHAPNHAN_THONGBAO_NOIDUNG
        OR v_status_app = pkg_common.TUCHOI_THONGBAO_NOIDUNG

        OR v_status_app = pkg_common.THONGBAO_CAPBANG
        OR v_status_app = pkg_common.CONGBO_BANG THEN

        -- lay ra trang thai cua notice
        SELECT COUNT(*) INTO v_count FROM app_notice_info WHERE case_code = P_CASE_CODE AND deleted = 0;
        dbms_output.put_line('v_count ' || v_count);
        IF  v_count > 0 THEN
            SELECT status INTO v_status_notice FROM
            (
                SELECT RANK() OVER (PARTITION BY case_code ORDER BY id DESC ) AS myrank,status
                FROM app_notice_info a WHERE case_code = P_CASE_CODE  AND deleted = 0 ORDER BY id desc
            ) WHERE myrank = 1;

            dbms_output.put_line('v_status_notice ' || v_status_notice);

            -- luat su gui, admin duyet
            IF v_status_notice =  pkg_common.CUC_TRALOI THEN
                v_request_by := v_lawer;
                v_processor_by := v_user_admin;

                -- luat su tra loi, admin duyet
            ELSIF v_status_notice =  pkg_common.LUATSU_GUICHOADMINDUYET OR v_status_notice =  pkg_common.LUATSU_DICHTRALOICUC THEN
                v_request_by := v_lawer;
                v_processor_by := v_user_admin;

            -- admin duyet, khach hang reivew
            ELSIF v_status_notice =  pkg_common.ADMIN_DUYETGUICHOKHACHHANG THEN
                v_request_by := v_user_admin;
                v_processor_by := v_created_by;

            -- admin duyet, luat su reivew
            ELSIF v_status_notice =  pkg_common.ADMIN_TUCHOIDUYET OR v_status_notice =  pkg_common.ADMIN_DUYET_TRALOICUC OR v_status_notice =  pkg_common.ADMIN_TUCHOI_TRALOICUC THEN
                v_request_by := v_user_admin;
                v_processor_by := v_lawer;

            -- khac hang review, luat su tra loi tiep
            ELSIF v_status_notice =  pkg_common.KHACHHANG_REVIEW_TRALOI THEN
                v_request_by := v_created_by;
                v_processor_by := v_lawer;

            -- luat su gui, khach hang
            ELSIF v_status_notice =  pkg_common.LUATSU_UPDATE_TB THEN
                v_request_by := v_lawer;
                v_processor_by := v_lawer;
            END IF;
        ELSE
            -- nguoi yeu cau la admin (chinh la thang xu ly gan nhat)
            v_request_by := v_created_by;

            v_processor_by := v_lawer;
        END IF;



        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);
    END IF;


EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_do_insert_billing
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2
)
IS
    -- actor
    v_request_by VARCHAR2(200) DEFAULT '';
    v_request_date DATE DEFAULT SYSDATE;
    v_processor_by VARCHAR2(200) DEFAULT '';
    v_processor_by_2 VARCHAR2(200) DEFAULT '';

    v_Content VARCHAR2(2000);

    v_created_by VARCHAR2(200);
    v_lawer VARCHAR2(200);
    v_user_admin VARCHAR2(200);

    -- billing
    v_status_billing NUMBER;
    v_pay_status_billing NUMBER;
    v_type_billing NUMBER;

    -- thong tin app
    v_app_case_code VARCHAR2(50);
    v_app_id NUMBER;
    v_status_app NUMBER;

BEGIN

    UPDATE B_TODOS SET STATUS = PKG_COMMON.TODO_STATUS_COMPLETED, PROCESSOR_DATE = SYSDATE
    WHERE TYPE = PKG_COMMON.TODO_TYPE_BILLING AND CASE_CODE = P_CASE_CODE AND STATUS = PKG_COMMON.TODO_STATUS_REVIEW;

    -- lay thong tin billing
    SELECT status,app_case_code,nvl(pay_status,-1), BILLING_TYPE, notes
    INTO v_status_billing,v_app_case_code,v_pay_status_billing,v_type_billing, v_Content
    FROM billing_header WHERE case_code = p_case_code;

    -- lay trang thai cua billing
    IF v_type_billing = pkg_common.BILLING_TYPE_APP THEN
        SELECT id,status,created_by INTO v_app_id,v_status_app,v_created_by FROM application_header
        WHERE case_code = v_app_case_code AND ROWNUM = 1;--AND LANGUAGUE_CODE = p_language_code;

        -- lay user admin
        SELECT a.created_by,u.username INTO v_user_admin, v_lawer FROM app_lawer a
        JOIN s_users u ON u.id = a.lawer_id
        WHERE case_code = v_app_case_code AND a.deleted = 0;

    ELSIF v_type_billing = pkg_common.BILLING_TYPE_SEARCH THEN

        -- lay user ADMIN, lawer
        SELECT created_by,admin_user_name,lawer_user_name
        INTO v_created_by,v_user_admin,v_lawer
        FROM view_search WHERE case_code = v_app_case_code;

    END IF;

    -- xet theo trang thai billing
    IF v_status_billing = pkg_common.BILLING_H_STATUS_REVIEW THEN

        /*-- lay content
        IF p_language_code = pkg_common.VI_VN THEN
            SELECT content INTO v_Content FROM allcode WHERE cdname = 'BILLING' and cdtype = 'STATUS' AND cdval = v_status_billing;
            v_Content := v_Content;
        ELSE
            SELECT content_eng INTO v_Content FROM allcode WHERE cdname = 'BILLING' and cdtype = 'STATUS' AND cdval = v_status_billing;
            v_Content := v_Content;
        END IF;*/

        -- nguoi yeu cau la luat su
        v_request_by := v_lawer;

        -- ng xu ly la thang admin dc phan quyen
        v_processor_by := v_user_admin;
        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);
    ELSIF v_status_billing = pkg_common.BILLING_H_STATUS_APPROVE THEN

        /*-- lay content
        IF p_language_code = pkg_common.VI_VN THEN
            SELECT content INTO v_Content FROM allcode WHERE cdname = 'BILLING' and cdtype = 'PAY_STATUS' AND cdval = v_pay_status_billing;
            v_Content := v_Content;
        ELSE
            SELECT content_eng INTO v_Content FROM allcode WHERE cdname = 'BILLING' and cdtype = 'PAY_STATUS' AND cdval = v_pay_status_billing;
            v_Content := v_Content;
        END IF;*/

        -- nguoi yeu cau admin
        v_request_by := v_user_admin;

        -- ng xu ly la thang admin va khach hang
        v_processor_by := v_created_by;
        v_processor_by_2 := v_user_admin;

        -- insert cho thang khach hang truoc
        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by_2,pkg_common.TODO_STATUS_REVIEW,p_language_code);
        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);
    END IF;


EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_do_insert_timesheet
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2
)
IS
    -- actor
    v_request_by VARCHAR2(200) DEFAULT '';
    v_request_date DATE DEFAULT SYSDATE;
    v_processor_by VARCHAR2(200) DEFAULT '';
    v_processor_by_2 VARCHAR2(200) DEFAULT '';

    v_Content VARCHAR2(2000);

    v_created_by VARCHAR2(200);
    v_lawer VARCHAR2(200);
    v_user_admin VARCHAR2(200);

    -- timesheet
    v_status_timesheet NUMBER;
    v_status_search NUMBER;

    -- thong tin app
    v_app_case_code VARCHAR2(50);

BEGIN

    UPDATE B_TODOS SET STATUS = PKG_COMMON.TODO_STATUS_COMPLETED, PROCESSOR_DATE = SYSDATE
    WHERE TYPE = PKG_COMMON.TODO_TYPE_TIMESHEET AND CASE_CODE = P_CASE_CODE AND STATUS = PKG_COMMON.TODO_STATUS_REVIEW;

    -- lay thong tin timesheet
    SELECT status,app_case_code, notes ,created_by
    INTO v_status_timesheet,v_app_case_code, v_Content ,v_created_by
    FROM timesheet WHERE case_code = p_case_code;

    IF INSTR(v_app_case_code,'SEARCH') > 0 THEN
        -- lay thong tin Search
        SELECT status,lawer_user_name,admin_user_name, created_by
        INTO v_status_search,v_lawer,v_user_admin, v_created_by
        FROM view_search WHERE case_code = v_app_case_code;
    ELSE
        -- lay user admin
        SELECT a.created_by,u.username INTO v_user_admin, v_lawer FROM app_lawer a
        JOIN s_users u ON u.id = a.lawer_id
        WHERE case_code = v_app_case_code AND a.deleted = 0;
    END IF ;


    IF v_status_timesheet = pkg_common.TIME_SHEET_STATUS_NEW THEN
        -- nguoi yeu cau la luat su
        v_request_by := v_lawer;

        -- ng xu ly la thang admin dc phan quyen
        v_processor_by := v_user_admin;
    ELSIF v_status_timesheet = pkg_common.TIME_SHEET_STATUS_APPROVE THEN
        -- nguoi yeu cau admin
        v_request_by := v_user_admin;

        -- ng xu ly la thang lawer --> ko phai lam gi
        v_processor_by := '';
    ELSIF v_status_timesheet = pkg_common.TIME_SHEET_STATUS_REJECT THEN
        -- nguoi yeu cau admin
        v_request_by := v_user_admin;

        -- ng xu ly la thang lawer
        v_processor_by := v_lawer;
    END IF;

    proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);


EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE proc_do_insert_search
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2
)
IS
    -- actor
    v_request_by VARCHAR2(200) DEFAULT '';
    v_request_date DATE DEFAULT SYSDATE;
    v_processor_by VARCHAR2(200) DEFAULT '';
    v_processor_by_2 VARCHAR2(200) DEFAULT '';

    v_Content VARCHAR2(2000);

    v_created_by VARCHAR2(200);
    v_lawer VARCHAR2(200);
    v_user_admin VARCHAR2(200);

    -- search
    v_status_search NUMBER;

    -- thong tin app
    v_app_case_code VARCHAR2(50);
    v_app_id NUMBER;
    v_status_app NUMBER;

BEGIN

    UPDATE B_TODOS SET STATUS = PKG_COMMON.TODO_STATUS_COMPLETED, PROCESSOR_DATE = SYSDATE
    WHERE TYPE = PKG_COMMON.TODO_TYPE_SEARCH AND CASE_CODE = P_CASE_CODE AND STATUS = PKG_COMMON.TODO_STATUS_REVIEW;

     -- lay thong tin Search
    SELECT status,lawer_user_name,admin_user_name, created_by,note
    INTO v_status_search,v_lawer,v_user_admin, v_created_by,v_Content
    FROM view_search WHERE case_code = p_case_code;

    -- neu la yc moi -> ng xu ly la admin
    IF v_status_search = pkg_common.SEARCH_STATUS_NEW THEN

        v_request_by := v_created_by;

        -- ng xu ly la thang admin
        v_processor_by := pkg_common.USER_ADMIN;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

    -- da phan loai cho ls ->
    ELSIF v_status_search = pkg_common.SEARCH_STATUS_GRANT_LAWER THEN

        -- ng yeu cau la thang admin
        v_request_by := v_user_admin;

        -- ng xu ly la thang admin
        v_processor_by := v_lawer;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

    -- luat su da tra loi -> gui den admin
    ELSIF v_status_search = pkg_common.SEARCH_STATUS_LAWER_CONFIRMED THEN

        -- ng yeu cau la thang admin
        v_request_by := v_lawer;

        -- ng xu ly la thang admin
        v_processor_by := v_user_admin;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

    -- admin da duyet -> gui den cho khach hang
    ELSIF v_status_search = pkg_common.SEARCH_STATUS_ADMIN_CONFIRMED THEN

        -- ng yeu cau la thang admin
        v_request_by := v_user_admin;

        -- ng xu ly la thang admin
        v_processor_by := v_created_by;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

    END IF;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

-- mac dinh them moi trang thai cua n la moi tao chua active
-- se co thread de update trang thai sau
PROCEDURE proc_insert
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,
    p_content IN VARCHAR2,
    p_request_by IN VARCHAR2,
    p_request_date IN DATE,
    p_processor_by IN VARCHAR2,
    p_status IN NUMBER,
    p_language_code IN VARCHAR2
)
IS
    v_id NUMBER;
BEGIN

    SELECT seq_todos.NEXTVAL INTO v_id FROM dual;

    INSERT INTO b_todos
    (
        todo_id, type, case_code, content, request_by,
        request_date, processor_by, status, language_code
    )
    VALUES
    (
        v_id,p_type,p_case_code,p_content,p_request_by, p_request_date,
        p_processor_by,p_status, p_language_code
    );

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE proc_todo_home_search
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR

)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_TYPE VARCHAR2(10) DEFAULT 'ALL';
    V_USERNAME VARCHAR2(50) DEFAULT 'ALL';

    V_FROM NUMBER ;
    V_TO NUMBER;

BEGIN
-- PKG_LOG.LOGMSG('1');COMMIT;

    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_TYPE := ITEM.CONDITION;
        END IF;
         IF V_INDEX = 1 THEN
            V_USERNAME := UPPER(ITEM.CONDITION);
        END IF;
        V_INDEX := V_INDEX + 1;
    END LOOP;

    IF V_TYPE =  'TODO' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.PROCESSOR_BY) = ''' || UPPER(V_USERNAME) || ''' ';
    END IF;

     IF V_TYPE =  'ORDER' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.REQUEST_BY) = ''' || UPPER(V_USERNAME) || ''' ';
    END IF;



    V_SQL := 'SELECT  A.* FROM VIEW_TODOS A WHERE A.STATUS = 0 ';
    V_SQL :=  V_SQL || V_CONDITION;


    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.todo_id DESC';
    END IF;



    V_TOTAL_COUNT := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_TOTAL_COUNT INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;

    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE PROC_NOTIFI_GETBY_APPS
(
    P_KEYSEARCH IN VARCHAR2,
    P_CURSOR OUT PKG_COMMON.T_CURSOR,
    P_CURSOR_RIMIND OUT PKG_COMMON.T_CURSOR
)
IS
BEGIN

    OPEN P_CURSOR FOR
    SELECT a.*, ROWNUM AS STT
    FROM
    (
        SELECT * FROM VIEW_TODOS r
        WHERE r.case_code = P_KEYSEARCH
        ORDER BY r.TODO_ID  DESC
    ) a ;

    OPEN P_CURSOR_RIMIND FOR
    SELECT a.*, ROWNUM AS STT
    FROM
    (
        SELECT * FROM B_REMIND A WHERE A.case_code = P_KEYSEARCH ORDER BY A.REMIND_ID  DESC
    ) a ;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE proc_get_notify
(
    P_USERNAME IN VARCHAR2,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS

BEGIN

    OPEN P_CURSOR FOR SELECT
        (SELECT COUNT(0) FROM VIEW_TODOS A WHERE A.STATUS =   PKG_COMMON.TODO_STATUS_REVIEW AND A.PROCESSOR_BY = P_USERNAME) AS NUMBER_TODO,
        (SELECT COUNT(0) FROM VIEW_TODOS A WHERE A.STATUS = PKG_COMMON.TODO_STATUS_REVIEW AND A.REQUEST_BY = P_USERNAME) AS NUMBER_REQUEST,
        (SELECT COUNT(0) FROM VIEW_REMIND A WHERE A.STATUS =  PKG_COMMON.TODO_STATUS_REVIEW AND A.PROCESSOR_BY = P_USERNAME) AS NUMBER_REMIND
     FROM DUAL;


EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE proc_do_insert_wiki
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2
)
IS
    -- actor
    v_request_by VARCHAR2(200) DEFAULT '';
    v_request_date DATE DEFAULT SYSDATE;
    v_processor_by VARCHAR2(200) DEFAULT '';
    v_processor_by_2 VARCHAR2(200) DEFAULT '';

    v_Content VARCHAR2(2000);

    v_created_by VARCHAR2(200);

    v_user_admin VARCHAR2(200);

    v_lawer VARCHAR2(200);

    --
    v_status  NUMBER;

    -- thong tin app
    v_app_case_code VARCHAR2(50);
    v_app_id NUMBER;
    v_status_app NUMBER;

BEGIN

    UPDATE B_TODOS SET STATUS = PKG_COMMON.TODO_STATUS_COMPLETED, PROCESSOR_DATE = SYSDATE
    WHERE TYPE = PKG_COMMON.TODO_TYPE_WIKI AND CASE_CODE = P_CASE_CODE AND STATUS = PKG_COMMON.TODO_STATUS_REVIEW;

     -- lay thong tin wiki


    SELECT status, created_by,  a1.content INTO v_status, v_created_by, v_Content
    FROM WIKI_DOCS a LEFT JOIN allcode a1 on a1.CDNAME = 'WIKI' AND a1.CDTYPE = 'STATUS'
    AND a1.CDVAL = a.status
     WHERE case_code = p_case_code;

    -- neu la yc moi -> ng xu ly la admin
    IF v_status = pkg_common.WIKI_STATUS_NEW THEN

        v_request_by := v_created_by;

        -- ng xu ly la thang admin
        v_processor_by := pkg_common.USER_ADMIN;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

    -- bi tu choi->
    ELSIF v_status = pkg_common.WIKI_STATUS_REJECT THEN

        -- ng yeu cau la thang admin
        v_request_by := pkg_common.USER_ADMIN;

        -- ng xu ly la thang nguoi tao (luat su)
        v_processor_by := v_created_by;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

    END IF;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;



PROCEDURE proc_do_insert_register
(
    p_type IN NUMBER,
    p_case_code IN VARCHAR2,        -- case code, co the la ma don, ma billing, hoac ma search
    p_language_code IN VARCHAR2
)
IS
    -- actor
    v_request_by VARCHAR2(200) DEFAULT '';
    v_request_date DATE DEFAULT SYSDATE;
    v_processor_by VARCHAR2(200) DEFAULT '';
    v_processor_by_2 VARCHAR2(200) DEFAULT '';

    v_Content VARCHAR2(2000);

    v_created_by VARCHAR2(200);

    v_user_admin VARCHAR2(200);

    v_lawer VARCHAR2(200);

    --
    v_status  NUMBER;

    -- thong tin app
    v_app_case_code VARCHAR2(50);
    v_app_id NUMBER;
    v_status_app NUMBER;

BEGIN

    UPDATE B_TODOS SET STATUS = PKG_COMMON.TODO_STATUS_COMPLETED, PROCESSOR_DATE = SYSDATE
    WHERE TYPE = PKG_COMMON.TODO_TYPE_REGISTER AND CASE_CODE = P_CASE_CODE AND STATUS = PKG_COMMON.TODO_STATUS_REVIEW;

     -- lay thong tin REGISTER


    SELECT status, a.FISTNAME || ' ' || a.LASTNAME,  a1.content INTO v_status, v_created_by, v_Content
    FROM REGISTERINFO a LEFT JOIN allcode a1 on a1.CDNAME = 'REGITERINFO' AND a1.CDTYPE = 'STATUS'
    AND a1.CDVAL = a.status
     WHERE case_code = p_case_code;

    -- neu la yc moi -> ng xu ly la admin
    IF v_status = pkg_common.REGISTER_STATUS_NEW THEN

        v_request_by := v_created_by;

        -- ng xu ly la thang admin
        v_processor_by := pkg_common.USER_ADMIN;

        proc_insert(p_type,p_case_code,v_Content,v_request_by,v_request_date, v_processor_by,pkg_common.TODO_STATUS_REVIEW,p_language_code);

    END IF;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


END;
/


-- End of DDL Script for Package LEGALTECH.PKG_TODOS

-- Start of DDL Script for Package LEGALTECH.PKG_WIKI_CATALOUGE
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_wiki_catalouge
  IS

PROCEDURE PROC_WIKI_CATALOGUES_INSERT
(
    P_NAME IN WIKI_CATALOGUES.NAME % TYPE,
    P_NAME_ENG IN WIKI_CATALOGUES.NAME % TYPE,
    P_CATA_LEVEL IN WIKI_CATALOGUES.CATA_LEVEL % TYPE,
    P_CREATED_BY IN WIKI_CATALOGUES.CREATED_BY % TYPE,
    P_CREATED_DATE IN WIKI_CATALOGUES.CREATED_DATE % TYPE,
    P_PARENT_ID IN NUMBER,
    P_RETURN OUT NUMBER
);
PROCEDURE PROC_WIKI_CATALOGUES_UPDATE
(
P_ID IN WIKI_CATALOGUES.ID % TYPE,
P_NAME IN WIKI_CATALOGUES.NAME % TYPE,
P_NAME_ENG IN WIKI_CATALOGUES.NAME % TYPE,
P_CATA_LEVEL IN WIKI_CATALOGUES.CATA_LEVEL % TYPE,
P_MODIFIED_BY IN WIKI_CATALOGUES.MODIFIED_BY % TYPE,
P_MODIFIED_DATE IN WIKI_CATALOGUES.MODIFIED_DATE % TYPE,
P_PARENT_ID IN NUMBER,
P_RETURN OUT NUMBER
);

PROCEDURE PROC_WIKI_CATALOGUES_GETALL
(
P_CURSOR OUT PKG_COMMON.t_cursor
);

PROCEDURE PROC_WIKI_CATALOGUES_GETBYID
(
  P_ID IN WIKI_CATALOGUES.ID % TYPE,
  P_CURSOR OUT PKG_COMMON.t_cursor
);


PROCEDURE PROC_WIKI_CATALOGUES_DELETE
(
  P_ID IN WIKI_CATALOGUES.ID % TYPE,
  P_RETURN OUT NUMBER
);


PROCEDURE PROC_WIKI_CATA_DOC_SEARCH
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.t_cursor
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_wiki_catalouge
IS


PROCEDURE PROC_WIKI_CATALOGUES_INSERT
(
    P_NAME IN WIKI_CATALOGUES.NAME % TYPE,
    P_NAME_ENG IN WIKI_CATALOGUES.NAME % TYPE,
    P_CATA_LEVEL IN WIKI_CATALOGUES.CATA_LEVEL % TYPE,
    P_CREATED_BY IN WIKI_CATALOGUES.CREATED_BY % TYPE,
    P_CREATED_DATE IN WIKI_CATALOGUES.CREATED_DATE % TYPE,
    P_PARENT_ID IN NUMBER,
    P_RETURN OUT NUMBER
)
IS
V_ID NUMBER;
BEGIN

SELECT SEQ_WIKI_CATAS.NEXTVAL INTO V_ID FROM DUAL;
 P_RETURN := V_ID;
    INSERT INTO WIKI_CATALOGUES
    (
    ID, NAME, CATA_LEVEL, CREATED_BY, CREATED_DATE, NAME_ENG, PARENT_ID
     )
    VALUES
    (
     V_ID, P_NAME, P_CATA_LEVEL, P_CREATED_BY, TRUNC(P_CREATED_DATE), P_NAME_ENG, P_PARENT_ID
    );

COMMIT;
EXCEPTION
WHEN OTHERS THEN
P_RETURN := -1;
RAISE;
END;




--2.UPDATE

PROCEDURE PROC_WIKI_CATALOGUES_UPDATE
(
P_ID IN WIKI_CATALOGUES.ID % TYPE,
P_NAME IN WIKI_CATALOGUES.NAME % TYPE,
P_NAME_ENG IN WIKI_CATALOGUES.NAME % TYPE,
P_CATA_LEVEL IN WIKI_CATALOGUES.CATA_LEVEL % TYPE,
P_MODIFIED_BY IN WIKI_CATALOGUES.MODIFIED_BY % TYPE,
P_MODIFIED_DATE IN WIKI_CATALOGUES.MODIFIED_DATE % TYPE,
P_PARENT_ID IN NUMBER,
P_RETURN OUT NUMBER
)
IS

BEGIN
 P_RETURN := 0;
UPDATE WIKI_CATALOGUES SET
NAME = P_NAME,
CATA_LEVEL = P_CATA_LEVEL,
MODIFIED_BY = P_MODIFIED_BY,
MODIFIED_DATE = TRUNC(P_MODIFIED_DATE),
NAME_ENG = P_NAME_ENG,
PARENT_ID = P_PARENT_ID
WHERE ID = P_ID;
COMMIT;
EXCEPTION
WHEN OTHERS THEN
P_RETURN := -1;
ROLLBACK;
RAISE;
END;

--3.GELALL

PROCEDURE PROC_WIKI_CATALOGUES_GETALL
(
P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
 BEGIN
 OPEN P_CURSOR FOR

    SELECT A.ID,
    CASE WHEN A.CATA_LEVEL = 0 THEN A.NAME
    ELSE '---' || A.NAME END AS NAME,

     A.CATA_LEVEL, A.CREATED_BY, A.CREATED_DATE,
       A.MODIFIED_BY, A.MODIFIED_DATE, A.DELETED, A.NAME_ENG,
       A.PARENT_ID
       FROM WIKI_CATALOGUES A WHERE A.DELETED = 0
         START WITH a.PARENT_ID = 0
     CONNECT BY PRIOR ID = PARENT_ID
        ORDER  SIBLINGS by NAME  ASC   ;
END;

--4.GELBYID

PROCEDURE PROC_WIKI_CATALOGUES_GETBYID
(
  P_ID IN WIKI_CATALOGUES.ID % TYPE,
  P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
 BEGIN
    OPEN P_CURSOR FOR SELECT A.*, B.NAME AS PARENT_NAME, b.NAME_ENG AS PARENT_NAME_EN, (SELECT COUNT(0) FROM WIKI_CATALOGUES  WHERE PARENT_ID = A.ID AND deleted = 0 )
    AS CHILD_NUM FROM WIKI_CATALOGUES A LEFT JOIN WIKI_CATALOGUES B
    ON A.PARENT_ID = B.ID  WHERE A.ID = P_ID AND a.DELETED = 0;
END;



PROCEDURE PROC_WIKI_CATALOGUES_DELETE
(
  P_ID IN WIKI_CATALOGUES.ID % TYPE,
  P_RETURN OUT NUMBER
)
IS
V_COUNT NUMBER;
V_COUNT_PARENT NUMBER;
 BEGIN
 P_RETURN := 0;
  SELECT COUNT(0) INTO V_COUNT FROM WIKI_DOCS_CATALOGUES A INNER JOIN WIKI_DOCS B ON A.DOC_ID = B.ID
  WHERE B.DELETED = 0 AND A.CATALOGUE_ID = P_ID ;
 SELECT COUNT(0) INTO V_COUNT_PARENT FROM WIKI_CATALOGUES  A
  WHERE A.DELETED = 0 AND A.PARENT_ID = P_ID ;

  IF V_COUNT + V_COUNT_PARENT > 0 THEN
  P_RETURN := -2;
  RETURN;
  END IF;

    UPDATE WIKI_CATALOGUES SET DELETED = 1 WHERE ID = P_ID ;
    P_RETURN := 0;
    COMMIT;
EXCEPTION
WHEN OTHERS THEN
P_RETURN := -1;
ROLLBACK;
RAISE;
END;



PROCEDURE PROC_WIKI_CATA_DOC_SEARCH
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_SQL_TOTAL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT NUMBER  ;

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));


    V_NAME VARCHAR2(100) DEFAULT 'ALL';
    V_CATA_ID VARCHAR2(20) DEFAULT 'ALL';

    V_FROM NUMBER ;
    V_TO NUMBER;
BEGIN

   --PKG_LOG.LOGMSG('vao 1'); commit;
    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_NAME := ITEM.CONDITION;
        END IF;
         IF V_INDEX = 1 THEN
            V_CATA_ID := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;

 --  PKG_LOG.LOGMSG('vao 2'); commit;

    IF V_NAME <> 'ALL'    THEN
        V_CONDITION :=  V_CONDITION || ' AND ( A.NAME  LIKE ''%' || UPPER(V_NAME) || '%''  OR   A.NAME_ENG  LIKE ''%' || UPPER(V_NAME) || '%'')';
    END IF;
    IF V_CATA_ID <> 'ALL'    THEN
        V_CONDITION :=  V_CONDITION || ' AND A.PARENT_ID  = ''' || UPPER(V_CATA_ID) || '''' ;
    END IF;


    V_SQL := 'SELECT * FROM (  SELECT A.*, B.NAME AS PARENT_NAME FROM WIKI_CATALOGUES A LEFT JOIN WIKI_CATALOGUES B
            ON A.PARENT_ID = B.ID   ) A WHERE 1 = 1 AND A.DELETED = 0 ';

    V_SQL :=  V_SQL || V_CONDITION;

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || ' ORDER BY ' || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY MODIFIED_BY DESC';
    END IF;


    V_SQL_TOTAL := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_SQL_TOTAL INTO V_TOTAL_COUNT;

    V_FROM := P_FROM;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;

    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

END;
/


-- End of DDL Script for Package LEGALTECH.PKG_WIKI_CATALOUGE

-- Start of DDL Script for Package LEGALTECH.PKG_WIKI_DOCS
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_wiki_docs
  IS
 PROCEDURE PROC_WIKI_DOCS_INSERT
(
    P_TITLE IN WIKI_DOCS.TITLE % TYPE,
    P_CONTENT IN WIKI_DOCS.CONTENT % TYPE,
    P_CREATED_BY IN WIKI_DOCS.CREATED_BY % TYPE,
    P_CREATED_DATE IN WIKI_DOCS.CREATED_DATE % TYPE,
    P_LANGUAGE_CODE IN WIKI_DOCS.LANGUAGE_CODE % TYPE,
    P_HASHTAG IN VARCHAR2,
    P_FILE_URL01 IN VARCHAR2,
    P_FILE_URL02 IN VARCHAR2,
    P_FILE_URL03 IN VARCHAR2,
    P_CATA_ID IN NUMBER,
    P_STATUS IN NUMBER,
    P_RETURN OUT NUMBER
);

PROCEDURE PROC_WIKI_DOCS_UPDATE
(
P_ID IN WIKI_DOCS.ID % TYPE,
P_TITLE IN WIKI_DOCS.TITLE % TYPE,
P_CONTENT IN WIKI_DOCS.CONTENT % TYPE,
P_MODIFIED_BY IN WIKI_DOCS.MODIFIED_BY % TYPE,
P_MODIFIED_DATE IN WIKI_DOCS.MODIFIED_DATE % TYPE,
P_LANGUAGE_CODE IN WIKI_DOCS.LANGUAGE_CODE % TYPE,
P_HASHTAG IN VARCHAR2,
P_FILE_URL01 IN VARCHAR2,
P_FILE_URL02 IN VARCHAR2,
P_FILE_URL03 IN VARCHAR2,
P_CATA_ID IN NUMBER,
P_STATUS IN NUMBER,
P_NOTE IN VARCHAR2,
P_RETURN OUT NUMBER
);

PROCEDURE PROC_WIKI_DOCS_GETALL
(
P_CURSOR OUT PKG_COMMON.t_cursor
);


PROCEDURE PROC_WIKI_DOCS_GETBYID
(
  P_ID IN WIKI_DOCS.ID % TYPE,
  P_CURSOR OUT PKG_COMMON.t_cursor
);

PROCEDURE PROC_WIKI_DOCS_DELETE
(
  P_ID IN WIKI_DOCS.ID % TYPE,
  P_RETURN OUT NUMBER
);


PROCEDURE PROC_WIKI_DOC_SEARCH
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.t_cursor
);

PROCEDURE PROC_WIKI_DOCS_UPDATE_HASHTAG
(
P_ID IN WIKI_DOCS.ID % TYPE,
P_HASHTAG IN VARCHAR2,
P_RETURN OUT NUMBER
);

PROCEDURE PROC_PORTAL_WIKI_DOCS_GETBYID
(
  P_ID IN WIKI_DOCS.ID % TYPE,
  P_CURSOR OUT PKG_COMMON.t_cursor
);

PROCEDURE PROC_WIKI_DOCS_APPRO_OR_REFUSE
(
P_ID IN WIKI_DOCS.ID % TYPE,
P_STATUS IN NUMBER,
P_NOTE IN VARCHAR2,
P_MODIFIED_BY IN VARCHAR,
P_MODIFIED_DATE IN DATE,
P_RETURN OUT NUMBER
);

PROCEDURE PROC_WIKI_DOCS_GETBY_CASECODE
(
  P_CASECODE IN WIKI_DOCS.CASE_CODE % TYPE,
  P_CURSOR OUT PKG_COMMON.t_cursor
);

END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_wiki_docs
IS


PROCEDURE PROC_WIKI_DOCS_INSERT
(
    P_TITLE IN WIKI_DOCS.TITLE % TYPE,
    P_CONTENT IN WIKI_DOCS.CONTENT % TYPE,
    P_CREATED_BY IN WIKI_DOCS.CREATED_BY % TYPE,
    P_CREATED_DATE IN WIKI_DOCS.CREATED_DATE % TYPE,
    P_LANGUAGE_CODE IN WIKI_DOCS.LANGUAGE_CODE % TYPE,
    P_HASHTAG IN VARCHAR2,
    P_FILE_URL01 IN VARCHAR2,
    P_FILE_URL02 IN VARCHAR2,
    P_FILE_URL03 IN VARCHAR2,
    P_CATA_ID IN NUMBER,
    P_STATUS IN NUMBER,
    P_RETURN OUT NUMBER
)
IS
V_ID NUMBER;
  V_CASE_CODE VARCHAR2(100);
   V_ID_CASE_CODE VARCHAR2(100);
BEGIN

  SELECT SEQ_GENCODE.NEXTVAL INTO V_ID_CASE_CODE FROM DUAL;

    V_CASE_CODE := 'WIKI' || to_char(SYSDATE,'yyyyMMdd') || V_ID_CASE_CODE;

SELECT SEQ_WIKI_DOCS.NEXTVAL INTO V_ID FROM DUAL;
P_RETURN := V_ID;
    INSERT INTO WIKI_DOCS
    (
         ID, TITLE, CONTENT,  CREATED_BY, CREATED_DATE,
         LANGUAGE_CODE, HASHTAG, FILE_URL01,
         FILE_URL02, FILE_URL03, STATUS,  CASE_CODE
    )
    VALUES
    (
        V_ID, P_TITLE, P_CONTENT,  P_CREATED_BY,
         TRUNC(P_CREATED_DATE), P_LANGUAGE_CODE, P_HASHTAG,
         P_FILE_URL01, P_FILE_URL02, P_FILE_URL03, P_STATUS,  V_CASE_CODE
     );

INSERT INTO WIKI_DOCS_CATALOGUES A (ID, A.DOC_ID, A.CATALOGUE_ID )
VALUES(SEQ_WIKI_CATAS.NEXTVAL, V_ID, P_CATA_ID);


 -- insert todo
    pkg_todos.proc_do_insert_wiki(pkg_common.TODO_TYPE_WIKI,V_CASE_CODE,p_language_code);

COMMIT;
EXCEPTION
WHEN OTHERS THEN
P_RETURN :=-1;
RAISE;
END;




--2.UPDATE

PROCEDURE PROC_WIKI_DOCS_UPDATE
(
P_ID IN WIKI_DOCS.ID % TYPE,
P_TITLE IN WIKI_DOCS.TITLE % TYPE,
P_CONTENT IN WIKI_DOCS.CONTENT % TYPE,
P_MODIFIED_BY IN WIKI_DOCS.MODIFIED_BY % TYPE,
P_MODIFIED_DATE IN WIKI_DOCS.MODIFIED_DATE % TYPE,
P_LANGUAGE_CODE IN WIKI_DOCS.LANGUAGE_CODE % TYPE,
P_HASHTAG IN VARCHAR2,
P_FILE_URL01 IN VARCHAR2,
P_FILE_URL02 IN VARCHAR2,
P_FILE_URL03 IN VARCHAR2,
P_CATA_ID IN NUMBER,
P_STATUS IN NUMBER,
P_NOTE IN VARCHAR2,
P_RETURN OUT NUMBER
)
IS
V_CASE_CODE VARCHAR2(200);
BEGIN

SELECT a.case_code INTO V_CASE_CODE  FROM  WIKI_DOCS a WHERE a.id = P_ID;

P_RETURN := P_ID;
UPDATE WIKI_DOCS SET
TITLE = P_TITLE,
CONTENT = P_CONTENT,
MODIFIED_BY = P_MODIFIED_BY,
MODIFIED_DATE = TRUNC(P_MODIFIED_DATE),
LANGUAGE_CODE = P_LANGUAGE_CODE,
HASHTAG = P_HASHTAG,
FILE_URL01 = P_FILE_URL01,
FILE_URL02 = P_FILE_URL02,
FILE_URL03 = P_FILE_URL03,
STATUS = P_STATUS,
NOTE = P_NOTE
WHERE ID = P_ID;

DELETE FROM WIKI_DOCS_CATALOGUES WHERE DOC_ID = P_ID;
INSERT INTO WIKI_DOCS_CATALOGUES A (ID, A.DOC_ID, A.CATALOGUE_ID )
VALUES(SEQ_WIKI_CATAS.NEXTVAL, P_ID, P_CATA_ID);


 IF P_STATUS =  pkg_common.WIKI_STATUS_NEW THEN
  -- NEU GUI BAI THI INSERT VAO TODO
       pkg_todos.proc_do_insert_wiki(pkg_common.TODO_TYPE_WIKI,V_CASE_CODE,p_language_code);
END IF;

COMMIT;
EXCEPTION
WHEN OTHERS THEN
ROLLBACK;
RAISE;
END;
--2END

--3.GELALL

PROCEDURE PROC_WIKI_DOCS_GETALL
(
P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
 BEGIN
 OPEN P_CURSOR FOR SELECT * FROM WIKI_DOCS;
END;

--4.GELBYID

PROCEDURE PROC_WIKI_DOCS_GETBYID
(
  P_ID IN WIKI_DOCS.ID % TYPE,
  P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
 BEGIN
OPEN P_CURSOR FOR SELECT A.*, C.ID AS CATA_ID, C.NAME AS CATA_NAME FROM WIKI_DOCS A INNER JOIN WIKI_DOCS_CATALOGUES B
        ON A.ID = B.DOC_ID INNER JOIN WIKI_CATALOGUES
        C ON B.CATALOGUE_ID = C.ID WHERE NVL(A.DELETED,0) = 0
       AND A.ID = P_ID;
END;

PROCEDURE PROC_WIKI_DOCS_DELETE
(
  P_ID IN WIKI_DOCS.ID % TYPE,
  P_RETURN OUT NUMBER
)
IS
 BEGIN
 P_RETURN:=0;
 UPDATE  WIKI_DOCS SET DELETED = 1
 WHERE ID = P_ID;

 EXCEPTION
WHEN OTHERS THEN
P_RETURN := -1;
ROLLBACK;
RAISE;
END;



PROCEDURE PROC_WIKI_DOC_SEARCH
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_SQL_TOTAL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT NUMBER  ;

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_CATA_ID VARCHAR2(100) DEFAULT 'ALL';
    V_NAME_HASHTAG VARCHAR2(100) DEFAULT 'ALL';

    V_FROM NUMBER ;
    V_TO NUMBER;
BEGIN

   --PKG_LOG.LOGMSG('vao 1'); commit;
    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_STATUS := ITEM.CONDITION;
        END IF;
         IF V_INDEX = 1 THEN
            V_CATA_ID := ITEM.CONDITION;
        END IF;
         IF V_INDEX = 2 THEN
            V_NAME_HASHTAG := ITEM.CONDITION;
        END IF;
        V_INDEX := V_INDEX + 1;
    END LOOP;

   --PKG_LOG.LOGMSG('vao 2'); commit;
    IF V_STATUS <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND STATUS IN  (' || V_STATUS || ') ';
    END IF;
    IF V_CATA_ID <> 'ALL' AND V_CATA_ID <> 'null'  THEN
        V_CONDITION :=  V_CONDITION || ' AND B.CATALOGUE_ID  LIKE ''%' || UPPER(V_CATA_ID) || '%'' ';
    END IF;
    IF V_NAME_HASHTAG <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND ( UPPER(A.TITLE) LIKE ''%' || UPPER(V_NAME_HASHTAG) || '%''
         OR  UPPER(A.HASHTAG) LIKE ''%' || UPPER(V_NAME_HASHTAG) || '%''
         )
         ';
    END IF;



    V_SQL := 'SELECT  A.ID, A.TITLE,  A.VIEW_NUMBER, A.CREATED_BY,
        A.CREATED_DATE, A.MODIFIED_BY, A.MODIFIED_DATE, A.DELETED,
        A.LANGUAGE_CODE, A.HASHTAG, A.FILE_URL01, A.FILE_URL02,
        A.FILE_URL03, A.STATUS, C.ID AS CATA_ID, C.NAME AS CATA_NAME FROM WIKI_DOCS A INNER JOIN WIKI_DOCS_CATALOGUES B
        ON A.ID = B.DOC_ID INNER JOIN WIKI_CATALOGUES
        C ON B.CATALOGUE_ID = C.ID
        WHERE NVL(A.DELETED,0) = 0  ';

    V_SQL :=  V_SQL || V_CONDITION;

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || ' ORDER BY ' || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.MODIFIED_BY DESC';
    END IF;


   --PKG_LOG.LOGMSG(V_SQL); COMMIT;
    V_SQL_TOTAL := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_SQL_TOTAL INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;



    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE PROC_WIKI_DOCS_UPDATE_HASHTAG
(
    P_ID IN WIKI_DOCS.ID % TYPE,
    P_HASHTAG IN VARCHAR2,
    P_RETURN OUT NUMBER
)
IS
BEGIN
    P_RETURN := P_ID;
    UPDATE WIKI_DOCS SET
    HASHTAG = P_HASHTAG WHERE ID = P_ID;

    COMMIT;
EXCEPTION
WHEN OTHERS THEN
    ROLLBACK;
    RAISE;
END;

PROCEDURE PROC_PORTAL_WIKI_DOCS_GETBYID
(
  P_ID IN WIKI_DOCS.ID % TYPE,
  P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
BEGIN
    UPDATE WIKI_DOCS A SET  A.VIEW_NUMBER  =   NVL(A.VIEW_NUMBER,0) + 1 WHERE ID = P_ID;
    COMMIT;

    OPEN P_CURSOR FOR
    SELECT A.*, C.ID AS CATA_ID, C.NAME AS CATA_NAME
    FROM WIKI_DOCS A
    INNER JOIN WIKI_DOCS_CATALOGUES B ON A.ID = B.DOC_ID
    INNER JOIN WIKI_CATALOGUES C ON B.CATALOGUE_ID = C.ID WHERE NVL(A.DELETED,0) = 0 AND A.ID = P_ID;
END;



PROCEDURE PROC_WIKI_DOCS_APPRO_OR_REFUSE
(
    P_ID IN WIKI_DOCS.ID % TYPE,
    P_STATUS IN NUMBER,
    P_NOTE IN VARCHAR2,
    P_MODIFIED_BY IN VARCHAR,
    P_MODIFIED_DATE IN DATE,
    P_RETURN OUT NUMBER
)
IS
    V_CASE_CODE VARCHAR2(100);
    V_language_code  VARCHAR2(100);
BEGIN
    SELECT A.CASE_CODE, A.LANGUAGE_CODE  INTO V_CASE_CODE, V_language_code FROM WIKI_DOCS A WHERE A.ID = P_ID;
    P_RETURN := P_ID;
    UPDATE WIKI_DOCS A SET
    STATUS = P_STATUS,
    NOTE = P_NOTE,
    A.MODIFIED_BY = P_MODIFIED_BY,
     A.MODIFIED_DATE = P_MODIFIED_DATE
    WHERE ID = P_ID;

    -- insert todo
    pkg_todos.proc_do_insert_wiki(pkg_common.TODO_TYPE_WIKI,V_CASE_CODE,V_language_code);

    COMMIT;
EXCEPTION
WHEN OTHERS THEN
    ROLLBACK;
    RAISE;
END;



PROCEDURE PROC_WIKI_DOCS_GETBY_CASECODE
(
    P_CASECODE IN WIKI_DOCS.CASE_CODE % TYPE,
    P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
BEGIN
    OPEN P_CURSOR FOR
    SELECT a.id, a.title,  a.view_number, a.created_by,
       a.created_date, a.modified_by, a.modified_date, a.deleted,
       a.language_code, a.hashtag, a.file_url01, a.file_url02,
       a.file_url03, a.status, a.note, a.rating, a.number_voted,
       a.user_voted, a.case_code, C.ID AS CATA_ID, C.NAME AS CATA_NAME
    FROM WIKI_DOCS A
    INNER JOIN WIKI_DOCS_CATALOGUES B ON A.ID = B.DOC_ID
    INNER JOIN WIKI_CATALOGUES C ON B.CATALOGUE_ID = C.ID
    WHERE NVL(A.DELETED,0) = 0 AND A.CASE_CODE = P_CASECODE;

EXCEPTION
WHEN OTHERS THEN
    ROLLBACK;
    RAISE;
END;


END;
/


-- End of DDL Script for Package LEGALTECH.PKG_WIKI_DOCS

-- Start of DDL Script for Package LEGALTECH.PKG_WIKI_PORTAL
-- Generated 20-Thg2-2019 0:04:34 from LEGALTECH@LEGALONLINE

CREATE OR REPLACE 
PACKAGE pkg_wiki_portal
  IS
 PROCEDURE PROC_GET_CATALOGUE
(
  P_CURSOR OUT PKG_COMMON.t_cursor
);

PROCEDURE PROC_GET_DOC_BY_CATA_ID
(
  P_CATA_ID IN NUMBER,
  P_CURSOR OUT PKG_COMMON.t_cursor
);


PROCEDURE PROC_WIKI_DOC_SEARCH
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.t_cursor
);
PROCEDURE PROC_VOTING
(
 P_DOCID IN NUMBER,
 P_USERID IN VARCHAR2,
 P_POINT IN NUMBER,
 P_CURSOR OUT PKG_COMMON.t_cursor
);

PROCEDURE PROC_SEARCH_CATALOGE
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.t_cursor
);
END;
/


CREATE OR REPLACE 
PACKAGE BODY pkg_wiki_portal
IS


PROCEDURE PROC_GET_CATALOGUE
(
  P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
 BEGIN

    OPEN P_CURSOR FOR

    SELECT A.ID,
    CASE WHEN A.CATA_LEVEL = 0 THEN A.NAME
    ELSE    A.NAME END AS NAME,

     A.CATA_LEVEL, A.CREATED_BY, A.CREATED_DATE,
       A.MODIFIED_BY, A.MODIFIED_DATE, A.DELETED, A.NAME_ENG,
       A.PARENT_ID
       FROM WIKI_CATALOGUES A WHERE A.DELETED = 0
         START WITH a.PARENT_ID = 0
     CONNECT BY PRIOR ID = PARENT_ID
        ORDER  SIBLINGS by NAME  ASC   ;



     EXCEPTION WHEN OTHERS THEN
     RAISE;
END;


PROCEDURE PROC_GET_DOC_BY_CATA_ID
(
  P_CATA_ID IN NUMBER,
  P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
 BEGIN
    OPEN P_CURSOR FOR SELECT A.* FROM WIKI_DOCS A INNER JOIN WIKI_DOCS_CATALOGUES B ON A.ID = B.DOC_ID WHERE A.DELETED = 0
      AND B.CATALOGUE_ID =  P_CATA_ID ;

     EXCEPTION WHEN OTHERS THEN
     RAISE;
END;


PROCEDURE PROC_WIKI_DOC_SEARCH
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_SQL_TOTAL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT NUMBER  ;

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_CATA_ID VARCHAR2(100) DEFAULT 'ALL';
    V_NAME_HASHTAG VARCHAR2(100) DEFAULT 'ALL';
    V_LANGUAGE_CODE VARCHAR2(100) DEFAULT 'ALL';
    V_FROM NUMBER ;
    V_TO NUMBER;
BEGIN

    --PKG_LOG.LOGMSG('vao 1'); commit;
    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_STATUS := ITEM.CONDITION;
        END IF;
         IF V_INDEX = 1 THEN
            V_CATA_ID := ITEM.CONDITION;
        END IF;
        IF V_INDEX = 2 THEN
            V_NAME_HASHTAG := ITEM.CONDITION;
        END IF;
        IF V_INDEX = 3 THEN
            V_LANGUAGE_CODE := ITEM.CONDITION;
        END IF;
        V_INDEX := V_INDEX + 1;
    END LOOP;

    --PKG_LOG.LOGMSG('vao 2'); commit;
    IF V_STATUS <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND STATUS IN  (' || V_STATUS || ') ';
    END IF;
    IF V_CATA_ID <> 'ALL' AND V_CATA_ID <> 'null'  THEN
        V_CONDITION :=  V_CONDITION || ' AND B.CATALOGUE_ID  LIKE ''%' || UPPER(V_CATA_ID) || '%'' ';
    END IF;
    IF V_NAME_HASHTAG <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND ( UPPER(A.TITLE) LIKE ''%' || UPPER(V_NAME_HASHTAG) || '%''
         OR  UPPER(A.HASHTAG) LIKE ''%' || UPPER(V_NAME_HASHTAG) || '%''
         )
         ';
    END IF;

    IF V_LANGUAGE_CODE <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND A.LANGUAGE_CODE = ''' || UPPER(V_LANGUAGE_CODE) ||  '''';
    END IF;



    V_SQL := 'SELECT  A.ID, A.TITLE,  A.VIEW_NUMBER, A.CREATED_BY,
        A.CREATED_DATE, A.MODIFIED_BY, A.MODIFIED_DATE, A.DELETED,
        A.LANGUAGE_CODE, A.HASHTAG, A.FILE_URL01, A.FILE_URL02,
        A.FILE_URL03, A.STATUS, C.ID AS CATA_ID, C.NAME AS CATA_NAME FROM WIKI_DOCS A INNER JOIN WIKI_DOCS_CATALOGUES B
        ON A.ID = B.DOC_ID INNER JOIN WIKI_CATALOGUES
        C ON B.CATALOGUE_ID = C.ID
        WHERE NVL(A.DELETED,0) = 0  ';

    V_SQL :=  V_SQL || V_CONDITION;

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || ' ORDER BY ' || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.TITLE ASC ';
    END IF;



    V_SQL_TOTAL := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_SQL_TOTAL INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;
    --PKG_LOG.LOGMSG(V_SQL); COMMIT;
    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;

PROCEDURE PROC_VOTING
(
    P_DOCID IN NUMBER,
    P_USERID IN VARCHAR2,
    P_POINT IN NUMBER,
    P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
    V_TOTAL_STARTS NUMBER;
    V_TOTAL_VOTED NUMBER;
    V_CURR_RATE NUMBER;
    V_CURR_STARS  NUMBER;
    V_TOTAL_RATE NUMBER;
    V_CREATED_BY VARCHAR2(50);
BEGIN
    SELECT A.CREATED_BY INTO V_CREATED_BY
    FROM WIKI_DOCS A WHERE A.ID = P_DOCID;

    UPDATE WIKI_DOCS A SET A.NUMBER_VOTED = NVL(A.NUMBER_VOTED,0) + 1,
        A.RATING = NVL(A.RATING,0) +  P_POINT ,
        A.USER_VOTED = A.USER_VOTED || '|' || P_USERID || '|'
    WHERE  A.ID = P_DOCID;


   SELECT SUM(NVL(RATING,0)) / (SUM(NVL(NUMBER_VOTED,0) * 5)) INTO V_TOTAL_RATE
   FROM WIKI_DOCS A WHERE UPPER(A.CREATED_BY) = UPPER(V_CREATED_BY);

    -- UPDATE RATE VAO BANG USER

    UPDATE S_USERS A SET A.RATING =  ROUND( V_TOTAL_RATE, 6) WHERE UPPER( A.USERNAME) = UPPER(V_CREATED_BY) AND DELETED = 0;


    COMMIT;
    OPEN P_CURSOR FOR SELECT  NUMBER_VOTED, RATING, USER_VOTED FROM WIKI_DOCS WHERE ID = P_DOCID;


EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


PROCEDURE PROC_SEARCH_CATALOGE
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.t_cursor
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_SQL_TOTAL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT NUMBER  ;

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_NAMEABC VARCHAR2(10) DEFAULT 'ALL';
    V_NAME_SEARCH VARCHAR2(100) DEFAULT 'ALL';
    V_PARENTID VARCHAR2(100) DEFAULT 'ALL';
    V_LANGUAGE_CODE VARCHAR2(100) DEFAULT 'ALL';
    V_FROM NUMBER ;
    V_TO NUMBER;
BEGIN

    --PKG_LOG.LOGMSG('vao 1'); commit;
    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_NAMEABC := ITEM.CONDITION;
        END IF;
         IF V_INDEX = 1 THEN
            V_NAME_SEARCH := ITEM.CONDITION;
        END IF;
        IF V_INDEX = 2 THEN
            V_PARENTID := ITEM.CONDITION;
        END IF;
        IF V_INDEX = 3 THEN
            V_LANGUAGE_CODE := ITEM.CONDITION;
        END IF;
        V_INDEX := V_INDEX + 1;
    END LOOP;

    --PKG_LOG.LOGMSG('vao 2'); commit;
    IF V_NAMEABC <> 'ALL' THEN

      IF V_LANGUAGE_CODE = PKG_COMMON.EN_US  THEN
         V_CONDITION :=  V_CONDITION || ' AND UPPER(NAME_ENG) LIKE  UPPER( ''' || V_NAMEABC || '%'') ';
        ELSE
         V_CONDITION :=  V_CONDITION || ' AND UPPER(NAME) LIKE UPPER( ''' || V_NAMEABC || '%'' )';
      END IF;

    END IF;
    IF V_NAME_SEARCH <> 'ALL'  THEN
        IF V_LANGUAGE_CODE = PKG_COMMON.EN_US  THEN
         V_CONDITION :=  V_CONDITION || ' AND NAME_ENG LIKE  ''%' || V_NAME_SEARCH || '%'' ';
        ELSE
         V_CONDITION :=  V_CONDITION || ' AND NAME LIKE  ''%' || V_NAME_SEARCH || '%'' ';
      END IF;
    END IF;
    IF V_PARENTID <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || '  AND PARENT_ID =  ' || V_PARENTID ;
    END IF;


    V_SQL := 'SELECT A.NAME, A.NAME_ENG, A.ID, A.PARENT_ID, NVL(B.NUMBER_DOC,0) AS NUMBER_DOC
     FROM WIKI_CATALOGUES A
     LEFT JOIN
     (SELECT COUNT(0) AS NUMBER_DOC, A.CATALOGUE_ID FROM WIKI_DOCS_CATALOGUES A
     INNER JOIN WIKI_DOCS WK ON A.DOC_ID = WK.ID WHERE WK.DELETED = 0
     AND WK.STATUS = 3
     GROUP BY A.CATALOGUE_ID) B ON A.ID = B.CATALOGUE_ID
     WHERE 1 = 1 ';

    V_SQL :=  V_SQL || V_CONDITION;

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || ' ORDER BY ' || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.NAME ASC ';
    END IF;


    PKG_LOG.LOGMSG(V_SQL); commit;
    V_SQL_TOTAL := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_SQL_TOTAL INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;
    --PKG_LOG.LOGMSG(V_SQL); COMMIT;
    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;


END;
/


-- End of DDL Script for Package LEGALTECH.PKG_WIKI_PORTAL

